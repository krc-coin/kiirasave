<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiira Save - Skysoft Technologies</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #1abc9c;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .auth-container {
            display: flex;
            justify-content: center;
            margin-top: 50px;
        }
        
        .auth-form {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .auth-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--dark-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .btn {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-3 {
            margin-top: 15px;
        }
        
        .hidden {
            display: none;
        }
        
        /* Dashboard styles */
        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .sidebar {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .main-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-nav {
            list-style: none;
        }
        
        .sidebar-nav li {
            margin-bottom: 10px;
        }
        
        .sidebar-nav a {
            display: block;
            padding: 10px;
            color: var(--dark-color);
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .sidebar-nav a:hover {
            background-color: var(--light-color);
        }
        
        .sidebar-nav a.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background-color: var(--light-color);
            font-weight: 600;
        }
        
        table tr:hover {
            background-color: #f9f9f9;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .badge-info {
            background-color: var(--info-color);
            color: white;
        }
        
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            transform: translateY(-20px);
            transition: transform 0.3s;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Alert styles */
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Progress bar */
        .progress {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Kiira Save</h1>
            <p>A product of Skysoft Technologies</p>
        </div>
    </header>

    <div class="container">
        <!-- Authentication Views -->
        <div id="auth-views" class="auth-container">
            <!-- Sign In View -->
            <div id="signin-view" class="auth-form">
                <h2>Sign In</h2>
                <div id="signin-alert" class="alert hidden"></div>
                <form id="signin-form">
                    <div class="form-group">
                        <label for="signin-email">Email or Phone</label>
                        <input type="text" id="signin-email" required>
                    </div>
                    <div class="form-group">
                        <label for="signin-password">Password</label>
                        <input type="password" id="signin-password" required>
                    </div>
                    <button type="submit" class="btn btn-block">Sign In</button>
                </form>
                <p class="text-center mt-3">Don't have an account? <a href="#" id="show-signup">Sign Up</a></p>
            </div>

            <!-- Sign Up View -->
            <div id="signup-view" class="auth-form hidden">
                <h2>Sign Up</h2>
                <div id="signup-alert" class="alert hidden"></div>
                <form id="signup-form">
                    <div class="form-group">
                        <label for="signup-name">Full Name</label>
                        <input type="text" id="signup-name" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-phone">Phone Number</label>
                        <input type="tel" id="signup-phone" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-location">Location</label>
                        <input type="text" id="signup-location" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-next-of-kin">Next of Kin</label>
                        <input type="text" id="signup-next-of-kin" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-next-of-kin-phone">Next of Kin Phone</label>
                        <input type="tel" id="signup-next-of-kin-phone" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-group">Group Name or ID</label>
                        <input type="text" id="signup-group">
                        <small>Leave blank if you want to create a new group</small>
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" required>
                    </div>
                    <div class="form-group">
                        <label for="signup-confirm-password">Confirm Password</label>
                        <input type="password" id="signup-confirm-password" required>
                    </div>
                    <button type="submit" class="btn btn-block">Sign Up</button>
                </form>
                <p class="text-center mt-3">Already have an account? <a href="#" id="show-signin">Sign In</a></p>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden">
            <div class="dashboard">
                <div class="sidebar">
                    <div class="user-profile">
                        <h3 id="user-name">John Doe</h3>
                        <p id="user-role">Group Member</p>
                    </div>
                    <ul class="sidebar-nav">
                        <li><a href="#" class="active" data-view="overview">Overview</a></li>
                        <li><a href="#" data-view="savings">My Savings</a></li>
                        <li><a href="#" data-view="group-members">Group Members</a></li>
                        <li><a href="#" data-view="saving-history">Saving History</a></li>
                        <li><a href="#" data-view="loans">Loans</a></li>
                        <li><a href="#" data-view="shares">Shares Market</a></li>
                        <li><a href="#" data-view="messages">Messages</a></li>
                        <li><a href="#" data-view="settings">Settings</a></li>
                        <li class="admin-only hidden"><a href="#" data-view="admin">Admin Panel</a></li>
                        <li class="super-admin-only hidden"><a href="#" data-view="super-admin">Super Admin</a></li>
                        <li><a href="#" id="logout-btn">Logout</a></li>
                    </ul>
                </div>
                <div class="main-content">
                    <!-- Broadcast Message -->
                    <div id="broadcast-message" class="alert alert-info hidden"></div>
                    
                    <!-- Overview Tab -->
                    <div id="overview-view" class="tab-content active">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Group Summary</h3>
                            </div>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-label">Total Group Savings</div>
                                    <div class="stat-value" id="total-group-savings">UGX 0</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">My Savings</div>
                                    <div class="stat-value" id="my-savings">UGX 0</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Group Members</div>
                                    <div class="stat-value" id="group-members-count">0</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Savings Cycle</div>
                                    <div class="stat-value" id="savings-cycle">Day 1</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Recent Activities</h3>
                            </div>
                            <div id="recent-activities">
                                <p>No recent activities</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Savings Tab -->
                    <div id="savings-view" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">My Savings</h3>
                                <button class="btn" id="add-saving-btn">Add Saving</button>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" id="savings-progress" style="width: 0%">0%</div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="savings-list">
                                    <tr>
                                        <td colspan="4">No savings records found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Group Members Tab -->
                    <div id="group-members-view" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Group Members</h3>
                                <button class="btn admin-only hidden" id="invite-member-btn">Invite Member</button>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Contact</th>
                                        <th>Savings</th>
                                        <th>Status</th>
                                        <th class="admin-only hidden">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="members-list">
                                    <tr>
                                        <td colspan="5">No members found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Saving History Tab -->
                    <div id="saving-history-view" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Saving History</h3>
                                <button class="btn" id="print-history-btn">Print History</button>
                            </div>
                            <div id="history-tabs" class="tabs">
                                <div class="tab active" data-tab="personal-history">Personal</div>
                                <div class="tab" data-tab="group-history">Group</div>
                            </div>
                            <div id="personal-history" class="tab-content active">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="personal-history-list">
                                        <tr>
                                            <td colspan="3">No history found</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="group-history" class="tab-content">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Member</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="group-history-list">
                                        <tr>
                                            <td colspan="3">No group history found</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loans Tab -->
                    <div id="loans-view" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Loans</h3>
                                <button class="btn" id="apply-loan-btn" disabled>Apply for Loan</button>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Interest</th>
                                        <th>Status</th>
                                        <th>Due Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="loans-list">
                                    <tr>
                                        <td colspan="6">No loan records found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Shares Market Tab -->
                    <div id="shares-view" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Shares Market</h3>
                            </div>
                            <div id="shares-tabs" class="tabs">
                                <div class="tab active" data-tab="available-shares">Available Shares</div>
                                <div class="tab" data-tab="my-shares">My Shares</div>
                                <div class="tab" data-tab="sell-shares">Sell Shares</div>
                            </div>
                            <div id="available-shares" class="tab-content active">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Seller</th>
                                            <th>Amount</th>
                                            <th>Price</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="available-shares-list">
                                        <tr>
                                            <td colspan="4">No shares available for purchase</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="my-shares" class="tab-content">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date Purchased</th>
                                            <th>Amount</th>
                                            <th>Price</th>
                                            <th>Seller</th>
                                        </tr>
                                    </thead>
                                    <tbody id="my-shares-list">
                                        <tr>
                                            <td colspan="4">You haven't purchased any shares</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="sell-shares" class="tab-content">
                                <form id="sell-shares-form">
                                    <div class="form-group">
                                        <label for="shares-amount">Amount to Sell</label>
                                        <input type="number" id="shares-amount" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label for="shares-price">Price per Share</label>
                                        <input type="number" id="shares-price" min="1">
                                    </div>
                                    <button type="submit" class="btn">List for Sale</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Messages Tab -->
                    <div id="messages-view" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Messages</h3>
                                <button class="btn" id="new-message-btn">New Message</button>
                            </div>
                            <div id="messages-tabs" class="tabs">
                                <div class="tab active" data-tab="inbox">Inbox</div>
                                <div class="tab" data-tab="sent">Sent</div>
                                <div class="tab" data-tab="broadcasts">Broadcasts</div>
                            </div>
                            <div id="inbox" class="tab-content active">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>From</th>
                                            <th>Subject</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inbox-list">
                                        <tr>
                                            <td colspan="4">No messages</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="sent" class="tab-content">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>To</th>
                                            <th>Subject</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sent-list">
                                        <tr>
                                            <td colspan="4">No sent messages</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="broadcasts" class="tab-content">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>From</th>
                                            <th>Subject</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="broadcasts-list">
                                        <tr>
                                            <td colspan="4">No broadcasts</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settings Tab -->
                    <div id="settings-view" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Profile Settings</h3>
                            </div>
                            <form id="profile-settings-form">
                                <div class="form-group">
                                    <label for="settings-name">Full Name</label>
                                    <input type="text" id="settings-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="settings-email">Email</label>
                                    <input type="email" id="settings-email" required>
                                </div>
                                <div class="form-group">
                                    <label for="settings-phone">Phone Number</label>
                                    <input type="tel" id="settings-phone" required>
                                </div>
                                <div class="form-group">
                                    <label for="settings-location">Location</label>
                                    <input type="text" id="settings-location" required>
                                </div>
                                <div class="form-group">
                                    <label for="settings-next-of-kin">Next of Kin</label>
                                    <input type="text" id="settings-next-of-kin" required>
                                </div>
                                <div class="form-group">
                                    <label for="settings-next-of-kin-phone">Next of Kin Phone</label>
                                    <input type="tel" id="settings-next-of-kin-phone" required>
                                </div>
                                <button type="submit" class="btn">Update Profile</button>
                            </form>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Change Password</h3>
                            </div>
                            <form id="change-password-form">
                                <div class="form-group">
                                    <label for="current-password">Current Password</label>
                                    <input type="password" id="current-password" required>
                                </div>
                                <div class="form-group">
                                    <label for="new-password">New Password</label>
                                    <input type="password" id="new-password" required>
                                </div>
                                <div class="form-group">
                                    <label for="confirm-new-password">Confirm New Password</label>
                                    <input type="password" id="confirm-new-password" required>
                                </div>
                                <button type="submit" class="btn">Change Password</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Admin Panel Tab -->
                    <div id="admin-view" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Admin Panel</h3>
                            </div>
                            <div class="tabs">
                                <div class="tab active" data-tab="pending-approvals">Pending Approvals</div>
                                <div class="tab" data-tab="group-settings">Group Settings</div>
                                <div class="tab" data-tab="manage-members">Manage Members</div>
                                <div class="tab" data-tab="financial-reports">Financial Reports</div>
                            </div>
                            
                            <div id="pending-approvals" class="tab-content active">
                                <h4>Pending Savings</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Member</th>
                                            <th>Amount</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pending-savings-list">
                                        <tr>
                                            <td colspan="4">No pending savings</td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <h4>Pending Members</h4>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Contact</th>
                                            <th>Date Applied</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pending-members-list">
                                        <tr>
                                            <td colspan="4">No pending members</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="group-settings" class="tab-content">
                                <form id="group-settings-form">
                                    <div class="form-group">
                                        <label for="group-name">Group Name</label>
                                        <input type="text" id="group-name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="saving-frequency">Saving Frequency</label>
                                        <select id="saving-frequency" required>
                                            <option value="daily">Daily</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="annually">Annually</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="saving-amount">Saving Amount (UGX)</label>
                                        <input type="number" id="saving-amount" min="0">
                                        <small>Set to 0 for flexible amounts</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="saving-day">Saving Day</label>
                                        <select id="saving-day">
                                            <option value="1">1st</option>
                                            <!-- More options would be added dynamically -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="compulsory-saving"> Compulsory Saving
                                        </label>
                                    </div>
                                    <div class="form-group" id="fine-options-container" style="display: none;">
                                        <label>Fine for Missing Saving</label>
                                        <select id="fine-type">
                                            <option value="percentage_collection">Percentage of recent collection</option>
                                            <option value="percentage_total">Percentage of total savings</option>
                                            <option value="percentage_personal">Percentage of personal savings</option>
                                            <option value="fixed">Fixed amount</option>
                                        </select>
                                        <input type="number" id="fine-amount" min="0" placeholder="Amount/Percentage">
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="enable-loans"> Enable Loans
                                        </label>
                                    </div>
                                    <div class="form-group" id="loan-interest-container" style="display: none;">
                                        <label for="loan-interest">Default Loan Interest Rate (%)</label>
                                        <input type="number" id="loan-interest" min="0" step="0.1">
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="enable-shares"> Enable Shares Market
                                        </label>
                                    </div>
                                    <button type="submit" class="btn">Save Settings</button>
                                </form>
                            </div>
                            
                            <div id="manage-members" class="tab-content">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Contact</th>
                                            <th>Savings</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-members-list">
                                        <tr>
                                            <td colspan="5">No members found</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="financial-reports" class="tab-content">
                                <div class="form-group">
                                    <label for="report-type">Report Type</label>
                                    <select id="report-type">
                                        <option value="savings">Savings Report</option>
                                        <option value="loans">Loans Report</option>
                                        <option value="shares">Shares Report</option>
                                        <option value="full">Full Financial Report</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="report-period">Period</label>
                                    <select id="report-period">
                                        <option value="current">Current Cycle</option>
                                        <option value="last">Last Cycle</option>
                                        <option value="all">All Time</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                                <div id="custom-range-container" style="display: none;">
                                    <div class="form-group">
                                        <label for="start-date">Start Date</label>
                                        <input type="date" id="start-date">
                                    </div>
                                    <div class="form-group">
                                        <label for="end-date">End Date</label>
                                        <input type="date" id="end-date">
                                    </div>
                                </div>
                                <button class="btn" id="generate-report-btn">Generate Report</button>
                                <div id="report-results" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Super Admin Tab -->
                    <div id="super-admin-view" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Super Admin Panel</h3>
                            </div>
                            <div class="tabs">
                                <div class="tab active" data-tab="all-groups">All Groups</div>
                                <div class="tab" data-tab="system-settings">System Settings</div>
                                <div class="tab" data-tab="broadcast-messages">Broadcast Messages</div>
                                <div class="tab" data-tab="advertisements">Advertisements</div>
                                <div class="tab" data-tab="backup-restore">Backup/Restore</div>
                            </div>
                            
                            <div id="all-groups" class="tab-content active">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Group Name</th>
                                            <th>Admin</th>
                                            <th>Members</th>
                                            <th>Total Savings</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="all-groups-list">
                                        <tr>
                                            <td colspan="6">No groups found</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="system-settings" class="tab-content">
                                <form id="system-settings-form">
                                    <div class="form-group">
                                        <label for="default-currency">Default Currency</label>
                                        <select id="default-currency" required>
                                            <option value="UGX">UGX - Ugandan Shilling</option>
                                            <option value="KES">KES - Kenyan Shilling</option>
                                            <option value="TZS">TZS - Tanzanian Shilling</option>
                                            <option value="USD">USD - US Dollar</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="max-groups-per-user">Max Groups per User</label>
                                        <input type="number" id="max-groups-per-user" min="1" value="2" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="subscription-fee">Subscription Fee (UGX)</label>
                                        <input type="number" id="subscription-fee" min="0">
                                        <small>Set to 0 for free</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="mobile-money-number">Mobile Money Number</label>
                                        <input type="tel" id="mobile-money-number">
                                    </div>
                                    <div class="form-group">
                                        <label for="inactivity-threshold">Group Inactivity Threshold (months)</label>
                                        <input type="number" id="inactivity-threshold" min="1" value="12" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="successor1">First Successor (Username)</label>
                                        <input type="text" id="successor1">
                                    </div>
                                    <div class="form-group">
                                        <label for="successor2">Second Successor (Username)</label>
                                        <input type="text" id="successor2">
                                    </div>
                                    <button type="submit" class="btn">Save System Settings</button>
                                </form>
                            </div>
                            
                            <div id="broadcast-messages" class="tab-content">
                                <form id="broadcast-form">
                                    <div class="form-group">
                                        <label for="broadcast-type">Recipients</label>
                                        <select id="broadcast-type">
                                            <option value="all-admins">All Group Admins</option>
                                            <option value="all-members">All Members</option>
                                            <option value="specific-group">Specific Group</option>
                                        </select>
                                    </div>
                                    <div class="form-group" id="specific-group-container" style="display: none;">
                                        <label for="broadcast-group">Select Group</label>
                                        <select id="broadcast-group"></select>
                                    </div>
                                    <div class="form-group">
                                        <label for="broadcast-subject">Subject</label>
                                        <input type="text" id="broadcast-subject" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="broadcast-message">Message</label>
                                        <textarea id="broadcast-message" rows="5" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="broadcast-attachment">Attachment</label>
                                        <input type="file" id="broadcast-attachment">
                                    </div>
                                    <div class="form-group">
                                        <label for="broadcast-duration">Display Duration (days)</label>
                                        <input type="number" id="broadcast-duration" min="1" value="7">
                                    </div>
                                    <button type="submit" class="btn">Send Broadcast</button>
                                </form>
                            </div>
                            
                            <div id="advertisements" class="tab-content">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Advertiser</th>
                                            <th>Location</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="advertisements-list">
                                        <tr>
                                            <td colspan="6">No advertisements</td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h4>Pending Advertisements</h4>
                                    </div>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Advertiser</th>
                                                <th>Location</th>
                                                <th>Payment</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pending-ads-list">
                                            <tr>
                                                <td colspan="4">No pending advertisements</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div id="backup-restore" class="tab-content">
                                <div class="card">
                                    <div class="card-header">
                                        <h4>Backup Data</h4>
                                    </div>
                                    <div class="form-group">
                                        <label for="backup-type">Backup Type</label>
                                        <select id="backup-type">
                                            <option value="full">Full System Backup</option>
                                            <option value="groups">Groups Data Only</option>
                                            <option value="users">Users Data Only</option>
                                            <option value="transactions">Transactions Only</option>
                                        </select>
                                    </div>
                                    <button class="btn" id="create-backup-btn">Create Backup</button>
                                    <div id="backup-result" class="mt-3"></div>
                                </div>
                                
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h4>Restore Data</h4>
                                    </div>
                                    <div class="form-group">
                                        <label for="restore-file">Backup File</label>
                                        <input type="file" id="restore-file" accept=".json">
                                    </div>
                                    <button class="btn" id="restore-btn">Restore</button>
                                    <div id="restore-result" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-saving-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Saving</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-saving-form">
                    <div class="form-group">
                        <label for="saving-amount-input">Amount (UGX)</label>
                        <input type="number" id="saving-amount-input" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="saving-date">Date</label>
                        <input type="date" id="saving-date" required>
                    </div>
                    <div class="form-group">
                        <label for="saving-proof">Proof of Payment</label>
                        <input type="file" id="saving-proof">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancel-saving-btn">Cancel</button>
                <button class="btn" id="submit-saving-btn">Submit</button>
            </div>
        </div>
    </div>

    <div id="invite-member-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Invite Member</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="invite-member-form">
                    <div class="form-group">
                        <label for="invite-email">Email Address</label>
                        <input type="email" id="invite-email" required>
                    </div>
                    <div class="form-group">
                        <label for="invite-message">Message (Optional)</label>
                        <textarea id="invite-message" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancel-invite-btn">Cancel</button>
                <button class="btn" id="send-invite-btn">Send Invitation</button>
            </div>
        </div>
    </div>

    <div id="apply-loan-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Apply for Loan</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="apply-loan-form">
                    <div class="form-group">
                        <label for="loan-amount">Amount (UGX)</label>
                        <input type="number" id="loan-amount" min="1" required>
                        <small>Maximum: <span id="max-loan-amount">0</span> UGX</small>
                    </div>
                    <div class="form-group">
                        <label for="loan-purpose">Purpose</label>
                        <textarea id="loan-purpose" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="loan-period">Repayment Period</label>
                        <select id="loan-period" required>
                            <option value="1week">1 Week</option>
                            <option value="1month">1 Month</option>
                            <option value="4months">4 Months</option>
                            <option value="6months">6 Months</option>
                            <option value="cycle-end">End of Cycle</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <p>Interest Rate: <span id="loan-interest-rate">0</span>%</p>
                        <p>Total to Repay: <span id="loan-total-repay">0</span> UGX</p>
                        <p>Daily Interest After Due Date: <span id="loan-penalty-rate">0</span>%</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancel-loan-btn">Cancel</button>
                <button class="btn" id="submit-loan-btn">Submit Application</button>
            </div>
        </div>
    </div>

    <div id="new-message-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Message</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="new-message-form">
                    <div class="form-group">
                        <label for="message-recipient">To</label>
                        <select id="message-recipient" required>
                            <option value="">Select Recipient</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="message-subject">Subject</label>
                        <input type="text" id="message-subject" required>
                    </div>
                    <div class="form-group">
                        <label for="message-body">Message</label>
                        <textarea id="message-body" rows="5" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="message-attachment">Attachment</label>
                        <input type="file" id="message-attachment">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancel-message-btn">Cancel</button>
                <button class="btn" id="send-message-btn">Send Message</button>
            </div>
        </div>
    </div>

    <div id="view-message-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="message-view-title">Message</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="message-view-content"></div>
                <div id="message-attachment-view" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="close-message-btn">Close</button>
                <button class="btn" id="reply-message-btn">Reply</button>
            </div>
        </div>
    </div>

    <div id="admin-approval-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Approval</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="approval-content"></div>
                <div class="form-group mt-3">
                    <label for="approval-comment">Comment (Optional)</label>
                    <textarea id="approval-comment" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="reject-approval-btn">Reject</button>
                <button class="btn btn-success" id="confirm-approval-btn">Approve</button>
            </div>
        </div>
    </div>

    <div id="buy-shares-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Buy Shares</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="buy-shares-form">
                    <div class="form-group">
                        <label>Seller: <span id="share-seller-name"></span></label>
                    </div>
                    <div class="form-group">
                        <label>Available Shares: <span id="share-available-amount"></span> UGX</label>
                    </div>
                    <div class="form-group">
                        <label>Price per Share: <span id="share-price-per"></span> UGX</label>
                    </div>
                    <div class="form-group">
                        <label for="buy-share-amount">Amount to Buy (UGX)</label>
                        <input type="number" id="buy-share-amount" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Total Cost: <span id="share-total-cost">0</span> UGX</label>
                    </div>
                    <div class="form-group">
                        <label for="share-payment-method">Payment Method</label>
                        <select id="share-payment-method" required>
                            <option value="">Select Method</option>
                            <option value="mobile_money">Mobile Money</option>
                            <option value="cash">Cash</option>
                            <option value="bank">Bank Transfer</option>
                        </select>
                    </div>
                    <div class="form-group" id="share-proof-container" style="display: none;">
                        <label for="share-proof">Proof of Payment</label>
                        <input type="file" id="share-proof">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancel-buy-shares-btn">Cancel</button>
                <button class="btn" id="confirm-buy-shares-btn">Confirm Purchase</button>
            </div>
        </div>
    </div>

    <div id="gift-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Gift to Member</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="gift-form">
                    <div class="form-group">
                        <label for="gift-recipient">Recipient</label>
                        <select id="gift-recipient" required>
                            <option value="">Select Member</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gift-amount">Amount (UGX)</label>
                        <input type="number" id="gift-amount" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="gift-message">Message (Optional)</label>
                        <textarea id="gift-message" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancel-gift-btn">Cancel</button>
                <button class="btn" id="submit-gift-btn">Send Gift</button>
            </div>
        </div>
    </div>

    <div id="admin-transfer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Transfer Admin Rights</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="admin-transfer-form">
                    <div class="form-group">
                        <label for="new-admin-select">Select New Admin</label>
                        <select id="new-admin-select" required>
                            <option value="">Select Member</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transfer-reason">Reason (Optional)</label>
                        <textarea id="transfer-reason" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancel-transfer-btn">Cancel</button>
                <button class="btn" id="confirm-transfer-btn">Transfer Rights</button>
            </div>
        </div>
    </div>

    <div id="merge-groups-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Merge Groups</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="merge-groups-form">
                    <div class="form-group">
                        <label for="merge-group1">First Group</label>
                        <select id="merge-group1" required>
                            <option value="">Select Group</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="merge-group2">Second Group</label>
                        <select id="merge-group2" required>
                            <option value="">Select Group</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="merge-reason">Reason for Merge (Optional)</label>
                        <textarea id="merge-reason" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancel-merge-btn">Cancel</button>
                <button class="btn" id="request-merge-btn">Request Merge</button>
            </div>
        </div>
    </div>

    <div id="vote-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Vote</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="vote-question"></div>
                <div class="form-group mt-3">
                    <label for="vote-comment">Comment (Optional)</label>
                    <textarea id="vote-comment" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="vote-no-btn">No</button>
                <button class="btn btn-success" id="vote-yes-btn">Yes</button>
            </div>
        </div>
    </div>

    <div id="create-ad-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Advertisement</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-ad-form">
                    <div class="form-group">
                        <label for="ad-location">Target Location</label>
                        <select id="ad-location" required>
                            <option value="all">All Locations</option>
                            <!-- More options would be added dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ad-title">Title</label>
                        <input type="text" id="ad-title" required>
                    </div>
                    <div class="form-group">
                        <label for="ad-content">Content</label>
                        <textarea id="ad-content" rows="5" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="ad-image">Image</label>
                        <input type="file" id="ad-image" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label for="ad-duration">Duration (days)</label>
                        <input type="number" id="ad-duration" min="1" value="7" required>
                    </div>
                    <div class="alert alert-info">
                        <p>Cost: <span id="ad-cost">0</span> UGX</p>
                    </div>
                    <div class="form-group">
                        <label for="ad-payment-method">Payment Method</label>
                        <select id="ad-payment-method" required>
                            <option value="">Select Method</option>
                            <option value="mobile_money">Mobile Money</option>
                            <option value="bank">Bank Transfer</option>
                        </select>
                    </div>
                    <div class="form-group" id="ad-proof-container" style="display: none;">
                        <label for="ad-proof">Proof of Payment</label>
                        <input type="file" id="ad-proof">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancel-ad-btn">Cancel</button>
                <button class="btn" id="submit-ad-btn">Submit Advertisement</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsencrypt@3.3.2/bin/jsencrypt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script>
        // Initialize DateTime
        const DateTime = luxon.DateTime;
        
        // Application state
        const state = {
            currentUser: null,
            currentGroup: null,
            isAdmin: false,
            isSuperAdmin: false,
            blockchain: [],
            peers: [],
            torrent: null,
            peer: null,
            db: null,
            torrentClient: new WebTorrent(),
            peerConnections: {},
            messageQueue: [],
            pendingTransactions: [],
            consensusReached: false
        };
        
        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('KiiraSaveDB', 1);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create object stores
                    if (!db.objectStoreNames.contains('users')) {
                        const usersStore = db.createObjectStore('users', { keyPath: 'id' });
                        usersStore.createIndex('email', 'email', { unique: true });
                        usersStore.createIndex('phone', 'phone', { unique: true });
                    }
                    
                    if (!db.objectStoreNames.contains('groups')) {
                        const groupsStore = db.createObjectStore('groups', { keyPath: 'id' });
                        groupsStore.createIndex('name', 'name', { unique: true });
                    }
                    
                    if (!db.objectStoreNames.contains('transactions')) {
                        const transactionsStore = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        transactionsStore.createIndex('userId', 'userId', { unique: false });
                        transactionsStore.createIndex('groupId', 'groupId', { unique: false });
                        transactionsStore.createIndex('type', 'type', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('messages')) {
                        const messagesStore = db.createObjectStore('messages', { keyPath: 'id', autoIncrement: true });
                        messagesStore.createIndex('senderId', 'senderId', { unique: false });
                        messagesStore.createIndex('recipientId', 'recipientId', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('blockchain')) {
                        db.createObjectStore('blockchain', { keyPath: 'index' });
                    }
                    
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
                
                request.onsuccess = (event) => {
                    state.db = event.target.result;
                    resolve(state.db);
                };
                
                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // Initialize WebTorrent
        function initTorrent() {
            // Generate a unique torrent ID based on user ID or random string
            const torrentId = state.currentUser ? `kiira-save-${state.currentUser.id}` : `kiira-save-${Math.random().toString(36).substr(2, 9)}`;
            
            // Create a new torrent
            state.torrent = state.torrentClient.seed(new Blob([JSON.stringify({})]), {
                name: torrentId,
                announce: ['wss://tracker.openwebtorrent.com']
            }, (torrent) => {
                console.log('Torrent created:', torrent.magnetURI);
                
                // When a peer connects
                torrent.on('wire', (wire, addr) => {
                    console.log('Connected to peer:', addr);
                    
                    wire.on('data', (data) => {
                        handlePeerData(data);
                    });
                    
                    // Send any queued messages
                    if (state.messageQueue.length > 0) {
                        state.messageQueue.forEach(message => {
                            wire.send(JSON.stringify(message));
                        });
                        state.messageQueue = [];
                    }
                });
            });
            
            // Join the swarm
            state.torrentClient.add(`magnet:?xt=urn:btih:${torrentId}&dn=kiira-save`, (torrent) => {
                console.log('Joined swarm:', torrent.magnetURI);
            });
        }
        
        // Initialize PeerJS
        function initPeerJS() {
            // Generate a unique peer ID based on user ID or random string
            const peerId = state.currentUser ? `kiira-save-${state.currentUser.id}` : `kiira-save-${Math.random().toString(36).substr(2, 9)}`;
            
            state.peer = new Peer(peerId);
            
            state.peer.on('open', (id) => {
                console.log('PeerJS connected with ID:', id);
            });
            
            state.peer.on('connection', (conn) => {
                console.log('Peer connected:', conn.peer);
                
                conn.on('data', (data) => {
                    handlePeerData(data);
                });
                
                state.peerConnections[conn.peer] = conn;
            });
            
            state.peer.on('error', (err) => {
                console.error('PeerJS error:', err);
            });
        }
        
        // Handle incoming peer data
        function handlePeerData(data) {
            try {
                const message = JSON.parse(data);
                
                switch (message.type) {
                    case 'block':
                        handleNewBlock(message.data);
                        break;
                    case 'transaction':
                        handleNewTransaction(message.data);
                        break;
                    case 'consensus':
                        handleConsensus(message.data);
                        break;
                    case 'message':
                        handleNewMessage(message.data);
                        break;
                    default:
                        console.log('Unknown message type:', message.type);
                }
            } catch (err) {
                console.error('Error handling peer data:', err);
            }
        }
        
        // Send data to all peers
        function broadcastData(type, data) {
            const message = { type, data };
            
            // Send via WebTorrent
            if (state.torrent && state.torrent.wires.length > 0) {
                state.torrent.wires.forEach(wire => {
                    wire.send(JSON.stringify(message));
                });
            } else {
                state.messageQueue.push(message);
            }
            
            // Send via PeerJS
            Object.values(state.peerConnections).forEach(conn => {
                conn.send(JSON.stringify(message));
            });
        }
        
        // Cryptographic functions
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        async function generateKeyPair() {
            return await crypto.subtle.generateKey(
                {
                    name: "RSA-OAEP",
                    modulusLength: 2048,
                    publicExponent: new Uint8Array([1, 0, 1]),
                    hash: "SHA-256"
                },
                true,
                ["encrypt", "decrypt"]
            );
        }
        
        async function encryptData(data, publicKey) {
            const encoder = new TextEncoder();
            const encodedData = encoder.encode(JSON.stringify(data));
            return await crypto.subtle.encrypt(
                { name: "RSA-OAEP" },
                publicKey,
                encodedData
            );
        }
        
        async function decryptData(encryptedData, privateKey) {
            const decryptedData = await crypto.subtle.decrypt(
                { name: "RSA-OAEP" },
                privateKey,
                encryptedData
            );
            const decoder = new TextDecoder();
            return JSON.parse(decoder.decode(decryptedData));
        }
        
        // Blockchain functions
        function createGenesisBlock() {
            return {
                index: 0,
                timestamp: DateTime.now().toISO(),
                data: {
                    type: 'genesis',
                    message: 'Kiira Save Genesis Block'
                },
                previousHash: '0',
                hash: calculateHash(0, '0', DateTime.now().toISO(), { type: 'genesis', message: 'Kiira Save Genesis Block' })
            };
        }
        
        function calculateHash(index, previousHash, timestamp, data) {
            const str = `${index}${previousHash}${timestamp}${JSON.stringify(data)}`;
            let hash = 0;
            
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0; // Convert to 32bit integer
            }
            
            return hash.toString();
        }
        
        function generateNextBlock(blockData) {
            const previousBlock = getLatestBlock();
            const nextIndex = previousBlock.index + 1;
            const nextTimestamp = DateTime.now().toISO();
            const nextHash = calculateHash(nextIndex, previousBlock.hash, nextTimestamp, blockData);
            
            return {
                index: nextIndex,
                timestamp: nextTimestamp,
                data: blockData,
                previousHash: previousBlock.hash,
                hash: nextHash
            };
        }
        
        function getLatestBlock() {
            return state.blockchain[state.blockchain.length - 1];
        }
        
        function isValidNewBlock(newBlock, previousBlock) {
            if (previousBlock.index + 1 !== newBlock.index) {
                console.log('Invalid index');
                return false;
            } else if (previousBlock.hash !== newBlock.previousHash) {
                console.log('Invalid previous hash');
                return false;
            } else if (calculateHash(newBlock.index, newBlock.previousHash, newBlock.timestamp, newBlock.data) !== newBlock.hash) {
                console.log('Invalid hash');
                return false;
            }
            return true;
        }
        
        function isValidChain(blockchain) {
            if (JSON.stringify(blockchain[0]) !== JSON.stringify(createGenesisBlock())) {
                return false;
            }
            
            for (let i = 1; i < blockchain.length; i++) {
                if (!isValidNewBlock(blockchain[i], blockchain[i - 1])) {
                    return false;
                }
            }
            
            return true;
        }
        
        function replaceChain(newBlocks) {
            if (isValidChain(newBlocks) && newBlocks.length > state.blockchain.length) {
                console.log('Received blockchain is valid. Replacing current blockchain with received blockchain');
                state.blockchain = newBlocks;
                broadcastData('consensus', { blockchain: state.blockchain });
                return true;
            } else {
                console.log('Received blockchain is invalid');
                return false;
            }
        }
        
        function handleNewBlock(newBlock) {
            const latestBlock = getLatestBlock();
            
            if (isValidNewBlock(newBlock, latestBlock)) {
                state.blockchain.push(newBlock);
                broadcastData('consensus', { blockchain: state.blockchain });
            } else {
                console.log('Received invalid block:', newBlock);
            }
        }
        
        function handleNewTransaction(transaction) {
            // Verify transaction
            if (verifyTransaction(transaction)) {
                state.pendingTransactions.push(transaction);
                
                // If we have enough transactions, create a new block
                if (state.pendingTransactions.length >= 5) {
                    mineNewBlock();
                }
            } else {
                console.log('Invalid transaction:', transaction);
            }
        }
        
        function handleConsensus(data) {
            if (data.blockchain) {
                replaceChain(data.blockchain);
            }
        }
        
        function verifyTransaction(transaction) {
            // Basic validation
            if (!transaction.type || !transaction.sender || !transaction.amount || !transaction.timestamp) {
                return false;
            }
            
            // Additional validation based on transaction type
            switch (transaction.type) {
                case 'saving':
                    return transaction.amount > 0;
                case 'loan':
                    return transaction.amount > 0 && transaction.interestRate >= 0;
                case 'share':
                    return transaction.amount > 0 && transaction.price >= 0;
                default:
                    return true;
            }
        }
        
        function mineNewBlock() {
            if (state.pendingTransactions.length === 0) {
                return;
            }
            
            const blockData = {
                type: 'transactions',
                transactions: state.pendingTransactions
            };
            
            const newBlock = generateNextBlock(blockData);
            state.blockchain.push(newBlock);
            state.pendingTransactions = [];
            
            // Broadcast the new block
            broadcastData('block', newBlock);
            
            // Save to IndexedDB
            saveBlockchain();
        }
        
        // Save blockchain to IndexedDB
        function saveBlockchain() {
            if (!state.db) return;
            
            const transaction = state.db.transaction(['blockchain'], 'readwrite');
            const store = transaction.objectStore('blockchain');
            
            state.blockchain.forEach(block => {
                store.put(block);
            });
        }
        
        // Load blockchain from IndexedDB
        function loadBlockchain() {
            return new Promise((resolve, reject) => {
                if (!state.db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = state.db.transaction(['blockchain'], 'readonly');
                const store = transaction.objectStore('blockchain');
                const request = store.getAll();
                
                request.onsuccess = (event) => {
                    const blocks = event.target.result;
                    if (blocks.length > 0) {
                        // Sort blocks by index
                        blocks.sort((a, b) => a.index - b.index);
                        state.blockchain = blocks;
                    } else {
                        // Create genesis block if no blocks exist
                        state.blockchain = [createGenesisBlock()];
                        saveBlockchain();
                    }
                    resolve(state.blockchain);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }
        
        // User authentication functions
        async function signUp(userData) {
            try {
                // Check if passwords match
                if (userData.password !== userData.confirmPassword) {
                    throw new Error('Passwords do not match');
                }
                
                // Hash password
                const hashedPassword = await hashPassword(userData.password);
                
                // Generate key pair
                const keyPair = await generateKeyPair();
                
                // Export keys
                const publicKey = await crypto.subtle.exportKey('jwk', keyPair.publicKey);
                const privateKey = await crypto.subtle.exportKey('jwk', keyPair.privateKey);
                
                // Create user object
                const user = {
                    id: generateId(),
                    name: userData.name,
                    email: userData.email,
                    phone: userData.phone,
                    location: userData.location,
                    nextOfKin: userData.nextOfKin,
                    nextOfKinPhone: userData.nextOfKinPhone,
                    passwordHash: hashedPassword,
                    publicKey,
                    privateKey,
                    createdAt: DateTime.now().toISO(),
                    updatedAt: DateTime.now().toISO()
                };
                
                // Check if group exists or create new one
                let group;
                if (userData.groupId) {
                    group = await getGroup(userData.groupId);
                    if (!group) {
                        throw new Error('Group not found');
                    }
                } else if (userData.groupName) {
                    // Create new group
                    group = {
                        id: generateId(),
                        name: userData.groupName,
                        adminId: user.id,
                        members: [user.id],
                        settings: {
                            savingFrequency: 'monthly',
                            savingAmount: 0,
                            savingDay: 1,
                            compulsorySaving: false,
                            enableLoans: false,
                            enableShares: false,
                            loanInterestRate: 10,
                            currency: 'UGX',
                            createdAt: DateTime.now().toISO()
                        },
                        createdAt: DateTime.now().toISO(),
                        updatedAt: DateTime.now().toISO()
                    };
                    
                    await saveGroup(group);
                    
                    // Set user as admin
                    user.roles = ['admin'];
                }
                
                // Save user
                await saveUser(user);
                
                // Add user to group if not the creator
                if (userData.groupId) {
                    group.members.push(user.id);
                    await saveGroup(group);
                }
                
                // Set current user and group
                state.currentUser = user;
                state.currentGroup = group;
                state.isAdmin = user.roles && user.roles.includes('admin');
                state.isSuperAdmin = user.roles && user.roles.includes('superadmin');
                
                // Initialize blockchain and peer connections
                await loadBlockchain();
                initTorrent();
                initPeerJS();
                
                // Update UI
                updateUI();
                
                return user;
            } catch (err) {
                console.error('Sign up error:', err);
                throw err;
            }
        }
        
        async function signIn(emailOrPhone, password) {
            try {
                // Find user by email or phone
                const user = await getUserByEmailOrPhone(emailOrPhone);
                if (!user) {
                    throw new Error('User not found');
                }
                
                // Verify password
                const hashedPassword = await hashPassword(password);
                if (user.passwordHash !== hashedPassword) {
                    throw new Error('Invalid password');
                }
                
                // Import keys
                const publicKey = await crypto.subtle.importKey(
                    'jwk',
                    user.publicKey,
                    { name: 'RSA-OAEP', hash: 'SHA-256' },
                    true,
                    ['encrypt']
                );
                
                const privateKey = await crypto.subtle.importKey(
                    'jwk',
                    user.privateKey,
                    { name: 'RSA-OAEP', hash: 'SHA-256' },
                    true,
                    ['decrypt']
                );
                
                // Set current user
                state.currentUser = {
                    ...user,
                    publicKey,
                    privateKey
                };
                
                // Get user's group
                const groups = await getUserGroups(user.id);
                state.currentGroup = groups[0]; // For simplicity, using the first group
                state.isAdmin = user.roles && user.roles.includes('admin');
                state.isSuperAdmin = user.roles && user.roles.includes('superadmin');
                
                // Initialize blockchain and peer connections
                await loadBlockchain();
                initTorrent();
                initPeerJS();
                
                // Update UI
                updateUI();
                
                return user;
            } catch (err) {
                console.error('Sign in error:', err);
                throw err;
            }
        }
        
        function logout() {
            state.currentUser = null;
            state.currentGroup = null;
            state.isAdmin = false;
            state.isSuperAdmin = false;
            
            // Close peer connections
            if (state.torrent) {
                state.torrentClient.remove(state.torrent);
                state.torrent = null;
            }
            
            if (state.peer) {
                state.peer.destroy();
                state.peer = null;
            }
            
            // Update UI
            updateUI();
        }
        
        // Database functions
        function saveUser(user) {
            return new Promise((resolve, reject) => {
                if (!state.db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = state.db.transaction(['users'], 'readwrite');
                const store = transaction.objectStore('users');
                const request = store.put(user);
                
                request.onsuccess = () => resolve(user);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function getUser(id) {
            return new Promise((resolve, reject) => {
                if (!state.db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = state.db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                const request = store.get(id);
                
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function getUserByEmailOrPhone(emailOrPhone) {
            return new Promise((resolve, reject) => {
                if (!state.db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = state.db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                
                // Try email first
                const emailIndex = store.index('email');
                const emailRequest = emailIndex.get(emailOrPhone);
                
                emailRequest.onsuccess = (event) => {
                    if (event.target.result) {
                        resolve(event.target.result);
                    } else {
                        // Try phone if email not found
                        const phoneIndex = store.index('phone');
                        const phoneRequest = phoneIndex.get(emailOrPhone);
                        
                        phoneRequest.onsuccess = (event) => resolve(event.target.result);
                        phoneRequest.onerror = (event) => reject(event.target.error);
                    }
                };
                
                emailRequest.onerror = (event) => reject(event.target.error);
            });
        }
        
        function saveGroup(group) {
            return new Promise((resolve, reject) => {
                if (!state.db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = state.db.transaction(['groups'], 'readwrite');
                const store = transaction.objectStore('groups');
                const request = store.put(group);
                
                request.onsuccess = () => resolve(group);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function getGroup(id) {
            return new Promise((resolve, reject) => {
                if (!state.db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = state.db.transaction(['groups'], 'readonly');
                const store = transaction.objectStore('groups');
                const request = store.get(id);
                
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function getUserGroups(userId) {
            return new Promise((resolve, reject) => {
                if (!state.db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = state.db.transaction(['groups'], 'readonly');
                const store = transaction.objectStore('groups');
                const request = store.getAll();
                
                request.onsuccess = (event) => {
                    const allGroups = event.target.result;
                    const userGroups = allGroups.filter(group => group.members.includes(userId));
                    resolve(userGroups);
                };
                
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function saveTransaction(transaction) {
            return new Promise((resolve, reject) => {
                if (!state.db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transactionObj = state.db.transaction(['transactions'], 'readwrite');
                const store = transactionObj.objectStore('transactions');
                const request = store.add(transaction);
                
                request.onsuccess = () => resolve(transaction);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function getTransactionsByUser(userId) {
            return new Promise((resolve, reject) => {
                if (!state.db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = state.db.transaction(['transactions'], 'readonly');
                const store = transaction.objectStore('transactions');
                const index = store.index('userId');
                const request = index.getAll(userId);
                
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function getTransactionsByGroup(groupId) {
            return new Promise((resolve, reject) => {
                if (!state.db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = state.db.transaction(['transactions'], 'readonly');
                const store = transaction.objectStore('transactions');
                const index = store.index('groupId');
                const request = index.getAll(groupId);
                
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function saveMessage(message) {
            return new Promise((resolve, reject) => {
                if (!state.db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = state.db.transaction(['messages'], 'readwrite');
                const store = transaction.objectStore('messages');
                const request = store.add(message);
                
                request.onsuccess = () => resolve(message);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function getMessagesByUser(userId) {
            return new Promise((resolve, reject) => {
                if (!state.db) {
                    reject('Database not initialized');
                    return;
                }
                
                const transaction = state.db.transaction(['messages'], 'readonly');
                const store = transaction.objectStore('messages');
                const sentIndex = store.index('senderId');
                const receivedIndex = store.index('recipientId');
                
                const sentRequest = sentIndex.getAll(userId);
                const receivedRequest = receivedIndex.getAll(userId);
                
                Promise.all([
                    new Promise(res => {
                        sentRequest.onsuccess = (event) => res(event.target.result);
                        sentRequest.onerror = (event) => reject(event.target.error);
                    }),
                    new Promise(res => {
                        receivedRequest.onsuccess = (event) => res(event.target.result);
                        receivedRequest.onerror = (event) => reject(event.target.error);
                    })
                ]).then(([sent, received]) => {
                    resolve({ sent, received });
                });
            });
        }
        
        // Helper functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function formatCurrency(amount, currency = 'UGX') {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency,
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        function formatDate(dateString) {
            return DateTime.fromISO(dateString).toLocaleString(DateTime.DATETIME_MED);
        }
        
        function showAlert(elementId, message, type = 'danger') {
            const alertElement = document.getElementById(elementId);
            alertElement.textContent = message;
            alertElement.className = `alert alert-${type}`;
            alertElement.classList.remove('hidden');
            
            setTimeout(() => {
                alertElement.classList.add('hidden');
            }, 5000);
        }
        
        function toggleModal(modalId, show = true) {
            const modal = document.getElementById(modalId);
            if (show) {
                modal.classList.add('active');
            } else {
                modal.classList.remove('active');
            }
        }
        
        // UI Update functions
        function updateUI() {
            if (state.currentUser) {
                // Show dashboard
                document.getElementById('auth-views').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                
                // Update user info
                document.getElementById('user-name').textContent = state.currentUser.name;
                document.getElementById('user-role').textContent = state.isSuperAdmin ? 'Super Admin' : state.isAdmin ? 'Group Admin' : 'Group Member';
                
                // Show/hide admin elements
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.classList.toggle('hidden', !state.isAdmin);
                });
                
                document.querySelectorAll('.super-admin-only').forEach(el => {
                    el.classList.toggle('hidden', !state.isSuperAdmin);
                });
                
                // Load dashboard data
                loadDashboardData();
            } else {
                // Show auth views
                document.getElementById('auth-views').classList.remove('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
                
                // Show sign in view by default
                document.getElementById('signin-view').classList.remove('hidden');
                document.getElementById('signup-view').classList.add('hidden');
            }
        }
        
        async function loadDashboardData() {
            if (!state.currentUser || !state.currentGroup) return;
            
            try {
                // Load group members
                const members = await Promise.all(state.currentGroup.members.map(memberId => getUser(memberId)));
                
                // Calculate total savings
                const transactions = await getTransactionsByGroup(state.currentGroup.id);
                const savings = transactions.filter(t => t.type === 'saving' && t.status === 'confirmed');
                const totalSavings = savings.reduce((sum, t) => sum + t.amount, 0);
                
                // Calculate user savings
                const userSavings = savings
                    .filter(t => t.userId === state.currentUser.id)
                    .reduce((sum, t) => sum + t.amount, 0);
                
                // Calculate savings percentage
                const savingsPercentage = totalSavings > 0 ? Math.round((userSavings / totalSavings) * 100) : 0;
                
                // Update UI
                document.getElementById('total-group-savings').textContent = formatCurrency(totalSavings, state.currentGroup.settings.currency);
                document.getElementById('my-savings').textContent = formatCurrency(userSavings, state.currentGroup.settings.currency);
                document.getElementById('group-members-count').textContent = members.length;
                document.getElementById('savings-progress').style.width = `${savingsPercentage}%`;
                document.getElementById('savings-progress').textContent = `${savingsPercentage}%`;
                
                // Update savings cycle
                const cycleStart = DateTime.fromISO(state.currentGroup.settings.createdAt);
                const now = DateTime.now();
                let cycleText = '';
                
                if (state.currentGroup.settings.savingFrequency === 'daily') {
                    const days = now.diff(cycleStart, 'days').days;
                    cycleText = `Day ${Math.floor(days) + 1}`;
                } else if (state.currentGroup.settings.savingFrequency === 'weekly') {
                    const weeks = now.diff(cycleStart, 'weeks').weeks;
                    cycleText = `Week ${Math.floor(weeks) + 1}`;
                } else if (state.currentGroup.settings.savingFrequency === 'monthly') {
                    const months = now.diff(cycleStart, 'months').months;
                    cycleText = `Month ${Math.floor(months) + 1}`;
                } else if (state.currentGroup.settings.savingFrequency === 'annually') {
                    const years = now.diff(cycleStart, 'years').years;
                    cycleText = `Year ${Math.floor(years) + 1}`;
                }
                
                document.getElementById('savings-cycle').textContent = cycleText;
                
                // Update members list
                const membersList = document.getElementById('members-list');
                membersList.innerHTML = '';
                
                members.forEach(member => {
                    const memberSavings = savings
                        .filter(t => t.userId === member.id)
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const memberPercentage = totalSavings > 0 ? Math.round((memberSavings / totalSavings) * 100) : 0;
                    
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${member.name}</td>
                        <td>${member.phone}</td>
                        <td>${state.currentGroup.settings.showAmounts ? formatCurrency(memberSavings, state.currentGroup.settings.currency) : `${memberPercentage}%`}</td>
                        <td><span class="badge ${member.id === state.currentGroup.adminId ? 'badge-success' : 'badge-info'}">${member.id === state.currentGroup.adminId ? 'Admin' : 'Member'}</span></td>
                        ${state.isAdmin ? `<td>
                            <button class="btn" data-member-id="${member.id}" data-action="view-profile">View</button>
                            ${member.id !== state.currentGroup.adminId ? `<button class="btn" data-member-id="${member.id}" data-action="remove-member">Remove</button>` : ''}
                            ${member.id !== state.currentGroup.adminId && !member.roles?.includes('admin') ? `<button class="btn" data-member-id="${member.id}" data-action="make-admin">Make Admin</button>` : ''}
                        </td>` : '<td></td>'}
                    `;
                    
                    membersList.appendChild(row);
                });
                
                // Update savings list
                const savingsList = document.getElementById('savings-list');
                savingsList.innerHTML = '';
                
                const userTransactions = transactions
                    .filter(t => t.userId === state.currentUser.id && t.type === 'saving')
                    .sort((a, b) => DateTime.fromISO(b.timestamp) - DateTime.fromISO(a.timestamp));
                
                if (userTransactions.length === 0) {
                    savingsList.innerHTML = '<tr><td colspan="4">No savings records found</td></tr>';
                } else {
                    userTransactions.forEach(transaction => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${formatDate(transaction.timestamp)}</td>
                            <td>${formatCurrency(transaction.amount, state.currentGroup.settings.currency)}</td>
                            <td><span class="badge ${transaction.status === 'confirmed' ? 'badge-success' : transaction.status === 'pending' ? 'badge-warning' : 'badge-danger'}">${transaction.status}</span></td>
                            <td>
                                ${transaction.status === 'pending' ? `<button class="btn" data-transaction-id="${transaction.id}" data-action="cancel-saving">Cancel</button>` : ''}
                            </td>
                        `;
                        
                        savingsList.appendChild(row);
                    });
                }
                
                // Update recent activities
                const recentActivities = document.getElementById('recent-activities');
                recentActivities.innerHTML = '';
                
                const groupTransactions = transactions
                    .sort((a, b) => DateTime.fromISO(b.timestamp) - DateTime.fromISO(a.timestamp))
                    .slice(0, 5);
                
                if (groupTransactions.length === 0) {
                    recentActivities.innerHTML = '<p>No recent activities</p>';
                } else {
                    groupTransactions.forEach(transaction => {
                        const activity = document.createElement('div');
                        activity.className = 'activity-item';
                        
                        let activityText = '';
                        const member = members.find(m => m.id === transaction.userId);
                        const memberName = member ? member.name : 'Unknown';
                        
                        switch (transaction.type) {
                            case 'saving':
                                activityText = `${memberName} saved ${formatCurrency(transaction.amount, state.currentGroup.settings.currency)}`;
                                break;
                            case 'loan':
                                activityText = `${memberName} ${transaction.status === 'approved' ? 'was approved for' : 'applied for'} a loan of ${formatCurrency(transaction.amount, state.currentGroup.settings.currency)}`;
                                break;
                            case 'share':
                                activityText = `${memberName} ${transaction.status === 'sold' ? 'sold' : 'listed'} shares worth ${formatCurrency(transaction.amount, state.currentGroup.settings.currency)}`;
                                break;
                            default:
                                activityText = `${memberName} performed an action`;
                        }
                        
                        activity.innerHTML = `
                            <p>${activityText} <small>${formatDate(transaction.timestamp)}</small></p>
                        `;
                        
                        recentActivities.appendChild(activity);
                    });
                }
                
                // Update loans list if loans are enabled
                if (state.currentGroup.settings.enableLoans) {
                    document.getElementById('apply-loan-btn').disabled = false;
                    
                    const loansList = document.getElementById('loans-list');
                    loansList.innerHTML = '';
                    
                    const loanTransactions = transactions
                        .filter(t => t.type === 'loan' && t.userId === state.currentUser.id)
                        .sort((a, b) => DateTime.fromISO(b.timestamp) - DateTime.fromISO(a.timestamp));
                    
                    if (loanTransactions.length === 0) {
                        loansList.innerHTML = '<tr><td colspan="6">No loan records found</td></tr>';
                    } else {
                        loanTransactions.forEach(transaction => {
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${formatDate(transaction.timestamp)}</td>
                                <td>${formatCurrency(transaction.amount, state.currentGroup.settings.currency)}</td>
                                <td>${transaction.interestRate}%</td>
                                <td><span class="badge ${transaction.status === 'approved' ? 'badge-success' : transaction.status === 'pending' ? 'badge-warning' : 'badge-danger'}">${transaction.status}</span></td>
                                <td>${transaction.dueDate ? formatDate(transaction.dueDate) : 'N/A'}</td>
                                <td>
                                    ${transaction.status === 'approved' ? `<button class="btn" data-loan-id="${transaction.id}" data-action="repay-loan">Repay</button>` : ''}
                                    ${transaction.status === 'pending' ? `<button class="btn" data-loan-id="${transaction.id}" data-action="cancel-loan">Cancel</button>` : ''}
                                </td>
                            `;
                            
                            loansList.appendChild(row);
                        });
                    }
                }
                
                // Update shares market if enabled
                if (state.currentGroup.settings.enableShares) {
                    const availableSharesList = document.getElementById('available-shares-list');
                    availableSharesList.innerHTML = '';
                    
                    const shareTransactions = transactions
                        .filter(t => t.type === 'share' && t.status === 'listed')
                        .sort((a, b) => DateTime.fromISO(b.timestamp) - DateTime.fromISO(a.timestamp));
                    
                    if (shareTransactions.length === 0) {
                        availableSharesList.innerHTML = '<tr><td colspan="4">No shares available for purchase</td></tr>';
                    } else {
                        shareTransactions.forEach(transaction => {
                            const seller = members.find(m => m.id === transaction.userId);
                            const sellerName = seller ? seller.name : 'Unknown';
                            
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${sellerName}</td>
                                <td>${formatCurrency(transaction.amount, state.currentGroup.settings.currency)}</td>
                                <td>${formatCurrency(transaction.price, state.currentGroup.settings.currency)}</td>
                                <td><button class="btn" data-share-id="${transaction.id}" data-action="buy-shares">Buy</button></td>
                            `;
                            
                            availableSharesList.appendChild(row);
                        });
                    }
                    
                    // Update my shares list
                    const mySharesList = document.getElementById('my-shares-list');
                    mySharesList.innerHTML = '';
                    
                    const purchasedShares = transactions
                        .filter(t => t.type === 'share' && t.status === 'sold' && t.recipientId === state.currentUser.id)
                        .sort((a, b) => DateTime.fromISO(b.timestamp) - DateTime.fromISO(a.timestamp));
                    
                    if (purchasedShares.length === 0) {
                        mySharesList.innerHTML = '<tr><td colspan="4">You haven\'t purchased any shares</td></tr>';
                    } else {
                        purchasedShares.forEach(transaction => {
                            const seller = members.find(m => m.id === transaction.userId);
                            const sellerName = seller ? seller.name : 'Unknown';
                            
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${formatDate(transaction.timestamp)}</td>
                                <td>${formatCurrency(transaction.amount, state.currentGroup.settings.currency)}</td>
                                <td>${formatCurrency(transaction.price, state.currentGroup.settings.currency)}</td>
                                <td>${sellerName}</td>
                            `;
                            
                            mySharesList.appendChild(row);
                        });
                    }
                }
                
                // Update admin panel if admin
                if (state.isAdmin) {
                    // Pending savings
                    const pendingSavingsList = document.getElementById('pending-savings-list');
                    pendingSavingsList.innerHTML = '';
                    
                    const pendingSavings = transactions
                        .filter(t => t.type === 'saving' && t.status === 'pending')
                        .sort((a, b) => DateTime.fromISO(a.timestamp) - DateTime.fromISO(b.timestamp));
                    
                    if (pendingSavings.length === 0) {
                        pendingSavingsList.innerHTML = '<tr><td colspan="4">No pending savings</td></tr>';
                    } else {
                        pendingSavings.forEach(transaction => {
                            const member = members.find(m => m.id === transaction.userId);
                            const memberName = member ? member.name : 'Unknown';
                            
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${memberName}</td>
                                <td>${formatCurrency(transaction.amount, state.currentGroup.settings.currency)}</td>
                                <td>${formatDate(transaction.timestamp)}</td>
                                <td>
                                    <button class="btn" data-transaction-id="${transaction.id}" data-action="approve-saving">Approve</button>
                                    <button class="btn" data-transaction-id="${transaction.id}" data-action="reject-saving">Reject</button>
                                </td>
                            `;
                            
                            pendingSavingsList.appendChild(row);
                        });
                    }
                    
                    // Pending members
                    const pendingMembersList = document.getElementById('pending-members-list');
                    pendingMembersList.innerHTML = '';
                    
                    // In a real app, we would have a way to track pending members
                    // For now, we'll just show an empty state
                    pendingMembersList.innerHTML = '<tr><td colspan="4">No pending members</td></tr>';
                }
                
                // Update super admin panel if super admin
                if (state.isSuperAdmin) {
                    const allGroupsList = document.getElementById('all-groups-list');
                    allGroupsList.innerHTML = '';
                    
                    // In a real app, we would fetch all groups
                    // For now, we'll just show the current group
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${state.currentGroup.name}</td>
                        <td>${state.currentUser.name}</td>
                        <td>${state.currentGroup.members.length}</td>
                        <td>${formatCurrency(totalSavings, state.currentGroup.settings.currency)}</td>
                        <td><span class="badge badge-success">Active</span></td>
                        <td>
                            <button class="btn" data-group-id="${state.currentGroup.id}" data-action="view-group">View</button>
                        </td>
                    `;
                    
                    allGroupsList.appendChild(row);
                }
                
            } catch (err) {
                console.error('Error loading dashboard data:', err);
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize database
            await initDB();
            
            // Check if user is already logged in (in a real app, we would have proper session management)
            const lastUser = localStorage.getItem('lastUser');
            if (lastUser) {
                try {
                    await signIn(lastUser, '');
                    // In a real app, we wouldn't do this - we would require password again
                    // This is just for demo purposes
                } catch (err) {
                    console.log('Auto login failed:', err);
                    localStorage.removeItem('lastUser');
                }
            }
            
            // Auth view toggle
            document.getElementById('show-signup').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('signin-view').classList.add('hidden');
                document.getElementById('signup-view').classList.remove('hidden');
            });
            
            document.getElementById('show-signin').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('signup-view').classList.add('hidden');
                document.getElementById('signin-view').classList.remove('hidden');
            });
            
            // Sign in form
            document.getElementById('signin-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const emailOrPhone = document.getElementById('signin-email').value;
                const password = document.getElementById('signin-password').value;
                
                try {
                    await signIn(emailOrPhone, password);
                    localStorage.setItem('lastUser', emailOrPhone);
                } catch (err) {
                    showAlert('signin-alert', err.message);
                }
            });
            
            // Sign up form
            document.getElementById('signup-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const userData = {
                    name: document.getElementById('signup-name').value,
                    email: document.getElementById('signup-email').value,
                    phone: document.getElementById('signup-phone').value,
                    location: document.getElementById('signup-location').value,
                    nextOfKin: document.getElementById('signup-next-of-kin').value,
                    nextOfKinPhone: document.getElementById('signup-next-of-kin-phone').value,
                    groupId: null,
                    groupName: null,
                    password: document.getElementById('signup-password').value,
                    confirmPassword: document.getElementById('signup-confirm-password').value
                };
                
                const groupInput = document.getElementById('signup-group').value;
                if (groupInput) {
                    // Check if input is likely an ID (for simplicity, we assume any input is a group name)
                    userData.groupName = groupInput;
                } else {
                    // Create new group
                    userData.groupName = `${userData.name}'s Group`;
                }
                
                try {
                    await signUp(userData);
                    localStorage.setItem('lastUser', userData.email);
                } catch (err) {
                    showAlert('signup-alert', err.message);
                }
            });
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });
            
            // Dashboard navigation
            document.querySelectorAll('.sidebar-nav a[data-view]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    document.querySelectorAll('.sidebar-nav a').forEach(el => {
                        el.classList.remove('active');
                    });
                    
                    // Add active class to clicked link
                    link.classList.add('active');
                    
                    // Hide all tab contents
                    document.querySelectorAll('.tab-content').forEach(el => {
                        el.classList.remove('active');
                    });
                    
                    // Show selected tab content
                    const viewId = `${link.getAttribute('data-view')}-view`;
                    document.getElementById(viewId).classList.add('active');
                });
            });
            
            // Tab navigation
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabContainer = tab.closest('.tabs');
                    const tabContentId = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs in this container
                    tabContainer.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Hide all tab contents in this container
                    tabContainer.parentElement.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show selected tab content
                    document.getElementById(tabContentId).classList.add('active');
                });
            });
            
            // Add saving
            document.getElementById('add-saving-btn').addEventListener('click', () => {
                toggleModal('add-saving-modal');
            });
            
            document.getElementById('cancel-saving-btn').addEventListener('click', () => {
                toggleModal('add-saving-modal', false);
            });
            
            document.getElementById('submit-saving-btn').addEventListener('click', async () => {
                const amount = parseFloat(document.getElementById('saving-amount-input').value);
                const date = document.getElementById('saving-date').value;
                
                if (!amount || amount <= 0 || !date) {
                    alert('Please enter valid amount and date');
                    return;
                }
                
                try {
                    const transaction = {
                        id: generateId(),
                        type: 'saving',
                        userId: state.currentUser.id,
                        groupId: state.currentGroup.id,
                        amount,
                        timestamp: DateTime.fromISO(date).toISO(),
                        status: 'pending',
                        createdAt: DateTime.now().toISO()
                    };
                    
                    await saveTransaction(transaction);
                    broadcastData('transaction', transaction);
                    
                    toggleModal('add-saving-modal', false);
                    loadDashboardData();
                } catch (err) {
                    console.error('Error adding saving:', err);
                    alert('Failed to add saving');
                }
            });
            
            // Apply for loan
            document.getElementById('apply-loan-btn').addEventListener('click', () => {
                if (!state.currentGroup.settings.enableLoans) {
                    alert('Loans are not enabled in this group');
                    return;
                }
                
                // Calculate max loan amount (for demo, using 50% of savings)
                const maxAmount = state.currentGroup.settings.maxLoanPercentage ? 
                    (state.currentUser.savings * state.currentGroup.settings.maxLoanPercentage / 100) :
                    (state.currentUser.savings * 0.5);
                
                document.getElementById('max-loan-amount').textContent = formatCurrency(maxAmount, state.currentGroup.settings.currency);
                document.getElementById('loan-amount').max = maxAmount;
                document.getElementById('loan-interest-rate').textContent = state.currentGroup.settings.loanInterestRate || 10;
                
                toggleModal('apply-loan-modal');
            });
            
            document.getElementById('cancel-loan-btn').addEventListener('click', () => {
                toggleModal('apply-loan-modal', false);
            });
            
            document.getElementById('submit-loan-btn').addEventListener('click', async () => {
                const amount = parseFloat(document.getElementById('loan-amount').value);
                const purpose = document.getElementById('loan-purpose').value;
                const period = document.getElementById('loan-period').value;
                
                if (!amount || amount <= 0 || !purpose) {
                    alert('Please enter valid amount and purpose');
                    return;
                }
                
                try {
                    // Calculate due date based on period
                    let dueDate;
                    const now = DateTime.now();
                    
                    switch (period) {
                        case '1week':
                            dueDate = now.plus({ weeks: 1 }).toISO();
                            break;
                        case '1month':
                            dueDate = now.plus({ months: 1 }).toISO();
                            break;
                        case '4months':
                            dueDate = now.plus({ months: 4 }).toISO();
                            break;
                        case '6months':
                            dueDate = now.plus({ months: 6 }).toISO();
                            break;
                        case 'cycle-end':
                            // For demo, we'll just add 6 months
                            dueDate = now.plus({ months: 6 }).toISO();
                            break;
                        default:
                            dueDate = now.plus({ months: 1 }).toISO();
                    }
                    
                    const transaction = {
                        id: generateId(),
                        type: 'loan',
                        userId: state.currentUser.id,
                        groupId: state.currentGroup.id,
                        amount,
                        interestRate: state.currentGroup.settings.loanInterestRate || 10,
                        purpose,
                        dueDate,
                        status: 'pending',
                        timestamp: DateTime.now().toISO(),
                        createdAt: DateTime.now().toISO()
                    };
                    
                    await saveTransaction(transaction);
                    broadcastData('transaction', transaction);
                    
                    toggleModal('apply-loan-modal', false);
                    loadDashboardData();
                } catch (err) {
                    console.error('Error applying for loan:', err);
                    alert('Failed to apply for loan');
                }
            });
            
            // Invite member
            document.getElementById('invite-member-btn').addEventListener('click', () => {
                toggleModal('invite-member-modal');
            });
            
            document.getElementById('cancel-invite-btn').addEventListener('click', () => {
                toggleModal('invite-member-modal', false);
            });
            
            document.getElementById('send-invite-btn').addEventListener('click', async () => {
                const email = document.getElementById('invite-email').value;
                const message = document.getElementById('invite-message').value;
                
                if (!email) {
                    alert('Please enter email address');
                    return;
                }
                
                try {
                    // In a real app, we would send an email invitation
                    // For demo, we'll just show a success message
                    alert(`Invitation sent to ${email}`);
                    
                    toggleModal('invite-member-modal', false);
                } catch (err) {
                    console.error('Error sending invitation:', err);
                    alert('Failed to send invitation');
                }
            });
            
            // New message
            document.getElementById('new-message-btn').addEventListener('click', () => {
                // In a real app, we would populate the recipient dropdown
                toggleModal('new-message-modal');
            });
            
            document.getElementById('cancel-message-btn').addEventListener('click', () => {
                toggleModal('new-message-modal', false);
            });
            
            document.getElementById('send-message-btn').addEventListener('click', async () => {
                const recipientId = document.getElementById('message-recipient').value;
                const subject = document.getElementById('message-subject').value;
                const body = document.getElementById('message-body').value;
                
                if (!recipientId || !subject || !body) {
                    alert('Please fill all fields');
                    return;
                }
                
                try {
                    const message = {
                        id: generateId(),
                        senderId: state.currentUser.id,
                        recipientId,
                        subject,
                        body,
                        timestamp: DateTime.now().toISO(),
                        status: 'sent',
                        createdAt: DateTime.now().toISO()
                    };
                    
                    await saveMessage(message);
                    broadcastData('message', message);
                    
                    toggleModal('new-message-modal', false);
                    loadDashboardData();
                } catch (err) {
                    console.error('Error sending message:', err);
                    alert('Failed to send message');
                }
            });
            
            // Profile settings
            document.getElementById('profile-settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                try {
                    state.currentUser.name = document.getElementById('settings-name').value;
                    state.currentUser.email = document.getElementById('settings-email').value;
                    state.currentUser.phone = document.getElementById('settings-phone').value;
                    state.currentUser.location = document.getElementById('settings-location').value;
                    state.currentUser.nextOfKin = document.getElementById('settings-next-of-kin').value;
                    state.currentUser.nextOfKinPhone = document.getElementById('settings-next-of-kin-phone').value;
                    state.currentUser.updatedAt = DateTime.now().toISO();
                    
                    await saveUser(state.currentUser);
                    alert('Profile updated successfully');
                    updateUI();
                } catch (err) {
                    console.error('Error updating profile:', err);
                    alert('Failed to update profile');
                }
            });
            
            // Change password
            document.getElementById('change-password-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmNewPassword = document.getElementById('confirm-new-password').value;
                
                if (newPassword !== confirmNewPassword) {
                    alert('New passwords do not match');
                    return;
                }
                
                try {
                    // Verify current password
                    const currentHash = await hashPassword(currentPassword);
                    if (currentHash !== state.currentUser.passwordHash) {
                        alert('Current password is incorrect');
                        return;
                    }
                    
                    // Update password
                    state.currentUser.passwordHash = await hashPassword(newPassword);
                    state.currentUser.updatedAt = DateTime.now().toISO();
                    
                    await saveUser(state.currentUser);
                    alert('Password changed successfully');
                } catch (err) {
                    console.error('Error changing password:', err);
                    alert('Failed to change password');
                }
            });
            
            // Group settings
            document.getElementById('group-settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                try {
                    state.currentGroup.name = document.getElementById('group-name').value;
                    state.currentGroup.settings.savingFrequency = document.getElementById('saving-frequency').value;
                    state.currentGroup.settings.savingAmount = parseFloat(document.getElementById('saving-amount').value) || 0;
                    state.currentGroup.settings.savingDay = parseInt(document.getElementById('saving-day').value) || 1;
                    state.currentGroup.settings.compulsorySaving = document.getElementById('compulsory-saving').checked;
                    state.currentGroup.settings.enableLoans = document.getElementById('enable-loans').checked;
                    state.currentGroup.settings.enableShares = document.getElementById('enable-shares').checked;
                    
                    if (state.currentGroup.settings.compulsorySaving) {
                        state.currentGroup.settings.fineType = document.getElementById('fine-type').value;
                        state.currentGroup.settings.fineAmount = parseFloat(document.getElementById('fine-amount').value) || 0;
                    }
                    
                    if (state.currentGroup.settings.enableLoans) {
                        state.currentGroup.settings.loanInterestRate = parseFloat(document.getElementById('loan-interest').value) || 10;
                    }
                    
                    state.currentGroup.updatedAt = DateTime.now().toISO();
                    
                    await saveGroup(state.currentGroup);
                    alert('Group settings updated successfully');
                    loadDashboardData();
                } catch (err) {
                    console.error('Error updating group settings:', err);
                    alert('Failed to update group settings');
                }
            });
            
            // System settings
            document.getElementById('system-settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                try {
                    // In a real app, we would save system-wide settings
                    alert('System settings updated successfully');
                } catch (err) {
                    console.error('Error updating system settings:', err);
                    alert('Failed to update system settings');
                }
            });
            
            // Broadcast message
            document.getElementById('broadcast-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const broadcastType = document.getElementById('broadcast-type').value;
                const subject = document.getElementById('broadcast-subject').value;
                const message = document.getElementById('broadcast-message').value;
                const duration = parseInt(document.getElementById('broadcast-duration').value) || 7;
                
                if (!subject || !message) {
                    alert('Please fill all fields');
                    return;
                }
                
                try {
                    // In a real app, we would save and broadcast the message
                    alert('Broadcast message sent successfully');
                    toggleModal('broadcast-modal', false);
                } catch (err) {
                    console.error('Error sending broadcast:', err);
                    alert('Failed to send broadcast');
                }
            });
            
            // Create advertisement
            document.getElementById('create-ad-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const location = document.getElementById('ad-location').value;
                const title = document.getElementById('ad-title').value;
                const content = document.getElementById('ad-content').value;
                const duration = parseInt(document.getElementById('ad-duration').value) || 7;
                
                if (!location || !title || !content) {
                    alert('Please fill all fields');
                    return;
                }
                
                try {
                    // In a real app, we would save the advertisement
                    alert('Advertisement submitted successfully');
                    toggleModal('create-ad-modal', false);
                } catch (err) {
                    console.error('Error creating advertisement:', err);
                    alert('Failed to create advertisement');
                }
            });
            
            // Create backup
            document.getElementById('create-backup-btn').addEventListener('click', async () => {
                try {
                    // In a real app, we would create a backup of the database
                    alert('Backup created successfully');
                } catch (err) {
                    console.error('Error creating backup:', err);
                    alert('Failed to create backup');
                }
            });
            
            // Restore backup
            document.getElementById('restore-btn').addEventListener('click', async () => {
                try {
                    // In a real app, we would restore from backup
                    alert('Backup restored successfully');
                } catch (err) {
                    console.error('Error restoring backup:', err);
                    alert('Failed to restore backup');
                }
            });
            
            // Print history
            document.getElementById('print-history-btn').addEventListener('click', () => {
                window.print();
            });
            
            // Generate report
            document.getElementById('generate-report-btn').addEventListener('click', async () => {
                const reportType = document.getElementById('report-type').value;
                const reportPeriod = document.getElementById('report-period').value;
                
                try {
                    // In a real app, we would generate the requested report
                    document.getElementById('report-results').innerHTML = `
                        <div class="alert alert-info">
                            Report generated for ${reportType} (${reportPeriod})
                        </div>
                    `;
                } catch (err) {
                    console.error('Error generating report:', err);
                    alert('Failed to generate report');
                }
            });
            
            // Dynamic event listeners for action buttons
            document.addEventListener('click', async (e) => {
                if (e.target.hasAttribute('data-action')) {
                    const action = e.target.getAttribute('data-action');
                    const transactionId = e.target.getAttribute('data-transaction-id');
                    const memberId = e.target.getAttribute('data-member-id');
                    const loanId = e.target.getAttribute('data-loan-id');
                    const shareId = e.target.getAttribute('data-share-id');
                    const groupId = e.target.getAttribute('data-group-id');
                    
                    try {
                        switch (action) {
                            case 'view-profile':
                                // In a real app, we would show member profile
                                alert('View profile action');
                                break;
                                
                            case 'remove-member':
                                if (confirm('Are you sure you want to remove this member?')) {
                                    // Remove member from group
                                    state.currentGroup.members = state.currentGroup.members.filter(id => id !== memberId);
                                    await saveGroup(state.currentGroup);
                                    loadDashboardData();
                                }
                                break;
                                
                            case 'make-admin':
                                if (confirm('Are you sure you want to make this member an admin?')) {
                                    // Get member and add admin role
                                    const member = await getUser(memberId);
                                    if (!member.roles) member.roles = [];
                                    if (!member.roles.includes('admin')) {
                                        member.roles.push('admin');
                                        await saveUser(member);
                                        loadDashboardData();
                                    }
                                }
                                break;
                                
                            case 'cancel-saving':
                                if (confirm('Are you sure you want to cancel this saving?')) {
                                    // Get transaction and update status
                                    const transaction = await getTransaction(transactionId);
                                    transaction.status = 'cancelled';
                                    await saveTransaction(transaction);
                                    loadDashboardData();
                                }
                                break;
                                
                            case 'approve-saving':
                                if (confirm('Are you sure you want to approve this saving?')) {
                                    // Get transaction and update status
                                    const transaction = await getTransaction(transactionId);
                                    transaction.status = 'confirmed';
                                    await saveTransaction(transaction);
                                    loadDashboardData();
                                }
                                break;
                                
                            case 'reject-saving':
                                if (confirm('Are you sure you want to reject this saving?')) {
                                    // Get transaction and update status
                                    const transaction = await getTransaction(transactionId);
                                    transaction.status = 'rejected';
                                    await saveTransaction(transaction);
                                    loadDashboardData();
                                }
                                break;
                                
                            case 'repay-loan':
                                // In a real app, we would handle loan repayment
                                alert('Repay loan action');
                                break;
                                
                            case 'cancel-loan':
                                if (confirm('Are you sure you want to cancel this loan application?')) {
                                    // Get transaction and update status
                                    const transaction = await getTransaction(loanId);
                                    transaction.status = 'cancelled';
                                    await saveTransaction(transaction);
                                    loadDashboardData();
                                }
                                break;
                                
                            case 'buy-shares':
                                // In a real app, we would handle share purchase
                                alert('Buy shares action');
                                break;
                                
                            case 'view-group':
                                // In a real app, we would show group details
                                alert('View group action');
                                break;
                                
                            default:
                                console.log('Unknown action:', action);
                        }
                    } catch (err) {
                        console.error('Error handling action:', err);
                        alert('Failed to perform action');
                    }
                }
            });
            
            // Initialize profile form with current user data
            if (state.currentUser) {
                document.getElementById('settings-name').value = state.currentUser.name;
                document.getElementById('settings-email').value = state.currentUser.email;
                document.getElementById('settings-phone').value = state.currentUser.phone;
                document.getElementById('settings-location').value = state.currentUser.location;
                document.getElementById('settings-next-of-kin').value = state.currentUser.nextOfKin;
                document.getElementById('settings-next-of-kin-phone').value = state.currentUser.nextOfKinPhone;
            }
            
            // Initialize group settings form if admin
            if (state.isAdmin && state.currentGroup) {
                document.getElementById('group-name').value = state.currentGroup.name;
                document.getElementById('saving-frequency').value = state.currentGroup.settings.savingFrequency;
                document.getElementById('saving-amount').value = state.currentGroup.settings.savingAmount;
                document.getElementById('saving-day').value = state.currentGroup.settings.savingDay;
                document.getElementById('compulsory-saving').checked = state.currentGroup.settings.compulsorySaving;
                document.getElementById('enable-loans').checked = state.currentGroup.settings.enableLoans;
                document.getElementById('enable-shares').checked = state.currentGroup.settings.enableShares;
                
                if (state.currentGroup.settings.compulsorySaving) {
                    document.getElementById('fine-options-container').style.display = 'block';
                    document.getElementById('fine-type').value = state.currentGroup.settings.fineType;
                    document.getElementById('fine-amount').value = state.currentGroup.settings.fineAmount;
                }
                
                if (state.currentGroup.settings.enableLoans) {
                    document.getElementById('loan-interest-container').style.display = 'block';
                    document.getElementById('loan-interest').value = state.currentGroup.settings.loanInterestRate;
                }
            }
            
            // Toggle fine options based on compulsory saving checkbox
            if (document.getElementById('compulsory-saving')) {
                document.getElementById('compulsory-saving').addEventListener('change', (e) => {
                    document.getElementById('fine-options-container').style.display = e.target.checked ? 'block' : 'none';
                });
            }
            
            // Toggle loan interest based on enable loans checkbox
            if (document.getElementById('enable-loans')) {
                document.getElementById('enable-loans').addEventListener('change', (e) => {
                    document.getElementById('loan-interest-container').style.display = e.target.checked ? 'block' : 'none';
                });
            }
            
            // Toggle specific group container based on broadcast type
            if (document.getElementById('broadcast-type')) {
                document.getElementById('broadcast-type').addEventListener('change', (e) => {
                    document.getElementById('specific-group-container').style.display = 
                        e.target.value === 'specific-group' ? 'block' : 'none';
                });
            }
            
            // Toggle custom range container based on report period
            if (document.getElementById('report-period')) {
                document.getElementById('report-period').addEventListener('change', (e) => {
                    document.getElementById('custom-range-container').style.display = 
                        e.target.value === 'custom' ? 'block' : 'none';
                });
            }
            
            // Toggle share proof container based on payment method
            if (document.getElementById('share-payment-method')) {
                document.getElementById('share-payment-method').addEventListener('change', (e) => {
                    document.getElementById('share-proof-container').style.display = 
                        e.target.value ? 'block' : 'none';
                });
            }
            
            // Toggle ad proof container based on payment method
            if (document.getElementById('ad-payment-method')) {
                document.getElementById('ad-payment-method').addEventListener('change', (e) => {
                    document.getElementById('ad-proof-container').style.display = 
                        e.target.value ? 'block' : 'none';
                });
            }
        });
    </script>
</body>
</html>