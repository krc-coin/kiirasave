<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiira Save - Login</title>
    <!-- IPFS and DAT CDNs -->
    <script src="https://cdn.jsdelivr.net/npm/ipfs-core/dist/index.min.js"></script>
    <script src="https://bundle.run/dat-sdk@7.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p@0.36.4/dist/libp2p.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-webrtc-star@0.24.4/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-bootstrap@0.15.3/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-mdns@0.19.0/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peer-id@0.16.0/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-websockets@0.16.0/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-noise@6.0.0/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-mplex@0.10.5/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/multiaddr@9.0.1/dist/index.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --border-radius: 5px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Auth Pages */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #3498db, #2c3e50);
        }

        .auth-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 400px;
            padding: 30px;
            transition: var(--transition);
        }

        .auth-card h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .btn {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
            width: 100%;
        }

        .btn:hover {
            background: var(--secondary-color);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .text-center {
            text-align: center;
        }

        .mt-3 {
            margin-top: 15px;
        }

        .mb-3 {
            margin-bottom: 15px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Dashboard Layout */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: var(--dark-color);
            color: white;
            padding: 20px 0;
            transition: var(--transition);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h3 {
            color: white;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 10px 20px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            transition: var(--transition);
            cursor: pointer;
            text-decoration: none;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .menu-item i {
            margin-right: 10px;
            font-size: 18px;
        }

        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
            background: #f5f7fa;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        .header h2 {
            color: var(--dark-color);
        }

        .user-profile {
            display: flex;
            align-items: center;
        }

        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .user-profile .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-profile .user-name {
            font-weight: 600;
            color: var(--dark-color);
        }

        .user-profile .user-role {
            font-size: 12px;
            color: #777;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-header h3 {
            color: var(--dark-color);
        }

        .card-body {
            padding: 10px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            text-align: center;
        }

        .stat-card .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .stat-card .stat-label {
            color: #777;
            font-size: 14px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f9f9f9;
            font-weight: 600;
            color: var(--dark-color);
        }

        .table tr:hover {
            background: #f5f5f5;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-primary {
            background: var(--primary-color);
            color: white;
        }

        .badge-success {
            background: var(--success-color);
            color: white;
        }

        .badge-warning {
            background: var(--warning-color);
            color: white;
        }

        .badge-danger {
            background: var(--danger-color);
            color: white;
        }

        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid transparent;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeeba;
            color: #856404;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            color: var(--dark-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--dark-color);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-col {
            flex: 1;
        }

        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #eee;
            margin-bottom: 10px;
            overflow: hidden;
            position: relative;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload-btn {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .avatar-upload-btn input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Broadcast message */
        .broadcast-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            z-index: 1001;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .broadcast-message {
            flex: 1;
            padding: 0 20px;
        }

        .broadcast-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        /* Calendar */
        .calendar {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .calendar th {
            background: var(--primary-color);
            color: white;
            padding: 10px;
            text-align: center;
        }

        .calendar td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar td:hover {
            background: #f5f5f5;
        }

        .calendar .today {
            background: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .calendar .selected {
            background: var(--secondary-color);
            color: white;
        }

        .calendar .other-month {
            color: #aaa;
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 50px;
            margin: 20px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 20px;
            width: 2px;
            background: #ddd;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -40px;
            top: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 3px solid white;
        }

        .timeline-content {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px;
        }

        .timeline-date {
            font-size: 12px;
            color: #777;
            margin-bottom: 5px;
        }

        .timeline-text {
            margin-bottom: 5px;
        }

        .timeline-user {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .timeline-user img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .timeline-user-name {
            font-weight: 600;
            font-size: 14px;
        }

        /* Voting */
        .voting-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .voting-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .voting-option:hover {
            background: #f5f5f5;
        }

        .voting-option.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .voting-results {
            margin-top: 20px;
        }

        .voting-result {
            margin-bottom: 10px;
        }

        .voting-result-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .voting-result-bar {
            height: 10px;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
        }

        .voting-result-progress {
            height: 100%;
            background: var(--primary-color);
            border-radius: 5px;
        }

        /* Advert */
        .advert-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px;
            margin-bottom: 20px;
        }

        .advert-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
        }

        .advert-text {
            margin-bottom: 10px;
        }

        .advert-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #777;
        }

        /* Print styles */
        @media print {
            .sidebar, .header, .no-print {
                display: none !important;
            }

            .main-content {
                margin-left: 0 !important;
                padding: 0 !important;
            }

            .card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }

            .table th {
                background: #f9f9f9 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Container (Login/Signup) -->
    <div id="auth-container" class="auth-container">
        <div id="login-card" class="auth-card">
            <h2>Login to Kiira Save</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">Email or Phone</label>
                    <input type="text" id="login-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" class="form-control" required>
                </div>
                <button type="submit" id="login-btn" class="btn btn-block">
                    <span id="login-btn-text">Login</span>
                </button>
            </form>
            <div class="text-center mt-3">
                <p>Don't have an account? <a href="#" id="show-signup">Sign up</a></p>
            </div>
        </div>

        <div id="signup-card" class="auth-card" style="display: none;">
            <h2>Create Account</h2>
            <form id="signup-form">
                <div class="form-group">
                    <label for="signup-name">Full Name</label>
                    <input type="text" id="signup-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signup-phone">Phone Number</label>
                    <input type="tel" id="signup-phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signup-confirm-password">Confirm Password</label>
                    <input type="password" id="signup-confirm-password" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signup-next-of-kin">Next of Kin Name</label>
                    <input type="text" id="signup-next-of-kin" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signup-next-of-kin-phone">Next of Kin Phone</label>
                    <input type="tel" id="signup-next-of-kin-phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signup-location">Location</label>
                    <input type="text" id="signup-location" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signup-group">Group Name (Leave blank if creating new group)</label>
                    <input type="text" id="signup-group" class="form-control">
                </div>
                <button type="submit" id="signup-btn" class="btn btn-block">
                    <span id="signup-btn-text">Sign Up</span>
                </button>
            </form>
            <div class="text-center mt-3">
                <p>Already have an account? <a href="#" id="show-login">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div id="dashboard-container" class="dashboard" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3 id="group-title">Kiira Save</h3>
                <p id="group-cycle">Cycle: Monthly</p>
            </div>
            <div class="sidebar-menu">
                <a href="#" class="menu-item active" data-section="dashboard">
                    <i>üìä</i> Dashboard
                </a>
                <a href="#" class="menu-item" data-section="savings">
                    <i>üí∞</i> Savings
                </a>
                <a href="#" class="menu-item" data-section="loans">
                    <i>üè¶</i> Loans
                </a>
                <a href="#" class="menu-item" data-section="shares">
                    <i>üìà</i> Shares
                </a>
                <a href="#" class="menu-item" data-section="members">
                    <i>üë•</i> Members
                </a>
                <a href="#" class="menu-item" data-section="timeline">
                    <i>üïí</i> Timeline
                </a>
                <a href="#" class="menu-item" data-section="messages">
                    <i>‚úâÔ∏è</i> Messages
                </a>
                <div id="admin-menu" style="display: none;">
                    <a href="#" class="menu-item" data-section="admin">
                        <i>‚öôÔ∏è</i> Admin
                    </a>
                    <a href="#" class="menu-item" data-section="approvals">
                        <i>‚úÖ</i> Approvals
                    </a>
                    <a href="#" class="menu-item" data-section="reports">
                        <i>üìä</i> Reports
                    </a>
                </div>
                <a href="#" class="menu-item" data-section="profile">
                    <i>üë§</i> Profile
                </a>
                <a href="#" class="menu-item" id="logout-btn">
                    <i>üö™</i> Logout
                </a>
            </div>
            <div class="advert-container" id="sidebar-advert">
                <!-- Adverts will be loaded here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h2 id="section-title">Dashboard</h2>
                <div class="user-profile">
                    <img id="user-avatar" src="https://via.placeholder.com/40" alt="User">
                    <div class="user-info">
                        <span class="user-name" id="username">John Doe</span>
                        <span class="user-role" id="user-role">Member</span>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard-section" class="content-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Your Savings</div>
                        <div class="stat-value" id="user-savings">UGX 0</div>
                        <div class="stat-percentage" id="user-savings-percentage">0% of total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Group Savings</div>
                        <div class="stat-value" id="group-savings">UGX 0</div>
                        <div class="stat-members" id="group-members-count">0 members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Next Saving Date</div>
                        <div class="stat-value" id="next-saving-date">-</div>
                        <div class="stat-remaining" id="days-remaining">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cycle Progress</div>
                        <div class="stat-value" id="cycle-progress">0%</div>
                        <div class="stat-end-date" id="cycle-end-date">-</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Recent Savings</h3>
                        <button class="btn btn-outline" id="add-saving-btn">Add Saving</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="savings-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Savings will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Group Members</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="members-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Savings</th>
                                        <th>Percentage</th>
                                        <th>Last Active</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Members will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Savings Section -->
            <div id="savings-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h3>Your Savings</h3>
                        <button class="btn btn-outline" id="new-saving-btn">New Saving</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="user-savings-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- User savings will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Saving History</h3>
                    </div>
                    <div class="card-body">
                        <div id="savings-history">
                            <!-- Savings history timeline will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loans Section -->
            <div id="loans-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h3>Loan Application</h3>
                        <button class="btn btn-outline" id="apply-loan-btn" disabled>Apply for Loan</button>
                    </div>
                    <div class="card-body">
                        <div id="loan-info">
                            <p>Loan feature is currently disabled by the group admin.</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Your Loans</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="loans-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Interest</th>
                                        <th>Status</th>
                                        <th>Due Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Loans will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Pending Loan Approvals</h3>
                    </div>
                    <div class="card-body">
                        <div id="pending-loans">
                            <!-- Pending loans for approval will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shares Section -->
            <div id="shares-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h3>Your Shares</h3>
                        <button class="btn btn-outline" id="sell-shares-btn">Sell Shares</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="shares-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Shares</th>
                                        <th>Value</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Shares will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Available Shares</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="available-shares-table">
                                <thead>
                                    <tr>
                                        <th>Seller</th>
                                        <th>Shares</th>
                                        <th>Price</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Available shares will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Members Section -->
            <div id="members-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h3>Group Members</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="all-members-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Savings</th>
                                        <th>Percentage</th>
                                        <th>Last Active</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- All members will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline Section -->
            <div id="timeline-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h3>Group Timeline</h3>
                    </div>
                    <div class="card-body">
                        <div id="group-timeline">
                            <!-- Timeline will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Section -->
            <div id="messages-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h3>Messages</h3>
                        <button class="btn btn-outline" id="new-message-btn">New Message</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="messages-table">
                                <thead>
                                    <tr>
                                        <th>From</th>
                                        <th>Message</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Messages will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Section -->
            <div id="admin-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h3>Group Settings</h3>
                    </div>
                    <div class="card-body">
                        <form id="group-settings-form">
                            <div class="form-group">
                                <label for="group-name">Group Name</label>
                                <input type="text" id="group-name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="group-currency">Currency</label>
                                <select id="group-currency" class="form-control" required>
                                    <option value="UGX">UGX - Ugandan Shilling</option>
                                    <option value="KES">KES - Kenyan Shilling</option>
                                    <option value="TZS">TZS - Tanzanian Shilling</option>
                                    <option value="USD">USD - US Dollar</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="saving-frequency">Saving Frequency</label>
                                <select id="saving-frequency" class="form-control" required>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="annually">Annually</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="form-group" id="weekly-day-container" style="display: none;">
                                <label for="weekly-day">Day of Week</label>
                                <select id="weekly-day" class="form-control">
                                    <option value="0">Sunday</option>
                                    <option value="1">Monday</option>
                                    <option value="2">Tuesday</option>
                                    <option value="3">Wednesday</option>
                                    <option value="4">Thursday</option>
                                    <option value="5">Friday</option>
                                    <option value="6">Saturday</option>
                                </select>
                            </div>
                            <div class="form-group" id="monthly-day-container" style="display: none;">
                                <label for="monthly-day">Day of Month</label>
                                <input type="number" id="monthly-day" class="form-control" min="1" max="31" value="1">
                            </div>
                            <div class="form-group">
                                <label for="saving-amount">Default Saving Amount</label>
                                <input type="number" id="saving-amount" class="form-control">
                                <small class="text-muted">Leave empty if members can save any amount</small>
                            </div>
                            <div class="form-group">
                                <label for="compulsory-saving">Compulsory Saving</label>
                                <select id="compulsory-saving" class="form-control">
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cycle-length">Cycle Length</label>
                                <select id="cycle-length" class="form-control">
                                    <option value="1">1 Month</option>
                                    <option value="3">3 Months</option>
                                    <option value="6">6 Months</option>
                                    <option value="12">1 Year</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="loan-interest">Default Loan Interest (%)</label>
                                <input type="number" id="loan-interest" class="form-control" min="0" max="100" value="10">
                            </div>
                            <div class="form-group">
                                <label for="late-penalty">Late Payment Penalty (%)</label>
                                <input type="number" id="late-penalty" class="form-control" min="0" max="100" value="20">
                            </div>
                            <div class="form-group">
                                <label for="max-groups-per-member">Max Groups Per Member</label>
                                <input type="number" id="max-groups-per-member" class="form-control" min="1" value="2">
                            </div>
                            <div class="form-group">
                                <label for="share-price">Share Price</label>
                                <input type="number" id="share-price" class="form-control" min="0" value="1000">
                            </div>
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Admin Tools</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <button class="btn btn-outline" id="enable-loans-btn">Enable Loans</button>
                            <button class="btn btn-outline" id="disable-loans-btn">Disable Loans</button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-outline" id="enable-withdrawals-btn">Enable Withdrawals</button>
                            <button class="btn btn-outline" id="disable-withdrawals-btn">Disable Withdrawals</button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-outline" id="enable-shares-btn">Enable Shares</button>
                            <button class="btn btn-outline" id="disable-shares-btn">Disable Shares</button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-outline" id="start-new-cycle-btn">Start New Cycle</button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-outline" id="transfer-admin-btn">Transfer Admin Role</button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-outline" id="broadcast-message-btn">Broadcast Message</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Approvals Section -->
            <div id="approvals-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h3>Pending Approvals</h3>
                    </div>
                    <div class="card-body">
                        <div id="pending-approvals">
                            <!-- Pending approvals will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h3>Group Reports</h3>
                        <div>
                            <button class="btn btn-outline" id="print-savings-report-btn">Print Savings Report</button>
                            <button class="btn btn-outline" id="print-loans-report-btn">Print Loans Report</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="reports-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Member</th>
                                        <th>Amount</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Reports will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profile-section" class="content-section" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h3>Your Profile</h3>
                    </div>
                    <div class="card-body">
                        <form id="profile-form">
                            <div class="avatar-upload">
                                <div class="avatar-preview">
                                    <img id="profile-avatar" src="https://via.placeholder.com/100" alt="Profile">
                                </div>
                                <div class="avatar-upload-btn">
                                    <button type="button" class="btn btn-outline">Change Avatar</button>
                                    <input type="file" id="avatar-upload" accept="image/*">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="profile-name">Full Name</label>
                                <input type="text" id="profile-name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="profile-email">Email</label>
                                <input type="email" id="profile-email" class="form-control" required readonly>
                            </div>
                            <div class="form-group">
                                <label for="profile-phone">Phone Number</label>
                                <input type="tel" id="profile-phone" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="profile-next-of-kin">Next of Kin Name</label>
                                <input type="text" id="profile-next-of-kin" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="profile-next-of-kin-phone">Next of Kin Phone</label>
                                <input type="tel" id="profile-next-of-kin-phone" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="profile-location">Location</label>
                                <input type="text" id="profile-location" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="profile-password">New Password (Leave blank to keep current)</label>
                                <input type="password" id="profile-password" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="profile-confirm-password">Confirm New Password</label>
                                <input type="password" id="profile-confirm-password" class="form-control">
                            </div>
                            <button type="submit" class="btn btn-primary">Update Profile</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-saving-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Saving</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-saving-form">
                    <div class="form-group">
                        <label for="saving-date">Date</label>
                        <input type="date" id="saving-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="saving-amount-input">Amount</label>
                        <input type="number" id="saving-amount-input" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="saving-proof">Proof of Payment (Optional)</label>
                        <input type="file" id="saving-proof" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="submit-saving-btn">Submit</button>
            </div>
        </div>
    </div>

    <div id="apply-loan-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Apply for Loan</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="apply-loan-form">
                    <div class="form-group">
                        <label for="loan-amount">Amount</label>
                        <input type="number" id="loan-amount" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="loan-purpose">Purpose</label>
                        <textarea id="loan-purpose" class="form-control" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="loan-period">Repayment Period</label>
                        <select id="loan-period" class="form-control" required>
                            <option value="7">1 Week</option>
                            <option value="30">1 Month</option>
                            <option value="90">3 Months</option>
                            <option value="180">6 Months</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Calculations</label>
                        <div id="loan-calculations">
                            <p>Interest: <span id="loan-interest-amount">0</span></p>
                            <p>Total to Pay: <span id="loan-total-amount">0</span></p>
                            <p>Due Date: <span id="loan-due-date">-</span></p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="submit-loan-btn">Apply</button>
            </div>
        </div>
    </div>

    <div id="sell-shares-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Sell Shares</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="sell-shares-form">
                    <div class="form-group">
                        <label for="shares-amount">Number of Shares</label>
                        <input type="number" id="shares-amount" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="shares-price">Price per Share</label>
                        <input type="number" id="shares-price" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="shares-reason">Reason for Selling (Optional)</label>
                        <textarea id="shares-reason" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="submit-shares-btn">Submit</button>
            </div>
        </div>
    </div>

    <div id="buy-shares-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Buy Shares</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="buy-shares-form">
                    <div class="form-group">
                        <label for="buy-shares-amount">Number of Shares</label>
                        <input type="number" id="buy-shares-amount" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="buy-shares-total">Total Amount</label>
                        <input type="number" id="buy-shares-total" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="buy-shares-payment">Payment Method</label>
                        <select id="buy-shares-payment" class="form-control" required>
                            <option value="mobile_money">Mobile Money</option>
                            <option value="cash">Cash</option>
                            <option value="bank">Bank Transfer</option>
                        </select>
                    </div>
                    <div class="form-group" id="mobile-money-details" style="display: none;">
                        <label for="mobile-money-number">Mobile Money Number</label>
                        <input type="tel" id="mobile-money-number" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="submit-buy-shares-btn">Buy Shares</button>
            </div>
        </div>
    </div>

    <div id="new-message-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>New Message</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="new-message-form">
                    <div class="form-group">
                        <label for="message-recipient">Recipient</label>
                        <select id="message-recipient" class="form-control" required>
                            <!-- Recipients will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="message-subject">Subject</label>
                        <input type="text" id="message-subject" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="message-content">Message</label>
                        <textarea id="message-content" class="form-control" rows="5" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="submit-message-btn">Send</button>
            </div>
        </div>
    </div>

    <div id="view-message-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="message-view-subject">Message Subject</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="message-header">
                    <p><strong>From:</strong> <span id="message-view-from"></span></p>
                    <p><strong>Date:</strong> <span id="message-view-date"></span></p>
                </div>
                <div class="message-content" id="message-view-content">
                    <!-- Message content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Close</button>
                <button class="btn btn-primary" id="reply-message-btn">Reply</button>
            </div>
        </div>
    </div>

    <div id="transfer-admin-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Transfer Admin Role</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This action is irreversible. You will lose all admin privileges.
                </div>
                <form id="transfer-admin-form">
                    <div class="form-group">
                        <label for="new-admin-select">Select New Admin</label>
                        <select id="new-admin-select" class="form-control" required>
                            <!-- Members will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transfer-reason">Reason for Transfer (Optional)</label>
                        <textarea id="transfer-reason" class="form-control"></textarea>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="confirm-transfer" required>
                        <label for="confirm-transfer">I confirm that I want to transfer admin privileges</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="submit-transfer-btn">Transfer</button>
            </div>
        </div>
    </div>

    <div id="broadcast-message-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Broadcast Message</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="broadcast-message-form">
                    <div class="form-group">
                        <label for="broadcast-audience">Audience</label>
                        <select id="broadcast-audience" class="form-control" required>
                            <option value="all_members">All Group Members</option>
                            <option value="specific_members">Specific Members</option>
                            <option value="admins_only">Admins Only</option>
                        </select>
                    </div>
                    <div class="form-group" id="specific-members-container" style="display: none;">
                        <label for="broadcast-specific-members">Select Members</label>
                        <select id="broadcast-specific-members" class="form-control" multiple>
                            <!-- Members will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="broadcast-subject">Subject</label>
                        <input type="text" id="broadcast-subject" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="broadcast-content">Message</label>
                        <textarea id="broadcast-content" class="form-control" rows="5" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="broadcast-attachment">Attachment (Optional)</label>
                        <input type="file" id="broadcast-attachment" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="submit-broadcast-btn">Send</button>
            </div>
        </div>
    </div>

    <div id="vote-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="vote-title">Vote</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="vote-description">
                    <!-- Vote description will be loaded here -->
                </div>
                <div class="voting-options" id="vote-options">
                    <!-- Voting options will be loaded here -->
                </div>
                <div class="voting-results" id="vote-results" style="display: none;">
                    <!-- Voting results will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Close</button>
                <button class="btn btn-primary" id="submit-vote-btn" style="display: none;">Vote</button>
            </div>
        </div>
    </div>

    <div id="approval-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="approval-title">Approve Request</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="approval-details">
                    <!-- Approval details will be loaded here -->
                </div>
                <div class="form-group">
                    <label for="approval-comment">Comment (Optional)</label>
                    <textarea id="approval-comment" class="form-control"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-danger" id="reject-approval-btn">Reject</button>
                <button class="btn btn-success" id="approve-approval-btn">Approve</button>
            </div>
        </div>
    </div>

    <div id="gift-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gift Money</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="gift-form">
                    <div class="form-group">
                        <label for="gift-recipient">Recipient</label>
                        <select id="gift-recipient" class="form-control" required>
                            <!-- Recipients will be loaded here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gift-amount">Amount</label>
                        <input type="number" id="gift-amount" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="gift-message">Message (Optional)</label>
                        <textarea id="gift-message" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="submit-gift-btn">Send Gift</button>
            </div>
        </div>
    </div>

    <div id="withdraw-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Withdraw Savings</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="withdraw-form">
                    <div class="form-group">
                        <label for="withdraw-amount">Amount (Available: <span id="available-balance">0</span>)</label>
                        <input type="number" id="withdraw-amount" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="withdraw-method">Withdrawal Method</label>
                        <select id="withdraw-method" class="form-control" required>
                            <option value="mobile_money">Mobile Money</option>
                            <option value="cash">Cash</option>
                            <option value="bank">Bank Transfer</option>
                        </select>
                    </div>
                    <div class="form-group" id="withdraw-mobile-money-details" style="display: none;">
                        <label for="withdraw-mobile-number">Mobile Money Number</label>
                        <input type="tel" id="withdraw-mobile-number" class="form-control">
                    </div>
                    <div class="form-group" id="withdraw-bank-details" style="display: none;">
                        <label for="withdraw-bank-name">Bank Name</label>
                        <input type="text" id="withdraw-bank-name" class="form-control">
                        <label for="withdraw-account-number">Account Number</label>
                        <input type="text" id="withdraw-account-number" class="form-control">
                        <label for="withdraw-account-name">Account Name</label>
                        <input type="text" id="withdraw-account-name" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline modal-close">Cancel</button>
                <button class="btn btn-primary" id="submit-withdraw-btn">Request Withdrawal</button>
            </div>
        </div>
    </div>

    <div id="loading-modal" class="modal">
        <div class="modal-content" style="text-align: center; padding: 40px;">
            <div class="loading" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>
            <h3 id="loading-message">Loading...</h3>
        </div>
    </div>

    <!-- Broadcast Message Display -->
    <div id="broadcast-display" style="display: none;">
        <!-- Broadcast messages will be shown here -->
    </div>

    <script>
        // Global variables
        let ipfs = null;
        let libp2p = null;
        let node = null;
        let db = null;
        let currentUser = null;
        let currentGroup = null;
        let isSuperAdmin = false;
        let isGroupAdmin = false;
        let chain = [];
        let peers = [];
        let peerId = null;
        let networkInitialized = false;
        let databasesInitialized = false;
        let uiInitialized = false;
        let indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize UI first
            initUI();

            // Initialize databases in the background
            initDatabases().then(() => {
                databasesInitialized = true;
                checkAppReady();
            }).catch(err => {
                console.error('Database initialization failed:', err);
                showError('Failed to initialize databases. Please refresh the page.');
            });

            // Initialize network in the background
            initNetwork().then(() => {
                networkInitialized = true;
                checkAppReady();
            }).catch(err => {
                console.error('Network initialization failed:', err);
                showError('Network initialization failed. Some features may not work.');
            });
        });

        function checkAppReady() {
            if (databasesInitialized && networkInitialized && uiInitialized) {
                // Check if user is already logged in
                checkAuthState();
            }
        }

        function initUI() {
            // Auth UI events
            document.getElementById('show-signup').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('login-card').style.display = 'none';
                document.getElementById('signup-card').style.display = 'block';
            });

            document.getElementById('show-login').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('signup-card').style.display = 'none';
                document.getElementById('login-card').style.display = 'block';
            });

            // Login form
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                loginUser();
            });

            // Signup form
            document.getElementById('signup-form').addEventListener('submit', function(e) {
                e.preventDefault();
                signupUser();
            });

            // Logout button
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                logoutUser();
            });

            // Menu navigation
            document.querySelectorAll('.menu-item[data-section]').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    
                    // Update active menu item
                    document.querySelectorAll('.menu-item').forEach(i => {
                        i.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });

            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('active');
                });
            });

            // Saving frequency change
            document.getElementById('saving-frequency').addEventListener('change', function() {
                document.getElementById('weekly-day-container').style.display = 'none';
                document.getElementById('monthly-day-container').style.display = 'none';
                
                if (this.value === 'weekly') {
                    document.getElementById('weekly-day-container').style.display = 'block';
                } else if (this.value === 'monthly') {
                    document.getElementById('monthly-day-container').style.display = 'block';
                }
            });

            // Payment method change
            document.getElementById('buy-shares-payment').addEventListener('change', function() {
                document.getElementById('mobile-money-details').style.display = 'none';
                
                if (this.value === 'mobile_money') {
                    document.getElementById('mobile-money-details').style.display = 'block';
                }
            });

            // Withdrawal method change
            document.getElementById('withdraw-method').addEventListener('change', function() {
                document.getElementById('withdraw-mobile-money-details').style.display = 'none';
                document.getElementById('withdraw-bank-details').style.display = 'none';
                
                if (this.value === 'mobile_money') {
                    document.getElementById('withdraw-mobile-money-details').style.display = 'block';
                } else if (this.value === 'bank') {
                    document.getElementById('withdraw-bank-details').style.display = 'block';
                }
            });

            // Broadcast audience change
            document.getElementById('broadcast-audience').addEventListener('change', function() {
                document.getElementById('specific-members-container').style.display = 'none';
                
                if (this.value === 'specific_members') {
                    document.getElementById('specific-members-container').style.display = 'block';
                }
            });

            // Add saving button
            document.getElementById('add-saving-btn').addEventListener('click', function() {
                showModal('add-saving-modal');
            });

            // Submit saving button
            document.getElementById('submit-saving-btn').addEventListener('click', function() {
                addSaving();
            });

            // Apply loan button
            document.getElementById('apply-loan-btn').addEventListener('click', function() {
                showModal('apply-loan-modal');
            });

            // Loan amount calculation
            document.getElementById('loan-amount').addEventListener('input', calculateLoan);
            document.getElementById('loan-period').addEventListener('change', calculateLoan);

            // Submit loan button
            document.getElementById('submit-loan-btn').addEventListener('click', function() {
                applyForLoan();
            });

            // Sell shares button
            document.getElementById('sell-shares-btn').addEventListener('click', function() {
                showModal('sell-shares-modal');
            });

            // Submit shares button
            document.getElementById('submit-shares-btn').addEventListener('click', function() {
                sellShares();
            });

            // Buy shares amount calculation
            document.getElementById('buy-shares-amount').addEventListener('input', function() {
                const amount = parseFloat(this.value) || 0;
                const price = parseFloat(document.getElementById('shares-price').value) || 0;
                document.getElementById('buy-shares-total').value = (amount * price).toFixed(2);
            });

            // Submit buy shares button
            document.getElementById('submit-buy-shares-btn').addEventListener('click', function() {
                buyShares();
            });

            // New message button
            document.getElementById('new-message-btn').addEventListener('click', function() {
                showModal('new-message-modal');
            });

            // Submit message button
            document.getElementById('submit-message-btn').addEventListener('click', function() {
                sendMessage();
            });

            // Reply message button
            document.getElementById('reply-message-btn').addEventListener('click', function() {
                replyToMessage();
            });

            // Transfer admin button
            document.getElementById('transfer-admin-btn').addEventListener('click', function() {
                showModal('transfer-admin-modal');
            });

            // Submit transfer button
            document.getElementById('submit-transfer-btn').addEventListener('click', function() {
                transferAdminRole();
            });

            // Broadcast message button
            document.getElementById('broadcast-message-btn').addEventListener('click', function() {
                showModal('broadcast-message-modal');
            });

            // Submit broadcast button
            document.getElementById('submit-broadcast-btn').addEventListener('click', function() {
                sendBroadcast();
            });

            // Submit vote button
            document.getElementById('submit-vote-btn').addEventListener('click', function() {
                submitVote();
            });

            // Approve approval button
            document.getElementById('approve-approval-btn').addEventListener('click', function() {
                processApproval(true);
            });

            // Reject approval button
            document.getElementById('reject-approval-btn').addEventListener('click', function() {
                processApproval(false);
            });

            // Submit gift button
            document.getElementById('submit-gift-btn').addEventListener('click', function() {
                sendGift();
            });

            // Submit withdraw button
            document.getElementById('submit-withdraw-btn').addEventListener('click', function() {
                requestWithdrawal();
            });

            // Loan enable/disable buttons
            document.getElementById('enable-loans-btn').addEventListener('click', function() {
                updateGroupSetting('loansEnabled', true);
            });

            document.getElementById('disable-loans-btn').addEventListener('click', function() {
                updateGroupSetting('loansEnabled', false);
            });

            // Withdrawal enable/disable buttons
            document.getElementById('enable-withdrawals-btn').addEventListener('click', function() {
                updateGroupSetting('withdrawalsEnabled', true);
            });

            document.getElementById('disable-withdrawals-btn').addEventListener('click', function() {
                updateGroupSetting('withdrawalsEnabled', false);
            });

            // Shares enable/disable buttons
            document.getElementById('enable-shares-btn').addEventListener('click', function() {
                updateGroupSetting('sharesEnabled', true);
            });

            document.getElementById('disable-shares-btn').addEventListener('click', function() {
                updateGroupSetting('sharesEnabled', false);
            });

            // New cycle button
            document.getElementById('start-new-cycle-btn').addEventListener('click', function() {
                startNewCycle();
            });

            // Print buttons
            document.getElementById('print-savings-report-btn').addEventListener('click', function() {
                printSavingsReport();
            });

            document.getElementById('print-loans-report-btn').addEventListener('click', function() {
                printLoansReport();
            });

            // Profile form
            document.getElementById('profile-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateProfile();
            });

            // Avatar upload
            document.getElementById('avatar-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('profile-avatar').src = event.target.result;
                        document.getElementById('user-avatar').src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Group settings form
            document.getElementById('group-settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveGroupSettings();
            });

            uiInitialized = true;
            checkAppReady();
        });

        async function initDatabases() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('KiiraSaveDB', 1);

                request.onerror = function(event) {
                    console.error('Database error:', event.target.error);
                    reject('Database error');
                };

                request.onupgradeneeded = function(event) {
                    const db = event.target.result;

                    // Create object store for users
                    const userStore = db.createObjectStore('users', { keyPath: 'id' });
                    userStore.createIndex('email', 'email', { unique: true });
                    userStore.createIndex('phone', 'phone', { unique: true });

                    // Create object store for groups
                    const groupStore = db.createObjectStore('groups', { keyPath: 'id' });
                    groupStore.createIndex('name', 'name', { unique: true });

                    // Create object store for group members
                    const memberStore = db.createObjectStore('groupMembers', { keyPath: 'id' });
                    memberStore.createIndex('groupId', 'groupId', { unique: false });
                    memberStore.createIndex('userId', 'userId', { unique: false });

                    // Create object store for savings
                    const savingStore = db.createObjectStore('savings', { keyPath: 'id' });
                    savingStore.createIndex('userId', 'userId', { unique: false });
                    savingStore.createIndex('groupId', 'groupId', { unique: false });
                    savingStore.createIndex('date', 'date', { unique: false });

                    // Create object store for loans
                    const loanStore = db.createObjectStore('loans', { keyPath: 'id' });
                    loanStore.createIndex('userId', 'userId', { unique: false });
                    loanStore.createIndex('groupId', 'groupId', { unique: false });

                    // Create object store for shares
                    const shareStore = db.createObjectStore('shares', { keyPath: 'id' });
                    shareStore.createIndex('userId', 'userId', { unique: false });
                    shareStore.createIndex('groupId', 'groupId', { unique: false });

                    // Create object store for messages
                    const messageStore = db.createObjectStore('messages', { keyPath: 'id' });
                    messageStore.createIndex('senderId', 'senderId', { unique: false });
                    messageStore.createIndex('recipientId', 'recipientId', { unique: false });

                    // Create object store for votes
                    const voteStore = db.createObjectStore('votes', { keyPath: 'id' });
                    voteStore.createIndex('groupId', 'groupId', { unique: false });

                    // Create object store for blockchain
                    const blockchainStore = db.createObjectStore('blockchain', { keyPath: 'index' });

                    // Create object store for peer information
                    const peerStore = db.createObjectStore('peers', { keyPath: 'id' });

                    console.log('Database structure created');
                };

                request.onsuccess = function(event) {
                    db = event.target.result;
                    console.log('Database initialized');
                    resolve();
                };
            });
        }

        async function initNetwork() {
            try {
                // Initialize IPFS
                ipfs = await Ipfs.create({
                    repo: 'kiira-save-ipfs',
                    config: {
                        Addresses: {
                            Swarm: [
                                '/dns4/wrtc-star1.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star',
                                '/dns4/wrtc-star2.sjc.dwebops.pub/tcp/443/wss/p2p-webrtc-star'
                            ]
                        },
                        Bootstrap: [
                            '/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN',
                            '/dns4/ipfs.io/tcp/443/wss/p2p/QmSoLPppuBtQSGwKDZT2M73ULpjvfd3aZ6ha4oFGL1KrGM'
                        ]
                    }
                });

                console.log('IPFS initialized');

                // Initialize libp2p
                const peerId = await PeerId.create({ bits: 2048 });
                
                libp2p = await Libp2p.create({
                    peerId,
                    modules: {
                        transport: [Websockets, WebRTCStar],
                        connEncryption: [NOISE],
                        streamMuxer: [MPLEX],
                        peerDiscovery: [Bootstrap, MDNS]
                    },
                    config: {
                        peerDiscovery: {
                            autoDial: true,
                            [Bootstrap.tag]: {
                                enabled: true,
                                list: [
                                    '/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN',
                                    '/dns4/ipfs.io/tcp/443/wss/p2p/QmSoLPppuBtQSGwKDZT2M73ULpjvfd3aZ6ha4oFGL1KrGM'
                                ]
                            },
                            [MDNS.tag]: {
                                enabled: true,
                                interval: 10000
                            }
                        }
                    }
                });

                await libp2p.start();
                console.log('libp2p initialized');

                // Handle incoming connections
                libp2p.handle('/kiira-save/1.0.0', ({ stream }) => {
                    handleIncomingStream(stream);
                });

                // Listen for peer discovery
                libp2p.on('peer:discovery', (peerId) => {
                    console.log('Discovered peer:', peerId.toB58String());
                    if (!peers.includes(peerId.toB58String())) {
                        peers.push(peerId.toB58String());
                        connectToPeer(peerId);
                    }
                });

                // Connect to bootstrap nodes
                const bootstrapMultiaddrs = [
                    '/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN',
                    '/dns4/ipfs.io/tcp/443/wss/p2p/QmSoLPppuBtQSGwKDZT2M73ULpjvfd3aZ6ha4oFGL1KrGM'
                ];

                for (const ma of bootstrapMultiaddrs) {
                    const peerId = PeerId.createFromB58String(ma.split('/p2p/')[1]);
                    const multiaddr = multiaddr(ma);
                    await libp2p.dial(multiaddr);
                    console.log('Connected to bootstrap node:', peerId.toB58String());
                    peers.push(peerId.toB58String());
                }

                // Initialize blockchain
                await initBlockchain();

                console.log('Network initialized');
            } catch (err) {
                console.error('Network initialization error:', err);
                throw err;
            }
        }

        async function initBlockchain() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['blockchain'], 'readonly');
                const store = transaction.objectStore('blockchain');
                const request = store.getAll();

                request.onsuccess = function(event) {
                    chain = event.target.result || [];
                    
                    if (chain.length === 0) {
                        // Create genesis block if chain is empty
                        createGenesisBlock().then(resolve).catch(reject);
                    } else {
                        resolve();
                    }
                };

                request.onerror = function(event) {
                    console.error('Error loading blockchain:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function createGenesisBlock() {
            const genesisBlock = {
                index: 0,
                timestamp: Date.now(),
                data: { type: 'genesis', message: 'Kiira Save Genesis Block' },
                previousHash: '0',
                hash: '',
                nonce: 0
            };

            genesisBlock.hash = await calculateHash(genesisBlock);
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['blockchain'], 'readwrite');
                const store = transaction.objectStore('blockchain');
                const request = store.add(genesisBlock);

                request.onsuccess = function() {
                    chain.push(genesisBlock);
                    resolve();
                };

                request.onerror = function(event) {
                    console.error('Error adding genesis block:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function addBlock(data) {
            const lastBlock = chain[chain.length - 1];
            const newBlock = {
                index: chain.length,
                timestamp: Date.now(),
                data: data,
                previousHash: lastBlock.hash,
                hash: '',
                nonce: 0
            };

            // Mine the block (proof of work)
            await mineBlock(newBlock);

            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['blockchain'], 'readwrite');
                const store = transaction.objectStore('blockchain');
                const request = store.add(newBlock);

                request.onsuccess = function() {
                    chain.push(newBlock);
                    broadcastBlock(newBlock);
                    resolve(newBlock);
                };

                request.onerror = function(event) {
                    console.error('Error adding block:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function mineBlock(block) {
            // Simple proof of work - find a hash with 4 leading zeros
            while (true) {
                block.hash = await calculateHash(block);
                if (block.hash.substring(0, 4) === '0000') {
                    break;
                }
                block.nonce++;
            }
        }

        async function calculateHash(block) {
            const blockString = JSON.stringify(block);
            const encoder = new TextEncoder();
            const data = encoder.encode(blockString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        async function broadcastBlock(block) {
            if (!networkInitialized) return;

            for (const peer of peers) {
                try {
                    const peerId = PeerId.createFromB58String(peer);
                    const connection = await libp2p.dial(peerId);
                    const { stream } = await connection.newStream('/kiira-save/1.0.0');
                    
                    const message = {
                        type: 'new_block',
                        block: block
                    };

                    await sendMessageOverStream(stream, message);
                } catch (err) {
                    console.error('Error broadcasting block to peer:', peer, err);
                }
            }
        }

        async function handleIncomingStream(stream) {
            try {
                const message = await readMessageFromStream(stream);
                
                if (message.type === 'new_block') {
                    // Validate the new block
                    const isValid = await validateBlock(message.block);
                    
                    if (isValid) {
                        // Add to our chain if it's valid
                        const transaction = db.transaction(['blockchain'], 'readwrite');
                        const store = transaction.objectStore('blockchain');
                        const request = store.add(message.block);

                        request.onsuccess = function() {
                            chain.push(message.block);
                            console.log('Added new block from peer:', message.block);
                        };

                        request.onerror = function(event) {
                            console.error('Error adding block from peer:', event.target.error);
                        };
                    }
                } else if (message.type === 'chain_request') {
                    // Send our chain to the requesting peer
                    const response = {
                        type: 'chain_response',
                        chain: chain
                    };

                    await sendMessageOverStream(stream, response);
                } else if (message.type === 'chain_response') {
                    // Compare chains and potentially replace ours
                    await handleChainResponse(message.chain);
                }
            } catch (err) {
                console.error('Error handling incoming stream:', err);
            } finally {
                stream.close();
            }
        }

        async function validateBlock(block) {
            // Check hash is valid
            const calculatedHash = await calculateHash(block);
            if (calculatedHash !== block.hash) {
                console.log('Invalid block hash');
                return false;
            }

            // Check proof of work
            if (block.hash.substring(0, 4) !== '0000') {
                console.log('Block does not meet proof of work requirements');
                return false;
            }

            // Check previous hash matches
            const lastBlock = chain[chain.length - 1];
            if (block.previousHash !== lastBlock.hash) {
                console.log('Block previous hash does not match');
                return false;
            }

            return true;
        }

        async function handleChainResponse(newChain) {
            // Check if the new chain is longer and valid
            if (newChain.length > chain.length) {
                let isValid = true;
                
                // Validate each block in the new chain
                for (let i = 1; i < newChain.length; i++) {
                    const block = newChain[i];
                    const previousBlock = newChain[i - 1];
                    
                    // Check hash is valid
                    const calculatedHash = await calculateHash(block);
                    if (calculatedHash !== block.hash) {
                        isValid = false;
                        break;
                    }

                    // Check previous hash matches
                    if (block.previousHash !== previousBlock.hash) {
                        isValid = false;
                        break;
                    }
                }

                if (isValid) {
                    // Replace our chain with the new one
                    const transaction = db.transaction(['blockchain'], 'readwrite');
                    const store = transaction.objectStore('blockchain');
                    const clearRequest = store.clear();

                    clearRequest.onsuccess = function() {
                        const addRequests = [];
                        for (const block of newChain) {
                            addRequests.push(store.add(block));
                        }

                        Promise.all(addRequests).then(() => {
                            chain = newChain;
                            console.log('Replaced chain with longer valid chain');
                        }).catch(err => {
                            console.error('Error replacing chain:', err);
                        });
                    };

                    clearRequest.onerror = function(event) {
                        console.error('Error clearing chain:', event.target.error);
                    };
                }
            }
        }

        async function connectToPeer(peerId) {
            try {
                const multiaddr = `/ipfs/${peerId.toB58String()}`;
                await libp2p.dial(multiaddr);
                console.log('Connected to peer:', peerId.toB58String());

                // Request their chain to sync
                const { stream } = await libp2p.dialProtocol(peerId, '/kiira-save/1.0.0');
                const message = { type: 'chain_request' };
                await sendMessageOverStream(stream, message);
            } catch (err) {
                console.error('Error connecting to peer:', peerId.toB58String(), err);
            }
        }

        async function sendMessageOverStream(stream, message) {
            const encoder = new TextEncoder();
            const data = encoder.encode(JSON.stringify(message));
            await stream.sink(data);
        }

        async function readMessageFromStream(stream) {
            let data = '';
            for await (const chunk of stream.source) {
                const decoder = new TextDecoder();
                data += decoder.decode(chunk, { stream: true });
            }
            return JSON.parse(data);
        }

        async function checkAuthState() {
            const user = await getCurrentUser();
            if (user) {
                currentUser = user;
                await loadUserData();
                showDashboard();
            } else {
                showAuth();
            }
        }

        async function getCurrentUser() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                const request = store.getAll();

                request.onsuccess = function(event) {
                    const users = event.target.result;
                    if (users.length > 0) {
                        resolve(users[0]); // For simplicity, using the first user
                    } else {
                        resolve(null);
                    }
                };

                request.onerror = function(event) {
                    console.error('Error getting current user:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function loginUser() {
            const emailOrPhone = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!emailOrPhone || !password) {
                showError('Please enter both email/phone and password');
                return;
            }

            showLoading('Logging in...');

            try {
                const user = await findUserByEmailOrPhone(emailOrPhone);
                
                if (!user) {
                    hideLoading();
                    showError('User not found');
                    return;
                }

                // Verify password
                const passwordMatch = await verifyPassword(password, user.password);
                
                if (!passwordMatch) {
                    hideLoading();
                    showError('Invalid password');
                    return;
                }

                currentUser = user;
                await loadUserData();
                hideLoading();
                showDashboard();
            } catch (err) {
                hideLoading();
                console.error('Login error:', err);
                showError('Login failed. Please try again.');
            }
        }

        async function findUserByEmailOrPhone(emailOrPhone) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                const emailIndex = store.index('email');
                const phoneIndex = store.index('phone');

                // Try email first
                const emailRequest = emailIndex.get(emailOrPhone);
                
                emailRequest.onsuccess = function(event) {
                    if (event.target.result) {
                        resolve(event.target.result);
                    } else {
                        // Try phone if email not found
                        const phoneRequest = phoneIndex.get(emailOrPhone);
                        
                        phoneRequest.onsuccess = function(event) {
                            resolve(event.target.result);
                        };

                        phoneRequest.onerror = function(event) {
                            reject(event.target.error);
                        };
                    }
                };

                emailRequest.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function verifyPassword(password, hash) {
            // In a real app, use a proper password hashing library like bcrypt
            // This is a simplified version for demonstration
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex === hash;
        }

        async function signupUser() {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const phone = document.getElementById('signup-phone').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            const nextOfKin = document.getElementById('signup-next-of-kin').value;
            const nextOfKinPhone = document.getElementById('signup-next-of-kin-phone').value;
            const location = document.getElementById('signup-location').value;
            const groupName = document.getElementById('signup-group').value;

            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            if (!name || !email || !phone || !password || !nextOfKin || !nextOfKinPhone || !location) {
                showError('Please fill in all required fields');
                return;
            }

            showLoading('Creating account...');

            try {
                // Hash password
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const passwordHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                // Create user
                const userId = generateId();
                const user = {
                    id: userId,
                    name: name,
                    email: email,
                    phone: phone,
                    password: passwordHash,
                    nextOfKin: nextOfKin,
                    nextOfKinPhone: nextOfKinPhone,
                    location: location,
                    avatar: '',
                    createdAt: Date.now(),
                    lastActive: Date.now()
                };

                // Save user to database
                await saveUser(user);

                // Check if joining existing group or creating new one
                if (groupName) {
                    // Join existing group
                    const group = await findGroupByName(groupName);
                    
                    if (!group) {
                        hideLoading();
                        showError('Group not found. Please check the name or leave blank to create a new group.');
                        return;
                    }

                    // Add user to group
                    await addGroupMember(group.id, userId, 'member');
                    currentGroup = group;
                } else {
                    // Create new group
                    const groupId = generateId();
                    const group = {
                        id: groupId,
                        name: `${name}'s Group`,
                        currency: 'UGX',
                        savingFrequency: 'monthly',
                        savingAmount: 0,
                        compulsorySaving: 'no',
                        cycleLength: 1,
                        loanInterest: 10,
                        latePenalty: 20,
                        maxGroupsPerMember: 2,
                        sharePrice: 1000,
                        loansEnabled: false,
                        withdrawalsEnabled: false,
                        sharesEnabled: false,
                        createdAt: Date.now(),
                        cycleStartDate: Date.now(),
                        cycleEndDate: calculateCycleEndDate(Date.now(), 1),
                        adminId: userId
                    };

                    // Save group to database
                    await saveGroup(group);

                    // Add user to group as admin
                    await addGroupMember(groupId, userId, 'admin');
                    currentGroup = group;
                }

                currentUser = user;
                await loadUserData();
                hideLoading();
                showDashboard();
            } catch (err) {
                hideLoading();
                console.error('Signup error:', err);
                showError('Signup failed. Please try again.');
            }
        }

        async function saveUser(user) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['users'], 'readwrite');
                const store = transaction.objectStore('users');
                const request = store.put(user);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function findGroupByName(name) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['groups'], 'readonly');
                const store = transaction.objectStore('groups');
                const index = store.index('name');
                const request = index.get(name);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function saveGroup(group) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['groups'], 'readwrite');
                const store = transaction.objectStore('groups');
                const request = store.put(group);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function addGroupMember(groupId, userId, role) {
            return new Promise((resolve, reject) => {
                const memberId = generateId();
                const member = {
                    id: memberId,
                    groupId: groupId,
                    userId: userId,
                    role: role,
                    joinedAt: Date.now(),
                    lastActive: Date.now()
                };

                const transaction = db.transaction(['groupMembers'], 'readwrite');
                const store = transaction.objectStore('groupMembers');
                const request = store.put(member);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        function generateId() {
            return crypto.getRandomValues(new Uint32Array(1))[0].toString(16);
        }

        function calculateCycleEndDate(startDate, months) {
            const date = new Date(startDate);
            date.setMonth(date.getMonth() + months);
            return date.getTime();
        }

        async function loadUserData() {
            // Load user's groups
            const groups = await getUserGroups(currentUser.id);
            
            if (groups.length > 0) {
                currentGroup = groups[0]; // For simplicity, using the first group
                isGroupAdmin = await checkIfGroupAdmin(currentUser.id, currentGroup.id);
            } else {
                currentGroup = null;
                isGroupAdmin = false;
            }

            // Check if user is super admin (first user in the system)
            const allUsers = await getAllUsers();
            isSuperAdmin = allUsers.length > 0 && allUsers[0].id === currentUser.id;

            // Update UI based on user role
            updateUIForUserRole();
        }

        async function getUserGroups(userId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['groupMembers'], 'readonly');
                const store = transaction.objectStore('groupMembers');
                const index = store.index('userId');
                const request = index.getAll(userId);

                request.onsuccess = async function(event) {
                    const memberships = event.target.result;
                    const groups = [];
                    
                    for (const membership of memberships) {
                        const group = await getGroupById(membership.groupId);
                        if (group) {
                            groups.push(group);
                        }
                    }

                    resolve(groups);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function getGroupById(groupId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['groups'], 'readonly');
                const store = transaction.objectStore('groups');
                const request = store.get(groupId);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function checkIfGroupAdmin(userId, groupId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['groupMembers'], 'readonly');
                const store = transaction.objectStore('groupMembers');
                const index = store.index('userId');
                const request = index.get(userId);

                request.onsuccess = function(event) {
                    const membership = event.target.result;
                    resolve(membership && membership.role === 'admin');
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function getAllUsers() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                const request = store.getAll();

                request.onsuccess = function(event) {
                    resolve(event.target.result || []);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        function updateUIForUserRole() {
            // Update user info in header
            document.getElementById('username').textContent = currentUser.name;
            document.getElementById('user-avatar').src = currentUser.avatar || 'https://via.placeholder.com/40';
            
            if (isSuperAdmin) {
                document.getElementById('user-role').textContent = 'Super Admin';
            } else if (isGroupAdmin) {
                document.getElementById('user-role').textContent = 'Group Admin';
            } else {
                document.getElementById('user-role').textContent = 'Member';
            }

            // Show/hide admin menu
            if (isSuperAdmin || isGroupAdmin) {
                document.getElementById('admin-menu').style.display = 'block';
            } else {
                document.getElementById('admin-menu').style.display = 'none';
            }

            // Update group title
            if (currentGroup) {
                document.getElementById('group-title').textContent = currentGroup.name;
                document.title = `${currentGroup.name} - Kiira Save`;
                
                // Update cycle info
                const cycleMonths = currentGroup.cycleLength;
                const cycleText = cycleMonths === 1 ? 'Monthly' : 
                                 cycleMonths === 3 ? 'Quarterly' : 
                                 cycleMonths === 6 ? 'Bi-Annual' : 
                                 cycleMonths === 12 ? 'Annual' : 'Custom';
                document.getElementById('group-cycle').textContent = `Cycle: ${cycleText}`;
            }

            // Load dashboard data
            loadDashboardData();
        }

        async function loadDashboardData() {
            if (!currentGroup) return;

            // Load group members
            const members = await getGroupMembers(currentGroup.id);
            document.getElementById('group-members-count').textContent = `${members.length} members`;

            // Load user savings
            const userSavings = await getUserSavings(currentUser.id, currentGroup.id);
            const totalSavings = userSavings.reduce((sum, saving) => sum + saving.amount, 0);
            document.getElementById('user-savings').textContent = `${currentGroup.currency} ${totalSavings.toLocaleString()}`;

            // Load group savings
            const groupSavings = await getGroupSavings(currentGroup.id);
            const groupTotalSavings = groupSavings.reduce((sum, saving) => sum + saving.amount, 0);
            document.getElementById('group-savings').textContent = `${currentGroup.currency} ${groupTotalSavings.toLocaleString()}`;

            // Calculate user's percentage of total savings
            const userPercentage = groupTotalSavings > 0 ? (totalSavings / groupTotalSavings * 100) : 0;
            document.getElementById('user-savings-percentage').textContent = `${userPercentage.toFixed(2)}% of total`;

            // Calculate next saving date
            const nextSavingDate = calculateNextSavingDate();
            document.getElementById('next-saving-date').textContent = formatDate(nextSavingDate);
            
            const daysRemaining = Math.ceil((nextSavingDate - Date.now()) / (1000 * 60 * 60 * 24));
            document.getElementById('days-remaining').textContent = `${daysRemaining} days remaining`;

            // Calculate cycle progress
            const cycleProgress = calculateCycleProgress();
            document.getElementById('cycle-progress').textContent = `${cycleProgress}%`;
            document.getElementById('cycle-end-date').textContent = `Ends on ${formatDate(currentGroup.cycleEndDate)}`;

            // Populate savings table
            populateSavingsTable(userSavings);

            // Populate members table
            populateMembersTable(members, groupTotalSavings);

            // Load timeline
            loadTimeline();

            // Load adverts
            loadAdverts();
        }

        async function getGroupMembers(groupId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['groupMembers'], 'readonly');
                const store = transaction.objectStore('groupMembers');
                const index = store.index('groupId');
                const request = index.getAll(groupId);

                request.onsuccess = async function(event) {
                    const memberships = event.target.result;
                    const members = [];
                    
                    for (const membership of memberships) {
                        const user = await getUserById(membership.userId);
                        if (user) {
                            members.push({
                                ...user,
                                role: membership.role,
                                lastActive: membership.lastActive
                            });
                        }
                    }

                    resolve(members);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function getUserById(userId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['users'], 'readonly');
                const store = transaction.objectStore('users');
                const request = store.get(userId);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function getUserSavings(userId, groupId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['savings'], 'readonly');
                const store = transaction.objectStore('savings');
                const index = store.index('userId');
                const request = index.getAll(userId);

                request.onsuccess = function(event) {
                    const allSavings = event.target.result || [];
                    const groupSavings = allSavings.filter(saving => saving.groupId === groupId);
                    resolve(groupSavings);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function getGroupSavings(groupId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['savings'], 'readonly');
                const store = transaction.objectStore('savings');
                const index = store.index('groupId');
                const request = index.getAll(groupId);

                request.onsuccess = function(event) {
                    resolve(event.target.result || []);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        function calculateNextSavingDate() {
            if (!currentGroup) return new Date();

            const now = new Date();
            const frequency = currentGroup.savingFrequency;

            if (frequency === 'daily') {
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                return tomorrow;
            } else if (frequency === 'weekly') {
                const dayOfWeek = currentGroup.weeklyDay || 0; // Default to Sunday
                const nextDate = new Date(now);
                
                // Calculate days until next saving day
                let daysToAdd = (dayOfWeek - now.getDay() + 7) % 7;
                if (daysToAdd === 0) daysToAdd = 7; // If today is the day, go to next week
                
                nextDate.setDate(nextDate.getDate() + daysToAdd);
                return nextDate;
            } else if (frequency === 'monthly') {
                const dayOfMonth = currentGroup.monthlyDay || 1;
                const nextDate = new Date(now);
                
                if (now.getDate() < dayOfMonth) {
                    // This month's saving day hasn't passed yet
                    nextDate.setDate(dayOfMonth);
                } else {
                    // Go to next month
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    nextDate.setDate(dayOfMonth);
                }
                
                return nextDate;
            } else {
                // For other frequencies, just return a date in the future
                return new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            }
        }

        function calculateCycleProgress() {
            if (!currentGroup) return 0;

            const now = Date.now();
            const start = currentGroup.cycleStartDate;
            const end = currentGroup.cycleEndDate;

            if (now >= end) return 100;
            if (now <= start) return 0;

            const total = end - start;
            const elapsed = now - start;
            return Math.min(100, Math.floor((elapsed / total) * 100));
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function populateSavingsTable(savings) {
            const tbody = document.querySelector('#savings-table tbody');
            tbody.innerHTML = '';

            // Sort by date (newest first)
            savings.sort((a, b) => b.date - a.date);

            // Show only recent savings (last 5)
            const recentSavings = savings.slice(0, 5);

            for (const saving of recentSavings) {
                const tr = document.createElement('tr');
                
                const dateTd = document.createElement('td');
                dateTd.textContent = formatDate(saving.date);
                tr.appendChild(dateTd);
                
                const amountTd = document.createElement('td');
                amountTd.textContent = `${currentGroup.currency} ${saving.amount.toLocaleString()}`;
                tr.appendChild(amountTd);
                
                const statusTd = document.createElement('td');
                const statusSpan = document.createElement('span');
                statusSpan.textContent = saving.status === 'approved' ? 'Approved' : 'Pending';
                statusSpan.className = saving.status === 'approved' ? 'badge badge-success' : 'badge badge-warning';
                statusTd.appendChild(statusSpan);
                tr.appendChild(statusTd);
                
                tbody.appendChild(tr);
            }
        }

        function populateMembersTable(members, totalSavings) {
            const tbody = document.querySelector('#members-table tbody');
            tbody.innerHTML = '';

            // Sort by savings (highest first)
            members.sort(async (a, b) => {
                const aSavings = await getUserSavings(a.id, currentGroup.id);
                const bSavings = await getUserSavings(b.id, currentGroup.id);
                const aTotal = aSavings.reduce((sum, s) => sum + s.amount, 0);
                const bTotal = bSavings.reduce((sum, s) => sum + s.amount, 0);
                return bTotal - aTotal;
            });

            for (const member of members) {
                const tr = document.createElement('tr');
                
                const nameTd = document.createElement('td');
                nameTd.textContent = member.name;
                tr.appendChild(nameTd);
                
                const savingsTd = document.createElement('td');
                const memberSavings = getUserSavings(member.id, currentGroup.id).then(savings => {
                    const total = savings.reduce((sum, s) => sum + s.amount, 0);
                    savingsTd.textContent = `${currentGroup.currency} ${total.toLocaleString()}`;
                });
                tr.appendChild(savingsTd);
                
                const percentageTd = document.createElement('td');
                const memberPercentage = getUserSavings(member.id, currentGroup.id).then(savings => {
                    const total = savings.reduce((sum, s) => sum + s.amount, 0);
                    const percentage = totalSavings > 0 ? (total / totalSavings * 100) : 0;
                    percentageTd.textContent = `${percentage.toFixed(2)}%`;
                });
                tr.appendChild(percentageTd);
                
                const activeTd = document.createElement('td');
                activeTd.textContent = formatDate(member.lastActive);
                tr.appendChild(activeTd);
                
                tbody.appendChild(tr);
            }
        }

        async function loadTimeline() {
            // Get all blocks with timeline events
            const timelineEvents = chain.filter(block => 
                block.data.type === 'saving' || 
                block.data.type === 'loan' || 
                block.data.type === 'share' ||
                block.data.type === 'message' ||
                block.data.type === 'vote' ||
                block.data.type === 'admin_transfer' ||
                block.data.type === 'withdrawal' ||
                block.data.type === 'gift'
            );

            // Sort by timestamp (newest first)
            timelineEvents.sort((a, b) => b.timestamp - a.timestamp);

            // Display in timeline
            const timelineContainer = document.getElementById('group-timeline');
            timelineContainer.innerHTML = '';

            for (const event of timelineEvents.slice(0, 10)) { // Show only recent 10 events
                const eventDiv = document.createElement('div');
                eventDiv.className = 'timeline-item';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'timeline-content';

                const dateDiv = document.createElement('div');
                dateDiv.className = 'timeline-date';
                dateDiv.textContent = formatDate(event.timestamp);
                contentDiv.appendChild(dateDiv);

                const textDiv = document.createElement('div');
                textDiv.className = 'timeline-text';

                // Create event description based on type
                let eventText = '';
                if (event.data.type === 'saving') {
                    const user = await getUserById(event.data.userId);
                    eventText = `${user.name} saved ${currentGroup.currency} ${event.data.amount}`;
                } else if (event.data.type === 'loan') {
                    const user = await getUserById(event.data.userId);
                    eventText = `${user.name} applied for a loan of ${currentGroup.currency} ${event.data.amount}`;
                } else if (event.data.type === 'share') {
                    const user = await getUserById(event.data.userId);
                    eventText = `${user.name} ${event.data.action} ${event.data.amount} shares`;
                } else if (event.data.type === 'message') {
                    const sender = await getUserById(event.data.senderId);
                    eventText = `${sender.name} sent a message: ${event.data.subject}`;
                } else if (event.data.type === 'vote') {
                    eventText = `New vote: ${event.data.topic}`;
                } else if (event.data.type === 'admin_transfer') {
                    const fromUser = await getUserById(event.data.fromUserId);
                    const toUser = await getUserById(event.data.toUserId);
                    eventText = `Admin role transferred from ${fromUser.name} to ${toUser.name}`;
                } else if (event.data.type === 'withdrawal') {
                    const user = await getUserById(event.data.userId);
                    eventText = `${user.name} requested a withdrawal of ${currentGroup.currency} ${event.data.amount}`;
                } else if (event.data.type === 'gift') {
                    const fromUser = await getUserById(event.data.fromUserId);
                    const toUser = await getUserById(event.data.toUserId);
                    eventText = `${fromUser.name} gifted ${currentGroup.currency} ${event.data.amount} to ${toUser.name}`;
                }

                textDiv.textContent = eventText;
                contentDiv.appendChild(textDiv);

                // Add user info if available
                if (event.data.userId || event.data.senderId) {
                    const userId = event.data.userId || event.data.senderId;
                    const user = await getUserById(userId);
                    
                    if (user) {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'timeline-user';

                        const img = document.createElement('img');
                        img.src = user.avatar || 'https://via.placeholder.com/30';
                        img.alt = user.name;
                        userDiv.appendChild(img);

                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'timeline-user-name';
                        nameDiv.textContent = user.name;
                        userDiv.appendChild(nameDiv);

                        contentDiv.appendChild(userDiv);
                    }
                }

                eventDiv.appendChild(contentDiv);
                timelineContainer.appendChild(eventDiv);
            }
        }

        async function loadAdverts() {
            // Get all advert blocks
            const advertBlocks = chain.filter(block => block.data.type === 'advert');

            // Display in sidebar
            const advertContainer = document.getElementById('sidebar-advert');
            advertContainer.innerHTML = '';

            for (const block of advertBlocks.slice(0, 3)) { // Show only 3 adverts
                const advert = block.data;
                const advertCard = document.createElement('div');
                advertCard.className = 'advert-card';

                if (advert.image) {
                    const img = document.createElement('img');
                    img.src = advert.image;
                    img.className = 'advert-image';
                    img.alt = advert.text;
                    advertCard.appendChild(img);
                }

                const textDiv = document.createElement('div');
                textDiv.className = 'advert-text';
                textDiv.textContent = advert.text;
                advertCard.appendChild(textDiv);

                const footerDiv = document.createElement('div');
                footerDiv.className = 'advert-footer';
                footerDiv.innerHTML = `<span>Sponsored</span><span>${formatDate(block.timestamp)}</span>`;
                advertCard.appendChild(footerDiv);

                advertContainer.appendChild(advertCard);
            }
        }

        async function addSaving() {
            const date = document.getElementById('saving-date').value;
            const amount = parseFloat(document.getElementById('saving-amount-input').value);
            const proofFile = document.getElementById('saving-proof').files[0];

            if (!date || isNaN(amount) || amount <= 0) {
                showError('Please enter a valid date and amount');
                return;
            }

            showLoading('Submitting saving...');

            try {
                // Save proof to IPFS if provided
                let proofHash = '';
                if (proofFile) {
                    const proofBuffer = await readFileAsBuffer(proofFile);
                    const { cid } = await ipfs.add(proofBuffer);
                    proofHash = cid.toString();
                }

                // Create saving record
                const savingId = generateId();
                const saving = {
                    id: savingId,
                    userId: currentUser.id,
                    groupId: currentGroup.id,
                    date: new Date(date).getTime(),
                    amount: amount,
                    proof: proofHash,
                    status: isGroupAdmin ? 'approved' : 'pending',
                    createdAt: Date.now()
                };

                // Save to database
                await saveSaving(saving);

                // Add to blockchain
                const blockData = {
                    type: 'saving',
                    savingId: savingId,
                    userId: currentUser.id,
                    groupId: currentGroup.id,
                    amount: amount,
                    status: saving.status
                };

                await addBlock(blockData);

                hideLoading();
                hideModal('add-saving-modal');
                showSuccess('Saving submitted successfully');
                loadDashboardData();
            } catch (err) {
                hideLoading();
                console.error('Error adding saving:', err);
                showError('Failed to submit saving. Please try again.');
            }
        }

        async function readFileAsBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function saveSaving(saving) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['savings'], 'readwrite');
                const store = transaction.objectStore('savings');
                const request = store.put(saving);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function calculateLoan() {
            const amount = parseFloat(document.getElementById('loan-amount').value) || 0;
            const period = parseInt(document.getElementById('loan-period').value) || 30;
            const interestRate = currentGroup.loanInterest || 10;

            const interest = amount * (interestRate / 100) * (period / 30);
            const total = amount + interest;

            document.getElementById('loan-interest-amount').textContent = `${currentGroup.currency} ${interest.toFixed(2)}`;
            document.getElementById('loan-total-amount').textContent = `${currentGroup.currency} ${total.toFixed(2)}`;

            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + period);
            document.getElementById('loan-due-date').textContent = formatDate(dueDate.getTime());
        }

        async function applyForLoan() {
            const amount = parseFloat(document.getElementById('loan-amount').value);
            const purpose = document.getElementById('loan-purpose').value;
            const period = parseInt(document.getElementById('loan-period').value);
            const interestRate = currentGroup.loanInterest || 10;

            if (isNaN(amount) || amount <= 0 || !purpose) {
                showError('Please enter valid loan details');
                return;
            }

            showLoading('Applying for loan...');

            try {
                // Check if user has enough savings
                const userSavings = await getUserSavings(currentUser.id, currentGroup.id);
                const totalSavings = userSavings.reduce((sum, saving) => sum + saving.amount, 0);

                if (amount > totalSavings) {
                    hideLoading();
                    showError('Loan amount cannot exceed your total savings');
                    return;
                }

                // Create loan record
                const loanId = generateId();
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + period);

                const loan = {
                    id: loanId,
                    userId: currentUser.id,
                    groupId: currentGroup.id,
                    amount: amount,
                    purpose: purpose,
                    interestRate: interestRate,
                    period: period,
                    dueDate: dueDate.getTime(),
                    status: 'pending',
                    createdAt: Date.now()
                };

                // Save to database
                await saveLoan(loan);

                // Add to blockchain
                const blockData = {
                    type: 'loan',
                    loanId: loanId,
                    userId: currentUser.id,
                    groupId: currentGroup.id,
                    amount: amount,
                    purpose: purpose,
                    interestRate: interestRate,
                    period: period,
                    dueDate: dueDate.getTime(),
                    status: 'pending'
                };

                await addBlock(blockData);

                hideLoading();
                hideModal('apply-loan-modal');
                showSuccess('Loan application submitted successfully');
                loadDashboardData();
            } catch (err) {
                hideLoading();
                console.error('Error applying for loan:', err);
                showError('Failed to apply for loan. Please try again.');
            }
        }

        async function saveLoan(loan) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['loans'], 'readwrite');
                const store = transaction.objectStore('loans');
                const request = store.put(loan);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function sellShares() {
            const amount = parseInt(document.getElementById('shares-amount').value);
            const price = parseFloat(document.getElementById('shares-price').value);
            const reason = document.getElementById('shares-reason').value;

            if (isNaN(amount) || amount <= 0 || isNaN(price) || price <= 0) {
                showError('Please enter valid share details');
                return;
            }

            showLoading('Listing shares for sale...');

            try {
                // Check if user has enough shares
                const userShares = await getUserShares(currentUser.id, currentGroup.id);
                const totalShares = userShares.reduce((sum, share) => sum + share.amount, 0);

                if (amount > totalShares) {
                    hideLoading();
                    showError('You don\'t have enough shares to sell');
                    return;
                }

                // Create share record
                const shareId = generateId();
                const share = {
                    id: shareId,
                    userId: currentUser.id,
                    groupId: currentGroup.id,
                    amount: amount,
                    price: price,
                    reason: reason,
                    status: 'pending',
                    createdAt: Date.now()
                };

                // Save to database
                await saveShare(share);

                // Add to blockchain
                const blockData = {
                    type: 'share',
                    shareId: shareId,
                    userId: currentUser.id,
                    groupId: currentGroup.id,
                    amount: amount,
                    price: price,
                    action: 'listed for sale',
                    status: 'pending'
                };

                await addBlock(blockData);

                hideLoading();
                hideModal('sell-shares-modal');
                showSuccess('Shares listed for sale successfully');
                loadDashboardData();
            } catch (err) {
                hideLoading();
                console.error('Error selling shares:', err);
                showError('Failed to list shares for sale. Please try again.');
            }
        }

        async function getUserShares(userId, groupId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['shares'], 'readonly');
                const store = transaction.objectStore('shares');
                const index = store.index('userId');
                const request = index.getAll(userId);

                request.onsuccess = function(event) {
                    const allShares = event.target.result || [];
                    const groupShares = allShares.filter(share => share.groupId === groupId);
                    resolve(groupShares);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function saveShare(share) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['shares'], 'readwrite');
                const store = transaction.objectStore('shares');
                const request = store.put(share);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function buyShares() {
            const amount = parseInt(document.getElementById('buy-shares-amount').value);
            const total = parseFloat(document.getElementById('buy-shares-total').value);
            const paymentMethod = document.getElementById('buy-shares-payment').value;
            const mobileNumber = document.getElementById('mobile-money-number').value;

            if (isNaN(amount) || amount <= 0 || isNaN(total) || total <= 0) {
                showError('Please enter valid share details');
                return;
            }

            if (paymentMethod === 'mobile_money' && !mobileNumber) {
                showError('Please enter mobile money number');
                return;
            }

            showLoading('Processing share purchase...');

            try {
                // Check if shares are still available
                const shareId = this.getAttribute('data-share-id');
                const share = await getShareById(shareId);

                if (!share || share.status !== 'approved') {
                    hideLoading();
                    showError('These shares are no longer available');
                    return;
                }

                if (amount > share.amount) {
                    hideLoading();
                    showError('Requested amount exceeds available shares');
                    return;
                }

                // Create transaction record
                const transactionId = generateId();
                const transaction = {
                    id: transactionId,
                    shareId: shareId,
                    buyerId: currentUser.id,
                    sellerId: share.userId,
                    groupId: currentGroup.id,
                    amount: amount,
                    price: share.price,
                    total: total,
                    paymentMethod: paymentMethod,
                    mobileNumber: paymentMethod === 'mobile_money' ? mobileNumber : '',
                    status: 'pending',
                    createdAt: Date.now()
                };

                // Save to database
                await saveShareTransaction(transaction);

                // Add to blockchain
                const blockData = {
                    type: 'share_transaction',
                    transactionId: transactionId,
                    shareId: shareId,
                    buyerId: currentUser.id,
                    sellerId: share.userId,
                    groupId: currentGroup.id,
                    amount: amount,
                    price: share.price,
                    total: total,
                    status: 'pending'
                };

                await addBlock(blockData);

                hideLoading();
                hideModal('buy-shares-modal');
                showSuccess('Share purchase request submitted successfully');
                loadDashboardData();
            } catch (err) {
                hideLoading();
                console.error('Error buying shares:', err);
                showError('Failed to process share purchase. Please try again.');
            }
        }

        async function getShareById(shareId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['shares'], 'readonly');
                const store = transaction.objectStore('shares');
                const request = store.get(shareId);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function saveShareTransaction(transaction) {
            return new Promise((resolve, reject) => {
                const transactionDB = db.transaction(['shareTransactions'], 'readwrite');
                const store = transactionDB.objectStore('shareTransactions');
                const request = store.put(transaction);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function sendMessage() {
            const recipientId = document.getElementById('message-recipient').value;
            const subject = document.getElementById('message-subject').value;
            const content = document.getElementById('message-content').value;

            if (!recipientId || !subject || !content) {
                showError('Please fill in all message fields');
                return;
            }

            showLoading('Sending message...');

            try {
                // Create message record
                const messageId = generateId();
                const message = {
                    id: messageId,
                    senderId: currentUser.id,
                    recipientId: recipientId,
                    subject: subject,
                    content: content,
                    read: false,
                    createdAt: Date.now()
                };

                // Save to database
                await saveMessage(message);

                // Add to blockchain
                const blockData = {
                    type: 'message',
                    messageId: messageId,
                    senderId: currentUser.id,
                    recipientId: recipientId,
                    subject: subject,
                    content: content
                };

                await addBlock(blockData);

                hideLoading();
                hideModal('new-message-modal');
                showSuccess('Message sent successfully');
                loadDashboardData();
            } catch (err) {
                hideLoading();
                console.error('Error sending message:', err);
                showError('Failed to send message. Please try again.');
            }
        }

        async function saveMessage(message) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['messages'], 'readwrite');
                const store = transaction.objectStore('messages');
                const request = store.put(message);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function replyToMessage() {
            const messageId = this.getAttribute('data-message-id');
            const message = await getMessageById(messageId);

            if (!message) {
                showError('Message not found');
                return;
            }

            // Set recipient in new message form
            document.getElementById('message-recipient').value = message.senderId;
            document.getElementById('message-subject').value = `Re: ${message.subject}`;
            
            // Show new message modal
            hideModal('view-message-modal');
            showModal('new-message-modal');
        }

        async function getMessageById(messageId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['messages'], 'readonly');
                const store = transaction.objectStore('messages');
                const request = store.get(messageId);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function transferAdminRole() {
            const newAdminId = document.getElementById('new-admin-select').value;
            const reason = document.getElementById('transfer-reason').value;
            const confirmed = document.getElementById('confirm-transfer').checked;

            if (!newAdminId) {
                showError('Please select a new admin');
                return;
            }

            if (!confirmed) {
                showError('Please confirm the transfer');
                return;
            }

            showLoading('Transferring admin role...');

            try {
                // Update group admin
                currentGroup.adminId = newAdminId;
                await saveGroup(currentGroup);

                // Update member roles
                await updateGroupMemberRole(currentUser.id, currentGroup.id, 'member');
                await updateGroupMemberRole(newAdminId, currentGroup.id, 'admin');

                // Add to blockchain
                const blockData = {
                    type: 'admin_transfer',
                    fromUserId: currentUser.id,
                    toUserId: newAdminId,
                    groupId: currentGroup.id,
                    reason: reason
                };

                await addBlock(blockData);

                // Update current user status
                isGroupAdmin = false;
                updateUIForUserRole();

                hideLoading();
                hideModal('transfer-admin-modal');
                showSuccess('Admin role transferred successfully');
            } catch (err) {
                hideLoading();
                console.error('Error transferring admin role:', err);
                showError('Failed to transfer admin role. Please try again.');
            }
        }

        async function updateGroupMemberRole(userId, groupId, role) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['groupMembers'], 'readwrite');
                const store = transaction.objectStore('groupMembers');
                const index = store.index('userId');
                const request = index.get(userId);

                request.onsuccess = function(event) {
                    const membership = event.target.result;
                    if (membership && membership.groupId === groupId) {
                        membership.role = role;
                        const updateRequest = store.put(membership);

                        updateRequest.onsuccess = function() {
                            resolve();
                        };

                        updateRequest.onerror = function(event) {
                            reject(event.target.error);
                        };
                    } else {
                        reject('Membership not found');
                    }
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function sendBroadcast() {
            const audience = document.getElementById('broadcast-audience').value;
            const specificMembers = Array.from(document.getElementById('broadcast-specific-members').selectedOptions)
                .map(option => option.value);
            const subject = document.getElementById('broadcast-subject').value;
            const content = document.getElementById('broadcast-content').value;
            const attachmentFile = document.getElementById('broadcast-attachment').files[0];

            if (!subject || !content) {
                showError('Please fill in all required fields');
                return;
            }

            showLoading('Sending broadcast...');

            try {
                // Save attachment to IPFS if provided
                let attachmentHash = '';
                if (attachmentFile) {
                    const attachmentBuffer = await readFileAsBuffer(attachmentFile);
                    const { cid } = await ipfs.add(attachmentBuffer);
                    attachmentHash = cid.toString();
                }

                // Create broadcast record
                const broadcastId = generateId();
                const broadcast = {
                    id: broadcastId,
                    senderId: currentUser.id,
                    groupId: currentGroup.id,
                    audience: audience,
                    specificMembers: specificMembers,
                    subject: subject,
                    content: content,
                    attachment: attachmentHash,
                    createdAt: Date.now()
                };

                // Save to database
                await saveBroadcast(broadcast);

                // Add to blockchain
                const blockData = {
                    type: 'broadcast',
                    broadcastId: broadcastId,
                    senderId: currentUser.id,
                    groupId: currentGroup.id,
                    audience: audience,
                    specificMembers: specificMembers,
                    subject: subject,
                    content: content,
                    attachment: attachmentHash
                };

                await addBlock(blockData);

                hideLoading();
                hideModal('broadcast-message-modal');
                showSuccess('Broadcast sent successfully');
                loadDashboardData();
            } catch (err) {
                hideLoading();
                console.error('Error sending broadcast:', err);
                showError('Failed to send broadcast. Please try again.');
            }
        }

        async function saveBroadcast(broadcast) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['broadcasts'], 'readwrite');
                const store = transaction.objectStore('broadcasts');
                const request = store.put(broadcast);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function submitVote() {
            const voteId = this.getAttribute('data-vote-id');
            const selectedOption = document.querySelector('.voting-option.selected');

            if (!selectedOption) {
                showError('Please select an option');
                return;
            }

            const option = selectedOption.getAttribute('data-option');

            showLoading('Submitting vote...');

            try {
                // Create vote record
                const voteRecordId = generateId();
                const voteRecord = {
                    id: voteRecordId,
                    voteId: voteId,
                    userId: currentUser.id,
                    groupId: currentGroup.id,
                    option: option,
                    createdAt: Date.now()
                };

                // Save to database
                await saveVoteRecord(voteRecord);

                // Add to blockchain
                const blockData = {
                    type: 'vote_record',
                    voteRecordId: voteRecordId,
                    voteId: voteId,
                    userId: currentUser.id,
                    groupId: currentGroup.id,
                    option: option
                };

                await addBlock(blockData);

                hideLoading();
                showSuccess('Vote submitted successfully');
                
                // Show results
                document.getElementById('vote-options').style.display = 'none';
                document.getElementById('vote-results').style.display = 'block';
                document.getElementById('submit-vote-btn').style.display = 'none';
                
                // Load vote results
                await loadVoteResults(voteId);
            } catch (err) {
                hideLoading();
                console.error('Error submitting vote:', err);
                showError('Failed to submit vote. Please try again.');
            }
        }

        async function saveVoteRecord(voteRecord) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['voteRecords'], 'readwrite');
                const store = transaction.objectStore('voteRecords');
                const request = store.put(voteRecord);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function loadVoteResults(voteId) {
            const voteRecords = await getVoteRecords(voteId);
            const vote = await getVoteById(voteId);

            if (!vote) return;

            const resultsContainer = document.getElementById('vote-results');
            resultsContainer.innerHTML = '';

            // Count votes for each option
            const voteCounts = {};
            vote.options.forEach(option => {
                voteCounts[option] = 0;
            });

            voteRecords.forEach(record => {
                voteCounts[record.option]++;
            });

            const totalVotes = voteRecords.length;

            // Display results
            vote.options.forEach(option => {
                const count = voteCounts[option];
                const percentage = totalVotes > 0 ? (count / totalVotes * 100) : 0;

                const resultDiv = document.createElement('div');
                resultDiv.className = 'voting-result';

                const labelDiv = document.createElement('div');
                labelDiv.className = 'voting-result-label';
                labelDiv.innerHTML = `<span>${option}</span><span>${count} votes (${percentage.toFixed(1)}%)</span>`;
                resultDiv.appendChild(labelDiv);

                const barDiv = document.createElement('div');
                barDiv.className = 'voting-result-bar';

                const progressDiv = document.createElement('div');
                progressDiv.className = 'voting-result-progress';
                progressDiv.style.width = `${percentage}%`;
                barDiv.appendChild(progressDiv);

                resultDiv.appendChild(barDiv);
                resultsContainer.appendChild(resultDiv);
            });
        }

        async function getVoteRecords(voteId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['voteRecords'], 'readonly');
                const store = transaction.objectStore('voteRecords');
                const index = store.index('voteId');
                const request = index.getAll(voteId);

                request.onsuccess = function(event) {
                    resolve(event.target.result || []);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function getVoteById(voteId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['votes'], 'readonly');
                const store = transaction.objectStore('votes');
                const request = store.get(voteId);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function processApproval(approved) {
            const approvalId = this.getAttribute('data-approval-id');
            const comment = document.getElementById('approval-comment').value;

            showLoading(approved ? 'Approving...' : 'Rejecting...');

            try {
                // Get approval record
                const approval = await getApprovalById(approvalId);
                
                if (!approval) {
                    hideLoading();
                    showError('Approval not found');
                    return;
                }

                // Update approval status
                approval.status = approved ? 'approved' : 'rejected';
                approval.processedBy = currentUser.id;
                approval.processedAt = Date.now();
                approval.comment = comment;

                // Save to database
                await updateApproval(approval);

                // Add to blockchain
                const blockData = {
                    type: 'approval',
                    approvalId: approvalId,
                    type: approval.type,
                    itemId: approval.itemId,
                    status: approval.status,
                    processedBy: currentUser.id,
                    comment: comment
                };

                await addBlock(blockData);

                // Update the original item based on approval type
                if (approval.type === 'saving') {
                    const saving = await getSavingById(approval.itemId);
                    if (saving) {
                        saving.status = approval.status;
                        await saveSaving(saving);
                    }
                } else if (approval.type === 'loan') {
                    const loan = await getLoanById(approval.itemId);
                    if (loan) {
                        loan.status = approval.status;
                        await saveLoan(loan);
                    }
                } else if (approval.type === 'share') {
                    const share = await getShareById(approval.itemId);
                    if (share) {
                        share.status = approval.status;
                        await saveShare(share);
                    }
                } else if (approval.type === 'share_transaction') {
                    const transaction = await getShareTransactionById(approval.itemId);
                    if (transaction) {
                        transaction.status = approval.status;
                        await saveShareTransaction(transaction);

                        // If approved, transfer shares
                        if (approval.status === 'approved') {
                            await transferShares(transaction);
                        }
                    }
                } else if (approval.type === 'withdrawal') {
                    const withdrawal = await getWithdrawalById(approval.itemId);
                    if (withdrawal) {
                        withdrawal.status = approval.status;
                        await saveWithdrawal(withdrawal);

                        // If approved, process withdrawal
                        if (approval.status === 'approved') {
                            await processWithdrawal(withdrawal);
                        }
                    }
                }

                hideLoading();
                hideModal('approval-modal');
                showSuccess(`Request ${approved ? 'approved' : 'rejected'} successfully`);
                loadDashboardData();
            } catch (err) {
                hideLoading();
                console.error('Error processing approval:', err);
                showError(`Failed to ${approved ? 'approve' : 'reject'} request. Please try again.`);
            }
        }

        async function getApprovalById(approvalId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['approvals'], 'readonly');
                const store = transaction.objectStore('approvals');
                const request = store.get(approvalId);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function updateApproval(approval) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['approvals'], 'readwrite');
                const store = transaction.objectStore('approvals');
                const request = store.put(approval);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function getSavingById(savingId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['savings'], 'readonly');
                const store = transaction.objectStore('savings');
                const request = store.get(savingId);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function getLoanById(loanId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['loans'], 'readonly');
                const store = transaction.objectStore('loans');
                const request = store.get(loanId);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function getShareTransactionById(transactionId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['shareTransactions'], 'readonly');
                const store = transaction.objectStore('shareTransactions');
                const request = store.get(transactionId);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function transferShares(transaction) {
            // Deduct shares from seller
            const share = await getShareById(transaction.shareId);
            if (share) {
                share.amount -= transaction.amount;
                
                if (share.amount <= 0) {
                    await deleteShare(share.id);
                } else {
                    await saveShare(share);
                }
            }

            // Add shares to buyer
            const buyerShares = await getUserShares(transaction.buyerId, transaction.groupId);
            const existingShare = buyerShares.find(s => s.price === transaction.price);

            if (existingShare) {
                existingShare.amount += transaction.amount;
                await saveShare(existingShare);
            } else {
                const newShare = {
                    id: generateId(),
                    userId: transaction.buyerId,
                    groupId: transaction.groupId,
                    amount: transaction.amount,
                    price: transaction.price,
                    status: 'approved',
                    createdAt: Date.now()
                };

                await saveShare(newShare);
            }

            // Record the transaction in blockchain
            const blockData = {
                type: 'share_transfer',
                transactionId: transaction.id,
                buyerId: transaction.buyerId,
                sellerId: transaction.sellerId,
                groupId: transaction.groupId,
                amount: transaction.amount,
                price: transaction.price,
                total: transaction.total
            };

            await addBlock(blockData);
        }

        async function deleteShare(shareId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['shares'], 'readwrite');
                const store = transaction.objectStore('shares');
                const request = store.delete(shareId);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function getWithdrawalById(withdrawalId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['withdrawals'], 'readonly');
                const store = transaction.objectStore('withdrawals');
                const request = store.get(withdrawalId);

                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function saveWithdrawal(withdrawal) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['withdrawals'], 'readwrite');
                const store = transaction.objectStore('withdrawals');
                const request = store.put(withdrawal);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function processWithdrawal(withdrawal) {
            // Deduct amount from user's savings
            const userSavings = await getUserSavings(withdrawal.userId, withdrawal.groupId);
            const totalSavings = userSavings.reduce((sum, saving) => sum + saving.amount, 0);

            if (withdrawal.amount > totalSavings) {
                throw new Error('Withdrawal amount exceeds user savings');
            }

            // For simplicity, we'll just record the withdrawal without actual payment processing
            const blockData = {
                type: 'withdrawal_processed',
                withdrawalId: withdrawal.id,
                userId: withdrawal.userId,
                groupId: withdrawal.groupId,
                amount: withdrawal.amount,
                method: withdrawal.method
            };

            await addBlock(blockData);
        }

        async function sendGift() {
            const recipientId = document.getElementById('gift-recipient').value;
            const amount = parseFloat(document.getElementById('gift-amount').value);
            const message = document.getElementById('gift-message').value;

            if (!recipientId || isNaN(amount) || amount <= 0) {
                showError('Please enter valid gift details');
                return;
            }

            showLoading('Processing gift...');

            try {
                // Check if user has enough savings
                const userSavings = await getUserSavings(currentUser.id, currentGroup.id);
                const totalSavings = userSavings.reduce((sum, saving) => sum + saving.amount, 0);

                if (amount > totalSavings) {
                    hideLoading();
                    showError('Gift amount cannot exceed your total savings');
                    return;
                }

                // Create gift record
                const giftId = generateId();
                const gift = {
                    id: giftId,
                    fromUserId: currentUser.id,
                    toUserId: recipientId,
                    groupId: currentGroup.id,
                    amount: amount,
                    message: message,
                    status: 'pending',
                    createdAt: Date.now()
                };

                // Save to database
                await saveGift(gift);

                // Add to blockchain
                const blockData = {
                    type: 'gift',
                    giftId: giftId,
                    fromUserId: currentUser.id,
                    toUserId: recipientId,
                    groupId: currentGroup.id,
                    amount: amount,
                    message: message,
                    status: 'pending'
                };

                await addBlock(blockData);

                hideLoading();
                hideModal('gift-modal');
                showSuccess('Gift sent successfully');
                loadDashboardData();
            } catch (err) {
                hideLoading();
                console.error('Error sending gift:', err);
                showError('Failed to send gift. Please try again.');
            }
        }

        async function saveGift(gift) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['gifts'], 'readwrite');
                const store = transaction.objectStore('gifts');
                const request = store.put(gift);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function requestWithdrawal() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const method = document.getElementById('withdraw-method').value;
            const mobileNumber = document.getElementById('withdraw-mobile-number').value;
            const bankName = document.getElementById('withdraw-bank-name').value;
            const accountNumber = document.getElementById('withdraw-account-number').value;
            const accountName = document.getElementById('withdraw-account-name').value;

            if (isNaN(amount) || amount <= 0) {
                showError('Please enter a valid amount');
                return;
            }

            if (method === 'mobile_money' && !mobileNumber) {
                showError('Please enter mobile money number');
                return;
            }

            if (method === 'bank' && (!bankName || !accountNumber || !accountName)) {
                showError('Please enter all bank details');
                return;
            }

            showLoading('Processing withdrawal request...');

            try {
                // Check if user has enough savings
                const userSavings = await getUserSavings(currentUser.id, currentGroup.id);
                const totalSavings = userSavings.reduce((sum, saving) => sum + saving.amount, 0);

                if (amount > totalSavings) {
                    hideLoading();
                    showError('Withdrawal amount cannot exceed your total savings');
                    return;
                }

                // Check if withdrawals are enabled
                if (!currentGroup.withdrawalsEnabled) {
                    hideLoading();
                    showError('Withdrawals are currently disabled by the admin');
                    return;
                }

                // Create withdrawal record
                const withdrawalId = generateId();
                const withdrawal = {
                    id: withdrawalId,
                    userId: currentUser.id,
                    groupId: currentGroup.id,
                    amount: amount,
                    method: method,
                    mobileNumber: method === 'mobile_money' ? mobileNumber : '',
                    bankName: method === 'bank' ? bankName : '',
                    accountNumber: method === 'bank' ? accountNumber : '',
                    accountName: method === 'bank' ? accountName : '',
                    status: 'pending',
                    createdAt: Date.now()
                };

                // Save to database
                await saveWithdrawal(withdrawal);

                // Add to blockchain
                const blockData = {
                    type: 'withdrawal',
                    withdrawalId: withdrawalId,
                    userId: currentUser.id,
                    groupId: currentGroup.id,
                    amount: amount,
                    method: method,
                    status: 'pending'
                };

                await addBlock(blockData);

                hideLoading();
                hideModal('withdraw-modal');
                showSuccess('Withdrawal request submitted successfully');
                loadDashboardData();
            } catch (err) {
                hideLoading();
                console.error('Error requesting withdrawal:', err);
                showError('Failed to request withdrawal. Please try again.');
            }
        }

        async function updateGroupSetting(setting, value) {
            if (!currentGroup) return;

            showLoading('Updating settings...');

            try {
                // Update group setting
                currentGroup[setting] = value;
                await saveGroup(currentGroup);

                // Add to blockchain
                const blockData = {
                    type: 'group_setting',
                    groupId: currentGroup.id,
                    setting: setting,
                    value: value,
                    updatedBy: currentUser.id
                };

                await addBlock(blockData);

                hideLoading();
                showSuccess('Settings updated successfully');
                loadDashboardData();
            } catch (err) {
                hideLoading();
                console.error('Error updating settings:', err);
                showError('Failed to update settings. Please try again.');
            }
        }

        async function saveGroupSettings() {
            const name = document.getElementById('group-name').value;
            const currency = document.getElementById('group-currency').value;
            const frequency = document.getElementById('saving-frequency').value;
            const weeklyDay = document.getElementById('weekly-day').value;
            const monthlyDay = document.getElementById('monthly-day').value;
            const amount = parseFloat(document.getElementById('saving-amount').value) || 0;
            const compulsory = document.getElementById('compulsory-saving').value;
            const cycleLength = parseInt(document.getElementById('cycle-length').value);
            const loanInterest = parseFloat(document.getElementById('loan-interest').value);
            const latePenalty = parseFloat(document.getElementById('late-penalty').value);
            const maxGroups = parseInt(document.getElementById('max-groups-per-member').value);
            const sharePrice = parseFloat(document.getElementById('share-price').value);

            if (!name || !currency || !frequency || !compulsory || isNaN(cycleLength) || 
                isNaN(loanInterest) || isNaN(latePenalty) || isNaN(maxGroups) || isNaN(sharePrice)) {
                showError('Please fill in all required fields');
                return;
            }

            showLoading('Saving settings...');

            try {
                // Update group settings
                currentGroup.name = name;
                currentGroup.currency = currency;
                currentGroup.savingFrequency = frequency;
                currentGroup.weeklyDay = frequency === 'weekly' ? weeklyDay : undefined;
                currentGroup.monthlyDay = frequency === 'monthly' ? monthlyDay : undefined;
                currentGroup.savingAmount = amount;
                currentGroup.compulsorySaving = compulsory;
                currentGroup.cycleLength = cycleLength;
                currentGroup.loanInterest = loanInterest;
                currentGroup.latePenalty = latePenalty;
                currentGroup.maxGroupsPerMember = maxGroups;
                currentGroup.sharePrice = sharePrice;

                // Save to database
                await saveGroup(currentGroup);

                // Add to blockchain
                const blockData = {
                    type: 'group_settings',
                    groupId: currentGroup.id,
                    name: name,
                    currency: currency,
                    savingFrequency: frequency,
                    weeklyDay: frequency === 'weekly' ? weeklyDay : undefined,
                    monthlyDay: frequency === 'monthly' ? monthlyDay : undefined,
                    savingAmount: amount,
                    compulsorySaving: compulsory,
                    cycleLength: cycleLength,
                    loanInterest: loanInterest,
                    latePenalty: latePenalty,
                    maxGroupsPerMember: maxGroups,
                    sharePrice: sharePrice,
                    updatedBy: currentUser.id
                };

                await addBlock(blockData);

                hideLoading();
                showSuccess('Settings saved successfully');
                loadDashboardData();
            } catch (err) {
                hideLoading();
                console.error('Error saving settings:', err);
                showError('Failed to save settings. Please try again.');
            }
        }

        async function startNewCycle() {
            if (!currentGroup) return;

            showLoading('Starting new cycle...');

            try {
                // Calculate new cycle dates
                const now = Date.now();
                const cycleLength = currentGroup.cycleLength || 1;
                const cycleEndDate = calculateCycleEndDate(now, cycleLength);

                // Update group cycle
                currentGroup.cycleStartDate = now;
                currentGroup.cycleEndDate = cycleEndDate;
                await saveGroup(currentGroup);

                // Add to blockchain
                const blockData = {
                    type: 'new_cycle',
                    groupId: currentGroup.id,
                    startDate: now,
                    endDate: cycleEndDate,
                    startedBy: currentUser.id
                };

                await addBlock(blockData);

                hideLoading();
                showSuccess('New cycle started successfully');
                loadDashboardData();
            } catch (err) {
                hideLoading();
                console.error('Error starting new cycle:', err);
                showError('Failed to start new cycle. Please try again.');
            }
        }

        async function printSavingsReport() {
            if (!currentGroup) return;

            showLoading('Generating report...');

            try {
                // Get all savings for the group
                const savings = await getGroupSavings(currentGroup.id);
                
                // Sort by date
                savings.sort((a, b) => b.date - a.date);

                // Group by date
                const savingsByDate = {};
                savings.forEach(saving => {
                    const dateStr = formatDate(saving.date);
                    if (!savingsByDate[dateStr]) {
                        savingsByDate[dateStr] = [];
                    }
                    savingsByDate[dateStr].push(saving);
                });

                // Create printable content
                let content = `
                    <h1>Savings Report - ${currentGroup.name}</h1>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                    <hr>
                `;

                for (const date in savingsByDate) {
                    content += `<h2>${date}</h2><table border="1" cellpadding="5" cellspacing="0" width="100%">`;
                    content += '<tr><th>Member</th><th>Amount</th><th>Status</th></tr>';
                    
                    for (const saving of savingsByDate[date]) {
                        const user = await getUserById(saving.userId);
                        content += `
                            <tr>
                                <td>${user ? user.name : 'Unknown'}</td>
                                <td>${currentGroup.currency} ${saving.amount.toLocaleString()}</td>
                                <td>${saving.status}</td>
                            </tr>
                        `;
                    }
                    
                    content += '</table><br>';
                }

                // Calculate totals
                const totalSavings = savings.reduce((sum, s) => sum + s.amount, 0);
                content += `<h3>Total Savings: ${currentGroup.currency} ${totalSavings.toLocaleString()}</h3>`;

                // Open print window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Savings Report - ${currentGroup.name}</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                                th { background-color: #f2f2f2; text-align: left; }
                                @media print {
                                    @page { size: auto; margin: 10mm; }
                                    body { margin: 0; }
                                }
                            </style>
                        </head>
                        <body>
                            ${content}
                            <script>
                                window.onload = function() {
                                    setTimeout(function() {
                                        window.print();
                                        window.close();
                                    }, 200);
                                };
                            </script>
                        </body>
                    </html>
                `);
                printWindow.document.close();

                hideLoading();
            } catch (err) {
                hideLoading();
                console.error('Error generating savings report:', err);
                showError('Failed to generate report. Please try again.');
            }
        }

        async function printLoansReport() {
            if (!currentGroup) return;

            showLoading('Generating report...');

            try {
                // Get all loans for the group
                const loans = await getGroupLoans(currentGroup.id);
                
                // Sort by date
                loans.sort((a, b) => b.createdAt - a.createdAt);

                // Create printable content
                let content = `
                    <h1>Loans Report - ${currentGroup.name}</h1>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                    <hr>
                    <table border="1" cellpadding="5" cellspacing="0" width="100%">
                        <tr>
                            <th>Member</th>
                            <th>Amount</th>
                            <th>Interest</th>
                            <th>Total</th>
                            <th>Due Date</th>
                            <th>Status</th>
                        </tr>
                `;
                
                for (const loan of loans) {
                    const user = await getUserById(loan.userId);
                    const interest = loan.amount * (loan.interestRate / 100) * (loan.period / 30);
                    const total = loan.amount + interest;
                    
                    content += `
                        <tr>
                            <td>${user ? user.name : 'Unknown'}</td>
                            <td>${currentGroup.currency} ${loan.amount.toLocaleString()}</td>
                            <td>${currentGroup.currency} ${interest.toFixed(2)}</td>
                            <td>${currentGroup.currency} ${total.toFixed(2)}</td>
                            <td>${formatDate(loan.dueDate)}</td>
                            <td>${loan.status}</td>
                        </tr>
                    `;
                }
                
                content += '</table>';

                // Calculate totals
                const totalLoans = loans.reduce((sum, l) => sum + l.amount, 0);
                const totalInterest = loans.reduce((sum, l) => sum + (l.amount * (l.interestRate / 100) * (l.period / 30)), 0);
                content += `
                    <h3>Total Loans: ${currentGroup.currency} ${totalLoans.toLocaleString()}</h3>
                    <h3>Total Interest: ${currentGroup.currency} ${totalInterest.toFixed(2)}</h3>
                `;

                // Open print window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Loans Report - ${currentGroup.name}</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                                th { background-color: #f2f2f2; text-align: left; }
                                @media print {
                                    @page { size: auto; margin: 10mm; }
                                    body { margin: 0; }
                                }
                            </style>
                        </head>
                        <body>
                            ${content}
                            <script>
                                window.onload = function() {
                                    setTimeout(function() {
                                        window.print();
                                        window.close();
                                    }, 200);
                                };
                            </script>
                        </body>
                    </html>
                `);
                printWindow.document.close();

                hideLoading();
            } catch (err) {
                hideLoading();
                console.error('Error generating loans report:', err);
                showError('Failed to generate report. Please try again.');
            }
        }

        async function getGroupLoans(groupId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['loans'], 'readonly');
                const store = transaction.objectStore('loans');
                const index = store.index('groupId');
                const request = index.getAll(groupId);

                request.onsuccess = function(event) {
                    resolve(event.target.result || []);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function updateProfile() {
            const name = document.getElementById('profile-name').value;
            const email = document.getElementById('profile-email').value;
            const phone = document.getElementById('profile-phone').value;
            const nextOfKin = document.getElementById('profile-next-of-kin').value;
            const nextOfKinPhone = document.getElementById('profile-next-of-kin-phone').value;
            const location = document.getElementById('profile-location').value;
            const password = document.getElementById('profile-password').value;
            const confirmPassword = document.getElementById('profile-confirm-password').value;

            if (!name || !email || !phone || !nextOfKin || !nextOfKinPhone || !location) {
                showError('Please fill in all required fields');
                return;
            }

            if (password && password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            showLoading('Updating profile...');

            try {
                // Update user data
                currentUser.name = name;
                currentUser.email = email;
                currentUser.phone = phone;
                currentUser.nextOfKin = nextOfKin;
                currentUser.nextOfKinPhone = nextOfKinPhone;
                currentUser.location = location;

                // Update password if changed
                if (password) {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(password);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    currentUser.password = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                }

                // Update avatar if changed
                const avatarInput = document.getElementById('avatar-upload');
                if (avatarInput.files.length > 0) {
                    const file = avatarInput.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        currentUser.avatar = e.target.result;
                        saveUserAndUpdateUI();
                    };
                    reader.readAsDataURL(file);
                } else {
                    await saveUserAndUpdateUI();
                }

                async function saveUserAndUpdateUI() {
                    // Save to database
                    await saveUser(currentUser);

                    // Add to blockchain
                    const blockData = {
                        type: 'profile_update',
                        userId: currentUser.id,
                        name: name,
                        email: email,
                        phone: phone,
                        nextOfKin: nextOfKin,
                        nextOfKinPhone: nextOfKinPhone,
                        location: location
                    };

                    await addBlock(blockData);

                    hideLoading();
                    showSuccess('Profile updated successfully');
                    updateUIForUserRole();
                }
            } catch (err) {
                hideLoading();
                console.error('Error updating profile:', err);
                showError('Failed to update profile. Please try again.');
            }
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show requested section
            document.getElementById(`${sectionId}-section`).style.display = 'block';
            document.getElementById('section-title').textContent = sectionId.charAt(0).toUpperCase() + sectionId.slice(1);

            // Load section data if needed
            if (sectionId === 'savings') {
                loadSavingsSection();
            } else if (sectionId === 'loans') {
                loadLoansSection();
            } else if (sectionId === 'shares') {
                loadSharesSection();
            } else if (sectionId === 'members') {
                loadMembersSection();
            } else if (sectionId === 'timeline') {
                loadTimeline();
            } else if (sectionId === 'messages') {
                loadMessagesSection();
            } else if (sectionId === 'admin') {
                loadAdminSection();
            } else if (sectionId === 'approvals') {
                loadApprovalsSection();
            } else if (sectionId === 'reports') {
                loadReportsSection();
            } else if (sectionId === 'profile') {
                loadProfileSection();
            }
        }

        async function loadSavingsSection() {
            if (!currentGroup) return;

            // Load user savings
            const userSavings = await getUserSavings(currentUser.id, currentGroup.id);
            
            // Populate user savings table
            const tbody = document.querySelector('#user-savings-table tbody');
            tbody.innerHTML = '';

            for (const saving of userSavings) {
                const tr = document.createElement('tr');
                
                const dateTd = document.createElement('td');
                dateTd.textContent = formatDate(saving.date);
                tr.appendChild(dateTd);
                
                const amountTd = document.createElement('td');
                amountTd.textContent = `${currentGroup.currency} ${saving.amount.toLocaleString()}`;
                tr.appendChild(amountTd);
                
                const statusTd = document.createElement('td');
                const statusSpan = document.createElement('span');
                statusSpan.textContent = saving.status === 'approved' ? 'Approved' : 'Pending';
                statusSpan.className = saving.status === 'approved' ? 'badge badge-success' : 'badge badge-warning';
                statusTd.appendChild(statusSpan);
                tr.appendChild(statusTd);
                
                const actionsTd = document.createElement('td');
                if (saving.status !== 'approved') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'btn btn-outline btn-sm';
                    deleteBtn.addEventListener('click', () => deleteSaving(saving.id));
                    actionsTd.appendChild(deleteBtn);
                }
                tr.appendChild(actionsTd);
                
                tbody.appendChild(tr);
            }

            // Load savings history
            loadSavingsHistory();
        }

        async function deleteSaving(savingId) {
            if (confirm('Are you sure you want to delete this saving record?')) {
                showLoading('Deleting saving...');

                try {
                    // Delete from database
                    await deleteSavingRecord(savingId);

                    // Add to blockchain
                    const blockData = {
                        type: 'saving_deleted',
                        savingId: savingId,
                        deletedBy: currentUser.id
                    };

                    await addBlock(blockData);

                    hideLoading();
                    showSuccess('Saving record deleted successfully');
                    loadSavingsSection();
                } catch (err) {
                    hideLoading();
                    console.error('Error deleting saving:', err);
                    showError('Failed to delete saving record. Please try again.');
                }
            }
        }

        async function deleteSavingRecord(savingId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['savings'], 'readwrite');
                const store = transaction.objectStore('savings');
                const request = store.delete(savingId);

                request.onsuccess = function() {
                    resolve();
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function loadSavingsHistory() {
            if (!currentGroup) return;

            // Get all savings for the group
            const savings = await getGroupSavings(currentGroup.id);
            
            // Sort by date (newest first)
            savings.sort((a, b) => b.date - a.date);

            // Group by date
            const savingsByDate = {};
            savings.forEach(saving => {
                const dateStr = formatDate(saving.date);
                if (!savingsByDate[dateStr]) {
                    savingsByDate[dateStr] = [];
                }
                savingsByDate[dateStr].push(saving);
            });

            // Display in history section
            const historyContainer = document.getElementById('savings-history');
            historyContainer.innerHTML = '';

            for (const date in savingsByDate) {
                const dateDiv = document.createElement('div');
                dateDiv.className = 'card mb-3';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'card-header';
                headerDiv.textContent = date;
                dateDiv.appendChild(headerDiv);
                
                const bodyDiv = document.createElement('div');
                bodyDiv.className = 'card-body';
                
                const table = document.createElement('table');
                table.className = 'table';
                
                const thead = document.createElement('thead');
                thead.innerHTML = '<tr><th>Member</th><th>Amount</th><th>Status</th></tr>';
                table.appendChild(thead);
                
                const tbody = document.createElement('tbody');
                
                for (const saving of savingsByDate[date]) {
                    const user = await getUserById(saving.userId);
                    
                    const tr = document.createElement('tr');
                    
                    const nameTd = document.createElement('td');
                    nameTd.textContent = user ? user.name : 'Unknown';
                    tr.appendChild(nameTd);
                    
                    const amountTd = document.createElement('td');
                    amountTd.textContent = `${currentGroup.currency} ${saving.amount.toLocaleString()}`;
                    tr.appendChild(amountTd);
                    
                    const statusTd = document.createElement('td');
                    const statusSpan = document.createElement('span');
                    statusSpan.textContent = saving.status === 'approved' ? 'Approved' : 'Pending';
                    statusSpan.className = saving.status === 'approved' ? 'badge badge-success' : 'badge badge-warning';
                    statusTd.appendChild(statusSpan);
                    tr.appendChild(statusTd);
                    
                    tbody.appendChild(tr);
                }
                
                table.appendChild(tbody);
                bodyDiv.appendChild(table);
                dateDiv.appendChild(bodyDiv);
                historyContainer.appendChild(dateDiv);
            }
        }

        async function loadLoansSection() {
            if (!currentGroup) return;

            // Enable/disable loan button based on group settings
            document.getElementById('apply-loan-btn').disabled = !currentGroup.loansEnabled;

            // Load user loans
            const userLoans = await getUserLoans(currentUser.id, currentGroup.id);
            
            // Populate loans table
            const tbody = document.querySelector('#loans-table tbody');
            tbody.innerHTML = '';

            for (const loan of userLoans) {
                const tr = document.createElement('tr');
                
                const dateTd = document.createElement('td');
                dateTd.textContent = formatDate(loan.createdAt);
                tr.appendChild(dateTd);
                
                const amountTd = document.createElement('td');
                amountTd.textContent = `${currentGroup.currency} ${loan.amount.toLocaleString()}`;
                tr.appendChild(amountTd);
                
                const interestTd = document.createElement('td');
                const interest = loan.amount * (loan.interestRate / 100) * (loan.period / 30);
                interestTd.textContent = `${currentGroup.currency} ${interest.toFixed(2)}`;
                tr.appendChild(interestTd);
                
                const statusTd = document.createElement('td');
                const statusSpan = document.createElement('span');
                statusSpan.textContent = loan.status === 'approved' ? 'Approved' : 
                                        loan.status === 'rejected' ? 'Rejected' : 'Pending';
                statusSpan.className = loan.status === 'approved' ? 'badge badge-success' : 
                                      loan.status === 'rejected' ? 'badge badge-danger' : 'badge badge-warning';
                statusTd.appendChild(statusSpan);
                tr.appendChild(statusTd);
                
                const dueDateTd = document.createElement('td');
                dueDateTd.textContent = formatDate(loan.dueDate);
                tr.appendChild(dueDateTd);
                
                tbody.appendChild(tr);
            }

            // Load pending loans for approval (if admin)
            if (isGroupAdmin) {
                loadPendingLoans();
            }
        }

        async function getUserLoans(userId, groupId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['loans'], 'readonly');
                const store = transaction.objectStore('loans');
                const index = store.index('userId');
                const request = index.getAll(userId);

                request.onsuccess = function(event) {
                    const allLoans = event.target.result || [];
                    const groupLoans = allLoans.filter(loan => loan.groupId === groupId);
                    resolve(groupLoans);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function loadPendingLoans() {
            if (!currentGroup) return;

            // Get all pending loans for the group
            const loans = await getGroupLoans(currentGroup.id);
            const pendingLoans = loans.filter(loan => loan.status === 'pending');
            
            // Display in pending loans section
            const pendingContainer = document.getElementById('pending-loans');
            pendingContainer.innerHTML = '';

            if (pendingLoans.length === 0) {
                pendingContainer.innerHTML = '<p>No pending loans for approval</p>';
                return;
            }

            for (const loan of pendingLoans) {
                const user = await getUserById(loan.userId);
                if (!user) continue;

                const loanCard = document.createElement('div');
                loanCard.className = 'card mb-3';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'card-header d-flex justify-content-between align-items-center';
                headerDiv.innerHTML = `
                    <span>Loan Application from ${user.name}</span>
                    <span>${formatDate(loan.createdAt)}</span>
                `;
                loanCard.appendChild(headerDiv);
                
                const bodyDiv = document.createElement('div');
                bodyDiv.className = 'card-body';
                
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'mb-3';
                detailsDiv.innerHTML = `
                    <p><strong>Amount:</strong> ${currentGroup.currency} ${loan.amount.toLocaleString()}</p>
                    <p><strong>Purpose:</strong> ${loan.purpose}</p>
                    <p><strong>Period:</strong> ${loan.period} days</p>
                    <p><strong>Interest Rate:</strong> ${loan.interestRate}%</p>
                    <p><strong>Total to Pay:</strong> ${currentGroup.currency} ${(loan.amount + (loan.amount * (loan.interestRate / 100) * (loan.period / 30))).toFixed(2)}</p>
                    <p><strong>Due Date:</strong> ${formatDate(loan.dueDate)}</p>
                `;
                bodyDiv.appendChild(detailsDiv);
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'd-flex justify-content-end gap-2';
                
                const rejectBtn = document.createElement('button');
                rejectBtn.textContent = 'Reject';
                rejectBtn.className = 'btn btn-danger';
                rejectBtn.addEventListener('click', () => showApprovalModal(loan.id, 'loan'));
                actionsDiv.appendChild(rejectBtn);
                
                const approveBtn = document.createElement('button');
                approveBtn.textContent = 'Approve';
                approveBtn.className = 'btn btn-success';
                approveBtn.addEventListener('click', () => showApprovalModal(loan.id, 'loan'));
                actionsDiv.appendChild(approveBtn);
                
                bodyDiv.appendChild(actionsDiv);
                loanCard.appendChild(bodyDiv);
                pendingContainer.appendChild(loanCard);
            }
        }

        async function showApprovalModal(itemId, type) {
            // Set approval details in modal
            document.getElementById('approval-title').textContent = `${type === 'loan' ? 'Loan' : 'Saving'} Approval`;
            
            let detailsHtml = '';
            if (type === 'loan') {
                const loan = await getLoanById(itemId);
                const user = await getUserById(loan.userId);
                
                detailsHtml = `
                    <p><strong>Applicant:</strong> ${user.name}</p>
                    <p><strong>Amount:</strong> ${currentGroup.currency} ${loan.amount.toLocaleString()}</p>
                    <p><strong>Purpose:</strong> ${loan.purpose}</p>
                    <p><strong>Period:</strong> ${loan.period} days</p>
                    <p><strong>Interest Rate:</strong> ${loan.interestRate}%</p>
                    <p><strong>Total to Pay:</strong> ${currentGroup.currency} ${(loan.amount + (loan.amount * (loan.interestRate / 100) * (loan.period / 30))).toFixed(2)}</p>
                    <p><strong>Due Date:</strong> ${formatDate(loan.dueDate)}</p>
                `;
            } else if (type === 'saving') {
                const saving = await getSavingById(itemId);
                const user = await getUserById(saving.userId);
                
                detailsHtml = `
                    <p><strong>Member:</strong> ${user.name}</p>
                    <p><strong>Amount:</strong> ${currentGroup.currency} ${saving.amount.toLocaleString()}</p>
                    <p><strong>Date:</strong> ${formatDate(saving.date)}</p>
                `;
                
                if (saving.proof) {
                    detailsHtml += `<p><strong>Proof:</strong> <a href="https://ipfs.io/ipfs/${saving.proof}" target="_blank">View Proof</a></p>`;
                }
            } else if (type === 'share') {
                const share = await getShareById(itemId);
                const user = await getUserById(share.userId);
                
                detailsHtml = `
                    <p><strong>Seller:</strong> ${user.name}</p>
                    <p><strong>Shares:</strong> ${share.amount}</p>
                    <p><strong>Price per Share:</strong> ${currentGroup.currency} ${share.price.toLocaleString()}</p>
                    <p><strong>Total Value:</strong> ${currentGroup.currency} ${(share.amount * share.price).toLocaleString()}</p>
                    ${share.reason ? `<p><strong>Reason:</strong> ${share.reason}</p>` : ''}
                `;
            } else if (type === 'share_transaction') {
                const transaction = await getShareTransactionById(itemId);
                const buyer = await getUserById(transaction.buyerId);
                const seller = await getUserById(transaction.sellerId);
                
                detailsHtml = `
                    <p><strong>Buyer:</strong> ${buyer.name}</p>
                    <p><strong>Seller:</strong> ${seller.name}</p>
                    <p><strong>Shares:</strong> ${transaction.amount}</p>
                    <p><strong>Price per Share:</strong> ${currentGroup.currency} ${transaction.price.toLocaleString()}</p>
                    <p><strong>Total Amount:</strong> ${currentGroup.currency} ${transaction.total.toLocaleString()}</p>
                    <p><strong>Payment Method:</strong> ${transaction.paymentMethod}</p>
                    ${transaction.mobileNumber ? `<p><strong>Mobile Number:</strong> ${transaction.mobileNumber}</p>` : ''}
                `;
            } else if (type === 'withdrawal') {
                const withdrawal = await getWithdrawalById(itemId);
                const user = await getUserById(withdrawal.userId);
                
                detailsHtml = `
                    <p><strong>Member:</strong> ${user.name}</p>
                    <p><strong>Amount:</strong> ${currentGroup.currency} ${withdrawal.amount.toLocaleString()}</p>
                    <p><strong>Method:</strong> ${withdrawal.method}</p>
                    ${withdrawal.mobileNumber ? `<p><strong>Mobile Number:</strong> ${withdrawal.mobileNumber}</p>` : ''}
                    ${withdrawal.bankName ? `<p><strong>Bank Name:</strong> ${withdrawal.bankName}</p>` : ''}
                    ${withdrawal.accountNumber ? `<p><strong>Account Number:</strong> ${withdrawal.accountNumber}</p>` : ''}
                    ${withdrawal.accountName ? `<p><strong>Account Name:</strong> ${withdrawal.accountName}</p>` : ''}
                `;
            }
            
            document.getElementById('approval-details').innerHTML = detailsHtml;
            
            // Set approval buttons data
            document.getElementById('approve-approval-btn').setAttribute('data-approval-id', itemId);
            document.getElementById('reject-approval-btn').setAttribute('data-approval-id', itemId);
            
            // Show modal
            showModal('approval-modal');
        }

        async function loadSharesSection() {
            if (!currentGroup) return;

            // Load user shares
            const userShares = await getUserShares(currentUser.id, currentGroup.id);
            
            // Populate shares table
            const tbody = document.querySelector('#shares-table tbody');
            tbody.innerHTML = '';

            for (const share of userShares) {
                const tr = document.createElement('tr');
                
                const dateTd = document.createElement('td');
                dateTd.textContent = formatDate(share.createdAt);
                tr.appendChild(dateTd);
                
                const amountTd = document.createElement('td');
                amountTd.textContent = share.amount;
                tr.appendChild(amountTd);
                
                const valueTd = document.createElement('td');
                valueTd.textContent = `${currentGroup.currency} ${(share.amount * share.price).toLocaleString()}`;
                tr.appendChild(valueTd);
                
                const statusTd = document.createElement('td');
                const statusSpan = document.createElement('span');
                statusSpan.textContent = share.status === 'approved' ? 'Approved' : 
                                        share.status === 'rejected' ? 'Rejected' : 'Pending';
                statusSpan.className = share.status === 'approved' ? 'badge badge-success' : 
                                      share.status === 'rejected' ? 'badge badge-danger' : 'badge badge-warning';
                statusTd.appendChild(statusSpan);
                tr.appendChild(statusTd);
                
                tbody.appendChild(tr);
            }

            // Load available shares
            loadAvailableShares();
        }

        async function loadAvailableShares() {
            if (!currentGroup) return;

            // Get all shares for the group that are approved and not owned by current user
            const shares = await getGroupShares(currentGroup.id);
            const availableShares = shares.filter(share => 
                share.userId !== currentUser.id && share.status === 'approved'
            );
            
            // Populate available shares table
            const tbody = document.querySelector('#available-shares-table tbody');
            tbody.innerHTML = '';

            for (const share of availableShares) {
                const user = await getUserById(share.userId);
                if (!user) continue;

                const tr = document.createElement('tr');
                
                const sellerTd = document.createElement('td');
                sellerTd.textContent = user.name;
                tr.appendChild(sellerTd);
                
                const amountTd = document.createElement('td');
                amountTd.textContent = share.amount;
                tr.appendChild(amountTd);
                
                const priceTd = document.createElement('td');
                priceTd.textContent = `${currentGroup.currency} ${share.price.toLocaleString()}`;
                tr.appendChild(priceTd);
                
                const actionsTd = document.createElement('td');
                const buyBtn = document.createElement('button');
                buyBtn.textContent = 'Buy';
                buyBtn.className = 'btn btn-primary btn-sm';
                buyBtn.addEventListener('click', () => showBuySharesModal(share.id));
                actionsTd.appendChild(buyBtn);
                tr.appendChild(actionsTd);
                
                tbody.appendChild(tr);
            }
        }

        async function getGroupShares(groupId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['shares'], 'readonly');
                const store = transaction.objectStore('shares');
                const index = store.index('groupId');
                const request = index.getAll(groupId);

                request.onsuccess = function(event) {
                    resolve(event.target.result || []);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function showBuySharesModal(shareId) {
            const share = await getShareById(shareId);
            if (!share) {
                showError('Share not found');
                return;
            }

            // Set share details in form
            document.getElementById('shares-amount').value = share.amount;
            document.getElementById('shares-price').value = share.price;
            document.getElementById('buy-shares-amount').value = '';
            document.getElementById('buy-shares-total').value = '';

            // Set share ID on submit button
            document.getElementById('submit-buy-shares-btn').setAttribute('data-share-id', shareId);

            // Show modal
            showModal('buy-shares-modal');
        }

        async function loadMembersSection() {
            if (!currentGroup) return;

            // Load group members
            const members = await getGroupMembers(currentGroup.id);
            
            // Populate members table
            const tbody = document.querySelector('#all-members-table tbody');
            tbody.innerHTML = '';

            for (const member of members) {
                const tr = document.createElement('tr');
                
                const nameTd = document.createElement('td');
                nameTd.textContent = member.name;
                tr.appendChild(nameTd);
                
                const savingsTd = document.createElement('td');
                const savings = await getUserSavings(member.id, currentGroup.id);
                const totalSavings = savings.reduce((sum, s) => sum + s.amount, 0);
                savingsTd.textContent = `${currentGroup.currency} ${totalSavings.toLocaleString()}`;
                tr.appendChild(savingsTd);
                
                const percentageTd = document.createElement('td');
                const groupSavings = await getGroupSavings(currentGroup.id);
                const groupTotalSavings = groupSavings.reduce((sum, s) => sum + s.amount, 0);
                const percentage = groupTotalSavings > 0 ? (totalSavings / groupTotalSavings * 100) : 0;
                percentageTd.textContent = `${percentage.toFixed(2)}%`;
                tr.appendChild(percentageTd);
                
                const activeTd = document.createElement('td');
                activeTd.textContent = formatDate(member.lastActive);
                tr.appendChild(activeTd);
                
                const actionsTd = document.createElement('td');
                
                if (isGroupAdmin && member.id !== currentUser.id) {
                    if (member.role !== 'admin') {
                        const makeAdminBtn = document.createElement('button');
                        makeAdminBtn.textContent = 'Make Admin';
                        makeAdminBtn.className = 'btn btn-outline btn-sm';
                        makeAdminBtn.addEventListener('click', () => makeMemberAdmin(member.id));
                        actionsTd.appendChild(makeAdminBtn);
                    }
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'Remove';
                    removeBtn.className = 'btn btn-outline btn-sm';
                    removeBtn.addEventListener('click', () => removeMember(member.id));
                    actionsTd.appendChild(removeBtn);
                }
                
                tr.appendChild(actionsTd);
                tbody.appendChild(tr);
            }
        }

        async function makeMemberAdmin(userId) {
            if (confirm('Are you sure you want to make this member an admin?')) {
                showLoading('Updating member role...');

                try {
                    // Update member role
                    await updateGroupMemberRole(userId, currentGroup.id, 'admin');

                    // Add to blockchain
                    const blockData = {
                        type: 'admin_added',
                        groupId: currentGroup.id,
                        userId: userId,
                        addedBy: currentUser.id
                    };

                    await addBlock(blockData);

                    hideLoading();
                    showSuccess('Member role updated successfully');
                    loadMembersSection();
                } catch (err) {
                    hideLoading();
                    console.error('Error updating member role:', err);
                    showError('Failed to update member role. Please try again.');
                }
            }
        }

        async function removeMember(userId) {
            if (confirm('Are you sure you want to remove this member from the group?')) {
                showLoading('Removing member...');

                try {
                    // Delete member from group
                    await deleteGroupMember(userId, currentGroup.id);

                    // Add to blockchain
                    const blockData = {
                        type: 'member_removed',
                        groupId: currentGroup.id,
                        userId: userId,
                        removedBy: currentUser.id
                    };

                    await addBlock(blockData);

                    // If removed member was the current user, go back to dashboard
                    if (userId === currentUser.id) {
                        window.location.reload();
                    } else {
                        hideLoading();
                        showSuccess('Member removed successfully');
                        loadMembersSection();
                    }
                } catch (err) {
                    hideLoading();
                    console.error('Error removing member:', err);
                    showError('Failed to remove member. Please try again.');
                }
            }
        }

        async function deleteGroupMember(userId, groupId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['groupMembers'], 'readwrite');
                const store = transaction.objectStore('groupMembers');
                const index = store.index('userId');
                const request = index.get(userId);

                request.onsuccess = function(event) {
                    const membership = event.target.result;
                    if (membership && membership.groupId === groupId) {
                        const deleteRequest = store.delete(membership.id);

                        deleteRequest.onsuccess = function() {
                            resolve();
                        };

                        deleteRequest.onerror = function(event) {
                            reject(event.target.error);
                        };
                    } else {
                        reject('Membership not found');
                    }
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function loadMessagesSection() {
            if (!currentGroup) return;

            // Load user messages
            const messages = await getUserMessages(currentUser.id);
            
            // Populate messages table
            const tbody = document.querySelector('#messages-table tbody');
            tbody.innerHTML = '';

            for (const message of messages) {
                const sender = await getUserById(message.senderId);
                if (!sender) continue;

                const tr = document.createElement('tr');
                
                const fromTd = document.createElement('td');
                fromTd.textContent = sender.name;
                tr.appendChild(fromTd);
                
                const contentTd = document.createElement('td');
                contentTd.textContent = message.subject;
                tr.appendChild(contentTd);
                
                const dateTd = document.createElement('td');
                dateTd.textContent = formatDate(message.createdAt);
                tr.appendChild(dateTd);
                
                const actionsTd = document.createElement('td');
                const viewBtn = document.createElement('button');
                viewBtn.textContent = 'View';
                viewBtn.className = 'btn btn-outline btn-sm';
                viewBtn.addEventListener('click', () => viewMessage(message.id));
                actionsTd.appendChild(viewBtn);
                tr.appendChild(actionsTd);
                
                tbody.appendChild(tr);
            }

            // Load recipients for new message
            loadMessageRecipients();
        }

        async function getUserMessages(userId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['messages'], 'readonly');
                const store = transaction.objectStore('messages');
                const index = store.index('recipientId');
                const request = index.getAll(userId);

                request.onsuccess = function(event) {
                    const messages = event.target.result || [];
                    // Sort by date (newest first)
                    messages.sort((a, b) => b.createdAt - a.createdAt);
                    resolve(messages);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function viewMessage(messageId) {
            const message = await getMessageById(messageId);
            if (!message) {
                showError('Message not found');
                return;
            }

            const sender = await getUserById(message.senderId);
            if (!sender) {
                showError('Sender not found');
                return;
            }

            // Set message details in modal
            document.getElementById('message-view-subject').textContent = message.subject;
            document.getElementById('message-view-from').textContent = sender.name;
            document.getElementById('message-view-date').textContent = formatDate(message.createdAt);
            document.getElementById('message-view-content').textContent = message.content;
            
            // Set message ID on reply button
            document.getElementById('reply-message-btn').setAttribute('data-message-id', messageId);

            // Mark as read if not already
            if (!message.read) {
                message.read = true;
                await saveMessage(message);
            }

            // Show modal
            showModal('view-message-modal');
        }

        async function loadMessageRecipients() {
            if (!currentGroup) return;

            // Load group members
            const members = await getGroupMembers(currentGroup.id);
            
            // Populate recipient dropdown
            const recipientSelect = document.getElementById('message-recipient');
            recipientSelect.innerHTML = '';

            for (const member of members) {
                if (member.id === currentUser.id) continue;

                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                recipientSelect.appendChild(option);
            }
        }

        async function loadAdminSection() {
            if (!currentGroup || !isGroupAdmin) return;

            // Load group settings into form
            document.getElementById('group-name').value = currentGroup.name;
            document.getElementById('group-currency').value = currentGroup.currency;
            document.getElementById('saving-frequency').value = currentGroup.savingFrequency;
            
            if (currentGroup.savingFrequency === 'weekly') {
                document.getElementById('weekly-day-container').style.display = 'block';
                document.getElementById('weekly-day').value = currentGroup.weeklyDay || '0';
            } else if (currentGroup.savingFrequency === 'monthly') {
                document.getElementById('monthly-day-container').style.display = 'block';
                document.getElementById('monthly-day').value = currentGroup.monthlyDay || '1';
            }
            
            document.getElementById('saving-amount').value = currentGroup.savingAmount || '';
            document.getElementById('compulsory-saving').value = currentGroup.compulsorySaving || 'no';
            document.getElementById('cycle-length').value = currentGroup.cycleLength || '1';
            document.getElementById('loan-interest').value = currentGroup.loanInterest || '10';
            document.getElementById('late-penalty').value = currentGroup.latePenalty || '20';
            document.getElementById('max-groups-per-member').value = currentGroup.maxGroupsPerMember || '2';
            document.getElementById('share-price').value = currentGroup.sharePrice || '1000';
        }

        async function loadApprovalsSection() {
            if (!currentGroup || !isGroupAdmin) return;

            // Get all pending approvals for the group
            const pendingSavings = await getGroupSavings(currentGroup.id);
            const pendingLoans = await getGroupLoans(currentGroup.id);
            const pendingShares = await getGroupShares(currentGroup.id);
            const pendingShareTransactions = await getGroupShareTransactions(currentGroup.id);
            const pendingWithdrawals = await getGroupWithdrawals(currentGroup.id);
            
            const allPending = [
                ...pendingSavings.filter(s => s.status === 'pending').map(s => ({ type: 'saving', item: s })),
                ...pendingLoans.filter(l => l.status === 'pending').map(l => ({ type: 'loan', item: l })),
                ...pendingShares.filter(s => s.status === 'pending').map(s => ({ type: 'share', item: s })),
                ...pendingShareTransactions.filter(t => t.status === 'pending').map(t => ({ type: 'share_transaction', item: t })),
                ...pendingWithdrawals.filter(w => w.status === 'pending').map(w => ({ type: 'withdrawal', item: w }))
            ];

            // Sort by date (oldest first)
            allPending.sort((a, b) => a.item.createdAt - b.item.createdAt);

            // Display in approvals section
            const approvalsContainer = document.getElementById('pending-approvals');
            approvalsContainer.innerHTML = '';

            if (allPending.length === 0) {
                approvalsContainer.innerHTML = '<p>No pending approvals</p>';
                return;
            }

            for (const pending of allPending) {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'card-header d-flex justify-content-between align-items-center';
                
                let typeText = '';
                if (pending.type === 'saving') typeText = 'Saving';
                else if (pending.type === 'loan') typeText = 'Loan';
                else if (pending.type === 'share') typeText = 'Share Listing';
                else if (pending.type === 'share_transaction') typeText = 'Share Purchase';
                else if (pending.type === 'withdrawal') typeText = 'Withdrawal';
                
                headerDiv.innerHTML = `
                    <span>${typeText} Approval</span>
                    <span>${formatDate(pending.item.createdAt)}</span>
                `;
                card.appendChild(headerDiv);
                
                const bodyDiv = document.createElement('div');
                bodyDiv.className = 'card-body';
                
                const user = await getUserById(pending.item.userId);
                if (user) {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'mb-3';
                    userDiv.innerHTML = `<strong>From:</strong> ${user.name}`;
                    bodyDiv.appendChild(userDiv);
                }
                
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'mb-3';
                
                if (pending.type === 'saving') {
                    detailsDiv.innerHTML = `
                        <p><strong>Amount:</strong> ${currentGroup.currency} ${pending.item.amount.toLocaleString()}</p>
                        <p><strong>Date:</strong> ${formatDate(pending.item.date)}</p>
                    `;
                } else if (pending.type === 'loan') {
                    const interest = pending.item.amount * (pending.item.interestRate / 100) * (pending.item.period / 30);
                    detailsDiv.innerHTML = `
                        <p><strong>Amount:</strong> ${currentGroup.currency} ${pending.item.amount.toLocaleString()}</p>
                        <p><strong>Purpose:</strong> ${pending.item.purpose}</p>
                        <p><strong>Period:</strong> ${pending.item.period} days</p>
                        <p><strong>Interest Rate:</strong> ${pending.item.interestRate}%</p>
                        <p><strong>Total to Pay:</strong> ${currentGroup.currency} ${(pending.item.amount + interest).toFixed(2)}</p>
                        <p><strong>Due Date:</strong> ${formatDate(pending.item.dueDate)}</p>
                    `;
                } else if (pending.type === 'share') {
                    detailsDiv.innerHTML = `
                        <p><strong>Shares:</strong> ${pending.item.amount}</p>
                        <p><strong>Price per Share:</strong> ${currentGroup.currency} ${pending.item.price.toLocaleString()}</p>
                        <p><strong>Total Value:</strong> ${currentGroup.currency} ${(pending.item.amount * pending.item.price).toLocaleString()}</p>
                        ${pending.item.reason ? `<p><strong>Reason:</strong> ${pending.item.reason}</p>` : ''}
                    `;
                } else if (pending.type === 'share_transaction') {
                    const buyer = await getUserById(pending.item.buyerId);
                    const seller = await getUserById(pending.item.sellerId);
                    
                    detailsDiv.innerHTML = `
                        <p><strong>Buyer:</strong> ${buyer.name}</p>
                        <p><strong>Seller:</strong> ${seller.name}</p>
                        <p><strong>Shares:</strong> ${pending.item.amount}</p>
                        <p><strong>Price per Share:</strong> ${currentGroup.currency} ${pending.item.price.toLocaleString()}</p>
                        <p><strong>Total Amount:</strong> ${currentGroup.currency} ${pending.item.total.toLocaleString()}</p>
                        <p><strong>Payment Method:</strong> ${pending.item.paymentMethod}</p>
                        ${pending.item.mobileNumber ? `<p><strong>Mobile Number:</strong> ${pending.item.mobileNumber}</p>` : ''}
                    `;
                } else if (pending.type === 'withdrawal') {
                    detailsDiv.innerHTML = `
                        <p><strong>Amount:</strong> ${currentGroup.currency} ${pending.item.amount.toLocaleString()}</p>
                        <p><strong>Method:</strong> ${pending.item.method}</p>
                        ${pending.item.mobileNumber ? `<p><strong>Mobile Number:</strong> ${pending.item.mobileNumber}</p>` : ''}
                        ${pending.item.bankName ? `<p><strong>Bank Name:</strong> ${pending.item.bankName}</p>` : ''}
                        ${pending.item.accountNumber ? `<p><strong>Account Number:</strong> ${pending.item.accountNumber}</p>` : ''}
                        ${pending.item.accountName ? `<p><strong>Account Name:</strong> ${pending.item.accountName}</p>` : ''}
                    `;
                }
                
                bodyDiv.appendChild(detailsDiv);
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'd-flex justify-content-end gap-2';
                
                const rejectBtn = document.createElement('button');
                rejectBtn.textContent = 'Reject';
                rejectBtn.className = 'btn btn-danger';
                rejectBtn.addEventListener('click', () => showApprovalModal(pending.item.id, pending.type));
                actionsDiv.appendChild(rejectBtn);
                
                const approveBtn = document.createElement('button');
                approveBtn.textContent = 'Approve';
                approveBtn.className = 'btn btn-success';
                approveBtn.addEventListener('click', () => showApprovalModal(pending.item.id, pending.type));
                actionsDiv.appendChild(approveBtn);
                
                bodyDiv.appendChild(actionsDiv);
                card.appendChild(bodyDiv);
                approvalsContainer.appendChild(card);
            }
        }

        async function getGroupShareTransactions(groupId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['shareTransactions'], 'readonly');
                const store = transaction.objectStore('shareTransactions');
                const index = store.index('groupId');
                const request = index.getAll(groupId);

                request.onsuccess = function(event) {
                    resolve(event.target.result || []);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function getGroupWithdrawals(groupId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['withdrawals'], 'readonly');
                const store = transaction.objectStore('withdrawals');
                const index = store.index('groupId');
                const request = index.getAll(groupId);

                request.onsuccess = function(event) {
                    resolve(event.target.result || []);
                };

                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }

        async function loadReportsSection() {
            if (!currentGroup) return;

            // Get all transactions for the group
            const savings = await getGroupSavings(currentGroup.id);
            const loans = await getGroupLoans(currentGroup.id);
            
            // Combine and sort by date (newest first)
            const allTransactions = [
                ...savings.map(s => ({ ...s, type: 'saving' })),
                ...loans.map(l => ({ ...l, type: 'loan' }))
            ].sort((a, b) => b.createdAt - a.createdAt);

            // Populate reports table
            const tbody = document.querySelector('#reports-table tbody');
            tbody.innerHTML = '';

            for (const transaction of allTransactions.slice(0, 50)) { // Show only recent 50
                const user = await getUserById(transaction.userId);
                if (!user) continue;

                const tr = document.createElement('tr');
                
                const dateTd = document.createElement('td');
                dateTd.textContent = formatDate(transaction.createdAt);
                tr.appendChild(dateTd);
                
                const userTd = document.createElement('td');
                userTd.textContent = user.name;
                tr.appendChild(userTd);
                
                const amountTd = document.createElement('td');
                amountTd.textContent = `${currentGroup.currency} ${transaction.amount.toLocaleString()}`;
                tr.appendChild(amountTd);
                
                const typeTd = document.createElement('td');
                typeTd.textContent = transaction.type === 'saving' ? 'Saving' : 'Loan';
                tr.appendChild(typeTd);
                
                const statusTd = document.createElement('td');
                const statusSpan = document.createElement('span');
                statusSpan.textContent = transaction.status === 'approved' ? 'Approved' : 
                                        transaction.status === 'rejected' ? 'Rejected' : 'Pending';
                statusSpan.className = transaction.status === 'approved' ? 'badge badge-success' : 
                                      transaction.status === 'rejected' ? 'badge badge-danger' : 'badge badge-warning';
                statusTd.appendChild(statusSpan);
                tr.appendChild(statusTd);
                
                tbody.appendChild(tr);
            }
        }

        async function loadProfileSection() {
            if (!currentUser) return;

            // Load user data into form
            document.getElementById('profile-name').value = currentUser.name;
            document.getElementById('profile-email').value = currentUser.email;
            document.getElementById('profile-phone').value = currentUser.phone;
            document.getElementById('profile-next-of-kin').value = currentUser.nextOfKin;
            document.getElementById('profile-next-of-kin-phone').value = currentUser.nextOfKinPhone;
            document.getElementById('profile-location').value = currentUser.location;
            document.getElementById('profile-avatar').src = currentUser.avatar || 'https://via.placeholder.com/100';
        }

        function showAuth() {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('dashboard-container').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'flex';
            document.title = currentGroup ? `${currentGroup.name} - Kiira Save` : 'Kiira Save';
        }

        function logoutUser() {
            currentUser = null;
            currentGroup = null;
            isSuperAdmin = false;
            isGroupAdmin = false;
            showAuth();
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showLoading(message) {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-modal').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading-modal').classList.remove('active');
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.textContent = message;
            
            // Insert at the top of the auth card or current section
            const container = document.getElementById('auth-container').style.display !== 'none' ? 
                document.getElementById('auth-container') : 
                document.querySelector('.content-section[style="display: block;"]');
            
            if (container) {
                container.insertBefore(errorDiv, container.firstChild);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success';
            successDiv.textContent = message;
            
            // Insert at the top of the auth card or current section
            const container = document.getElementById('auth-container').style.display !== 'none' ? 
                document.getElementById('auth-container') : 
                document.querySelector('.content-section[style="display: block;"]');
            
            if (container) {
                container.insertBefore(successDiv, container.firstChild);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    successDiv.remove();
                }, 5000);
            }
        }

        // Initialize service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }).catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
