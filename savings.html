<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiira Save - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .sidebar {
            background-color: white;
            min-height: 100vh;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar .nav-link {
            color: var(--dark-color);
            border-radius: 5px;
            margin-bottom: 5px;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: var(--light-color);
            color: var(--primary-color);
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        
        .main-content {
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .savings-progress {
            height: 20px;
            border-radius: 10px;
        }
        
        .timeline {
            position: relative;
            padding-left: 50px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--light-color);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -40px;
            top: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--primary-color);
            border: 3px solid white;
        }
        
        .broadcast-message {
            animation: slideIn 0.5s ease-out;
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050;
            width: 80%;
            max-width: 800px;
        }
        
        @keyframes slideIn {
            from { top: -100px; opacity: 0; }
            to { top: 60px; opacity: 1; }
        }
        
        .login-container {
            max-width: 400px;
            margin: 0 auto;
            padding-top: 50px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo img {
            height: 80px;
        }
        
        .logo h1 {
            color: var(--primary-color);
            font-weight: bold;
            margin-top: 10px;
        }
        
        .form-floating label {
            color: #6c757d;
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 3rem;
            height: 3rem;
        }
        
        .currency-selector {
            max-width: 100px;
        }
        
        .saving-day-selector {
            max-width: 150px;
        }
        
        .member-card {
            transition: transform 0.2s;
        }
        
        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .vote-progress {
            height: 10px;
        }
        
        .loan-calculator {
            background-color: var(--light-color);
            border-radius: 10px;
            padding: 15px;
        }
        
        .share-market-item {
            border-left: 4px solid var(--warning-color);
            padding-left: 10px;
        }
        
        .advert-card {
            border: 1px solid var(--light-color);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .advert-img {
            height: 150px;
            object-fit: cover;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.7rem;
        }
        
        .mobile-money-logo {
            height: 30px;
            margin-right: 10px;
        }
        
        .cycle-progress {
            height: 10px;
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            body {
                background-color: white;
                color: black;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Login/Signup Modal -->
    <div id="authContainer" class="login-container">
        <div class="logo">
            <h1>Kiira Save</h1>
            <p class="text-muted">A product of Skysoft Technologies</p>
        </div>
        <div id="loginForm">
            <div class="card">
                <div class="card-header text-center">
                    <h4>Login to Your Account</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="loginEmail" class="form-label">Email or Phone</label>
                        <input type="text" class="form-control" id="loginEmail" placeholder="Enter your email or phone">
                    </div>
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="rememberMe">
                        <label class="form-check-label" for="rememberMe">Remember me</label>
                    </div>
                    <button id="loginBtn" class="btn btn-primary w-100">Login</button>
                    <div class="auth-toggle mt-3">
                        <p>Don't have an account? <a href="#" id="showSignup">Sign up</a></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="signupForm" style="display: none;">
            <div class="card">
                <div class="card-header text-center">
                    <h4>Create New Account</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="signupName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="signupName" placeholder="Enter your full name">
                    </div>
                    <div class="mb-3">
                        <label for="signupEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="signupEmail" placeholder="Enter your email">
                        <div class="form-text">We'll send a verification code to this email</div>
                    </div>
                    <div class="mb-3">
                        <label for="signupPhone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="signupPhone" placeholder="Enter your phone number">
                        <div class="form-text">We'll send a verification code to this number</div>
                    </div>
                    <div class="mb-3">
                        <label for="signupPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="signupPassword" placeholder="Create a password">
                    </div>
                    <div class="mb-3">
                        <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="signupConfirmPassword" placeholder="Confirm your password">
                    </div>
                    <div class="mb-3">
                        <label for="signupNextOfKin" class="form-label">Next of Kin Name</label>
                        <input type="text" class="form-control" id="signupNextOfKin" placeholder="Enter next of kin name">
                    </div>
                    <div class="mb-3">
                        <label for="signupNextOfKinPhone" class="form-label">Next of Kin Phone</label>
                        <input type="tel" class="form-control" id="signupNextOfKinPhone" placeholder="Enter next of kin phone">
                    </div>
                    <div class="mb-3">
                        <label for="signupLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="signupLocation" placeholder="Enter your location">
                    </div>
                    <div class="mb-3">
                        <label for="groupSearch" class="form-label">Group Name (if joining existing group)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="groupSearch" placeholder="Search for group">
                            <button class="btn btn-outline-secondary" type="button" id="searchGroupBtn">Search</button>
                        </div>
                        <div id="groupSearchResults" class="mt-2" style="display: none;">
                            <div class="list-group" id="groupResultsList"></div>
                        </div>
                    </div>
                    <div id="newGroupFields" style="display: none;">
                        <div class="mb-3">
                            <label for="newGroupName" class="form-label">New Group Name</label>
                            <input type="text" class="form-control" id="newGroupName" placeholder="Enter new group name">
                        </div>
                        <div class="mb-3">
                            <label for="groupCurrency" class="form-label">Group Currency</label>
                            <select class="form-select" id="groupCurrency">
                                <option value="UGX">UGX - Ugandan Shilling</option>
                                <option value="KES">KES - Kenyan Shilling</option>
                                <option value="TZS">TZS - Tanzanian Shilling</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                            </select>
                        </div>
                    </div>
                    <button id="signupBtn" class="btn btn-primary w-100">Sign Up</button>
                    <div class="auth-toggle mt-3">
                        <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (hidden until login) -->
    <div id="appContainer" style="display: none;">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container-fluid">
                <a class="navbar-brand" href="#" id="appTitle">Kiira Save</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" id="dashboardLink"><i class="fas fa-home"></i> Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="savingsLink"><i class="fas fa-piggy-bank"></i> Savings</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="loansLink"><i class="fas fa-hand-holding-usd"></i> Loans</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="sharesLink"><i class="fas fa-chart-line"></i> Shares</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="membersLink"><i class="fas fa-users"></i> Members</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="messagesLink">
                                <i class="fas fa-envelope"></i> Messages
                                <span id="messageBadge" class="badge bg-danger notification-badge" style="display: none;">0</span>
                            </a>
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown">
                                <img id="profileNavImg" src="https://via.placeholder.com/40" alt="Profile" class="profile-img me-1">
                                <span id="profileNavName">User</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" id="profileLink"><i class="fas fa-user"></i> Profile</a></li>
                                <li><a class="dropdown-item" href="#" id="settingsLink"><i class="fas fa-cog"></i> Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Broadcast Message Container -->
        <div id="broadcastContainer" class="broadcast-message" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span id="broadcastTitle">Broadcast Message</span>
                    <button type="button" class="btn-close" aria-label="Close" id="closeBroadcast"></button>
                </div>
                <div class="card-body" id="broadcastContent">
                    Loading broadcast message...
                </div>
            </div>
        </div>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3 col-lg-2 d-md-block sidebar collapse no-print" id="sidebarMenu">
                    <div class="position-sticky pt-3">
                        <div class="text-center mb-4">
                            <img id="sidebarProfileImg" src="https://via.placeholder.com/100" alt="Profile" class="profile-img mb-2" style="width: 80px; height: 80px;">
                            <h5 id="sidebarProfileName">User Name</h5>
                            <p class="text-muted" id="sidebarProfileRole">Member</p>
                        </div>
                        
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" id="sidebarDashboard">
                                    <i class="fas fa-home"></i> Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" id="sidebarSavings">
                                    <i class="fas fa-piggy-bank"></i> My Savings
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" id="sidebarLoans">
                                    <i class="fas fa-hand-holding-usd"></i> Loans
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" id="sidebarShares">
                                    <i class="fas fa-chart-line"></i> Shares Market
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" id="sidebarMembers">
                                    <i class="fas fa-users"></i> Group Members
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" id="sidebarMessages">
                                    <i class="fas fa-envelope"></i> Messages
                                    <span id="sidebarMessageBadge" class="badge bg-danger notification-badge" style="display: none;">0</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" id="sidebarTimeline">
                                    <i class="fas fa-stream"></i> Group Timeline
                                </a>
                            </li>
                            <li class="nav-item admin-only" style="display: none;">
                                <a class="nav-link" href="#" id="sidebarAdmin">
                                    <i class="fas fa-user-shield"></i> Admin Panel
                                </a>
                            </li>
                            <li class="nav-item superadmin-only" style="display: none;">
                                <a class="nav-link" href="#" id="sidebarSuperAdmin">
                                    <i class="fas fa-crown"></i> Super Admin
                                </a>
                            </li>
                        </ul>

                        <hr>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">My Savings Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted">Your Savings</small>
                                    <h5 id="sidebarSavingsAmount">UGX 0</h5>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Group Total</small>
                                    <h5 id="sidebarGroupTotal">UGX 0</h5>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Your Percentage</small>
                                    <div class="progress savings-progress">
                                        <div id="sidebarSavingsPercentage" class="progress-bar bg-success" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Next Saving Day</h6>
                            </div>
                            <div class="card-body text-center">
                                <h4 id="sidebarNextSavingDay">--</h4>
                                <p class="text-muted mb-2" id="sidebarNextSavingAmount">Amount: UGX 0</p>
                                <button class="btn btn-sm btn-primary w-100" id="sidebarSaveNowBtn">Save Now</button>
                            </div>
                        </div>

                        <!-- Advert Space -->
                        <div class="card advert-card">
                            <div class="card-header">
                                <h6 class="mb-0">Advertisement</h6>
                            </div>
                            <div class="card-body p-0">
                                <img id="sidebarAdvertImg" src="https://via.placeholder.com/300x150?text=Advert+Space" alt="Advertisement" class="w-100 advert-img">
                                <div class="p-2">
                                    <h6 id="sidebarAdvertTitle">Advert Title</h6>
                                    <p class="small text-muted" id="sidebarAdvertContent">Advert content goes here...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                    <!-- Dashboard Content -->
                    <div id="dashboardContent">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Dashboard</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group me-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="printDashboardBtn">
                                        <i class="fas fa-print"></i> Print
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card text-white bg-primary mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="card-title">Your Savings</h6>
                                                <h2 id="dashboardSavingsAmount">UGX 0</h2>
                                            </div>
                                            <i class="fas fa-piggy-bank fa-3x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-white bg-success mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="card-title">Group Total</h6>
                                                <h2 id="dashboardGroupTotal">UGX 0</h2>
                                            </div>
                                            <i class="fas fa-users fa-3x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-white bg-info mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="card-title">Your Percentage</h6>
                                                <h2 id="dashboardSavingsPercentage">0%</h2>
                                            </div>
                                            <i class="fas fa-chart-pie fa-3x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Savings Progress</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Your Savings</span>
                                                <span id="dashboardProgressAmount">UGX 0 of UGX 0</span>
                                            </div>
                                            <div class="progress" style="height: 20px;">
                                                <div id="dashboardProgressBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%"></div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Group Cycle Progress</span>
                                                <span id="dashboardCycleProgressText">Day 0 of 30</span>
                                            </div>
                                            <div class="progress" style="height: 10px;">
                                                <div id="dashboardCycleProgressBar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card mb-4">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Recent Activities</h5>
                                        <a href="#" id="viewAllActivities">View All</a>
                                    </div>
                                    <div class="card-body">
                                        <div class="timeline" id="recentActivities">
                                            <!-- Timeline items will be added here dynamically -->
                                            <div class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Upcoming Events</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="upcomingEvents">
                                            <!-- Events will be added here dynamically -->
                                            <div class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Quick Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-primary w-100 mb-2" id="quickSaveBtn">
                                            <i class="fas fa-coins me-1"></i> Make Saving
                                        </button>
                                        <button class="btn btn-success w-100 mb-2" id="quickLoanBtn" disabled>
                                            <i class="fas fa-hand-holding-usd me-1"></i> Apply for Loan
                                        </button>
                                        <button class="btn btn-info w-100 mb-2" id="quickGiftBtn">
                                            <i class="fas fa-gift me-1"></i> Gift a Member
                                        </button>
                                        <button class="btn btn-warning w-100 mb-2" id="quickSharesBtn">
                                            <i class="fas fa-chart-line me-1"></i> Shares Market
                                        </button>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Top Savers</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="topSaversList">
                                            <!-- Top savers will be added here dynamically -->
                                            <div class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Savings Content -->
                    <div id="savingsContent" style="display: none;">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">My Savings</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group me-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="printSavingsBtn">
                                        <i class="fas fa-print"></i> Print
                                    </button>
                                </div>
                                <button type="button" class="btn btn-sm btn-primary" id="newSavingBtn">
                                    <i class="fas fa-plus"></i> New Saving
                                </button>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Saving Summary</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <tbody>
                                                    <tr>
                                                        <th>Total Saved</th>
                                                        <td id="savingsTotalAmount">UGX 0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Last Saving</th>
                                                        <td id="savingsLastDate">--</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Last Amount</th>
                                                        <td id="savingsLastAmount">UGX 0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Next Saving Day</th>
                                                        <td id="savingsNextDate">--</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Next Amount</th>
                                                        <td id="savingsNextAmount">UGX 0</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Saving Progress</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Current Cycle</span>
                                                <span id="savingsCycleProgressText">Day 0 of 30</span>
                                            </div>
                                            <div class="progress" style="height: 10px;">
                                                <div id="savingsCycleProgressBar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Your Savings</span>
                                                <span id="savingsProgressAmount">UGX 0 of UGX 0</span>
                                            </div>
                                            <div class="progress" style="height: 20px;">
                                                <div id="savingsProgressBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%"></div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Group Total</span>
                                                <span id="savingsGroupTotal">UGX 0</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>Your Percentage</span>
                                                <span id="savingsPercentage">0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Saving History</h5>
                                <div>
                                    <select class="form-select form-select-sm d-inline-block w-auto" id="savingsHistoryFilter">
                                        <option value="all">All</option>
                                        <option value="month">This Month</option>
                                        <option value="cycle">Current Cycle</option>
                                        <option value="year">This Year</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Amount</th>
                                                <th>Status</th>
                                                <th>Confirmed By</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="savingsHistoryTable">
                                            <!-- Savings history will be added here dynamically -->
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loans Content -->
                    <div id="loansContent" style="display: none;">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Loans</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group me-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="printLoansBtn">
                                        <i class="fas fa-print"></i> Print
                                    </button>
                                </div>
                                <button type="button" class="btn btn-sm btn-primary" id="newLoanBtn" disabled>
                                    <i class="fas fa-plus"></i> Apply for Loan
                                </button>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Loan Summary</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <tbody>
                                                    <tr>
                                                        <th>Current Loan</th>
                                                        <td id="loanCurrentAmount">UGX 0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Total Payable</th>
                                                        <td id="loanTotalPayable">UGX 0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Amount Paid</th>
                                                        <td id="loanAmountPaid">UGX 0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Balance</th>
                                                        <td id="loanBalance">UGX 0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Due Date</th>
                                                        <td id="loanDueDate">--</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Status</th>
                                                        <td id="loanStatus">--</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Loan Calculator</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="loan-calculator">
                                            <div class="mb-3">
                                                <label for="loanCalcAmount" class="form-label">Loan Amount</label>
                                                <input type="number" class="form-control" id="loanCalcAmount" placeholder="Enter amount">
                                            </div>
                                            <div class="mb-3">
                                                <label for="loanCalcPeriod" class="form-label">Repayment Period</label>
                                                <select class="form-select" id="loanCalcPeriod">
                                                    <option value="7">1 Week</option>
                                                    <option value="30">1 Month</option>
                                                    <option value="90">3 Months</option>
                                                    <option value="180">6 Months</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Interest Rate</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="loanCalcInterest" value="10" readonly>
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                            <button class="btn btn-primary w-100" id="calculateLoanBtn">Calculate</button>
                                            <hr>
                                            <div class="text-center">
                                                <h5>Loan Summary</h5>
                                                <p class="mb-1">Total Interest: <span id="loanCalcTotalInterest">UGX 0</span></p>
                                                <p class="mb-1">Total Payable: <span id="loanCalcTotalPayable">UGX 0</span></p>
                                                <p>Daily Payment: <span id="loanCalcDailyPayment">UGX 0</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">My Loans</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Amount</th>
                                                <th>Interest</th>
                                                <th>Total</th>
                                                <th>Due Date</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="loansHistoryTable">
                                            <!-- Loans history will be added here dynamically -->
                                            <tr>
                                                <td colspan="7" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Pending Loan Approvals</h5>
                            </div>
                            <div class="card-body">
                                <div id="pendingLoansList">
                                    <!-- Pending loans will be added here dynamically -->
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shares Content -->
                    <div id="sharesContent" style="display: none;">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Shares Market</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group me-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="printSharesBtn">
                                        <i class="fas fa-print"></i> Print
                                    </button>
                                </div>
                                <button type="button" class="btn btn-sm btn-primary" id="newShareBtn">
                                    <i class="fas fa-plus"></i> Sell Shares
                                </button>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">My Shares</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <tbody>
                                                    <tr>
                                                        <th>Total Shares</th>
                                                        <td id="sharesTotalAmount">0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Share Value</th>
                                                        <td id="sharesValue">UGX 0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Total Value</th>
                                                        <td id="sharesTotalValue">UGX 0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Shares for Sale</th>
                                                        <td id="sharesForSale">0</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Buy Shares</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="buySharesAmount" class="form-label">Amount to Invest</label>
                                            <input type="number" class="form-control" id="buySharesAmount" placeholder="Enter amount">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Estimated Shares</label>
                                            <input type="text" class="form-control" id="buySharesEstimate" readonly>
                                        </div>
                                        <button class="btn btn-success w-100" id="buySharesBtn" disabled>Buy Shares</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Available Shares</h5>
                            </div>
                            <div class="card-body">
                                <div id="sharesMarketList">
                                    <!-- Shares market will be added here dynamically -->
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Shares Transactions</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>Shares</th>
                                                <th>Amount</th>
                                                <th>Counterparty</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sharesTransactionsTable">
                                            <!-- Shares transactions will be added here dynamically -->
                                            <tr>
                                                <td colspan="6" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Members Content -->
                    <div id="membersContent" style="display: none;">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Group Members</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group me-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="printMembersBtn">
                                        <i class="fas fa-print"></i> Print
                                    </button>
                                </div>
                                <button type="button" class="btn btn-sm btn-primary admin-only" id="inviteMemberBtn" style="display: none;">
                                    <i class="fas fa-user-plus"></i> Invite Member
                                </button>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Group Summary</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <tbody>
                                                    <tr>
                                                        <th>Total Members</th>
                                                        <td id="membersTotalCount">0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Active Members</th>
                                                        <td id="membersActiveCount">0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Group Savings</th>
                                                        <td id="membersGroupTotal">UGX 0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Current Cycle</th>
                                                        <td id="membersCycleInfo">Day 0 of 30</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Next Saving Day</th>
                                                        <td id="membersNextSaving">--</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Savings Distribution</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="savingsDistributionChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">All Members</h5>
                                <div>
                                    <input type="text" class="form-control form-control-sm" id="membersSearch" placeholder="Search members...">
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row" id="membersList">
                                    <!-- Members will be added here dynamically -->
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card admin-only" style="display: none;">
                            <div class="card-header">
                                <h5 class="mb-0">Pending Approvals</h5>
                            </div>
                            <div class="card-body">
                                <div id="pendingApprovalsList">
                                    <!-- Pending approvals will be added here dynamically -->
                                    <div class="text-center py-4">
                                        <p>No pending approvals</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Messages Content -->
                    <div id="messagesContent" style="display: none;">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Messages</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <button type="button" class="btn btn-sm btn-primary" id="newMessageBtn">
                                    <i class="fas fa-plus"></i> New Message
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="Search messages...">
                                            <button class="btn btn-outline-secondary" type="button">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="list-group list-group-flush" id="messagesInbox">
                                        <!-- Messages will be added here dynamically -->
                                        <div class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0" id="messageSubject">Select a message</h5>
                                        <div>
                                            <button class="btn btn-sm btn-outline-danger" id="deleteMessageBtn" disabled>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" id="replyMessageBtn" disabled>
                                                <i class="fas fa-reply"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body" id="messageContent">
                                        <div class="text-center py-5">
                                            <i class="fas fa-envelope-open-text fa-3x text-muted mb-3"></i>
                                            <p>Select a message to read</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Content -->
                    <div id="profileContent" style="display: none;">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">My Profile</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="printProfileBtn">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Profile Picture</h5>
                                    </div>
                                    <div class="card-body text-center">
                                        <img id="profilePicture" src="https://via.placeholder.com/150" alt="Profile" class="profile-img mb-3" style="width: 150px; height: 150px;">
                                        <div>
                                            <button class="btn btn-sm btn-primary" id="changeProfilePicBtn">
                                                <i class="fas fa-camera"></i> Change Picture
                                            </button>
                                            <input type="file" id="profilePicUpload" accept="image/*" style="display: none;">
                                        </div>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Security</h5>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-warning w-100 mb-2" id="changePasswordBtn">
                                            <i class="fas fa-lock"></i> Change Password
                                        </button>
                                        <button class="btn btn-danger w-100" id="deactivateAccountBtn">
                                            <i class="fas fa-user-slash"></i> Deactivate Account
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-8">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Personal Information</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="profileForm">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="profileName" class="form-label">Full Name</label>
                                                    <input type="text" class="form-control" id="profileName">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="profileUsername" class="form-label">Username</label>
                                                    <input type="text" class="form-control" id="profileUsername">
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="profileEmail" class="form-label">Email</label>
                                                    <input type="email" class="form-control" id="profileEmail" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="profilePhone" class="form-label">Phone</label>
                                                    <input type="tel" class="form-control" id="profilePhone">
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="profileLocation" class="form-label">Location</label>
                                                <input type="text" class="form-control" id="profileLocation">
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="profileNextOfKin" class="form-label">Next of Kin</label>
                                                    <input type="text" class="form-control" id="profileNextOfKin">
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="profileNextOfKinPhone" class="form-label">Next of Kin Phone</label>
                                                    <input type="tel" class="form-control" id="profileNextOfKinPhone">
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary" id="saveProfileBtn">Save Changes</button>
                                        </form>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Groups</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="userGroupsList">
                                            <!-- User groups will be added here dynamically -->
                                            <div class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Panel Content -->
                    <div id="adminContent" style="display: none;">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Admin Panel</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="printAdminBtn">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Quick Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-primary w-100 mb-2" id="adminAddSavingBtn">
                                            <i class="fas fa-plus-circle"></i> Add Saving
                                        </button>
                                        <button class="btn btn-success w-100 mb-2" id="adminSettingsBtn">
                                            <i class="fas fa-cog"></i> Group Settings
                                        </button>
                                        <button class="btn btn-info w-100 mb-2" id="adminReportsBtn">
                                            <i class="fas fa-chart-bar"></i> Reports
                                        </button>
                                        <button class="btn btn-warning w-100 mb-2" id="adminBroadcastBtn">
                                            <i class="fas fa-bullhorn"></i> Broadcast
                                        </button>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Group Statistics</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table">
                                                <tbody>
                                                    <tr>
                                                        <th>Active Members</th>
                                                        <td id="adminActiveMembers">0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Inactive Members</th>
                                                        <td id="adminInactiveMembers">0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Total Savings</th>
                                                        <td id="adminTotalSavings">UGX 0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Pending Savings</th>
                                                        <td id="adminPendingSavings">UGX 0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Active Loans</th>
                                                        <td id="adminActiveLoans">0</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Shares on Market</th>
                                                        <td id="adminSharesMarket">0</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-8">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Recent Activities</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="timeline" id="adminActivities">
                                            <!-- Admin activities will be added here dynamically -->
                                            <div class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Pending Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="adminPendingActions">
                                            <!-- Pending actions will be added here dynamically -->
                                            <div class="text-center py-4">
                                                <p>No pending actions</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">All Members Savings</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Member</th>
                                                <th>Total Saved</th>
                                                <th>Percentage</th>
                                                <th>Last Saved</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminMembersSavings">
                                            <!-- Members savings will be added here dynamically -->
                                            <tr>
                                                <td colspan="6" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Savings History</h5>
                            </div>
                            <div class="card-body">
                                <div id="adminSavingsHistory">
                                    <!-- Savings history will be added here dynamically -->
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Super Admin Content -->
                    <div id="superAdminContent" style="display: none;">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Super Admin Panel</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="printSuperAdminBtn">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Quick Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-primary w-100 mb-2" id="superAdminBroadcastBtn">
                                            <i class="fas fa-bullhorn"></i> Broadcast Message
                                        </button>
                                        <button class="btn btn-success w-100 mb-2" id="superAdminSettingsBtn">
                                            <i class="fas fa-cog"></i> System Settings
                                        </button>
                                        <button class="btn btn-info w-100 mb-2" id="superAdminAdvertsBtn">
                                            <i class="fas fa-ad"></i> Advertisements
                                        </button>
                                        <button class="btn btn-warning w-100 mb-2" id="superAdminSubscriptionsBtn">
                                            <i class="fas fa-money-bill-wave"></i> Subscriptions
                                        </button>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">System Statistics</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table">
                                            <tbody>
                                                <tr>
                                                    <th>Total Groups</th>
                                                    <td id="superAdminTotalGroups">0</td>
                                                </tr>
                                                <tr>
                                                    <th>Active Groups</th>
                                                    <td id="superAdminActiveGroups">0</td>
                                                </tr>
                                                <tr>
                                                    <th>Inactive Groups</th>
                                                    <td id="superAdminInactiveGroups">0</td>
                                                </tr>
                                                <tr>
                                                    <th>Total Members</th>
                                                    <td id="superAdminTotalMembers">0</td>
                                                </tr>
                                                <tr>
                                                    <th>Subscribed Groups</th>
                                                    <td id="superAdminSubscribedGroups">0</td>
                                                </tr>
                                                <tr>
                                                    <th>Pending Subscriptions</th>
                                                    <td id="superAdminPendingSubscriptions">0</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Recent Activities</h5>
                                </div>
                                <div class="card-body">
                                    <div class="timeline" id="superAdminActivities">
                                        <!-- Super admin activities will be added here dynamically -->
                                        <div class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Pending Approvals</h5>
                                </div>
                                <div class="card-body">
                                    <div id="superAdminPendingApprovals">
                                        <!-- Pending approvals will be added here dynamically -->
                                        <div class="text-center py-4">
                                            <p>No pending approvals</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">All Groups</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Group Name</th>
                                            <th>Members</th>
                                            <th>Savings</th>
                                            <th>Cycle</th>
                                            <th>Status</th>
                                            <th>Subscription</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="superAdminGroupsList">
                                        <!-- Groups list will be added here dynamically -->
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">System Logs</h5>
                        </div>
                        <div class="card-body">
                            <div id="superAdminLogs">
                                <!-- System logs will be added here dynamically -->
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <!-- New Saving Modal -->
    <div class="modal fade" id="newSavingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Saving</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newSavingForm">
                        <div class="mb-3">
                            <label for="savingAmount" class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text" id="savingCurrency">UGX</span>
                                <input type="number" class="form-control" id="savingAmount" placeholder="Enter amount">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="savingDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="savingDate">
                        </div>
                        <div class="mb-3">
                            <label for="savingMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="savingMethod">
                                <option value="cash">Cash</option>
                                <option value="mobile_money">Mobile Money</option>
                                <option value="bank">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="mb-3" id="savingReferenceField" style="display: none;">
                            <label for="savingReference" class="form-label">Transaction Reference</label>
                            <input type="text" class="form-control" id="savingReference" placeholder="Enter reference">
                        </div>
                        <div class="mb-3">
                            <label for="savingNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="savingNotes" rows="2" placeholder="Optional notes"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitSavingBtn">Submit Saving</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Add Saving Modal -->
    <div class="modal fade" id="adminAddSavingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Saving for Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="adminAddSavingForm">
                        <div class="mb-3">
                            <label for="adminSavingMember" class="form-label">Member</label>
                            <select class="form-select" id="adminSavingMember">
                                <!-- Members will be added here dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="adminSavingAmount" class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text" id="adminSavingCurrency">UGX</span>
                                <input type="number" class="form-control" id="adminSavingAmount" placeholder="Enter amount">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="adminSavingDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="adminSavingDate">
                        </div>
                        <div class="mb-3">
                            <label for="adminSavingMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="adminSavingMethod">
                                <option value="cash">Cash</option>
                                <option value="mobile_money">Mobile Money</option>
                                <option value="bank">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="mb-3" id="adminSavingReferenceField" style="display: none;">
                            <label for="adminSavingReference" class="form-label">Transaction Reference</label>
                            <input type="text" class="form-control" id="adminSavingReference" placeholder="Enter reference">
                        </div>
                        <div class="mb-3">
                            <label for="adminSavingNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="adminSavingNotes" rows="2" placeholder="Optional notes"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitAdminSavingBtn">Add Saving</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Loan Modal -->
    <div class="modal fade" id="newLoanModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Apply for Loan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newLoanForm">
                        <div class="mb-3">
                            <label for="loanAmount" class="form-label">Loan Amount</label>
                            <div class="input-group">
                                <span class="input-group-text" id="loanCurrency">UGX</span>
                                <input type="number" class="form-control" id="loanAmount" placeholder="Enter amount">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="loanPurpose" class="form-label">Purpose</label>
                            <textarea class="form-control" id="loanPurpose" rows="2" placeholder="Explain the purpose of this loan"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="loanPeriod" class="form-label">Repayment Period</label>
                            <select class="form-select" id="loanPeriod">
                                <option value="7">1 Week</option>
                                <option value="30">1 Month</option>
                                <option value="90">3 Months</option>
                                <option value="180">6 Months</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Interest Rate</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="loanInterest" value="10" readonly>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total Payable</label>
                            <div class="input-group">
                                <span class="input-group-text">UGX</span>
                                <input type="text" class="form-control" id="loanTotalPayableCalc" readonly>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitLoanBtn">Apply for Loan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loan Details Modal -->
    <div class="modal fade" id="loanDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Loan Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <th>Loan Amount</th>
                                    <td id="loanDetailAmount">UGX 0</td>
                                </tr>
                                <tr>
                                    <th>Interest Rate</th>
                                    <td id="loanDetailInterest">0%</td>
                                </tr>
                                <tr>
                                    <th>Total Payable</th>
                                    <td id="loanDetailTotal">UGX 0</td>
                                </tr>
                                <tr>
                                    <th>Amount Paid</th>
                                    <td id="loanDetailPaid">UGX 0</td>
                                </tr>
                                <tr>
                                    <th>Balance</th>
                                    <td id="loanDetailBalance">UGX 0</td>
                                </tr>
                                <tr>
                                    <th>Due Date</th>
                                    <td id="loanDetailDueDate">--</td>
                                </tr>
                                <tr>
                                    <th>Status</th>
                                    <td id="loanDetailStatus">--</td>
                                </tr>
                                <tr>
                                    <th>Approval Votes</th>
                                    <td id="loanDetailVotes">0/0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="loanPaymentsSection">
                        <h6 class="mt-3">Payment History</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                    </tr>
                                </thead>
                                <tbody id="loanPaymentsTable">
                                    <!-- Payments will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="loanActionsSection" class="mt-3">
                        <button class="btn btn-success w-100 mb-2" id="makeLoanPaymentBtn">Make Payment</button>
                        <button class="btn btn-info w-100 mb-2" id="viewLoanTimelineBtn">View Timeline</button>
                        <button class="btn btn-warning w-100" id="requestLoanExtensionBtn">Request Extension</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Make Loan Payment Modal -->
    <div class="modal fade" id="loanPaymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Make Loan Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loanPaymentForm">
                        <div class="mb-3">
                            <label for="loanPaymentAmount" class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text" id="loanPaymentCurrency">UGX</span>
                                <input type="number" class="form-control" id="loanPaymentAmount" placeholder="Enter amount">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="loanPaymentDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="loanPaymentDate">
                        </div>
                        <div class="mb-3">
                            <label for="loanPaymentMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="loanPaymentMethod">
                                <option value="cash">Cash</option>
                                <option value="mobile_money">Mobile Money</option>
                                <option value="bank">Bank Transfer</option>
                            </select>
                        </div>
                        <div class="mb-3" id="loanPaymentReferenceField" style="display: none;">
                            <label for="loanPaymentReference" class="form-label">Transaction Reference</label>
                            <input type="text" class="form-control" id="loanPaymentReference" placeholder="Enter reference">
                        </div>
                        <div class="mb-3">
                            <label for="loanPaymentNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="loanPaymentNotes" rows="2" placeholder="Optional notes"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitLoanPaymentBtn">Submit Payment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Share Modal -->
    <div class="modal fade" id="newShareModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sell Shares</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newShareForm">
                        <div class="mb-3">
                            <label for="shareAmount" class="form-label">Number of Shares</label>
                            <input type="number" class="form-control" id="shareAmount" placeholder="Enter number of shares">
                        </div>
                        <div class="mb-3">
                            <label for="sharePrice" class="form-label">Price per Share</label>
                            <div class="input-group">
                                <span class="input-group-text" id="shareCurrency">UGX</span>
                                <input type="number" class="form-control" id="sharePrice" placeholder="Enter price per share">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="shareNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="shareNotes" rows="2" placeholder="Optional notes"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitShareBtn">List Shares</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Details Modal -->
    <div class="modal fade" id="shareDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Share Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <th>Seller</th>
                                    <td id="shareDetailSeller">--</td>
                                </tr>
                                <tr>
                                    <th>Shares Available</th>
                                    <td id="shareDetailAmount">0</td>
                                </tr>
                                <tr>
                                    <th>Price per Share</th>
                                    <td id="shareDetailPrice">UGX 0</td>
                                </tr>
                                <tr>
                                    <th>Total Value</th>
                                    <td id="shareDetailTotal">UGX 0</td>
                                </tr>
                                <tr>
                                    <th>Listed On</th>
                                    <td id="shareDetailDate">--</td>
                                </tr>
                                <tr>
                                    <th>Status</th>
                                    <td id="shareDetailStatus">--</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="shareBuySection" class="mt-3">
                        <div class="mb-3">
                            <label for="shareBuyQuantity" class="form-label">Number of Shares to Buy</label>
                            <input type="number" class="form-control" id="shareBuyQuantity" placeholder="Enter quantity">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total Cost</label>
                            <div class="input-group">
                                <span class="input-group-text">UGX</span>
                                <input type="text" class="form-control" id="shareBuyTotal" readonly>
                            </div>
                        </div>
                        <button class="btn btn-success w-100" id="buyShareBtn">Buy Shares</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gift Modal -->
    <div class="modal fade" id="giftModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gift a Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="giftForm">
                        <div class="mb-3">
                            <label for="giftRecipient" class="form-label">Recipient</label>
                            <select class="form-select" id="giftRecipient">
                                <!-- Members will be added here dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="giftAmount" class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text" id="giftCurrency">UGX</span>
                                <input type="number" class="form-control" id="giftAmount" placeholder="Enter amount">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="giftMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="giftMessage" rows="3" placeholder="Optional message"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitGiftBtn">Send Gift</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invite Member Modal -->
    <div class="modal fade" id="inviteMemberModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Invite New Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="inviteMemberForm">
                        <div class="mb-3">
                            <label for="inviteEmail" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="inviteEmail" placeholder="Enter email">
                        </div>
                        <div class="mb-3">
                            <label for="invitePhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="invitePhone" placeholder="Enter phone">
                        </div>
                        <div class="mb-3">
                            <label for="inviteName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="inviteName" placeholder="Enter name">
                        </div>
                        <div class="mb-3">
                            <label for="inviteMessage" class="form-label">Personal Message</label>
                            <textarea class="form-control" id="inviteMessage" rows="3" placeholder="Optional message"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitInviteBtn">Send Invitation</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Message Modal -->
    <div class="modal fade" id="newMessageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newMessageForm">
                        <div class="mb-3">
                            <label for="messageRecipient" class="form-label">To</label>
                            <select class="form-select" id="messageRecipient">
                                <!-- Recipients will be added here dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="messageSubject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="messageSubject" placeholder="Enter subject">
                        </div>
                        <div class="mb-3">
                            <label for="messageContent" class="form-label">Message</label>
                            <textarea class="form-control" id="messageContentText" rows="5" placeholder="Enter your message"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitMessageBtn">Send Message</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" placeholder="Enter current password">
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" placeholder="Enter new password">
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm new password">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitChangePasswordBtn">Change Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Deactivate Account Modal -->
    <div class="modal fade" id="deactivateAccountModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Deactivate Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to deactivate your account? You will no longer be able to access your savings and other group activities.</p>
                    <p class="text-danger">This action cannot be undone. You will need to contact your group admin to reactivate your account.</p>
                    <form id="deactivateAccountForm">
                        <div class="mb-3">
                            <label for="deactivatePassword" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="deactivatePassword" placeholder="Enter your password">
                        </div>
                        <div class="mb-3">
                            <label for="deactivateReason" class="form-label">Reason (Optional)</label>
                            <textarea class="form-control" id="deactivateReason" rows="2" placeholder="Why are you deactivating your account?"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="submitDeactivateBtn">Deactivate Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Settings Modal -->
    <div class="modal fade" id="adminSettingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Group Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="adminSettingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general-settings" type="button" role="tab">General</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="savings-tab" data-bs-toggle="tab" data-bs-target="#savings-settings" type="button" role="tab">Savings</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="loans-tab" data-bs-toggle="tab" data-bs-target="#loans-settings" type="button" role="tab">Loans</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="shares-tab" data-bs-toggle="tab" data-bs-target="#shares-settings" type="button" role="tab">Shares</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="members-tab" data-bs-toggle="tab" data-bs-target="#members-settings" type="button" role="tab">Members</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3" id="adminSettingsContent">
                        <div class="tab-pane fade show active" id="general-settings" role="tabpanel">
                            <form id="generalSettingsForm">
                                <div class="mb-3">
                                    <label for="groupNameSetting" class="form-label">Group Name</label>
                                    <input type="text" class="form-control" id="groupNameSetting">
                                </div>
                                <div class="mb-3">
                                    <label for="groupCurrencySetting" class="form-label">Currency</label>
                                    <select class="form-select" id="groupCurrencySetting">
                                        <option value="UGX">UGX - Ugandan Shilling</option>
                                        <option value="KES">KES - Kenyan Shilling</option>
                                        <option value="TZS">TZS - Tanzanian Shilling</option>
                                        <option value="USD">USD - US Dollar</option>
                                        <option value="EUR">EUR - Euro</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="groupDescriptionSetting" class="form-label">Description</label>
                                    <textarea class="form-control" id="groupDescriptionSetting" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="savings-settings" role="tabpanel">
                            <form id="savingsSettingsForm">
                                <div class="mb-3">
                                    <label for="savingFrequencySetting" class="form-label">Saving Frequency</label>
                                    <select class="form-select" id="savingFrequencySetting">
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="annually">Annually</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="weeklyDaySetting" style="display: none;">
                                    <label for="savingDaySetting" class="form-label">Day of Week</label>
                                    <select class="form-select" id="savingDaySetting">
                                        <option value="0">Sunday</option>
                                        <option value="1">Monday</option>
                                        <option value="2">Tuesday</option>
                                        <option value="3">Wednesday</option>
                                        <option value="4">Thursday</option>
                                        <option value="5">Friday</option>
                                        <option value="6">Saturday</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="monthlyDateSetting" style="display: none;">
                                    <label for="savingDateSetting" class="form-label">Date of Month</label>
                                    <select class="form-select" id="savingDateSetting">
                                        <!-- Dates 1-31 will be added here dynamically -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="savingAmountSetting" class="form-label">Saving Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text" id="savingAmountCurrency">UGX</span>
                                        <input type="number" class="form-control" id="savingAmountSetting" placeholder="Enter amount">
                                    </div>
                                    <div class="form-text">Set to 0 if members can save any amount</div>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="savingCompulsorySetting">
                                    <label class="form-check-label" for="savingCompulsorySetting">Compulsory Saving</label>
                                </div>
                                <div class="mb-3" id="savingPenaltySetting" style="display: none;">
                                    <label for="penaltyAmountSetting" class="form-label">Penalty for Missing Saving</label>
                                    <div class="input-group">
                                        <span class="input-group-text" id="penaltyAmountCurrency">UGX</span>
                                        <input type="number" class="form-control" id="penaltyAmountSetting" placeholder="Enter penalty amount">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="cycleLengthSetting" class="form-label">Cycle Length (Days)</label>
                                    <input type="number" class="form-control" id="cycleLengthSetting" placeholder="Enter number of days">
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="loans-settings" role="tabpanel">
                            <form id="loansSettingsForm">
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="loansEnabledSetting">
                                    <label class="form-check-label" for="loansEnabledSetting">Enable Loans</label>
                                </div>
                                <div class="mb-3">
                                    <label for="loanInterestSetting" class="form-label">Default Interest Rate</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="loanInterestSetting" placeholder="Enter interest rate">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="loanMaxAmountSetting" class="form-label">Maximum Loan Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text">UGX</span>
                                        <input type="number" class="form-control" id="loanMaxAmountSetting" placeholder="Enter maximum amount">
                                        <span class="input-group-text">or</span>
                                        <input type="number" class="form-control" id="loanMaxPercentageSetting" placeholder="Enter percentage">
                                        <span class="input-group-text">% of savings</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="loanVoteThresholdSetting" class="form-label">Approval Threshold</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="loanVoteThresholdSetting" placeholder="Enter percentage">
                                        <span class="input-group-text">% of members must approve</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="loanLatePenaltySetting" class="form-label">Late Payment Penalty</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="loanLatePenaltySetting" placeholder="Enter percentage">
                                        <span class="input-group-text">% daily interest on overdue amount</span>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="shares-settings" role="tabpanel">
                            <form id="sharesSettingsForm">
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="sharesEnabledSetting">
                                    <label class="form-check-label" for="sharesEnabledSetting">Enable Shares Market</label>
                                </div>
                                <div class="mb-3">
                                    <label for="shareValueSetting" class="form-label">Share Value</label>
                                    <div class="input-group">
                                        <span class="input-group-text">UGX</span>
                                        <input type="number" class="form-control" id="shareValueSetting" placeholder="Enter value per share">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="shareMinSetting" class="form-label">Minimum Shares to Sell</label>
                                    <input type="number" class="form-control" id="shareMinSetting" placeholder="Enter minimum shares">
                                </div>
                                <div class="mb-3">
                                    <label for="shareMaxSetting" class="form-label">Maximum Shares to Sell</label>
                                    <input type="number" class="form-control" id="shareMaxSetting" placeholder="Enter maximum shares">
                                </div>
                                <div class="mb-3">
                                    <label for="shareVoteThresholdSetting" class="form-label">Approval Threshold</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="shareVoteThresholdSetting" placeholder="Enter percentage">
                                        <span class="input-group-text">% of members must approve</span>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="members-settings" role="tabpanel">
                            <form id="membersSettingsForm">
                                <div class="mb-3">
                                    <label for="memberDisplaySetting" class="form-label">Display Members' Balances As</label>
                                    <select class="form-select" id="memberDisplaySetting">
                                        <option value="percentage">Percentage Only</option>
                                        <option value="amount">Amount Only</option>
                                        <option value="both">Both Percentage and Amount</option>
                                    </select>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="memberInactivitySetting">
                                    <label class="form-check-label" for="memberInactivitySetting">Enable Inactivity Monitoring</label>
                                </div>
                                <div class="mb-3" id="inactivityDaysSetting" style="display: none;">
                                    <label for="inactivityThresholdSetting" class="form-label">Days of Inactivity Before Action</label>
                                    <input type="number" class="form-control" id="inactivityThresholdSetting" placeholder="Enter number of days">
                                </div>
                                <div class="mb-3" id="inactivityActionSetting" style="display: none;">
                                    <label for="inactivityActionTypeSetting" class="form-label">Action to Take</label>
                                    <select class="form-select" id="inactivityActionTypeSetting">
                                        <option value="warning">Send Warning</option>
                                        <option value="suspend">Suspend Account</option>
                                        <option value="sell_shares">Sell Shares</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="adminTransferSetting" class="form-label">Admin Transfer Process</label>
                                    <select class="form-select" id="adminTransferSetting">
                                        <option value="vote">Vote by Members</option>
                                        <option value="appoint">Appoint by Current Admin</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="voteThresholdSetting" class="form-label">Vote Threshold for Admin Changes</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="voteThresholdSetting" placeholder="Enter percentage">
                                        <span class="input-group-text">% of members must approve</span>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Broadcast Modal -->
    <div class="modal fade" id="adminBroadcastModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Broadcast Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="adminBroadcastForm">
                        <div class="mb-3">
                            <label for="broadcastRecipients" class="form-label">Recipients</label>
                            <select class="form-select" id="broadcastRecipients">
                                <option value="all">All Group Members</option>
                                <option value="active">Active Members Only</option>
                                <option value="inactive">Inactive Members Only</option>
                                <option value="selected">Selected Members</option>
                            </select>
                        </div>
                        <div class="mb-3" id="broadcastMembersSelect" style="display: none;">
                            <label class="form-label">Select Members</label>
                            <div class="form-control" style="height: 150px; overflow-y: auto;" id="broadcastMembersList">
                                <!-- Members will be added here dynamically -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="broadcastSubject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="broadcastSubject" placeholder="Enter subject">
                        </div>
                        <div class="mb-3">
                            <label for="broadcastMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="broadcastMessage" rows="5" placeholder="Enter your message"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitBroadcastBtn">Send Broadcast</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Super Admin Broadcast Modal -->
    <div class="modal fade" id="superAdminBroadcastModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Broadcast Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="superAdminBroadcastForm">
                        <div class="mb-3">
                            <label for="superBroadcastRecipients" class="form-label">Recipients</label>
                            <select class="form-select" id="superBroadcastRecipients">
                                <option value="all">All Members</option>
                                <option value="admins">Group Admins Only</option>
                                <option value="members">Members Only (No Admins)</option>
                                <option value="group">Specific Group</option>
                            </select>
                        </div>
                        <div class="mb-3" id="superBroadcastGroupSelect" style="display: none;">
                            <label class="form-label">Select Group</label>
                            <select class="form-select" id="superBroadcastGroup">
                                <!-- Groups will be added here dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="superBroadcastSubject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="superBroadcastSubject" placeholder="Enter subject">
                        </div>
                        <div class="mb-3">
                            <label for="superBroadcastMessage" class="form-label">Message</label>
                            <textarea class="form-control" id="superBroadcastMessage" rows="5" placeholder="Enter your message"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="superBroadcastAttachment" class="form-label">Attachment (Optional)</label>
                            <input type="file" class="form-control" id="superBroadcastAttachment">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitSuperBroadcastBtn">Send Broadcast</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Super Admin Settings Modal -->
    <div class="modal fade" id="superAdminSettingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">System Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="superAdminSettingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="system-tab" data-bs-toggle="tab" data-bs-target="#system-settings" type="button" role="tab">System</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="subscription-tab" data-bs-toggle="tab" data-bs-target="#subscription-settings" type="button" role="tab">Subscriptions</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="adverts-tab" data-bs-toggle="tab" data-bs-target="#adverts-settings" type="button" role="tab">Advertisements</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="succession-tab" data-bs-toggle="tab" data-bs-target="#succession-settings" type="button" role="tab">Succession</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3" id="superAdminSettingsContent">
                        <div class="tab-pane fade show active" id="system-settings" role="tabpanel">
                            <form id="systemSettingsForm">
                                <div class="mb-3">
                                    <label for="systemNameSetting" class="form-label">System Name</label>
                                    <input type="text" class="form-control" id="systemNameSetting" value="Kiira Save">
                                </div>
                                <div class="mb-3">
                                    <label for="systemCurrencySetting" class="form-label">Default Currency</label>
                                    <select class="form-select" id="systemCurrencySetting">
                                        <option value="UGX">UGX - Ugandan Shilling</option>
                                        <option value="KES">KES - Kenyan Shilling</option>
                                        <option value="TZS">TZS - Tanzanian Shilling</option>
                                        <option value="USD">USD - US Dollar</option>
                                        <option value="EUR">EUR - Euro</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="systemInactivitySetting" class="form-label">Group Inactivity Threshold (Days)</label>
                                    <input type="number" class="form-control" id="systemInactivitySetting" placeholder="Enter number of days">
                                </div>
                                <div class="mb-3">
                                    <label for="systemMaxGroupsSetting" class="form-label">Maximum Groups per Member</label>
                                    <input type="number" class="form-control" id="systemMaxGroupsSetting" placeholder="Enter maximum number">
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="systemEmailVerificationSetting">
                                    <label class="form-check-label" for="systemEmailVerificationSetting">Require Email Verification</label>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="systemPhoneVerificationSetting">
                                    <label class="form-check-label" for="systemPhoneVerificationSetting">Require Phone Verification</label>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="subscription-settings" role="tabpanel">
                            <form id="subscriptionSettingsForm">
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="subscriptionEnabledSetting">
                                    <label class="form-check-label" for="subscriptionEnabledSetting">Enable Group Subscriptions</label>
                                </div>
                                <div class="mb-3">
                                    <label for="subscriptionAmountSetting" class="form-label">Subscription Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text">UGX</span>
                                        <input type="number" class="form-control" id="subscriptionAmountSetting" placeholder="Enter amount">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="subscriptionPeriodSetting" class="form-label">Subscription Period</label>
                                    <select class="form-select" id="subscriptionPeriodSetting">
                                        <option value="30">Monthly</option>
                                        <option value="365">Annual</option>
                                        <option value="730">2 Years</option>
                                        <option value="1095">3 Years</option>
                                        <option value="1825">5 Years</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="subscriptionPaymentMethods" class="form-label">Payment Methods</label>
                                    <select class="form-select" id="subscriptionPaymentMethods" multiple>
                                        <option value="mobile_money">Mobile Money</option>
                                        <option value="bank">Bank Transfer</option>
                                        <option value="cash">Cash</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="subscriptionMobileMoneyNumber" class="form-label">Mobile Money Number</label>
                                    <input type="tel" class="form-control" id="subscriptionMobileMoneyNumber" placeholder="Enter number">
                                </div>
                                <div class="mb-3">
                                    <label for="subscriptionBankDetails" class="form-label">Bank Account Details</label>
                                    <textarea class="form-control" id="subscriptionBankDetails" rows="3" placeholder="Enter bank details"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="subscriptionGracePeriod" class="form-label">Grace Period After Expiry (Days)</label>
                                    <input type="number" class="form-control" id="subscriptionGracePeriod" placeholder="Enter number of days">
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="adverts-settings" role="tabpanel">
                            <form id="advertsSettingsForm">
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="advertsEnabledSetting">
                                    <label class="form-check-label" for="advertsEnabledSetting">Enable Advertisements</label>
                                </div>
                                <div class="mb-3">
                                    <label for="advertDurationSetting" class="form-label">Default Advert Duration (Seconds)</label>
                                    <input type="number" class="form-control" id="advertDurationSetting" placeholder="Enter seconds">
                                </div>
                                <div class="mb-3">
                                    <label for="advertPriceSetting" class="form-label">Advert Price per Day</label>
                                    <div class="input-group">
                                        <span class="input-group-text">UGX</span>
                                        <input type="number" class="form-control" id="advertPriceSetting" placeholder="Enter amount">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="advertMaxImageSize" class="form-label">Maximum Image Size (KB)</label>
                                    <input type="number" class="form-control" id="advertMaxImageSize" placeholder="Enter size in KB">
                                </div>
                                <div class="mb-3">
                                    <label for="advertAllowedTypes" class="form-label">Allowed File Types</label>
                                    <input type="text" class="form-control" id="advertAllowedTypes" placeholder="e.g., .jpg, .png, .gif">
                                </div>
                                <div class="mb-3">
                                    <label for="advertPaymentMethods" class="form-label">Payment Methods</label>
                                    <select class="form-select" id="advertPaymentMethods" multiple>
                                        <option value="mobile_money">Mobile Money</option>
                                        <option value="bank">Bank Transfer</option>
                                        <option value="cash">Cash</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="succession-settings" role="tabpanel">
                            <form id="successionSettingsForm">
                                <div class="mb-3">
                                    <label for="successionInactivitySetting" class="form-label">Super Admin Inactivity Threshold (Days)</label>
                                    <input type="number" class="form-control" id="successionInactivitySetting" placeholder="Enter number of days">
                                </div>
                                <div class="mb-3">
                                    <label for="successionNoticePeriod" class="form-label">Notice Period Before Succession (Days)</label>
                                    <input type="number" class="form-control" id="successionNoticePeriod" placeholder="Enter number of days">
                                </div>
                                <div class="mb-3">
                                    <label for="primarySuccessor" class="form-label">Primary Successor</label>
                                    <select class="form-select" id="primarySuccessor">
                                        <!-- Members will be added here dynamically -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="secondarySuccessor" class="form-label">Secondary Successor</label>
                                    <select class="form-select" id="secondarySuccessor">
                                        <!-- Members will be added here dynamically -->
                                    </select>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="successionReclaimSetting">
                                    <label class="form-check-label" for="successionReclaimSetting">Allow Original Super Admin to Reclaim Role</label>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSuperSettingsBtn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Super Admin Adverts Modal -->
    <div class="modal fade" id="superAdminAdvertsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Advertisements</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Advertiser</th>
                                    <th>Title</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="advertsListTable">
                                <!-- Adverts will be added here dynamically -->
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Super Admin Subscriptions Modal -->
    <div class="modal fade" id="superAdminSubscriptionsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Group Subscriptions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Group</th>
                                    <th>Admin</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="subscriptionsListTable">
                                <!-- Subscriptions will be added here dynamically -->
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="newSubscriptionBtn">New Subscription</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Subscription Modal -->
    <div class="modal fade" id="newSubscriptionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Subscription</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newSubscriptionForm">
                        <div class="mb-3">
                            <label for="subscriptionGroup" class="form-label">Group</label>
                            <select class="form-select" id="subscriptionGroup">
                                <!-- Groups will be added here dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="subscriptionAmount" class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">UGX</span>
                                <input type="number" class="form-control" id="subscriptionAmount" placeholder="Enter amount">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="subscriptionPeriod" class="form-label">Period</label>
                            <select class="form-select" id="subscriptionPeriod">
                                <option value="30">1 Month</option>
                                <option value="365">1 Year</option>
                                <option value="730">2 Years</option>
                                <option value="1095">3 Years</option>
                                <option value="1825">5 Years</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="mb-3" id="customSubscriptionDays" style="display: none;">
                            <label for="subscriptionCustomDays" class="form-label">Custom Days</label>
                            <input type="number" class="form-control" id="subscriptionCustomDays" placeholder="Enter number of days">
                        </div>
                        <div class="mb-3">
                            <label for="subscriptionMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="subscriptionMethod">
                                <option value="mobile_money">Mobile Money</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="cash">Cash</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="subscriptionReference" class="form-label">Payment Reference</label>
                            <input type="text" class="form-control" id="subscriptionReference" placeholder="Enter reference">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitSubscriptionBtn">Create Subscription</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Verification Modal -->
    <div class="modal fade" id="verificationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Verify Your Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="emailVerificationSection">
                        <p>We've sent a verification code to your email address. Please enter it below:</p>
                        <div class="mb-3">
                            <label for="emailCode" class="form-label">Email Verification Code</label>
                            <input type="text" class="form-control" id="emailCode" placeholder="Enter code">
                        </div>
                        <button class="btn btn-link p-0" id="resendEmailCodeBtn">Resend Code</button>
                    </div>
                    <div id="phoneVerificationSection" class="mt-3">
                        <p>We've sent a verification code to your phone number. Please enter it below:</p>
                        <div class="mb-3">
                            <label for="phoneCode" class="form-label">Phone Verification Code</label>
                            <input type="text" class="form-control" id="phoneCode" placeholder="Enter code">
                        </div>
                        <button class="btn btn-link p-0" id="resendPhoneCodeBtn">Resend Code</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitVerificationBtn">Verify Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Approval Modal -->
    <div class="modal fade" id="groupApprovalModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Group Approval</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Your group request has been submitted for approval. You will receive a notification once it's approved.</p>
                    <p>In the meantime, you can invite members to join your group.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Header (hidden until printing) -->
    <div id="printHeader" class="print-only" style="display: none;">
        <div class="text-center">
            <h3>Kiira Save</h3>
            <p>A product of Skysoft Technologies</p>
            <h4 id="printTitle">Report</h4>
            <p id="printDate">Generated on: </p>
            <hr>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ipfs-core/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dat-sdk@1.0.0/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p@0.36.4/dist/libp2p.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peer-id@0.16.0/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-websockets@0.15.5/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-webrtc-star@0.24.4/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-mplex@0.10.5/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-noise@0.2.1/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-bootstrap@0.15.1/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-kad-dht@0.28.0/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libp2p-pubsub@0.10.0/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.27.2/dist/axios.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://sdk.twilio.com/js/client/v1.14/twilio.min.js"></script>

    <!-- Main Application Script -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEXAMPLEEXAMPLEEXAMPLEEXAMPLE",
            authDomain: "kiira-save.firebaseapp.com",
            projectId: "kiira-save",
            storageBucket: "kiira-save.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:EXAMPLEEXAMPLEEXAMPLE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Twilio configuration
        const twilioClient = new Twilio.Client({
            accountSid: 'ACXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',
            authToken: 'your_auth_token'
        });

        // Main application class
        class KiiraSave {
            constructor() {
                this.db = null;
                this.ipfs = null;
                this.dat = null;
                this.libp2p = null;
                this.peerId = null;
                this.chain = [];
                this.currentUser = null;
                this.currentGroup = null;
                this.peers = new Map();
                this.isInitialized = false;
                this.isSuperAdmin = false;
                this.isGroupAdmin = false;
                this.broadcastQueue = [];
                this.currentBroadcast = null;
                this.broadcastInterval = null;
                this.adverts = [];
                this.currentAdvert = null;
                this.advertInterval = null;
                this.init();
            }

            async init() {
                try {
                    // Initialize databases
                    await this.initDatabases();
                    
                    // Initialize network components
                    await this.initNetwork();
                    
                    // Load blockchain
                    await this.loadBlockchain();
                    
                    // Check authentication state
                    this.checkAuthState();
                    
                    // Initialize UI
                    this.initUI();
                    
                    this.isInitialized = true;
                    document.getElementById('loadingOverlay').style.display = 'none';
                } catch (error) {
                    console.error('Initialization error:', error);
                    alert('Failed to initialize application. Please refresh the page.');
                }
            }

            async initDatabases() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('KiiraSaveDB', 1);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Create object stores
                        if (!db.objectStoreNames.contains('users')) {
                            db.createObjectStore('users', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('groups')) {
                            db.createObjectStore('groups', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('savings')) {
                            db.createObjectStore('savings', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('loans')) {
                            db.createObjectStore('loans', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('shares')) {
                            db.createObjectStore('shares', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('messages')) {
                            db.createObjectStore('messages', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('transactions')) {
                            db.createObjectStore('transactions', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }
                        
                        if (!db.objectStoreNames.contains('blockchain')) {
                            db.createObjectStore('blockchain', { keyPath: 'index' });
                        }
                    };
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        console.error('Database error:', event.target.error);
                        reject(new Error('Failed to open database'));
                    };
                });
            }

            async initNetwork() {
                try {
                    // Initialize IPFS
                    this.ipfs = await Ipfs.create({
                        repo: 'kiira-save-ipfs',
                        config: {
                            Addresses: {
                                Swarm: [
                                    '/dns4/wrtc-star1.par.dwebops.pub/tcp/443/wss/p2p-webrtc-star',
                                    '/dns4/wrtc-star2.sjc.dwebops.pub/tcp/443/wss/p2p-webrtc-star'
                                ]
                            }
                        }
                    });
                    
                    // Initialize DAT
                    this.dat = await DatSdk.create({
                        persist: true,
                        storage: await DatSdk.storage('indexeddb')
                    });
                    
                    // Create Peer ID
                    this.peerId = await PeerId.create({ bits: 2048 });
                    
                    // Initialize libp2p
                    this.libp2p = await Libp2p.create({
                        peerId: this.peerId,
                        addresses: {
                            listen: [
                                '/ip4/0.0.0.0/tcp/0',
                                '/ip4/0.0.0.0/tcp/0/ws'
                            ]
                        },
                        modules: {
                            transport: [Websockets, WebRTCStar],
                            streamMuxer: [Mplex],
                            connEncryption: [Noise],
                            peerDiscovery: [Bootstrap],
                            dht: KadDHT,
                            pubsub: GossipSub
                        },
                        config: {
                            peerDiscovery: {
                                bootstrap: {
                                    interval: 60e3,
                                    enabled: true,
                                    list: [
                                        '/dns4/bootstrap1.kiira-save.p2p.io/tcp/4001/ipfs/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN',
                                        '/dns4/bootstrap2.kiira-save.p2p.io/tcp/4001/ipfs/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa'
                                    ]
                                }
                            },
                            dht: {
                                enabled: true,
                                randomWalk: {
                                    enabled: true
                                }
                            }
                        }
                    });
                    
                    // Start libp2p
                    await this.libp2p.start();
                    
                    // Set up event listeners
                    this.libp2p.on('peer:discovery', (peerId) => {
                        console.log('Discovered peer:', peerId.toB58String());
                        this.connectToPeer(peerId);
                    });
                    
                    this.libp2p.on('peer:connect', (peerId) => {
                        console.log('Connected to peer:', peerId.toB58String());
                        this.syncBlockchain(peerId);
                    });
                    
                    this.libp2p.on('peer:disconnect', (peerId) => {
                        console.log('Disconnected from peer:', peerId.toB58String());
                        this.peers.delete(peerId.toB58String());
                    });
                    
                    // Set up pubsub
                    this.libp2p.pubsub.subscribe('kiira-save-blockchain');
                    this.libp2p.pubsub.on('kiira-save-blockchain', (msg) => {
                        const data = JSON.parse(msg.data.toString());
                        this.handleBlockchainUpdate(data);
                    });
                    
                    console.log('Network initialized with peer ID:', this.peerId.toB58String());
                } catch (error) {
                    console.error('Network initialization error:', error);
                    throw new Error('Failed to initialize network components');
                }
            }

            async connectToPeer(peerId) {
                try {
                    if (!this.peers.has(peerId.toB58String())) {
                        await this.libp2p.dial(peerId);
                        this.peers.set(peerId.toB58String(), peerId);
                    }
                } catch (error) {
                    console.error('Failed to connect to peer:', error);
                }
            }

            async syncBlockchain(peerId) {
                try {
                    const stream = await this.libp2p.dialProtocol(peerId, '/kiira-save/sync/1.0.0');
                    
                    // Send our chain length
                    const writer = lp.encode();
                    writer.write(Buffer.from(JSON.stringify({ length: this.chain.length })));
                    writer.end();
                    
                    // Pipe our data to the peer
                    writer.pipe(stream);
                    
                    // Read the peer's response
                    const reader = lp.decode.fromReader(stream);
                    for await (const chunk of reader) {
                        const data = JSON.parse(chunk.toString());
                        
                        if (data.chain) {
                            // Received a blockchain from the peer
                            this.validateAndUpdateChain(data.chain);
                        }
                    }
                } catch (error) {
                    console.error('Blockchain sync error:', error);
                }
            }

            async loadBlockchain() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['blockchain'], 'readonly');
                    const store = transaction.objectStore('blockchain');
                    const request = store.getAll();
                    
                    request.onsuccess = (event) => {
                        const blocks = event.target.result;
                        if (blocks && blocks.length > 0) {
                            // Sort blocks by index
                            blocks.sort((a, b) => a.index - b.index);
                            
                            // Verify the chain
                            if (this.validateChain(blocks)) {
                                this.chain = blocks;
                                console.log('Blockchain loaded with', this.chain.length, 'blocks');
                                resolve();
                            } else {
                                reject(new Error('Blockchain verification failed'));
                            }
                        } else {
                            // Create genesis block if no blocks exist
                            this.createGenesisBlock();
                            resolve();
                        }
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error loading blockchain:', event.target.error);
                        reject(new Error('Failed to load blockchain'));
                    };
                });
            }

            validateChain(chain) {
                if (chain.length === 0) return true;
                
                // Check genesis block
                const genesisBlock = chain[0];
                if (genesisBlock.index !== 0 || 
                    genesisBlock.previousHash !== '0' || 
                    !this.validProof(genesisBlock)) {
                    return false;
                }
                
                // Check subsequent blocks
                for (let i = 1; i < chain.length; i++) {
                    const currentBlock = chain[i];
                    const previousBlock = chain[i - 1];
                    
                    if (currentBlock.previousHash !== previousBlock.hash ||
                        currentBlock.index !== previousBlock.index + 1 ||
                        !this.validProof(currentBlock)) {
                        return false;
                    }
                }
                
                return true;
            }

            validProof(block) {
                const blockString = JSON.stringify({
                    index: block.index,
                    previousHash: block.previousHash,
                    timestamp: block.timestamp,
                    data: block.data,
                    nonce: block.nonce
                });
                
                const hash = crypto.subtle.digest('SHA-256', new TextEncoder().encode(blockString));
                return hash.then(hashArray => {
                    const hashHex = Array.from(new Uint8Array(hashArray))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                    return hashHex.substring(0, 4) === '0000'; // Simple proof of work
                });
            }

            createGenesisBlock() {
                const genesisBlock = {
                    index: 0,
                    timestamp: Date.now(),
                    data: { type: 'genesis', message: 'Kiira Save Genesis Block' },
                    previousHash: '0',
                    nonce: 0,
                    hash: ''
                };
                
                this.mineBlock(genesisBlock).then(minedBlock => {
                    this.chain = [minedBlock];
                    this.saveBlock(minedBlock);
                });
            }

            async mineBlock(block) {
                let nonce = 0;
                let hash = '';
                
                while (true) {
                    block.nonce = nonce;
                    const blockString = JSON.stringify({
                        index: block.index,
                        previousHash: block.previousHash,
                        timestamp: block.timestamp,
                        data: block.data,
                        nonce: block.nonce
                    });
                    
                    const hashArray = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(blockString));
                    hash = Array.from(new Uint8Array(hashArray))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                    
                    if (hash.substring(0, 4) === '0000') { // Simple proof of work
                        block.hash = hash;
                        return block;
                    }
                    
                    nonce++;
                    
                    // Yield to the event loop every 1000 iterations
                    if (nonce % 1000 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                }
            }

            async addBlock(data) {
                const previousBlock = this.chain[this.chain.length - 1];
                const newBlock = {
                    index: previousBlock.index + 1,
                    timestamp: Date.now(),
                    data: data,
                    previousHash: previousBlock.hash,
                    nonce: 0,
                    hash: ''
                };
                
                const minedBlock = await this.mineBlock(newBlock);
                this.chain.push(minedBlock);
                await this.saveBlock(minedBlock);
                
                // Broadcast the new block to the network
                this.broadcastBlock(minedBlock);
                
                return minedBlock;
            }

            async saveBlock(block) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['blockchain'], 'readwrite');
                    const store = transaction.objectStore('blockchain');
                    const request = store.put(block);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => {
                        console.error('Error saving block:', event.target.error);
                        reject(new Error('Failed to save block'));
                    };
                });
            }

            broadcastBlock(block) {
                if (this.libp2p) {
                    this.libp2p.pubsub.publish(
                        'kiira-save-blockchain',
                        Buffer.from(JSON.stringify({
                            type: 'new_block',
                            block: block
                        }))
                    );
                }
            }

            handleBlockchainUpdate(data) {
                if (data.type === 'new_block') {
                    const newBlock = data.block;
                    const lastBlock = this.chain[this.chain.length - 1];
                    
                    // Validate the new block
                    if (newBlock.index === lastBlock.index + 1 &&
                        newBlock.previousHash === lastBlock.hash &&
                        this.validProof(newBlock)) {
                        
                        this.chain.push(newBlock);
                        this.saveBlock(newBlock);
                        
                        // Update UI if the block contains relevant data
                        this.processBlockData(newBlock.data);
                    }
                } else if (data.type === 'chain_request') {
                    // Another peer is requesting our chain
                    if (data.length < this.chain.length) {
                        this.libp2p.pubsub.publish(
                            'kiira-save-blockchain',
                            Buffer.from(JSON.stringify({
                                type: 'chain_response',
                                chain: this.chain
                            }))
                        );
                    }
                } else if (data.type === 'chain_response') {
                    // Received a chain from another peer
                    this.validateAndUpdateChain(data.chain);
                }
            }

            validateAndUpdateChain(newChain) {
                if (newChain.length > this.chain.length && this.validateChain(newChain)) {
                    // Replace our chain with the new one
                    this.chain = newChain;
                    
                    // Save all blocks to IndexedDB
                    Promise.all(newChain.map(block => this.saveBlock(block)))
                        .then(() => {
                            console.log('Blockchain updated to length', this.chain.length);
                            
                            // Process all block data to update application state
                            newChain.forEach(block => this.processBlockData(block.data));
                        })
                        .catch(error => {
                            console.error('Error saving updated blockchain:', error);
                        });
                }
            }

            processBlockData(data) {
                // Process the data in the block and update application state
                if (data.type === 'user_registration') {
                    // Handle new user registration
                    this.addUserToLocalDB(data.user);
                } else if (data.type === 'group_creation') {
                    // Handle new group creation
                    this.addGroupToLocalDB(data.group);
                } else if (data.type === 'saving_transaction') {
                    // Handle saving transaction
                    this.addSavingToLocalDB(data.saving);
                } else if (data.type === 'loan_transaction') {
                    // Handle loan transaction
                    this.addLoanToLocalDB(data.loan);
                } else if (data.type === 'share_transaction') {
                    // Handle share transaction
                    this.addShareToLocalDB(data.share);
                } else if (data.type === 'admin_action') {
                    // Handle admin action
                    this.processAdminAction(data.action);
                }
                
                // Update UI if needed
                if (this.currentUser) {
                    this.updateUI();
                }
            }

            async addUserToLocalDB(user) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readwrite');
                    const store = transaction.objectStore('users');
                    const request = store.put(user);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => {
                        console.error('Error saving user:', event.target.error);
                        reject(new Error('Failed to save user'));
                    };
                });
            }

            async addGroupToLocalDB(group) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['groups'], 'readwrite');
                    const store = transaction.objectStore('groups');
                    const request = store.put(group);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => {
                        console.error('Error saving group:', event.target.error);
                        reject(new Error('Failed to save group'));
                    };
                });
            }

            async addSavingToLocalDB(saving) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['savings'], 'readwrite');
                    const store = transaction.objectStore('savings');
                    const request = store.put(saving);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => {
                        console.error('Error saving saving transaction:', event.target.error);
                        reject(new Error('Failed to save saving transaction'));
                    };
                });
            }

            async addLoanToLocalDB(loan) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['loans'], 'readwrite');
                    const store = transaction.objectStore('loans');
                    const request = store.put(loan);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => {
                        console.error('Error saving loan transaction:', event.target.error);
                        reject(new Error('Failed to save loan transaction'));
                    };
                });
            }

            async addShareToLocalDB(share) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['shares'], 'readwrite');
                    const store = transaction.objectStore('shares');
                    const request = store.put(share);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => {
                        console.error('Error saving share transaction:', event.target.error);
                        reject(new Error('Failed to save share transaction'));
                    };
                });
            }

            processAdminAction(action) {
                // Process admin actions like role changes, settings updates, etc.
                if (action.type === 'role_change') {
                    if (action.userId === this.currentUser.id) {
                        // Update current user's roles
                        this.currentUser.roles = action.newRoles;
                        this.isGroupAdmin = action.newRoles.includes('group_admin');
                        this.isSuperAdmin = action.newRoles.includes('super_admin');
                        this.updateUI();
                    }
                } else if (action.type === 'group_settings_update') {
                    if (this.currentGroup && action.groupId === this.currentGroup.id) {
                        // Update current group settings
                        this.currentGroup.settings = action.settings;
                        this.updateUI();
                    }
                } else if (action.type === 'system_settings_update') {
                    // Update system settings
                    this.updateSystemSettings(action.settings);
                }
            }

            async updateSystemSettings(settings) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['settings'], 'readwrite');
                    const store = transaction.objectStore('settings');
                    const request = store.put({ key: 'system_settings', value: settings });
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => {
                        console.error('Error saving system settings:', event.target.error);
                        reject(new Error('Failed to save system settings'));
                    };
                });
            }

            async getSystemSettings() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['settings'], 'readonly');
                    const store = transaction.objectStore('settings');
                    const request = store.get('system_settings');
                    
                    request.onsuccess = (event) => {
                        resolve(event.target.result ? event.target.result.value : null);
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error loading system settings:', event.target.error);
                        reject(new Error('Failed to load system settings'));
                    };
                });
            }

            checkAuthState() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // User is signed in
                        await this.loadUserData(user.uid);
                        this.updateUI();
                    } else {
                        // User is signed out
                        this.currentUser = null;
                        this.currentGroup = null;
                        this.isSuperAdmin = false;
                        this.isGroupAdmin = false;
                        this.updateUI();
                    }
                });
            }

            async loadUserData(userId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['users'], 'readonly');
                    const store = transaction.objectStore('users');
                    const request = store.get(userId);
                    
                    request.onsuccess = async (event) => {
                        const user = event.target.result;
                        if (user) {
                            this.currentUser = user;
                            this.isSuperAdmin = user.roles.includes('super_admin');
                            
                            // Load the first group if user has groups
                            if (user.groups && user.groups.length > 0) {
                                await this.loadGroupData(user.groups[0]);
                            }
                            
                            resolve();
                        } else {
                            reject(new Error('User not found in local database'));
                        }
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error loading user data:', event.target.error);
                        reject(new Error('Failed to load user data'));
                    };
                });
            }

            async loadGroupData(groupId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['groups'], 'readonly');
                    const store = transaction.objectStore('groups');
                    const request = store.get(groupId);
                    
                    request.onsuccess = (event) => {
                        const group = event.target.result;
                        if (group) {
                            this.currentGroup = group;
                            this.isGroupAdmin = group.adminId === this.currentUser.id || 
                                              this.currentUser.roles.includes('group_admin');
                            resolve();
                        } else {
                            reject(new Error('Group not found in local database'));
                        }
                    };
                    
                    request.onerror = (event) => {
                        console.error('Error loading group data:', event.target.error);
                        reject(new Error('Failed to load group data'));
                    };
                });
            }

            initUI() {
                // Auth toggle
                document.getElementById('showSignup').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('signupForm').style.display = 'block';
                });
                
                document.getElementById('showLogin').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('signupForm').style.display = 'none';
                    document.getElementById('loginForm').style.display = 'block';
                });
                
                // Login form
                document.getElementById('loginBtn').addEventListener('click', () => this.handleLogin());
                
                // Signup form
                document.getElementById('signupBtn').addEventListener('click', () => this.handleSignup());
                document.getElementById('searchGroupBtn').addEventListener('click', () => this.searchGroups());
                
                // Main app navigation
                document.getElementById('dashboardLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('dashboardContent');
                });
                
                document.getElementById('savingsLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('savingsContent');
                });
                
                document.getElementById('loansLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('loansContent');
                });
                
                document.getElementById('sharesLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('sharesContent');
                });
                
                document.getElementById('membersLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('membersContent');
                });
                
                document.getElementById('messagesLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('messagesContent');
                });
                
                document.getElementById('profileLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('profileContent');
                });
                
                document.getElementById('settingsLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('profileContent');
                });
                
                document.getElementById('logoutLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.handleLogout();
                });
                
                document.getElementById('sidebarDashboard').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('dashboardContent');
                });
                
                document.getElementById('sidebarSavings').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('savingsContent');
                });
                
                document.getElementById('sidebarLoans').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('loansContent');
                });
                
                document.getElementById('sidebarShares').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('sharesContent');
                });
                
                document.getElementById('sidebarMembers').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('membersContent');
                });
                
                document.getElementById('sidebarMessages').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('messagesContent');
                });
                
                document.getElementById('sidebarTimeline').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('dashboardContent');
                });
                
                document.getElementById('sidebarAdmin').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('adminContent');
                });
                
                document.getElementById('sidebarSuperAdmin').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showContent('superAdminContent');
                });
                
                // Quick actions
                document.getElementById('quickSaveBtn').addEventListener('click', () => {
                    $('#newSavingModal').modal('show');
                });
                
                document.getElementById('quickLoanBtn').addEventListener('click', () => {
                    $('#newLoanModal').modal('show');
                });
                
                document.getElementById('quickGiftBtn').addEventListener('click', () => {
                    $('#giftModal').modal('show');
                });
                
                document.getElementById('quickSharesBtn').addEventListener('click', () => {
                    this.showContent('sharesContent');
                });
                
                document.getElementById('sidebarSaveNowBtn').addEventListener('click', () => {
                    $('#newSavingModal').modal('show');
                });
                
                // Modals
                document.getElementById('newSavingBtn').addEventListener('click', () => {
                    $('#newSavingModal').modal('show');
                });
                
                document.getElementById('submitSavingBtn').addEventListener('click', () => {
                    this.submitSaving();
                });
                
                document.getElementById('savingMethod').addEventListener('change', (e) => {
                    document.getElementById('savingReferenceField').style.display = 
                        e.target.value !== 'cash' ? 'block' : 'none';
                });
                
                document.getElementById('adminAddSavingBtn').addEventListener('click', () => {
                    $('#adminAddSavingModal').modal('show');
                });
                
                document.getElementById('submitAdminSavingBtn').addEventListener('click', () => {
                    this.submitAdminSaving();
                });
                
                document.getElementById('adminSavingMethod').addEventListener('change', (e) => {
                    document.getElementById('adminSavingReferenceField').style.display = 
                        e.target.value !== 'cash' ? 'block' : 'none';
                });
                
                document.getElementById('newLoanBtn').addEventListener('click', () => {
                    $('#newLoanModal').modal('show');
                });
                
                document.getElementById('submitLoanBtn').addEventListener('click', () => {
                    this.submitLoanApplication();
                });
                
                document.getElementById('loanAmount').addEventListener('input', () => {
                    this.calculateLoan();
                });
                
                document.getElementById('loanPeriod').addEventListener('change', () => {
                    this.calculateLoan();
                });
                
                document.getElementById('calculateLoanBtn').addEventListener('click', () => {
                    this.calculateLoan();
                });
                
                document.getElementById('newShareBtn').addEventListener('click', () => {
                    $('#newShareModal').modal('show');
                });
                
                document.getElementById('submitShareBtn').addEventListener('click', () => {
                    this.submitShareListing();
                });
                
                document.getElementById('buySharesBtn').addEventListener('click', () => {
                    this.buyShares();
                });
                
                document.getElementById('shareBuyQuantity').addEventListener('input', () => {
                    this.calculateSharePurchase();
                });
                
                document.getElementById('inviteMemberBtn').addEventListener('click', () => {
                    $('#inviteMemberModal').modal('show');
                });
                
                document.getElementById('submitInviteBtn').addEventListener('click', () => {
                    this.sendInvitation();
                });
                
                document.getElementById('newMessageBtn').addEventListener('click', () => {
                    $('#newMessageModal').modal('show');
                });
                
                document.getElementById('submitMessageBtn').addEventListener('click', () => {
                    this.sendMessage();
                });
                
                document.getElementById('changeProfilePicBtn').addEventListener('click', () => {
                    document.getElementById('profilePicUpload').click();
                });
                
                document.getElementById('profilePicUpload').addEventListener('change', (e) => {
                    this.uploadProfilePicture(e.target.files[0]);
                });
                
                document.getElementById('saveProfileBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.saveProfile();
                });
                
                document.getElementById('changePasswordBtn').addEventListener('click', () => {
                    $('#changePasswordModal').modal('show');
                });
                
                document.getElementById('submitChangePasswordBtn').addEventListener('click', () => {
                    this.changePassword();
                });
                
                document.getElementById('deactivateAccountBtn').addEventListener('click', () => {
                    $('#deactivateAccountModal').modal('show');
                });
                
                document.getElementById('submitDeactivateBtn').addEventListener('click', () => {
                    this.deactivateAccount();
                });
                
                document.getElementById('adminSettingsBtn').addEventListener('click', () => {
                    $('#adminSettingsModal').modal('show');
                });
                
                document.getElementById('saveSettingsBtn').addEventListener('click', () => {
                    this.saveGroupSettings();
                });
                
                document.getElementById('savingFrequencySetting').addEventListener('change', (e) => {
                    document.getElementById('weeklyDaySetting').style.display = 
                        e.target.value === 'weekly' ? 'block' : 'none';
                    document.getElementById('monthlyDateSetting').style.display = 
                        e.target.value === 'monthly' ? 'block' : 'none';
                });
                
                document.getElementById('savingCompulsorySetting').addEventListener('change', (e) => {
                    document.getElementById('savingPenaltySetting').style.display = 
                        e.target.checked ? 'block' : 'none';
                });
                
                document.getElementById('adminBroadcastBtn').addEventListener('click', () => {
                    $('#adminBroadcastModal').modal('show');
                });
                
                document.getElementById('submitBroadcastBtn').addEventListener('click', () => {
                    this.sendGroupBroadcast();
                });
                
                document.getElementById('broadcastRecipients').addEventListener('change', (e) => {
                    document.getElementById('broadcastMembersSelect').style.display = 
                        e.target.value === 'selected' ? 'block' : 'none';
                });
                
                document.getElementById('superAdminBroadcastBtn').addEventListener('click', () => {
                    $('#superAdminBroadcastModal').modal('show');
                });
                
                document.getElementById('submitSuperBroadcastBtn').addEventListener('click', () => {
                    this.sendSuperAdminBroadcast();
                });
                
                document.getElementById('superBroadcastRecipients').addEventListener('change', (e) => {
                    document.getElementById('superBroadcastGroupSelect').style.display = 
                        e.target.value === 'group' ? 'block' : 'none';
                });
                
                document.getElementById('superAdminSettingsBtn').addEventListener('click', () => {
                    $('#superAdminSettingsModal').modal('show');
                });
                
                document.getElementById('saveSuperSettingsBtn').addEventListener('click', () => {
                    this.saveSuperAdminSettings();
                });
                
                document.getElementById('superAdminAdvertsBtn').addEventListener('click', () => {
                    $('#superAdminAdvertsModal').modal('show');
                });
                
                document.getElementById('superAdminSubscriptionsBtn').addEventListener('click', () => {
                    $('#superAdminSubscriptionsModal').modal('show');
                });
                
                document.getElementById('newSubscriptionBtn').addEventListener('click', () => {
                    $('#newSubscriptionModal').modal('show');
                });
                
                document.getElementById('submitSubscriptionBtn').addEventListener('click', () => {
                    this.createSubscription();
                });
                
                document.getElementById('subscriptionPeriod').addEventListener('change', (e) => {
                    document.getElementById('customSubscriptionDays').style.display = 
                        e.target.value === 'custom' ? 'block' : 'none';
                });
                
                document.getElementById('closeBroadcast').addEventListener('click', () => {
                    this.closeCurrentBroadcast();
                });
                
                // Print buttons
                document.getElementById('printDashboardBtn').addEventListener('click', () => {
                    this.printContent('dashboardContent', 'Dashboard Report');
                });
                
                document.getElementById('printSavingsBtn').addEventListener('click', () => {
                    this.printContent('savingsContent', 'Savings Report');
                });
                
                document.getElementById('printLoansBtn').addEventListener('click', () => {
                    this.printContent('loansContent', 'Loans Report');
                });
                
                document.getElementById('printSharesBtn').addEventListener('click', () => {
                    this.printContent('sharesContent', 'Shares Report');
                });
                
                document.getElementById('printMembersBtn').addEventListener('click', () => {
                    this.printContent('membersContent', 'Members Report');
                });
                
                document.getElementById('printProfileBtn').addEventListener('click', () => {
                    this.printContent('profileContent', 'Profile Report');
                });
                
                document.getElementById('printAdminBtn').addEventListener('click', () => {
                    this.printContent('adminContent', 'Admin Report');
                });
                
                document.getElementById('printSuperAdminBtn').addEventListener('click', () => {
                    this.printContent('superAdminContent', 'Super Admin Report');
                });
                
                // Initialize other UI elements
                this.initSavingDayOptions();
                this.initMonthlyDateOptions();
            }

            initSavingDayOptions() {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const select = document.getElementById('savingDaySetting');
                
                days.forEach((day, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = day;
                    select.appendChild(option);
                });
            }

            initMonthlyDateOptions() {
                const select = document.getElementById('savingDateSetting');
                
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    select.appendChild(option);
                }
            }

            showContent(contentId) {
                // Hide all content sections
                document.querySelectorAll('main > div').forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show the selected content
                document.getElementById(contentId).style.display = 'block';
                
                // Update the UI for the specific content
                switch (contentId) {
                    case 'dashboardContent':
                        this.updateDashboard();
                        break;
                    case 'savingsContent':
                        this.updateSavings();
                        break;
                    case 'loansContent':
                        this.updateLoans();
                        break;
                    case 'sharesContent':
                        this.updateShares();
                        break;
                    case 'membersContent':
                        this.updateMembers();
                        break;
                    case 'messagesContent':
                        this.updateMessages();
                        break;
                    case 'profileContent':
                        this.updateProfile();
                        break;
                    case 'adminContent':
                        this.updateAdminPanel();
                        break;
                    case 'superAdminContent':
                        this.updateSuperAdminPanel();
                        break;
                }
            }

            updateUI() {
                if (this.currentUser) {
                    // User is logged in
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    
                    // Update profile info in navbar
                    document.getElementById('profileNavName').textContent = this.currentUser.name;
                    document.getElementById('profileNavImg').src = this.currentUser.profilePicture || 'https://via.placeholder.com/40';
                    
                    // Update sidebar profile info
                    document.getElementById('sidebarProfileName').textContent = this.currentUser.name;
                    document.getElementById('sidebarProfileImg').src = this.currentUser.profilePicture || 'https://via.placeholder.com/100';
                    
                    // Update role display
                    if (this.isSuperAdmin) {
                        document.getElementById('sidebarProfileRole').textContent = 'Super Admin';
                        document.querySelectorAll('.superadmin-only').forEach(el => el.style.display = 'block');
                    } else if (this.isGroupAdmin) {
                        document.getElementById('sidebarProfileRole').textContent = 'Group Admin';
                    } else {
                        document.getElementById('sidebarProfileRole').textContent = 'Member';
                    }
                    
                    // Show/hide admin sections
                    document.querySelectorAll('.admin-only').forEach(el => {
                        el.style.display = this.isGroupAdmin || this.isSuperAdmin ? 'block' : 'none';
                    });
                    
                    // Update group title in navbar
                    if (this.currentGroup) {
                        document.getElementById('appTitle').textContent = this.currentGroup.name;
                    }
                    
                    // Show dashboard by default
                    this.showContent('dashboardContent');
                    
                    // Start broadcast and advert rotations
                    this.startBroadcastRotation();
                    this.startAdvertRotation();
                } else {
                    // User is not logged in
                    document.getElementById('authContainer').style.display = 'block';
                    document.getElementById('appContainer').style.display = 'none';
                    
                    // Stop broadcast and advert rotations
                    this.stopBroadcastRotation();
                    this.stopAdvertRotation();
                }
            }

            async updateDashboard() {
                if (!this.currentUser || !this.currentGroup) return;
                
                // Update savings summary
                const savings = await this.getUserSavings(this.currentUser.id, this.currentGroup.id);
                const groupSavings = await this.getGroupSavings(this.currentGroup.id);
                
                const totalSaved = savings.reduce((sum, saving) => sum + saving.amount, 0);
                const groupTotal = groupSavings.reduce((sum, saving) => sum + saving.amount, 0);
                const percentage = groupTotal > 0 ? Math.round((totalSaved / groupTotal) * 100) : 0;
                
                document.getElementById('dashboardSavingsAmount').textContent = `${this.currentGroup.currency} ${totalSaved.toLocaleString()}`;
                document.getElementById('dashboardGroupTotal').textContent = `${this.currentGroup.currency} ${groupTotal.toLocaleString()}`;
                document.getElementById('dashboardSavingsPercentage').textContent = `${percentage}%`;
                
                // Update progress bars
                document.getElementById('dashboardProgressAmount').textContent = 
                    `${this.currentGroup.currency} ${totalSaved.toLocaleString()} of ${this.currentGroup.currency} ${this.currentGroup.settings.targetAmount?.toLocaleString() || 'N/A'}`;
                
                const progressPercentage = this.currentGroup.settings.targetAmount ? 
                    Math.min(100, Math.round((totalSaved / this.currentGroup.settings.targetAmount) * 100)) : 0;
                
                document.getElementById('dashboardProgressBar').style.width = `${progressPercentage}%`;
                document.getElementById('dashboardProgressBar').textContent = `${progressPercentage}%`;
                
                // Update cycle progress
                const cycleStart = new Date(this.currentGroup.cycleStartDate);
                const cycleEnd = new Date(cycleStart);
                cycleEnd.setDate(cycleStart.getDate() + this.currentGroup.settings.cycleLength);
                
                const today = new Date();
                const cycleDays = Math.floor((cycleEnd - cycleStart) / (1000 * 60 * 60 * 24));
                const daysPassed = Math.floor((today - cycleStart) / (1000 * 60 * 60 * 24));
                const cyclePercentage = Math.min(100, Math.round((daysPassed / cycleDays) * 100));
                
                document.getElementById('dashboardCycleProgressText').textContent = 
                    `Day ${daysPassed} of ${cycleDays}`;
                document.getElementById('dashboardCycleProgressBar').style.width = `${cyclePercentage}%`;
                
                // Update sidebar summary
                document.getElementById('sidebarSavingsAmount').textContent = `${this.currentGroup.currency} ${totalSaved.toLocaleString()}`;
                document.getElementById('sidebarGroupTotal').textContent = `${this.currentGroup.currency} ${groupTotal.toLocaleString()}`;
                document.getElementById('sidebarSavingsPercentage').style.width = `${percentage}%`;
                document.getElementById('sidebarSavingsPercentage').textContent = `${percentage}%`;
                
                // Update next saving day
                const nextSavingDay = this.calculateNextSavingDay();
                document.getElementById('sidebarNextSavingDay').textContent = nextSavingDay.formattedDate;
                document.getElementById('sidebarNextSavingAmount').textContent = 
                    `Amount: ${this.currentGroup.currency} ${this.currentGroup.settings.savingAmount || 'Any'}`;
                
                // Load recent activities
                this.loadRecentActivities();
                
                // Load upcoming events
                this.loadUpcomingEvents();
                
                // Load top savers
                this.loadTopSavers();
            }

            calculateNextSavingDay() {
                if (!this.currentGroup?.settings?.savingFrequency) {
                    return { date: null, formattedDate: 'Not set' };
                }
                
                const today = new Date();
                const nextDate = new Date(today);
                
                switch (this.currentGroup.settings.savingFrequency) {
                    case 'daily':
                        nextDate.setDate(today.getDate() + 1);
                        break;
                    case 'weekly':
                        const dayOfWeek = this.currentGroup.settings.savingDay || 0; // Default to Sunday
                        const daysUntilNext = (dayOfWeek - today.getDay() + 7) % 7;
                        nextDate.setDate(today.getDate() + (daysUntilNext || 7));
                        break;
                    case 'monthly':
                        const dayOfMonth = this.currentGroup.settings.savingDate || 1; // Default to 1st
                        nextDate.setDate(dayOfMonth);
                        if (nextDate <= today) {
                            nextDate.setMonth(today.getMonth() + 1);
                            nextDate.setDate(dayOfMonth);
                        }
                        break;
                    case 'annually':
                        nextDate.setFullYear(today.getFullYear() + 1);
                        break;
                }
                
                return {
                    date: nextDate,
                    formattedDate: nextDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })
                };
            }

            async loadRecentActivities() {
                try {
                    const activities = await this.getRecentActivities(this.currentGroup.id, 5);
                    const container = document.getElementById('recentActivities');
                    container.innerHTML = '';
                    
                    if (activities.length === 0) {
                        container.innerHTML = '<p>No recent activities</p>';
                        return;
                    }
                    
                    activities.forEach(activity => {
                        const item = document.createElement('div');
                        item.className = 'timeline-item';
                        
                        const content = document.createElement('div');
                        content.className = 'card p-2';
                        
                        const title = document.createElement('h6');
                        title.className = 'mb-1';
                        title.textContent = activity.title;
                        
                        const description = document.createElement('p');
                        description.className = 'small text-muted mb-1';
                        description.textContent = activity.description;
                        
                        const date = document.createElement('small');
                        date.className = 'text-muted';
                        date.textContent = new Date(activity.timestamp).toLocaleString();
                        
                        content.appendChild(title);
                        content.appendChild(description);
                        content.appendChild(date);
                        
                        item.appendChild(content);
                        container.appendChild(item);
                    });
                } catch (error) {
                    console.error('Error loading recent activities:', error);
                    document.getElementById('recentActivities').innerHTML = '<p>Error loading activities</p>';
                }
            }

            async loadUpcomingEvents() {
                try {
                    const events = await this.getUpcomingEvents(this.currentGroup.id, 3);
                    const container = document.getElementById('upcomingEvents');
                    container.innerHTML = '';
                    
                    if (events.length === 0) {
                        container.innerHTML = '<p>No upcoming events</p>';
                        return;
                    }
                    
                    events.forEach(event => {
                        const item = document.createElement('div');
                        item.className = 'mb-3';
                        
                        const card = document.createElement('div');
                        card.className = 'card p-2';
                        
                        const title = document.createElement('h6');
                        title.className = 'mb-1';
                        title.textContent = event.title;
                        
                        const date = document.createElement('p');
                        date.className = 'small text-muted mb-1';
                        date.textContent = new Date(event.date).toLocaleDateString('en-US', { 
                            weekday: 'long', month: 'long', day: 'numeric' 
                        });
                        
                        const description = document.createElement('p');
                        description.className = 'small';
                        description.textContent = event.description;
                        
                        card.appendChild(title);
                        card.appendChild(date);
                        card.appendChild(description);
                        
                        item.appendChild(card);
                        container.appendChild(item);
                    });
                } catch (error) {
                    console.error('Error loading upcoming events:', error);
                    document.getElementById('upcomingEvents').innerHTML = '<p>Error loading events</p>';
                }
            }

            async loadTopSavers() {
                try {
                    const savers = await this.getTopSavers(this.currentGroup.id, 3);
                    const container = document.getElementById('topSaversList');
                    container.innerHTML = '';
                    
                    if (savers.length === 0) {
                        container.innerHTML = '<p>No savings data</p>';
                        return;
                    }
                    
                    savers.forEach(saver => {
                        const item = document.createElement('div');
                        item.className = 'd-flex align-items-center mb-3';
                        
                        const img = document.createElement('img');
                        img.src = saver.profilePicture || 'https://via.placeholder.com/40';
                        img.className = 'profile-img me-3';
                        img.width = 40;
                        img.height = 40;
                        
                        const details = document.createElement('div');
                        details.className = 'flex-grow-1';
                        
                        const name = document.createElement('h6');
                        name.className = 'mb-0';
                        name.textContent = saver.name;
                        
                        const amount = document.createElement('p');
                        amount.className = 'small text-muted mb-0';
                        amount.textContent = `${this.currentGroup.currency} ${saver.amount.toLocaleString()}`;
                        
                        details.appendChild(name);
                        details.appendChild(amount);
                        
                        item.appendChild(img);
                        item.appendChild(details);
                        container.appendChild(item);
                    });
                } catch (error) {
                    console.error('Error loading top savers:', error);
                    document.getElementById('topSaversList').innerHTML = '<p>Error loading data</p>';
                }
            }

            async updateSavings() {
                if (!this.currentUser || !this.currentGroup) return;
                
                // Update savings summary
                const savings = await this.getUserSavings(this.currentUser.id, this.currentGroup.id);
                const groupSavings = await this.getGroupSavings(this.currentGroup.id);
                
                const totalSaved = savings.reduce((sum, saving) => sum + saving.amount, 0);
                const groupTotal = groupSavings.reduce((sum, saving) => sum + saving.amount, 0);
                const percentage = groupTotal > 0 ? Math.round((totalSaved / groupTotal) * 100) : 0;
                
                document.getElementById('savingsTotalAmount').textContent = `${this.currentGroup.currency} ${totalSaved.toLocaleString()}`;
                
                // Last saving
                if (savings.length > 0) {
                    const lastSaving = savings[savings.length - 1];
                    document.getElementById('savingsLastDate').textContent = new Date(lastSaving.date).toLocaleDateString();
                    document.getElementById('savingsLastAmount').textContent = `${this.currentGroup.currency} ${lastSaving.amount.toLocaleString()}`;
                } else {
                    document.getElementById('savingsLastDate').textContent = '--';
                    document.getElementById('savingsLastAmount').textContent = `${this.currentGroup.currency} 0`;
                }
                
                // Next saving day
                const nextSavingDay = this.calculateNextSavingDay();
                document.getElementById('savingsNextDate').textContent = nextSavingDay.formattedDate;
                document.getElementById('savingsNextAmount').textContent = 
                    `${this.currentGroup.currency} ${this.currentGroup.settings.savingAmount || 'Any'}`;
                
                // Update progress bars
                document.getElementById('savingsProgressAmount').textContent = 
                    `${this.currentGroup.currency} ${totalSaved.toLocaleString()} of ${this.currentGroup.currency} ${this.currentGroup.settings.targetAmount?.toLocaleString() || 'N/A'}`;
                
                const progressPercentage = this.currentGroup.settings.targetAmount ? 
                    Math.min(100, Math.round((totalSaved / this.currentGroup.settings.targetAmount) * 100)) : 0;
                
                document.getElementById('savingsProgressBar').style.width = `${progressPercentage}%`;
                document.getElementById('savingsProgressBar').textContent = `${progressPercentage}%`;
                
                // Update cycle progress
                const cycleStart = new Date(this.currentGroup.cycleStartDate);
                const cycleEnd = new Date(cycleStart);
                cycleEnd.setDate(cycleStart.getDate() + this.currentGroup.settings.cycleLength);
                
                const today = new Date();
                const cycleDays = Math.floor((cycleEnd - cycleStart) / (1000 * 60 * 60 * 24));
                const daysPassed = Math.floor((today - cycleStart) / (1000 * 60 * 60 * 24));
                const cyclePercentage = Math.min(100, Math.round((daysPassed / cycleDays) * 100));
                
                document.getElementById('savingsCycleProgressText').textContent = 
                    `Day ${daysPassed} of ${cycleDays}`;
                document.getElementById('savingsCycleProgressBar').style.width = `${cyclePercentage}%`;
                
                // Update group total and percentage
                document.getElementById('savingsGroupTotal').textContent = `${this.currentGroup.currency} ${groupTotal.toLocaleString()}`;
                document.getElementById('savingsPercentage').textContent = `${percentage}%`;
                
                // Load savings history
                this.loadSavingsHistory();
            }

            async loadSavingsHistory() {
                try {
                    const savings = await this.getUserSavings(this.currentUser.id, this.currentGroup.id);
                    const container = document.getElementById('savingsHistoryTable');
                    container.innerHTML = '';
                    
                    if (savings.length === 0) {
                        container.innerHTML = '<tr><td colspan="5" class="text-center py-4">No savings history</td></tr>';
                        return;
                    }
                    
                    // Sort by date descending
                    savings.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    savings.forEach(saving => {
                        const row = document.createElement('tr');
                        
                        const dateCell = document.createElement('td');
                        dateCell.textContent = new Date(saving.date).toLocaleDateString();
                        
                        const amountCell = document.createElement('td');
                        amountCell.textContent = `${this.currentGroup.currency} ${saving.amount.toLocaleString()}`;
                        
                        const statusCell = document.createElement('td');
                        const statusBadge = document.createElement('span');
                        statusBadge.className = saving.status === 'confirmed' ? 'badge bg-success' : 
                                              saving.status === 'pending' ? 'badge bg-warning' : 'badge bg-danger';
                        statusBadge.textContent = saving.status.charAt(0).toUpperCase() + saving.status.slice(1);
                        statusCell.appendChild(statusBadge);
                        
                        const confirmedByCell = document.createElement('td');
                        confirmedByCell.textContent = saving.confirmedBy ? saving.confirmedBy.name : '--';
                        
                        const actionsCell = document.createElement('td');
                        if (saving.status === 'pending') {
                            const cancelBtn = document.createElement('button');
                            cancelBtn.className = 'btn btn-sm btn-outline-danger';
                            cancelBtn.textContent = 'Cancel';
                            cancelBtn.addEventListener('click', () => this.cancelSaving(saving.id));
                            actionsCell.appendChild(cancelBtn);
                        } else {
                            actionsCell.textContent = '--';
                        }
                        
                        row.appendChild(dateCell);
                        row.appendChild(amountCell);
                        row.appendChild(statusCell);
                        row.appendChild(confirmedByCell);
                        row.appendChild(actionsCell);
                        
                        container.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error loading savings history:', error);
                    container.innerHTML = '<tr><td colspan="5" class="text-center py-4">Error loading history</td></tr>';
                }
            }

            async updateLoans() {
                if (!this.currentUser || !this.currentGroup) return;
                
                // Check if loans are enabled
                const loansEnabled = this.currentGroup.settings.loansEnabled;
                document.getElementById('newLoanBtn').disabled = !loansEnabled;
                
                if (!loansEnabled) {
                    document.getElementById('loansContent').innerHTML = `
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Loans</h1>
                        </div>
                        <div class="alert alert-info">
                            Loans are currently disabled for this group. Contact your group admin for more information.
                        </div>
                    `;
                    return;
                }
                
                // Update loan summary
                const loans = await this.getUserLoans(this.currentUser.id, this.currentGroup.id);
                const activeLoan = loans.find(loan => loan.status === 'active');
                
                if (activeLoan) {
                    const amountPaid = activeLoan.payments.reduce((sum, payment) => sum + payment.amount, 0);
                    const balance = activeLoan.totalAmount - amountPaid;
                    
                    document.getElementById('loanCurrentAmount').textContent = 
                        `${this.currentGroup.currency} ${activeLoan.amount.toLocaleString()}`;
                    document.getElementById('loanTotalPayable').textContent = 
                        `${this.currentGroup.currency} ${activeLoan.totalAmount.toLocaleString()}`;
                    document.getElementById('loanAmountPaid').textContent = 
                        `${this.currentGroup.currency} ${amountPaid.toLocaleString()}`;
                    document.getElementById('loanBalance').textContent = 
                        `${this.currentGroup.currency} ${balance.toLocaleString()}`;
                    document.getElementById('loanDueDate').textContent = 
                        new Date(activeLoan.dueDate).toLocaleDateString();
                    document.getElementById('loanStatus').textContent = 'Active';
                } else {
                    document.getElementById('loanCurrentAmount').textContent = `${this.currentGroup.currency} 0`;
                    document.getElementById('loanTotalPayable').textContent = `${this.currentGroup.currency} 0`;
                    document.getElementById('loanAmountPaid').textContent = `${this.currentGroup.currency} 0`;
                    document.getElementById('loanBalance').textContent = `${this.currentGroup.currency} 0`;
                    document.getElementById('loanDueDate').textContent = '--';
                    document.getElementById('loanStatus').textContent = 'No active loan';
                }
                
                // Set default interest rate
                document.getElementById('loanInterest').value = this.currentGroup.settings.loanInterestRate || 10;
                
                // Load loans history
                this.loadLoansHistory();
                
                // Load pending approvals (for admins)
                if (this.isGroupAdmin || this.isSuperAdmin) {
                    this.loadPendingLoanApprovals();
                }
            }

            async loadLoansHistory() {
                try {
                    const loans = await this.getUserLoans(this.currentUser.id, this.currentGroup.id);
                    const container = document.getElementById('loansHistoryTable');
                    container.innerHTML = '';
                    
                    if (loans.length === 0) {
                        container.innerHTML = '<tr><td colspan="7" class="text-center py-4">No loan history</td></tr>';
                        return;
                    }
                    
                    // Sort by date descending
                    loans.sort((a, b) => new Date(b.applicationDate) - new Date(a.applicationDate));
                    
                    loans.forEach(loan => {
                        const row = document.createElement('tr');
                        
                        const dateCell = document.createElement('td');
                        dateCell.textContent = new Date(loan.applicationDate).toLocaleDateString();
                        
                        const amountCell = document.createElement('td');
                        amountCell.textContent = `${this.currentGroup.currency} ${loan.amount.toLocaleString()}`;
                        
                        const interestCell = document.createElement('td');
                        interestCell.textContent = `${loan.interestRate}%`;
                        
                        const totalCell = document.createElement('td');
                        totalCell.textContent = `${this.currentGroup.currency} ${loan.totalAmount.toLocaleString()}`;
                        
                        const dueDateCell = document.createElement('td');
                        dueDateCell.textContent = new Date(loan.dueDate).toLocaleDateString();
                        
                        const statusCell = document.createElement('td');
                        const statusBadge = document.createElement('span');
                        statusBadge.className = loan.status === 'active' ? 'badge bg-success' : 
                                               loan.status === 'pending' ? 'badge bg-warning' : 
                                               loan.status === 'rejected' ? 'badge bg-danger' : 'badge bg-secondary';
                        statusBadge.textContent = loan.status.charAt(0).toUpperCase() + loan.status.slice(1);
                        statusCell.appendChild(statusBadge);
                        
                        const actionsCell = document.createElement('td');
                        const detailsBtn = document.createElement('button');
                        detailsBtn.className = 'btn btn-sm btn-outline-primary';
                        detailsBtn.textContent = 'Details';
                        detailsBtn.addEventListener('click', () => this.showLoanDetails(loan.id));
                        actionsCell.appendChild(detailsBtn);
                        
                        row.appendChild(dateCell);
                        row.appendChild(amountCell);
                        row.appendChild(interestCell);
                        row.appendChild(totalCell);
                        row.appendChild(dueDateCell);
                        row.appendChild(statusCell);
                        row.appendChild(actionsCell);
                        
                        container.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error loading loans history:', error);
                    container.innerHTML = '<tr><td colspan="7" class="text-center py-4">Error loading history</td></tr>';
                }
            }

            async loadPendingLoanApprovals() {
                try {
                    const pendingLoans = await this.getPendingLoans(this.currentGroup.id);
                    const container = document.getElementById('pendingLoansList');
                    container.innerHTML = '';
                    
                    if (pendingLoans.length === 0) {
                        container.innerHTML = '<p>No pending loan approvals</p>';
                        return;
                    }
                    
                    pendingLoans.forEach(loan => {
                        const card = document.createElement('div');
                        card.className = 'card mb-3';
                        
                        const cardHeader = document.createElement('div');
                        cardHeader.className = 'card-header d-flex justify-content-between align-items-center';
                        
                        const title = document.createElement('h6');
                        title.className = 'mb-0';
                        title.textContent = `Loan Application from ${loan.member.name}`;
                        
                        const amount = document.createElement('span');
                        amount.className = 'badge bg-primary';
                        amount.textContent = `${this.currentGroup.currency} ${loan.amount.toLocaleString()}`;
                        
                        cardHeader.appendChild(title);
                        cardHeader.appendChild(amount);
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body';
                        
                        const purpose = document.createElement('p');
                        purpose.textContent = loan.purpose;
                        purpose.className = 'mb-2';
                        
                        const details = document.createElement('div');
                        details.className = 'd-flex justify-content-between mb-3';
                        
                        const interest = document.createElement('small');
                        interest.className = 'text-muted';
                        interest.textContent = `Interest: ${loan.interestRate}%`;
                        
                        const period = document.createElement('small');
                        period.className = 'text-muted';
                        period.textContent = `Period: ${loan.period} days`;
                        
                        const total = document.createElement('small');
                        total.className = 'text-muted';
                        total.textContent = `Total: ${this.currentGroup.currency} ${loan.totalAmount.toLocaleString()}`;
                        
                        details.appendChild(interest);
                        details.appendChild(period);
                        details.appendChild(total);
                        
                        const votes = document.createElement('div');
                        votes.className = 'mb-3';
                        
                        const voteText = document.createElement('small');
                        voteText.className = 'd-block mb-1';
                        voteText.textContent = `Votes: ${loan.approvals.length} of ${this.currentGroup.members.length} (${Math.round((loan.approvals.length / this.currentGroup.members.length) * 100)}%)`;
                        
                        const voteProgress = document.createElement('div');
                        voteProgress.className = 'progress vote-progress';
                        voteProgress.style.height = '10px';
                        
                        const voteBar = document.createElement('div');
                        voteBar.className = 'progress-bar';
                        voteBar.style.width = `${(loan.approvals.length / this.currentGroup.members.length) * 100}%`;
                        voteBar.setAttribute('role', 'progressbar');
                        
                        voteProgress.appendChild(voteBar);
                        votes.appendChild(voteText);
                        votes.appendChild(voteProgress);
                        
                        const actions = document.createElement('div');
                        actions.className = 'd-flex justify-content-end';
                        
                        if (!loan.approvals.includes(this.currentUser.id)) {
                            const approveBtn = document.createElement('button');
                            approveBtn.className = 'btn btn-sm btn-success me-2';
                            approveBtn.textContent = 'Approve';
                            approveBtn.addEventListener('click', () => this.approveLoan(loan.id));
                            
                            const rejectBtn = document.createElement('button');
                            rejectBtn.className = 'btn btn-sm btn-danger';
                            rejectBtn.textContent = 'Reject';
                            rejectBtn.addEventListener('click', () => this.rejectLoan(loan.id));
                            
                            actions.appendChild(approveBtn);
                            actions.appendChild(rejectBtn);
                        } else {
                            const votedBadge = document.createElement('span');
                            votedBadge.className = 'badge bg-success';
                            votedBadge.textContent = 'You voted to approve';
                            actions.appendChild(votedBadge);
                        }
                        
                        cardBody.appendChild(purpose);
                        cardBody.appendChild(details);
                        cardBody.appendChild(votes);
                        cardBody.appendChild(actions);
                        
                        card.appendChild(cardHeader);
                        card.appendChild(cardBody);
                        container.appendChild(card);
                    });
                } catch (error) {
                    console.error('Error loading pending loan approvals:', error);
                    container.innerHTML = '<p>Error loading pending approvals</p>';
                }
            }

            async updateShares() {
                if (!this.currentUser || !this.currentGroup) return;
                
                // Check if shares are enabled
                const sharesEnabled = this.currentGroup.settings.sharesEnabled;
                document.getElementById('newShareBtn').disabled = !sharesEnabled;
                document.getElementById('buySharesBtn').disabled = !sharesEnabled;
                
                if (!sharesEnabled) {
                    document.getElementById('sharesContent').innerHTML = `
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Shares Market</h1>
                        </div>
                        <div class="alert alert-info">
                            Shares market is currently disabled for this group. Contact your group admin for more information.
                        </div>
                    `;
                    return;
                }
                
                // Update shares summary
                const shares = await this.getUserShares(this.currentUser.id, this.currentGroup.id);
                const sharesForSale = await this.getSharesForSale(this.currentGroup.id);
                
                const totalShares = shares.reduce((sum, share) => sum + share.amount, 0);
                const totalValue = totalShares * (this.currentGroup.settings.shareValue || 1);
                const forSale = sharesForSale.filter(share => share.sellerId === this.currentUser.id)
                    .reduce((sum, share) => sum + share.amount, 0);
                
                document.getElementById('sharesTotalAmount').textContent = totalShares.toLocaleString();
                document.getElementById('sharesValue').textContent = 
                    `${this.currentGroup.currency} ${(this.currentGroup.settings.shareValue || 1).toLocaleString()}`;
                document.getElementById('sharesTotalValue').textContent = 
                    `${this.currentGroup.currency} ${totalValue.toLocaleString()}`;
                document.getElementById('sharesForSale').textContent = forSale.toLocaleString();
                
                // Load shares market
                this.loadSharesMarket();
                
                // Load shares transactions
                this.loadSharesTransactions();
            }

            async loadSharesMarket() {
                try {
                    const shares = await this.getSharesForSale(this.currentGroup.id);
                    const container = document.getElementById('sharesMarketList');
                    container.innerHTML = '';
                    
                    if (shares.length === 0) {
                        container.innerHTML = '<p>No shares currently available</p>';
                        return;
                    }
                    
                    // Filter out shares listed by the current user
                    const availableShares = shares.filter(share => share.sellerId !== this.currentUser.id);
                    
                    if (availableShares.length === 0) {
                        container.innerHTML = '<p>No shares currently available</p>';
                        return;
                    }
                    
                    availableShares.forEach(share => {
                        const card = document.createElement('div');
                        card.className = 'card mb-3 share-market-item';
                        
                        const cardHeader = document.createElement('div');
                        cardHeader.className = 'card-header d-flex justify-content-between align-items-center';
                        
                        const title = document.createElement('h6');
                        title.className = 'mb-0';
                        title.textContent = `${share.amount} Shares Available`;
                        
                        const price = document.createElement('span');
                        price.className = 'badge bg-primary';
                        price.textContent = `${this.currentGroup.currency} ${share.pricePerShare.toLocaleString()} each`;
                        
                        cardHeader.appendChild(title);
                        cardHeader.appendChild(price);
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body';
                        
                        const seller = document.createElement('p');
                        seller.className = 'small mb-2';
                        seller.textContent = `Seller: ${share.seller.name}`;
                        
                        const total = document.createElement('p');
                        total.className = 'small mb-3';
                        total.textContent = `Total Value: ${this.currentGroup.currency} ${(share.amount * share.pricePerShare).toLocaleString()}`;
                        
                        const date = document.createElement('p');
                        date.className = 'small text-muted mb-3';
                        date.textContent = `Listed on: ${new Date(share.dateListed).toLocaleDateString()}`;
                        
                        const actions = document.createElement('div');
                        actions.className = 'd-flex justify-content-end';
                        
                        const buyBtn = document.createElement('button');
                        buyBtn.className = 'btn btn-sm btn-success';
                        buyBtn.textContent = 'Buy Shares';
                        buyBtn.addEventListener('click', () => this.showShareDetails(share.id));
                        
                        actions.appendChild(buyBtn);
                        
                        cardBody.appendChild(seller);
                        cardBody.appendChild(total);
                        cardBody.appendChild(date);
                        cardBody.appendChild(actions);
                        
                        card.appendChild(cardHeader);
                        card.appendChild(cardBody);
                        container.appendChild(card);
                    });
                } catch (error) {
                    console.error('Error loading shares market:', error);
                    container.innerHTML = '<p>Error loading shares market</p>';
                }
            }

            async loadSharesTransactions() {
                try {
                    const transactions = await this.getShareTransactions(this.currentUser.id, this.currentGroup.id);
                    const container = document.getElementById('sharesTransactionsTable');
                    container.innerHTML = '';
                    
                    if (transactions.length === 0) {
                        container.innerHTML = '<tr><td colspan="6" class="text-center py-4">No share transactions</td></tr>';
                        return;
                    }
                    
                    // Sort by date descending
                    transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    transactions.forEach(transaction => {
                        const row = document.createElement('tr');
                        
                        const dateCell = document.createElement('td');
                        dateCell.textContent = new Date(transaction.date).toLocaleDateString();
                        
                        const typeCell = document.createElement('td');
                        typeCell.textContent = transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1);
                        
                        const sharesCell = document.createElement('td');
                        sharesCell.textContent = transaction.shares.toLocaleString();
                        
                        const amountCell = document.createElement('td');
                        amountCell.textContent = `${this.currentGroup.currency} ${transaction.amount.toLocaleString()}`;
                        
                        const counterpartyCell = document.createElement('td');
                        counterpartyCell.textContent = transaction.counterparty.name;
                        
                        const statusCell = document.createElement('td');
                        const statusBadge = document.createElement('span');
                        statusBadge.className = transaction.status === 'completed' ? 'badge bg-success' : 
                                               transaction.status === 'pending' ? 'badge bg-warning' : 'badge bg-danger';
                        statusBadge.textContent = transaction.status.charAt(0).toUpperCase() + transaction.status.slice(1);
                        statusCell.appendChild(statusBadge);
                        
                        row.appendChild(dateCell);
                        row.appendChild(typeCell);
                        row.appendChild(sharesCell);
                        row.appendChild(amountCell);
                        row.appendChild(counterpartyCell);
                        row.appendChild(statusCell);
                        
                        container.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error loading share transactions:', error);
                    container.innerHTML = '<tr><td colspan="6" class="text-center py-4">Error loading transactions</td></tr>';
                }
            }

            async updateMembers() {
                if (!this.currentUser || !this.currentGroup) return;
                
                // Update group summary
                document.getElementById('membersTotalCount').textContent = this.currentGroup.members.length;
                
                const activeMembers = await this.getActiveMembers(this.currentGroup.id);
                document.getElementById('membersActiveCount').textContent = activeMembers.length;
                
                const groupSavings = await this.getGroupSavings(this.currentGroup.id);
                const groupTotal = groupSavings.reduce((sum, saving) => sum + saving.amount, 0);
                document.getElementById('membersGroupTotal').textContent = `${this.currentGroup.currency} ${groupTotal.toLocaleString()}`;
                
                // Update cycle info
                const cycleStart = new Date(this.currentGroup.cycleStartDate);
                const cycleEnd = new Date(cycleStart);
                cycleEnd.setDate(cycleStart.getDate() + this.currentGroup.settings.cycleLength);
                
                const today = new Date();
                const daysPassed = Math.floor((today - cycleStart) / (1000 * 60 * 60 * 24));
                document.getElementById('membersCycleInfo').textContent = `Day ${daysPassed} of ${this.currentGroup.settings.cycleLength}`;
                
                // Update next saving day
                const nextSavingDay = this.calculateNextSavingDay();
                document.getElementById('membersNextSaving').textContent = nextSavingDay.formattedDate;
                
                // Update savings distribution chart
                this.updateSavingsDistributionChart();
                
                // Load members list
                this.loadMembersList();
                
                // Load pending approvals (for admins)
                if (this.isGroupAdmin || this.isSuperAdmin) {
                    this.loadPendingMemberApprovals();
                }
            }

            async updateSavingsDistributionChart() {
                try {
                    const members = await this.getGroupMembers(this.currentGroup.id);
                    const groupSavings = await this.getGroupSavings(this.currentGroup.id);
                    
                    const memberSavings = {};
                    let groupTotal = 0;
                    
                    // Calculate total savings per member
                    groupSavings.forEach(saving => {
                        if (saving.status === 'confirmed') {
                            memberSavings[saving.userId] = (memberSavings[saving.userId] || 0) + saving.amount;
                            groupTotal += saving.amount;
                        }
                    });
                    
                    // Prepare chart data
                    const labels = [];
                    const data = [];
                    const backgroundColors = [];
                    
                    members.forEach(member => {
                        labels.push(member.name);
                        const savings = memberSavings[member.id] || 0;
                        data.push(savings);
                        
                        // Generate a color for each member
                        const color = `hsl(${Math.random() * 360}, 70%, 50%)`;
                        backgroundColors.push(color);
                    });
                    
                    // Get or create chart
                    const ctx = document.getElementById('savingsDistributionChart').getContext('2d');
                    
                    if (this.savingsChart) {
                        this.savingsChart.data.labels = labels;
                        this.savingsChart.data.datasets[0].data = data;
                        this.savingsChart.data.datasets[0].backgroundColor = backgroundColors;
                        this.savingsChart.update();
                    } else {
                        this.savingsChart = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: data,
                                    backgroundColor: backgroundColors,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'right',
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: (context) => {
                                                const value = context.raw;
                                                const percentage = groupTotal > 0 ? 
                                                    Math.round((value / groupTotal) * 100) : 0;
                                                return `${this.currentGroup.currency} ${value.toLocaleString()} (${percentage}%)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error updating savings distribution chart:', error);
                }
            }

            async loadMembersList() {
                try {
                    const members = await this.getGroupMembers(this.currentGroup.id);
                    const container = document.getElementById('membersList');
                    container.innerHTML = '';
                    
                    if (members.length === 0) {
                        container.innerHTML = '<p>No members in this group</p>';
                        return;
                    }
                    
                    // Sort members by name
                    members.sort((a, b) => a.name.localeCompare(b.name));
                    
                    members.forEach(member => {
                        const col = document.createElement('div');
                        col.className = 'col-md-6 col-lg-4 mb-3';
                        
                        const card = document.createElement('div');
                        card.className = 'card member-card h-100';
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body';
                        
                        const row = document.createElement('div');
                        row.className = 'row align-items-center';
                        
                        const imgCol = document.createElement('div');
                        imgCol.className = 'col-4';
                        
                        const img = document.createElement('img');
                        img.src = member.profilePicture || 'https://via.placeholder.com/100';
                        img.className = 'img-fluid rounded-circle';
                        img.alt = member.name;
                        
                        imgCol.appendChild(img);
                        
                        const infoCol = document.createElement('div');
                        infoCol.className = 'col-8';
                        
                        const name = document.createElement('h5');
                        name.className = 'mb-1';
                        name.textContent = member.name;
                        
                        const role = document.createElement('p');
                        role.className = 'small text-muted mb-1';
                        
                        if (member.id === this.currentGroup.adminId) {
                            role.textContent = 'Group Admin';
                        } else if (member.roles && member.roles.includes('group_admin')) {
                            role.textContent = 'Group Admin';
                        } else if (member.roles && member.roles.includes('super_admin')) {
                            role.textContent = 'Super Admin';
                        } else {
                            role.textContent = 'Member';
                        }
                        
                        const lastActive = document.createElement('p');
                        lastActive.className = 'small text-muted mb-0';
                        lastActive.textContent = `Last active: ${new Date(member.lastActive).toLocaleDateString()}`;
                        
                        infoCol.appendChild(name);
                        infoCol.appendChild(role);
                        infoCol.appendChild(lastActive);
                        
                        row.appendChild(imgCol);
                        row.appendChild(infoCol);
                        cardBody.appendChild(row);
                        
                        // Add admin actions if current user is admin
                        if ((this.isGroupAdmin || this.isSuperAdmin) && member.id !== this.currentUser.id) {
                            const footer = document.createElement('div');
                            footer.className = 'card-footer bg-transparent border-top-0';
                            
                            const btnGroup = document.createElement('div');
                            btnGroup.className = 'd-flex justify-content-between';
                            
                            const messageBtn = document.createElement('button');
                            messageBtn.className = 'btn btn-sm btn-outline-primary';
                            messageBtn.textContent = 'Message';
                            messageBtn.addEventListener('click', () => this.startNewMessage(member.id));
                            
                            const actionsBtn = document.createElement('button');
                            actionsBtn.className = 'btn btn-sm btn-outline-secondary';
                            actionsBtn.textContent = 'Actions';
                            actionsBtn.addEventListener('click', () => this.showMemberActions(member.id));
                            
                            btnGroup.appendChild(messageBtn);
                            btnGroup.appendChild(actionsBtn);
                            footer.appendChild(btnGroup);
                            cardBody.appendChild(footer);
                        }
                        
                        card.appendChild(cardBody);
                        col.appendChild(card);
                        container.appendChild(col);
                    });
                } catch (error) {
                    console.error('Error loading members list:', error);
                    container.innerHTML = '<p>Error loading members</p>';
                }
            }

            async loadPendingMemberApprovals() {
                try {
                    const pendingMembers = await this.getPendingMembers(this.currentGroup.id);
                    const container = document.getElementById('pendingApprovalsList');
                    container.innerHTML = '';
                    
                    if (pendingMembers.length === 0) {
                        container.innerHTML = '<p>No pending member approvals</p>';
                        return;
                    }
                    
                    pendingMembers.forEach(member => {
                        const card = document.createElement('div');
                        card.className = 'card mb-3';
                        
                        const cardHeader = document.createElement('div');
                        cardHeader.className = 'card-header';
                        cardHeader.textContent = 'Pending Approval';
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body';
                        
                        const row = document.createElement('div');
                        row.className = 'row align-items-center';
                        
                        const imgCol = document.createElement('div');
                        imgCol.className = 'col-3';
                        
                        const img = document.createElement('img');
                        img.src = member.profilePicture || 'https://via.placeholder.com/80';
                        img.className = 'img-fluid rounded-circle';
                        img.alt = member.name;
                        
                        imgCol.appendChild(img);
                        
                        const infoCol = document.createElement('div');
                        infoCol.className = 'col-9';
                        
                        const name = document.createElement('h5');
                        name.className = 'mb-1';
                        name.textContent = member.name;
                        
                        const email = document.createElement('p');
                        email.className = 'small text-muted mb-1';
                        email.textContent = member.email;
                        
                        const phone = document.createElement('p');
                        phone.className = 'small text-muted mb-3';
                        phone.textContent = member.phone;
                        
                        const actions = document.createElement('div');
                        actions.className = 'd-flex justify-content-end';
                        
                        const approveBtn = document.createElement('button');
                        approveBtn.className = 'btn btn-sm btn-success me-2';
                        approveBtn.textContent = 'Approve';
                        approveBtn.addEventListener('click', () => this.approveMember(member.id));
                        
                        const rejectBtn = document.createElement('button');
                        rejectBtn.className = 'btn btn-sm btn-danger';
                        rejectBtn.textContent = 'Reject';
                        rejectBtn.addEventListener('click', () => this.rejectMember(member.id));
                        
                        actions.appendChild(approveBtn);
                        actions.appendChild(rejectBtn);
                        
                        infoCol.appendChild(name);
                        infoCol.appendChild(email);
                        infoCol.appendChild(phone);
                        infoCol.appendChild(actions);
                        
                        row.appendChild(imgCol);
                        row.appendChild(infoCol);
                        cardBody.appendChild(row);
                        card.appendChild(cardHeader);
                        card.appendChild(cardBody);
                        container.appendChild(card);
                    });
                } catch (error) {
                    console.error('Error loading pending member approvals:', error);
                    container.innerHTML = '<p>Error loading pending approvals</p>';
                }
            }

            async updateMessages() {
                // Implement message loading logic
                // This would load the user's messages and display them
                console.log('Updating messages...');
            }

            async updateProfile() {
                if (!this.currentUser) return;
                
                // Update profile form
                document.getElementById('profileName').value = this.currentUser.name;
                document.getElementById('profileUsername').value = this.currentUser.username || '';
                document.getElementById('profileEmail').value = this.currentUser.email;
                document.getElementById('profilePhone').value = this.currentUser.phone || '';
                document.getElementById('profileLocation').value = this.currentUser.location || '';
                document.getElementById('profileNextOfKin').value = this.currentUser.nextOfKin || '';
                document.getElementById('profileNextOfKinPhone').value = this.currentUser.nextOfKinPhone || '';
                
                // Update profile picture
                document.getElementById('profilePicture').src = this.currentUser.profilePicture || 'https://via.placeholder.com/150';
                
                // Load user groups
                this.loadUserGroups();
            }

            async loadUserGroups() {
                try {
                    const groups = await this.getUserGroups(this.currentUser.id);
                    const container = document.getElementById('userGroupsList');
                    container.innerHTML = '';
                    
                    if (groups.length === 0) {
                        container.innerHTML = '<p>You are not a member of any groups</p>';
                        return;
                    }
                    
                    groups.forEach(group => {
                        const card = document.createElement('div');
                        card.className = 'card mb-3';
                        
                        const cardHeader = document.createElement('div');
                        cardHeader.className = 'card-header d-flex justify-content-between align-items-center';
                        
                        const title = document.createElement('h6');
                        title.className = 'mb-0';
                        title.textContent = group.name;
                        
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-primary';
                        
                        if (group.adminId === this.currentUser.id) {
                            badge.textContent = 'Admin';
                        } else if (group.moderators && group.moderators.includes(this.currentUser.id)) {
                            badge.textContent = 'Moderator';
                        } else {
                            badge.textContent = 'Member';
                        }
                        
                        cardHeader.appendChild(title);
                        cardHeader.appendChild(badge);
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body';
                        
                        const currency = document.createElement('p');
                        currency.className = 'small mb-1';
                        currency.textContent = `Currency: ${group.currency}`;
                        
                        const members = document.createElement('p');
                        members.className = 'small mb-1';
                        members.textContent = `Members: ${group.members.length}`;
                        
                        const savings = document.createElement('p');
                        savings.className = 'small mb-3';
                        savings.textContent = `Total Savings: ${group.currency} ${group.totalSavings?.toLocaleString() || '0'}`;
                        
                        const btnGroup = document.createElement('div');
                        btnGroup.className = 'd-flex justify-content-between';
                        
                        const viewBtn = document.createElement('button');
                        viewBtn.className = 'btn btn-sm btn-outline-primary';
                        viewBtn.textContent = 'View';
                        viewBtn.addEventListener('click', () => {
                            this.loadGroupData(group.id);
                            this.showContent('dashboardContent');
                        });
                        
                        const leaveBtn = document.createElement('button');
                        leaveBtn.className = 'btn btn-sm btn-outline-danger';
                        leaveBtn.textContent = 'Leave';
                        leaveBtn.addEventListener('click', () => this.leaveGroup(group.id));
                        
                        btnGroup.appendChild(viewBtn);
                        
                        // Don't allow leaving if user is the admin
                        if (group.adminId !== this.currentUser.id) {
                            btnGroup.appendChild(leaveBtn);
                        }
                        
                        cardBody.appendChild(currency);
                        cardBody.appendChild(members);
                        cardBody.appendChild(savings);
                        cardBody.appendChild(btnGroup);
                        
                        card.appendChild(cardHeader);
                        card.appendChild(cardBody);
                        container.appendChild(card);
                    });
                } catch (error) {
                    console.error('Error loading user groups:', error);
                    container.innerHTML = '<p>Error loading groups</p>';
                }
            }

            async updateAdminPanel() {
                if (!this.currentUser || !this.currentGroup || !this.isGroupAdmin) return;
                
                // Update admin summary
                const activeMembers = await this.getActiveMembers(this.currentGroup.id);
                const inactiveMembers = this.currentGroup.members.length - activeMembers.length;
                
                document.getElementById('adminActiveMembers').textContent = activeMembers.length;
                document.getElementById('adminInactiveMembers').textContent = inactiveMembers;
                
                const groupSavings = await this.getGroupSavings(this.currentGroup.id);
                const totalSavings = groupSavings.reduce((sum, saving) => sum + saving.amount, 0);
                const pendingSavings = groupSavings.filter(s => s.status === 'pending')
                    .reduce((sum, saving) => sum + saving.amount, 0);
                
                document.getElementById('adminTotalSavings').textContent = `${this.currentGroup.currency} ${totalSavings.toLocaleString()}`;
                document.getElementById('adminPendingSavings').textContent = `${this.currentGroup.currency} ${pendingSavings.toLocaleString()}`;
                
                const activeLoans = await this.getActiveLoans(this.currentGroup.id);
                document.getElementById('adminActiveLoans').textContent = activeLoans.length;
                
                const sharesOnMarket = await this.getSharesForSale(this.currentGroup.id);
                document.getElementById('adminSharesMarket').textContent = sharesOnMarket.length;
                
                // Load admin activities
                this.loadAdminActivities();
                
                // Load pending actions
                this.loadAdminPendingActions();
                
                // Load members savings
                this.loadMembersSavings();
                
                // Load savings history
                this.loadAdminSavingsHistory();
            }

            async loadAdminActivities() {
                try {
                    const activities = await this.getGroupActivities(this.currentGroup.id, 5);
                    const container = document.getElementById('adminActivities');
                    container.innerHTML = '';
                    
                    if (activities.length === 0) {
                        container.innerHTML = '<p>No recent activities</p>';
                        return;
                    }
                    
                    activities.forEach(activity => {
                        const item = document.createElement('div');
                        item.className = 'timeline-item';
                        
                        const content = document.createElement('div');
                        content.className = 'card p-2';
                        
                        const title = document.createElement('h6');
                        title.className = 'mb-1';
                        title.textContent = activity.title;
                        
                        const description = document.createElement('p');
                        description.className = 'small text-muted mb-1';
                        description.textContent = activity.description;
                        
                        const date = document.createElement('small');
                        date.className = 'text-muted';
                        date.textContent = new Date(activity.timestamp).toLocaleString();
                        
                        content.appendChild(title);
                        content.appendChild(description);
                        content.appendChild(date);
                        
                        item.appendChild(content);
                        container.appendChild(item);
                    });
                } catch (error) {
                    console.error('Error loading admin activities:', error);
                    document.getElementById('adminActivities').innerHTML = '<p>Error loading activities</p>';
                }
            }

            async loadAdminPendingActions() {
                try {
                    const pendingSavings = await this.getPendingSavings(this.currentGroup.id);
                    const pendingLoans = await this.getPendingLoans(this.currentGroup.id);
                    const pendingShares = await this.getPendingShares(this.currentGroup.id);
                    
                    const container = document.getElementById('adminPendingActions');
                    container.innerHTML = '';
                    
                    if (pendingSavings.length === 0 && pendingLoans.length === 0 && pendingShares.length === 0) {
                        container.innerHTML = '<p>No pending actions</p>';
                        return;
                    }
                    
                    // Pending savings
                    if (pendingSavings.length > 0) {
                        const heading = document.createElement('h6');
                        heading.className = 'mb-2';
                        heading.textContent = 'Pending Savings Approvals';
                        container.appendChild(heading);
                        
                        pendingSavings.forEach(saving => {
                            const card = document.createElement('div');
                            card.className = 'card mb-2';
                            
                            const cardBody = document.createElement('div');
                            cardBody.className = 'card-body p-2';
                            
                            const row = document.createElement('div');
                            row.className = 'row align-items-center';
                            
                            const memberCol = document.createElement('div');
                            memberCol.className = 'col-md-4';
                            memberCol.textContent = saving.member.name;
                            
                            const amountCol = document.createElement('div');
                            amountCol.className = 'col-md-3';
                            amountCol.textContent = `${this.currentGroup.currency} ${saving.amount.toLocaleString()}`;
                            
                            const dateCol = document.createElement('div');
                            dateCol.className = 'col-md-3';
                            dateCol.textContent = new Date(saving.date).toLocaleDateString();
                            
                            const actionsCol = document.createElement('div');
                            actionsCol.className = 'col-md-2 text-end';
                            
                            const approveBtn = document.createElement('button');
                            approveBtn.className = 'btn btn-sm btn-success me-1';
                            approveBtn.innerHTML = '<i class="fas fa-check"></i>';
                            approveBtn.addEventListener('click', () => this.approveSaving(saving.id));
                            
                            const rejectBtn = document.createElement('button');
                            rejectBtn.className = 'btn btn-sm btn-danger';
                            rejectBtn.innerHTML = '<i class="fas fa-times"></i>';
                            rejectBtn.addEventListener('click', () => this.rejectSaving(saving.id));
                            
                            actionsCol.appendChild(approveBtn);
                            actionsCol.appendChild(rejectBtn);
                            
                            row.appendChild(memberCol);
                            row.appendChild(amountCol);
                            row.appendChild(dateCol);
                            row.appendChild(actionsCol);
                            cardBody.appendChild(row);
                            card.appendChild(cardBody);
                            container.appendChild(card);
                        });
                    }
                    
                    // Pending loans
                    if (pendingLoans.length > 0) {
                        const heading = document.createElement('h6');
                        heading.className = 'mb-2 mt-3';
                        heading.textContent = 'Pending Loan Approvals';
                        container.appendChild(heading);
                        
                        pendingLoans.forEach(loan => {
                            const card = document.createElement('div');
                            card.className = 'card mb-2';
                            
                            const cardBody = document.createElement('div');
                            cardBody.className = 'card-body p-2';
                            
                            const row = document.createElement('div');
                            row.className = 'row align-items-center';
                            
                            const memberCol = document.createElement('div');
                            memberCol.className = 'col-md-3';
                            memberCol.textContent = loan.member.name;
                            
                            const amountCol = document.createElement('div');
                            amountCol.className = 'col-md-2';
                            amountCol.textContent = `${this.currentGroup.currency} ${loan.amount.toLocaleString()}`;
                            
                            const interestCol = document.createElement('div');
                            interestCol.className = 'col-md-2';
                            interestCol.textContent = `${loan.interestRate}%`;
                            
                            const votesCol = document.createElement('div');
                            votesCol.className = 'col-md-2';
                            votesCol.textContent = `${loan.approvals.length}/${this.currentGroup.members.length}`;
                            
                            const actionsCol = document.createElement('div');
                            actionsCol.className = 'col-md-3 text-end';
                            
                            const approveBtn = document.createElement('button');
                            approveBtn.className = 'btn btn-sm btn-success me-1';
                            approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve';
                            approveBtn.addEventListener('click', () => this.approveLoan(loan.id));
                            
                            const rejectBtn = document.createElement('button');
                            rejectBtn.className = 'btn btn-sm btn-danger me-1';
                            rejectBtn.innerHTML = '<i class="fas fa-times"></i> Reject';
                            rejectBtn.addEventListener('click', () => this.rejectLoan(loan.id));
                            
                            const detailsBtn = document.createElement('button');
                            detailsBtn.className = 'btn btn-sm btn-outline-primary';
                            detailsBtn.innerHTML = '<i class="fas fa-info-circle"></i>';
                            detailsBtn.addEventListener('click', () => this.showLoanDetails(loan.id));
                            
                            actionsCol.appendChild(approveBtn);
                            actionsCol.appendChild(rejectBtn);
                            actionsCol.appendChild(detailsBtn);
                            
                            row.appendChild(memberCol);
                            row.appendChild(amountCol);
                            row.appendChild(interestCol);
                            row.appendChild(votesCol);
                            row.appendChild(actionsCol);
                            cardBody.appendChild(row);
                            card.appendChild(cardBody);
                            container.appendChild(card);
                        });
                    }
                    
                    // Pending shares
                    if (pendingShares.length > 0) {
                        const heading = document.createElement('h6');
                        heading.className = 'mb-2 mt-3';
                        heading.textContent = 'Pending Share Approvals';
                        container.appendChild(heading);
                        
                        pendingShares.forEach(share => {
                            const card = document.createElement('div');
                            card.className = 'card mb-2';
                            
                            const cardBody = document.createElement('div');
                            cardBody.className = 'card-body p-2';
                            
                            const row = document.createElement('div');
                            row.className = 'row align-items-center';
                            
                            const memberCol = document.createElement('div');
                            memberCol.className = 'col-md-3';
                            memberCol.textContent = share.seller.name;
                            
                            const sharesCol = document.createElement('div');
                            sharesCol.className = 'col-md-2';
                            sharesCol.textContent = share.amount;
                            
                            const priceCol = document.createElement('div');
                            priceCol.className = 'col-md-2';
                            priceCol.textContent = `${this.currentGroup.currency} ${share.pricePerShare.toLocaleString()}`;
                            
                            const totalCol = document.createElement('div');
                            totalCol.className = 'col-md-2';
                            totalCol.textContent = `${this.currentGroup.currency} ${(share.amount * share.pricePerShare).toLocaleString()}`;
                            
                            const actionsCol = document.createElement('div');
                            actionsCol.className = 'col-md-3 text-end';
                            
                            const approveBtn = document.createElement('button');
                            approveBtn.className = 'btn btn-sm btn-success me-1';
                            approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve';
                            approveBtn.addEventListener('click', () => this.approveShare(share.id));
                            
                            const rejectBtn = document.createElement('button');
                            rejectBtn.className = 'btn btn-sm btn-danger';
                            rejectBtn.innerHTML = '<i class="fas fa-times"></i> Reject';
                            rejectBtn.addEventListener('click', () => this.rejectShare(share.id));
                            
                            actionsCol.appendChild(approveBtn);
                            actionsCol.appendChild(rejectBtn);
                            
                            row.appendChild(memberCol);
                            row.appendChild(sharesCol);
                            row.appendChild(priceCol);
                            row.appendChild(totalCol);
                            row.appendChild(actionsCol);
                            cardBody.appendChild(row);
                            card.appendChild(cardBody);
                            container.appendChild(card);
                        });
                    }
                } catch (error) {
                    console.error('Error loading admin pending actions:', error);
                    container.innerHTML = '<p>Error loading pending actions</p>';
                }
            }

            async loadMembersSavings() {
                try {
                    const members = await this.getGroupMembers(this.currentGroup.id);
                    const savings = await this.getGroupSavings(this.currentGroup.id);
                    const groupTotal = savings.reduce((sum, s) => s.status === 'confirmed' ? sum + s.amount : sum, 0);
                    
                    const container = document.getElementById('adminMembersSavings');
                    container.innerHTML = '';
                    
                    if (members.length === 0) {
                        container.innerHTML = '<tr><td colspan="6" class="text-center py-4">No members in this group</td></tr>';
                        return;
                    }
                    
                    // Calculate savings per member
                    const memberSavings = {};
                    savings.forEach(saving => {
                        if (saving.status === 'confirmed') {
                            memberSavings[saving.userId] = (memberSavings[saving.userId] || 0) + saving.amount;
                        }
                    });
                    
                    // Sort members by savings (descending)
                    members.sort((a, b) => (memberSavings[b.id] || 0) - (memberSavings[a.id] || 0));
                    
                    members.forEach(member => {
                        const savingsAmount = memberSavings[member.id] || 0;
                        const percentage = groupTotal > 0 ? Math.round((savingsAmount / groupTotal) * 100) : 0;
                        
                        const row = document.createElement('tr');
                        
                        const nameCell = document.createElement('td');
                        nameCell.textContent = member.name;
                        
                        const totalCell = document.createElement('td');
                        totalCell.textContent = `${this.currentGroup.currency} ${savingsAmount.toLocaleString()}`;
                        
                        const percentageCell = document.createElement('td');
                        percentageCell.textContent = `${percentage}%`;
                        
                        const lastCell = document.createElement('td');
                        const lastSaving = savings
                            .filter(s => s.userId === member.id && s.status === 'confirmed')
                            .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                        
                        lastCell.textContent = lastSaving ? new Date(lastSaving.date).toLocaleDateString() : '--';
                        
                        const statusCell = document.createElement('td');
                        const statusBadge = document.createElement('span');
                        
                        // Determine status (active if saved in last 30 days)
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        
                        const isActive = lastSaving && new Date(lastSaving.date) >= thirtyDaysAgo;
                        
                        statusBadge.className = isActive ? 'badge bg-success' : 'badge bg-warning';
                        statusBadge.textContent = isActive ? 'Active' : 'Inactive';
                        statusCell.appendChild(statusBadge);
                        
                        const actionsCell = document.createElement('td');
                        
                        if (member.id !== this.currentUser.id) {
                            const messageBtn = document.createElement('button');
                            messageBtn.className = 'btn btn-sm btn-outline-primary me-1';
                            messageBtn.innerHTML = '<i class="fas fa-envelope"></i>';
                            messageBtn.addEventListener('click', () => this.startNewMessage(member.id));
                            
                            const addSavingBtn = document.createElement('button');
                            addSavingBtn.className = 'btn btn-sm btn-outline-success';
                            addSavingBtn.innerHTML = '<i class="fas fa-plus-circle"></i>';
                            addSavingBtn.addEventListener('click', () => this.startAddSavingForMember(member.id));
                            
                            actionsCell.appendChild(messageBtn);
                            actionsCell.appendChild(addSavingBtn);
                        } else {
                            actionsCell.textContent = '--';
                        }
                        
                        row.appendChild(nameCell);
                        row.appendChild(totalCell);
                        row.appendChild(percentageCell);
                        row.appendChild(lastCell);
                        row.appendChild(statusCell);
                        row.appendChild(actionsCell);
                        
                        container.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error loading members savings:', error);
                    container.innerHTML = '<tr><td colspan="6" class="text-center py-4">Error loading data</td></tr>';
                }
            }

            async loadAdminSavingsHistory() {
                try {
                    const savings = await this.getGroupSavings(this.currentGroup.id);
                    const container = document.getElementById('adminSavingsHistory');
                    container.innerHTML = '';
                    
                    if (savings.length === 0) {
                        container.innerHTML = '<p>No savings history</p>';
                        return;
                    }
                    
                    // Group savings by date
                    const savingsByDate = {};
                    savings.forEach(saving => {
                        const dateStr = new Date(saving.date).toLocaleDateString();
                        if (!savingsByDate[dateStr]) {
                            savingsByDate[dateStr] = [];
                        }
                        savingsByDate[dateStr].push(saving);
                    });
                    
                    // Sort dates descending
                    const sortedDates = Object.keys(savingsByDate).sort((a, b) => new Date(b) - new Date(a));
                    
                    sortedDates.forEach(dateStr => {
                        const dateGroup = document.createElement('div');
                        dateGroup.className = 'mb-4';
                        
                        const dateHeader = document.createElement('h5');
                        dateHeader.className = 'mb-3';
                        dateHeader.textContent = dateStr;
                        
                        dateGroup.appendChild(dateHeader);
                        
                        const savingsList = document.createElement('div');
                        savingsList.className = 'list-group';
                        
                        savingsByDate[dateStr].forEach(saving => {
                            const item = document.createElement('div');
                            item.className = 'list-group-item';
                            
                            const row = document.createElement('div');
                            row.className = 'row align-items-center';
                            
                            const memberCol = document.createElement('div');
                            memberCol.className = 'col-md-4';
                            memberCol.textContent = saving.member.name;
                            
                            const amountCol = document.createElement('div');
                            amountCol.className = 'col-md-2';
                            amountCol.textContent = `${this.currentGroup.currency} ${saving.amount.toLocaleString()}`;
                            
                            const methodCol = document.createElement('div');
                            methodCol.className = 'col-md-2';
                            methodCol.textContent = saving.method.charAt(0).toUpperCase() + saving.method.slice(1);
                            
                            const statusCol = document.createElement('div');
                            statusCol.className = 'col-md-2';
                            
                            const statusBadge = document.createElement('span');
                            statusBadge.className = saving.status === 'confirmed' ? 'badge bg-success' : 
                                                  saving.status === 'pending' ? 'badge bg-warning' : 'badge bg-danger';
                            statusBadge.textContent = saving.status.charAt(0).toUpperCase() + saving.status.slice(1);
                            statusCol.appendChild(statusBadge);
                            
                            const actionsCol = document.createElement('div');
                            actionsCol.className = 'col-md-2 text-end';
                            
                            if (saving.status === 'pending') {
                                const approveBtn = document.createElement('button');
                                approveBtn.className = 'btn btn-sm btn-success me-1';
                                approveBtn.innerHTML = '<i class="fas fa-check"></i>';
                                approveBtn.addEventListener('click', () => this.approveSaving(saving.id));
                                
                                const rejectBtn = document.createElement('button');
                                rejectBtn.className = 'btn btn-sm btn-danger';
                                rejectBtn.innerHTML = '<i class="fas fa-times"></i>';
                                rejectBtn.addEventListener('click', () => this.rejectSaving(saving.id));
                                
                                actionsCol.appendChild(approveBtn);
                                actionsCol.appendChild(rejectBtn);
                            } else {
                                actionsCol.textContent = '--';
                            }
                            
                            row.appendChild(memberCol);
                            row.appendChild(amountCol);
                            row.appendChild(methodCol);
                            row.appendChild(statusCol);
                            row.appendChild(actionsCol);
                            item.appendChild(row);
                            savingsList.appendChild(item);
                        });
                        
                        dateGroup.appendChild(savingsList);
                        container.appendChild(dateGroup);
                    });
                } catch (error) {
                    console.error('Error loading admin savings history:', error);
                    container.innerHTML = '<p>Error loading history</p>';
                }
            }

            async updateSuperAdminPanel() {
                if (!this.currentUser || !this.isSuperAdmin) return;
                
                // Update system statistics
                const groups = await this.getAllGroups();
                const activeGroups = groups.filter(group => {
                    const lastActive = new Date(group.lastActive);
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    return lastActive >= thirtyDaysAgo;
                });
                
                const inactiveGroups = groups.length - activeGroups.length;
                
                document.getElementById('superAdminTotalGroups').textContent = groups.length;
                document.getElementById('superAdminActiveGroups').textContent = activeGroups.length;
                document.getElementById('superAdminInactiveGroups').textContent = inactiveGroups;
                
                const members = await this.getAllUsers();
                document.getElementById('superAdminTotalMembers').textContent = members.length;
                
                const subscribedGroups = groups.filter(group => group.subscription && 
                    new Date(group.subscription.expiryDate) > new Date()).length;
                document.getElementById('superAdminSubscribedGroups').textContent = subscribedGroups;
                
                const pendingSubscriptions = groups.filter(group => group.subscription && 
                    group.subscription.status === 'pending').length;
                document.getElementById('superAdminPendingSubscriptions').textContent = pendingSubscriptions;
                
                // Load super admin activities
                this.loadSuperAdminActivities();
                
                // Load pending approvals
                this.loadSuperAdminPendingApprovals();
                
                // Load all groups
                this.loadAllGroups();
                
                // Load system logs
                this.loadSystemLogs();
            }

            async loadSuperAdminActivities() {
                try {
                    const activities = await this.getSystemActivities(5);
                    const container = document.getElementById('superAdminActivities');
                    container.innerHTML = '';
                    
                    if (activities.length === 0) {
                        container.innerHTML = '<p>No recent activities</p>';
                        return;
                    }
                    
                    activities.forEach(activity => {
                        const item = document.createElement('div');
                        item.className = 'timeline-item';
                        
                        const content = document.createElement('div');
                        content.className = 'card p-2';
                        
                        const title = document.createElement('h6');
                        title.className = 'mb-1';
                        title.textContent = activity.title;
                        
                        const description = document.createElement('p');
                        description.className = 'small text-muted mb-1';
                        description.textContent = activity.description;
                        
                        const date = document.createElement('small');
                        date.className = 'text-muted';
                        date.textContent = new Date(activity.timestamp).toLocaleString();
                        
                        content.appendChild(title);
                        content.appendChild(description);
                        content.appendChild(date);
                        
                        item.appendChild(content);
                        container.appendChild(item);
                    });
                } catch (error) {
                    console.error('Error loading super admin activities:', error);
                    document.getElementById('superAdminActivities').innerHTML = '<p>Error loading activities</p>';
                }
            }

            async loadSuperAdminPendingApprovals() {
                try {
                    const pendingGroups = await this.getPendingGroups();
                    const container = document.getElementById('superAdminPendingApprovals');
                    container.innerHTML = '';
                    
                    if (pendingGroups.length === 0) {
                        container.innerHTML = '<p>No pending approvals</p>';
                        return;
                    }
                    
                    pendingGroups.forEach(group => {
                        const card = document.createElement('div');
                        card.className = 'card mb-3';
                        
                        const cardHeader = document.createElement('div');
                        cardHeader.className = 'card-header';
                        cardHeader.textContent = 'Group Approval Request';
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body';
                        
                        const row = document.createElement('div');
                        row.className = 'row align-items-center';
                        
                        const infoCol = document.createElement('div');
                        infoCol.className = 'col-md-8';
                        
                        const name = document.createElement('h5');
                        name.className = 'mb-1';
                        name.textContent = group.name;
                        
                        const admin = document.createElement('p');
                        admin.className = 'small text-muted mb-1';
                        admin.textContent = `Admin: ${group.admin.name}`;
                        
                        const members = document.createElement('p');
                        members.className = 'small text-muted mb-1';
                        members.textContent = `Members: ${group.members.length}`;
                        
                        const created = document.createElement('p');
                        created.className = 'small text-muted mb-3';
                        created.textContent = `Created: ${new Date(group.createdDate).toLocaleDateString()}`;
                        
                        infoCol.appendChild(name);
                        infoCol.appendChild(admin);
                        infoCol.appendChild(members);
                        infoCol.appendChild(created);
                        
                        const actionsCol = document.createElement('div');
                        actionsCol.className = 'col-md-4 text-end';
                        
                        const approveBtn = document.createElement('button');
                        approveBtn.className = 'btn btn-success me-2';
                        approveBtn.textContent = 'Approve';
                        approveBtn.addEventListener('click', () => this.approveGroup(group.id));
                        
                        const rejectBtn = document.createElement('button');
                        rejectBtn.className = 'btn btn-danger';
                        rejectBtn.textContent = 'Reject';
                        rejectBtn.addEventListener('click', () => this.rejectGroup(group.id));
                        
                        actionsCol.appendChild(approveBtn);
                        actionsCol.appendChild(rejectBtn);
                        
                        row.appendChild(infoCol);
                        row.appendChild(actionsCol);
                        cardBody.appendChild(row);
                        card.appendChild(cardHeader);
                        card.appendChild(cardBody);
                        container.appendChild(card);
                    });
                } catch (error) {
                    console.error('Error loading super admin pending approvals:', error);
                    container.innerHTML = '<p>Error loading pending approvals</p>';
                }
            }

            async loadAllGroups() {
                try {
                    const groups = await this.getAllGroups();
                    const container = document.getElementById('superAdminGroupsList');
                    container.innerHTML = '';
                    
                    if (groups.length === 0) {
                        container.innerHTML = '<tr><td colspan="7" class="text-center py-4">No groups</td></tr>';
                        return;
                    }
                    
                    // Sort groups by activity (most recent first)
                    groups.sort((a, b) => new Date(b.lastActive) - new Date(a.lastActive));
                    
                    groups.forEach(group => {
                        const row = document.createElement('tr');
                        
                        const nameCell = document.createElement('td');
                        nameCell.textContent = group.name;
                        
                        const membersCell = document.createElement('td');
                        membersCell.textContent = group.members.length;
                        
                        const savingsCell = document.createElement('td');
                        savingsCell.textContent = `${group.currency} ${group.totalSavings?.toLocaleString() || '0'}`;
                        
                        const cycleCell = document.createElement('td');
                        cycleCell.textContent = group.settings?.cycleLength ? `${group.settings.cycleLength} days` : '--';
                        
                        const statusCell = document.createElement('td');
                        const statusBadge = document.createElement('span');
                        
                        // Determine group status
                        const lastActive = new Date(group.lastActive);
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        
                        if (lastActive >= thirtyDaysAgo) {
                            statusBadge.className = 'badge bg-success';
                            statusBadge.textContent = 'Active';
                        } else {
                            statusBadge.className = 'badge bg-warning';
                            statusBadge.textContent = 'Inactive';
                        }
                        
                        statusCell.appendChild(statusBadge);
                        
                        const subscriptionCell = document.createElement('td');
                        if (group.subscription) {
                            const expiryDate = new Date(group.subscription.expiryDate);
                            const today = new Date();
                            
                            if (expiryDate > today) {
                                subscriptionCell.textContent = `Active until ${expiryDate.toLocaleDateString()}`;
                            } else {
                                subscriptionCell.innerHTML = `<span class="text-danger">Expired on ${expiryDate.toLocaleDateString()}</span>`;
                            }
                        } else {
                            subscriptionCell.textContent = 'Not subscribed';
                        }
                        
                        const actionsCell = document.createElement('td');
                        
                        const viewBtn = document.createElement('button');
                        viewBtn.className = 'btn btn-sm btn-outline-primary me-1';
                        viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                        viewBtn.addEventListener('click', () => this.viewGroupDetails(group.id));
                        
                        const messageBtn = document.createElement('button');
                        messageBtn.className = 'btn btn-sm btn-outline-secondary me-1';
                        messageBtn.innerHTML = '<i class="fas fa-envelope"></i>';
                        messageBtn.addEventListener('click', () => this.messageGroupAdmin(group.id));
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-sm btn-outline-danger';
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        deleteBtn.addEventListener('click', () => this.deleteGroup(group.id));
                        
                        actionsCell.appendChild(viewBtn);
                        actionsCell.appendChild(messageBtn);
                        actionsCell.appendChild(deleteBtn);
                        
                        row.appendChild(nameCell);
                        row.appendChild(membersCell);
                        row.appendChild(savingsCell);
                        row.appendChild(cycleCell);
                        row.appendChild(statusCell);
                        row.appendChild(subscriptionCell);
                        row.appendChild(actionsCell);
                        
                        container.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error loading all groups:', error);
                    container.innerHTML = '<tr><td colspan="7" class="text-center py-4">Error loading groups</td></tr>';
                }
            }

            async loadSystemLogs() {
                try {
                    const logs = await this.getSystemLogs(10);
                    const container = document.getElementById('superAdminLogs');
                    container.innerHTML = '';
                    
                    if (logs.length === 0) {
                        container.innerHTML = '<p>No system logs</p>';
                        return;
                    }
                    
                    logs.forEach(log => {
                        const item = document.createElement('div');
                        item.className = 'mb-3';
                        
                        const card = document.createElement('div');
                        card.className = 'card';
                        
                        const cardHeader = document.createElement('div');
                        cardHeader.className = 'card-header d-flex justify-content-between align-items-center py-2';
                        
                        const title = document.createElement('h6');
                        title.className = 'mb-0';
                        title.textContent = log.type.charAt(0).toUpperCase() + log.type.slice(1);
                        
                        const date = document.createElement('small');
                        date.className = 'text-muted';
                        date.textContent = new Date(log.timestamp).toLocaleString();
                        
                        cardHeader.appendChild(title);
                        cardHeader.appendChild(date);
                        
                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body py-2';
                        
                        const message = document.createElement('p');
                        message.className = 'mb-0 small';
                        message.textContent = log.message;
                        
                        cardBody.appendChild(message);
                        
                        card.appendChild(cardHeader);
                        card.appendChild(cardBody);
                        item.appendChild(card);
                        container.appendChild(item);
                    });
                } catch (error) {
                    console.error('Error loading system logs:', error);
                    container.innerHTML = '<p>Error loading system logs</p>';
                }
            }

            startBroadcastRotation() {
                this.stopBroadcastRotation();
                
                // Load broadcasts for the user
                this.loadBroadcasts().then(broadcasts => {
                    if (broadcasts.length === 0) return;
                    
                    this.broadcastQueue = broadcasts;
                    this.showNextBroadcast();
                    
                    // Get broadcast duration from settings (default to 10 seconds)
                    const duration = (this.systemSettings?.broadcastDuration || 10) * 1000;
                    this.broadcastInterval = setInterval(() => this.showNextBroadcast(), duration);
                });
            }

            stopBroadcastRotation() {
                if (this.broadcastInterval) {
                    clearInterval(this.broadcastInterval);
                    this.broadcastInterval = null;
                }
                
                document.getElementById('broadcastContainer').style.display = 'none';
                this.currentBroadcast = null;
            }

            showNextBroadcast() {
                if (this.broadcastQueue.length === 0) {
                    document.getElementById('broadcastContainer').style.display = 'none';
                    return;
                }
                
                // Get the next broadcast
                if (!this.currentBroadcast) {
                    this.currentBroadcast = this.broadcastQueue.shift();
                } else {
                    // Rotate to the next broadcast
                    this.broadcastQueue.push(this.currentBroadcast);
                    this.currentBroadcast = this.broadcastQueue.shift();
                }
                
                // Update the UI
                document.getElementById('broadcastTitle').textContent = this.currentBroadcast.title;
                document.getElementById('broadcastContent').innerHTML = this.currentBroadcast.message;
                document.getElementById('broadcastContainer').style.display = 'block';
                
                // If there's an image, add it to the content
                if (this.currentBroadcast.image) {
                    const img = document.createElement('img');
                    img.src = this.currentBroadcast.image;
                    img.className = 'img-fluid mb-2';
                    document.getElementById('broadcastContent').prepend(img);
                }
            }

            closeCurrentBroadcast() {
                document.getElementById('broadcastContainer').style.display = 'none';
            }

            startAdvertRotation() {
                this.stopAdvertRotation();
                
                // Load adverts
                this.loadAdverts().then(adverts => {
                    if (adverts.length === 0) {
                        // Show default advert space
                        document.getElementById('sidebarAdvertImg').src = 'https://via.placeholder.com/300x150?text=Advert+Space';
                        document.getElementById('sidebarAdvertTitle').textContent = 'Advert Title';
                        document.getElementById('sidebarAdvertContent').textContent = 'Advert content goes here...';
                        return;
                    }
                    
                    this.adverts = adverts;
                    this.showNextAdvert();
                    
                    // Get advert duration from settings (default to 30 seconds)
                    const duration = (this.systemSettings?.advertDuration || 30) * 1000;
                    this.advertInterval = setInterval(() => this.showNextAdvert(), duration);
                });
            }

            stopAdvertRotation() {
                if (this.advertInterval) {
                    clearInterval(this.advertInterval);
                    this.advertInterval = null;
                }
            }

            showNextAdvert() {
                if (this.adverts.length === 0) return;
                
                // Get the next advert
                if (!this.currentAdvert) {
                    this.currentAdvert = this.adverts.shift();
                } else {
                    // Rotate to the next advert
                    this.adverts.push(this.currentAdvert);
                    this.currentAdvert = this.adverts.shift();
                }
                
                // Update the UI
                document.getElementById('sidebarAdvertImg').src = this.currentAdvert.image;
                document.getElementById('sidebarAdvertTitle').textContent = this.currentAdvert.title;
                document.getElementById('sidebarAdvertContent').textContent = this.currentAdvert.content;
            }

            async handleLogin() {
                const emailOrPhone = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                const rememberMe = document.getElementById('rememberMe').checked;
                
                if (!emailOrPhone || !password) {
                    alert('Please enter both email/phone and password');
                    return;
                }
                
                try {
                    // Determine if the input is an email or phone number
                    const isEmail = emailOrPhone.includes('@');
                    
                    let userCredential;
                    if (isEmail) {
                        // Login with email
                        userCredential = await auth.signInWithEmailAndPassword(emailOrPhone, password);
                    } else {
                        // For phone login, we need to implement a custom solution
                        // This is a simplified version - in production, you'd verify the phone number first
                        
                        // Check if the phone number exists in your database
                        const user = await this.findUserByPhone(emailOrPhone);
                        if (!user) {
                            throw new Error('No user found with this phone number');
                        }
                        
                        // Sign in with the associated email
                        userCredential = await auth.signInWithEmailAndPassword(user.email, password);
                    }
                    
                    // Set persistence based on "remember me"
                    await auth.setPersistence(
                        rememberMe ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION
                    );
                    
                    // Load user data
                    await this.loadUserData(userCredential.user.uid);
                    
                    // Update UI
                    this.updateUI();
                    
                    // Close any open modals
                    $('.modal').modal('hide');
                } catch (error) {
                    console.error('Login error:', error);
                    alert(`Login failed: ${error.message}`);
                }
            }

            async handleSignup() {
                const name = document.getElementById('signupName').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const phone = document.getElementById('signupPhone').value.trim();
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                const nextOfKin = document.getElementById('signupNextOfKin').value.trim();
                const nextOfKinPhone = document.getElementById('signupNextOfKinPhone').value.trim();
                const location = document.getElementById('signupLocation').value.trim();
                
                // Validate inputs
                if (!name || !email || !phone || !password || !confirmPassword || !nextOfKin || !nextOfKinPhone || !location) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                
                if (password.length < 8) {
                    alert('Password must be at least 8 characters long');
                    return;
                }
                
                // Check if joining existing group or creating new one
                const groupSearch = document.getElementById('groupSearch').value.trim();
                const newGroupName = document.getElementById('newGroupName').value.trim();
                const groupCurrency = document.getElementById('groupCurrency').value;
                
                let groupId = null;
                let isGroupAdmin = false;
                
                if (groupSearch) {
                    // Joining existing group - in a real app, you'd search for the group
                    alert('Group search functionality would be implemented here');
                    return;
                } else if (newGroupName) {
                    // Creating new group
                    isGroupAdmin = true;
                    
                    // Create group data
                    const groupData = {
                        id: this.generateId(),
                        name: newGroupName,
                        currency: groupCurrency,
                        adminId: '', // Will be set after user creation
                        members: [],
                        settings: this.getDefaultGroupSettings(),
                        createdDate: new Date().toISOString(),
                        lastActive: new Date().toISOString(),
                        cycleStartDate: new Date().toISOString(),
                        subscription: null
                    };
                    
                    // Save group to blockchain
                    await this.addBlock({
                        type: 'group_creation',
                        group: groupData
                    });
                    
                    groupId = groupData.id;
                } else {
                    alert('Please either search for an existing group or create a new one');
                    return;
                }
                
                try {
                    // Create Firebase auth user
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const userId = userCredential.user.uid;
                    
                    // Send email verification
                    await userCredential.user.sendEmailVerification();
                    
                    // Send phone verification (would use Twilio in a real app)
                    // This is a simulation - in production, you'd implement actual SMS verification
                    console.log('Sending verification code to phone:', phone);
                    
                    // Create user data
    const userData = {
        id: userId,
        name: name,
        email: email,
        phone: phone,
        phoneVerified: false,
        emailVerified: false,
        profilePicture: '',
        location: location,
        nextOfKin: nextOfKin,
        nextOfKinPhone: nextOfKinPhone,
        groups: groupId ? [groupId] : [],
        roles: isGroupAdmin ? ['group_admin'] : [],
        createdAt: new Date().toISOString(),
        lastActive: new Date().toISOString()
    };
    
    // If this is the first user, make them super admin
    const users = await this.getAllUsers();
    if (users.length === 0) {
        userData.roles.push('super_admin');
        this.isSuperAdmin = true;
    }
    
    // Save user to blockchain
    await this.addBlock({
        type: 'user_registration',
        user: userData
    });
    
    // If creating a new group, update the group with admin ID
    if (isGroupAdmin && groupId) {
        const groupData = await this.getGroup(groupId);
        if (groupData) {
            groupData.adminId = userId;
            await this.addBlock({
                type: 'group_update',
                group: groupData
            });
        }
    }
    
    // Load user data
    await this.loadUserData(userId);
    
    // Show verification modals
    if (!userCredential.user.emailVerified) {
        $('#emailVerificationModal').modal('show');
    }
    
    if (!userData.phoneVerified) {
        $('#phoneVerificationModal').modal('show');
    }
    
    // Update UI
    this.updateUI();
    
    // Close signup modal
    $('#signupModal').modal('hide');
} catch (error) {
    console.error('Signup error:', error);
    alert(`Signup failed: ${error.message}`);
}

// Add verification methods
async verifyEmail() {
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        await user.reload();
        if (user.emailVerified) {
            // Update user in blockchain
            const userData = await this.getUser(user.uid);
            if (userData) {
                userData.emailVerified = true;
                await this.addBlock({
                    type: 'user_update',
                    user: userData
                });
                
                $('#emailVerificationModal').modal('hide');
                alert('Email verified successfully!');
            }
        } else {
            alert('Email not yet verified. Please check your inbox.');
        }
    } catch (error) {
        console.error('Email verification error:', error);
        alert('Error checking email verification status');
    }
}

async verifyPhone() {
    const code = document.getElementById('phoneVerificationCode').value.trim();
    if (!code) {
        alert('Please enter verification code');
        return;
    }
    
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        const storedCode = await this.getVerificationCode(user.uid);
        if (storedCode === code) {
            // Update user in blockchain
            const userData = await this.getUser(user.uid);
            if (userData) {
                userData.phoneVerified = true;
                await this.addBlock({
                    type: 'user_update',
                    user: userData
                });
                
                $('#phoneVerificationModal').modal('hide');
                alert('Phone verified successfully!');
            }
        } else {
            alert('Invalid verification code');
        }
    } catch (error) {
        console.error('Phone verification error:', error);
        alert('Error verifying phone number');
    }
}

async resendVerificationCode() {
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        const userData = await this.getUser(user.uid);
        if (!userData) throw new Error('User not found');
        
        const phoneVerificationCode = Math.floor(100000 + Math.random() * 900000).toString();
        await this.saveVerificationCode(user.uid, phoneVerificationCode);
        
        // Send SMS (using Twilio in production)
        if (this.twilioClient) {
            await this.twilioClient.messages.create({
                body: `Your new Kiira Save verification code is: ${phoneVerificationCode}`,
                to: userData.phone,
                from: '+15017122661' // Your Twilio number
            });
        }
        
        alert('New verification code sent!');
    } catch (error) {
        console.error('Resend code error:', error);
        alert('Error sending verification code');
    }
}

// Database methods for verification codes
async saveVerificationCode(userId, code) {
    return new Promise((resolve, reject) => {
        const transaction = this.db.transaction(['verification_codes'], 'readwrite');
        const store = transaction.objectStore('verification_codes');
        const request = store.put({ userId, code, timestamp: Date.now() });
        
        request.onsuccess = () => resolve();
        request.onerror = (event) => {
            console.error('Error saving verification code:', event.target.error);
            reject(new Error('Failed to save verification code'));
        };
    });
}

async getVerificationCode(userId) {
    return new Promise((resolve, reject) => {
        const transaction = this.db.transaction(['verification_codes'], 'readonly');
        const store = transaction.objectStore('verification_codes');
        const request = store.get(userId);
        
        request.onsuccess = (event) => {
            resolve(event.target.result ? event.target.result.code : null);
        };
        
        request.onerror = (event) => {
            console.error('Error loading verification code:', event.target.error);
            reject(new Error('Failed to load verification code'));
        };
    });
}

// Implement saving functionality
async submitSaving() {
    if (!this.currentUser || !this.currentGroup) return;
    
    const amount = parseFloat(document.getElementById('savingAmount').value);
    const method = document.getElementById('savingMethod').value;
    const reference = document.getElementById('savingReference').value.trim();
    const notes = document.getElementById('savingNotes').value.trim();
    
    if (isNaN(amount) || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }
    
    if (method !== 'cash' && !reference) {
        alert('Please enter a payment reference');
        return;
    }
    
    // Check if saving amount meets group requirements
    if (this.currentGroup.settings.savingAmount && 
        this.currentGroup.settings.savingAmount !== amount) {
        alert(`Saving amount must be ${this.currentGroup.currency} ${this.currentGroup.settings.savingAmount}`);
        return;
    }
    
    // Create saving transaction
    const saving = {
        id: this.generateId(),
        userId: this.currentUser.id,
        groupId: this.currentGroup.id,
        amount: amount,
        method: method,
        reference: method !== 'cash' ? reference : null,
        notes: notes,
        date: new Date().toISOString(),
        status: this.currentGroup.settings.autoApproveSavings ? 'confirmed' : 'pending',
        confirmedBy: this.currentGroup.settings.autoApproveSavings ? this.currentUser.id : null,
        confirmedAt: this.currentGroup.settings.autoApproveSavings ? new Date().toISOString() : null
    };
    
    try {
        // Add to blockchain
        await this.addBlock({
            type: 'saving_transaction',
            saving: saving
        });
        
        // Update UI
        this.updateSavings();
        
        // Close modal
        $('#newSavingModal').modal('hide');
        
        // Reset form
        document.getElementById('savingForm').reset();
        
        // Show success message
        alert('Saving submitted successfully!');
    } catch (error) {
        console.error('Error submitting saving:', error);
        alert('Failed to submit saving');
    }
}

// Implement admin saving functionality
async submitAdminSaving() {
    if (!this.currentUser || !this.currentGroup || !this.isGroupAdmin) return;
    
    const memberId = document.getElementById('adminSavingMember').value;
    const amount = parseFloat(document.getElementById('adminSavingAmount').value);
    const method = document.getElementById('adminSavingMethod').value;
    const reference = document.getElementById('adminSavingReference').value.trim();
    const notes = document.getElementById('adminSavingNotes').value.trim();
    
    if (!memberId) {
        alert('Please select a member');
        return;
    }
    
    if (isNaN(amount) || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }
    
    if (method !== 'cash' && !reference) {
        alert('Please enter a payment reference');
        return;
    }
    
    // Create saving transaction
    const saving = {
        id: this.generateId(),
        userId: memberId,
        groupId: this.currentGroup.id,
        amount: amount,
        method: method,
        reference: method !== 'cash' ? reference : null,
        notes: notes,
        date: new Date().toISOString(),
        status: 'confirmed',
        confirmedBy: this.currentUser.id,
        confirmedAt: new Date().toISOString()
    };
    
    try {
        // Add to blockchain
        await this.addBlock({
            type: 'saving_transaction',
            saving: saving
        });
        
        // Update UI
        this.updateSavings();
        
        // Close modal
        $('#adminAddSavingModal').modal('hide');
        
        // Reset form
        document.getElementById('adminSavingForm').reset();
        
        // Show success message
        alert('Saving added successfully!');
    } catch (error) {
        console.error('Error adding saving:', error);
        alert('Failed to add saving');
    }
}

// Implement loan application
async submitLoanApplication() {
    if (!this.currentUser || !this.currentGroup) return;
    
    // Check if loans are enabled
    if (!this.currentGroup.settings.loansEnabled) {
        alert('Loans are currently disabled for this group');
        return;
    }
    
    const amount = parseFloat(document.getElementById('loanAmount').value);
    const period = parseInt(document.getElementById('loanPeriod').value);
    const purpose = document.getElementById('loanPurpose').value.trim();
    
    if (isNaN(amount) || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }
    
    if (isNaN(period) || period <= 0) {
        alert('Please select a valid loan period');
        return;
    }
    
    if (!purpose) {
        alert('Please enter loan purpose');
        return;
    }
    
    // Check if amount exceeds maximum allowed
    const userSavings = await this.getUserSavings(this.currentUser.id, this.currentGroup.id);
    const totalSaved = userSavings.reduce((sum, saving) => sum + saving.amount, 0);
    
    if (amount > totalSaved) {
        alert(`Loan amount cannot exceed your total savings (${this.currentGroup.currency} ${totalSaved.toLocaleString()})`);
        return;
    }
    
    // Calculate interest and total payable
    const interestRate = this.currentGroup.settings.loanInterestRate || 10;
    const interest = (amount * interestRate * period) / (30 * 100); // Simple interest calculation
    const totalPayable = amount + interest;
    
    // Create loan application
    const loan = {
        id: this.generateId(),
        userId: this.currentUser.id,
        groupId: this.currentGroup.id,
        amount: amount,
        interestRate: interestRate,
        totalAmount: totalPayable,
        period: period,
        purpose: purpose,
        applicationDate: new Date().toISOString(),
        dueDate: new Date(Date.now() + period * 24 * 60 * 60 * 1000).toISOString(),
        status: 'pending',
        approvals: [],
        payments: []
    };
    
    try {
        // Add to blockchain
        await this.addBlock({
            type: 'loan_application',
            loan: loan
        });
        
        // Update UI
        this.updateLoans();
        
        // Close modal
        $('#newLoanModal').modal('hide');
        
        // Reset form
        document.getElementById('loanForm').reset();
        
        // Show success message
        alert('Loan application submitted successfully! It will be reviewed by group members.');
    } catch (error) {
        console.error('Error submitting loan application:', error);
        alert('Failed to submit loan application');
    }
}

// Implement loan approval/rejection
async approveLoan(loanId) {
    if (!this.currentUser || !this.currentGroup) return;
    
    try {
        const loan = await this.getLoan(loanId);
        if (!loan) throw new Error('Loan not found');
        
        // Check if user already approved
        if (loan.approvals.includes(this.currentUser.id)) {
            alert('You have already approved this loan');
            return;
        }
        
        // Add approval
        loan.approvals.push(this.currentUser.id);
        
        // Check if enough approvals to auto-approve
        const requiredApprovals = Math.ceil(this.currentGroup.members.length * 0.75); // 75% of members
        if (loan.approvals.length >= requiredApprovals) {
            loan.status = 'approved';
            
            // Add timeline post
            await this.addBlock({
                type: 'timeline_post',
                post: {
                    id: this.generateId(),
                    groupId: this.currentGroup.id,
                    userId: this.currentUser.id,
                    content: `Loan of ${this.currentGroup.currency} ${loan.amount.toLocaleString()} approved for ${loan.member.name}`,
                    timestamp: new Date().toISOString()
                }
            });
        }
        
        // Update blockchain
        await this.addBlock({
            type: 'loan_update',
            loan: loan
        });
        
        // Update UI
        this.updateLoans();
        
        // Show success message
        alert('Loan approval recorded successfully!');
    } catch (error) {
        console.error('Error approving loan:', error);
        alert('Failed to approve loan');
    }
}

async rejectLoan(loanId) {
    if (!this.currentUser || !this.currentGroup) return;
    
    try {
        const loan = await this.getLoan(loanId);
        if (!loan) throw new Error('Loan not found');
        
        // Update loan status
        loan.status = 'rejected';
        
        // Update blockchain
        await this.addBlock({
            type: 'loan_update',
            loan: loan
        });
        
        // Add timeline post
        await this.addBlock({
            type: 'timeline_post',
            post: {
                id: this.generateId(),
                groupId: this.currentGroup.id,
                userId: this.currentUser.id,
                content: `Loan of ${this.currentGroup.currency} ${loan.amount.toLocaleString()} rejected for ${loan.member.name}`,
                timestamp: new Date().toISOString()
            }
        });
        
        // Update UI
        this.updateLoans();
        
        // Show success message
        alert('Loan rejected successfully!');
    } catch (error) {
        console.error('Error rejecting loan:', error);
        alert('Failed to reject loan');
    }
}

// Implement share listing
async submitShareListing() {
    if (!this.currentUser || !this.currentGroup) return;
    
    // Check if shares are enabled
    if (!this.currentGroup.settings.sharesEnabled) {
        alert('Shares are currently disabled for this group');
        return;
    }
    
    const amount = parseInt(document.getElementById('shareAmount').value);
    const price = parseFloat(document.getElementById('sharePrice').value);
    
    if (isNaN(amount) || amount <= 0) {
        alert('Please enter a valid share amount');
        return;
    }
    
    if (isNaN(price) || price <= 0) {
        alert('Please enter a valid share price');
        return;
    }
    
    // Check if user has enough shares
    const userShares = await this.getUserShares(this.currentUser.id, this.currentGroup.id);
    const totalShares = userShares.reduce((sum, share) => sum + share.amount, 0);
    
    if (amount > totalShares) {
        alert(`You don't have enough shares (you have ${totalShares} shares)`);
        return;
    }
    
    // Create share listing
    const share = {
        id: this.generateId(),
        sellerId: this.currentUser.id,
        groupId: this.currentGroup.id,
        amount: amount,
        pricePerShare: price,
        totalPrice: amount * price,
        dateListed: new Date().toISOString(),
        status: 'pending'
    };
    
    try {
        // Add to blockchain
        await this.addBlock({
            type: 'share_listing',
            share: share
        });
        
        // Update UI
        this.updateShares();
        
        // Close modal
        $('#newShareModal').modal('hide');
        
        // Reset form
        document.getElementById('shareForm').reset();
        
        // Show success message
        alert('Share listing submitted successfully! Waiting for admin approval.');
    } catch (error) {
        console.error('Error submitting share listing:', error);
        alert('Failed to submit share listing');
    }
}

// Implement share approval/rejection
async approveShare(shareId) {
    if (!this.currentUser || !this.currentGroup || !this.isGroupAdmin) return;
    
    try {
        const share = await this.getShare(shareId);
        if (!share) throw new Error('Share not found');
        
        // Update share status
        share.status = 'active';
        
        // Update blockchain
        await this.addBlock({
            type: 'share_update',
            share: share
        });
        
        // Update UI
        this.updateShares();
        
        // Show success message
        alert('Share approved successfully! It is now available in the market.');
    } catch (error) {
        console.error('Error approving share:', error);
        alert('Failed to approve share');
    }
}

async rejectShare(shareId) {
    if (!this.currentUser || !this.currentGroup || !this.isGroupAdmin) return;
    
    try {
        const share = await this.getShare(shareId);
        if (!share) throw new Error('Share not found');
        
        // Update share status
        share.status = 'rejected';
        
        // Update blockchain
        await this.addBlock({
            type: 'share_update',
            share: share
        });
        
        // Update UI
        this.updateShares();
        
        // Show success message
        alert('Share rejected successfully!');
    } catch (error) {
        console.error('Error rejecting share:', error);
        alert('Failed to reject share');
    }
}

// Implement share purchase
async buyShares() {
    if (!this.currentUser || !this.currentGroup) return;
    
    // Check if shares are enabled
    if (!this.currentGroup.settings.sharesEnabled) {
        alert('Shares are currently disabled for this group');
        return;
    }
    
    const shareId = document.getElementById('shareSelect').value;
    const quantity = parseInt(document.getElementById('shareBuyQuantity').value);
    
    if (!shareId) {
        alert('Please select shares to buy');
        return;
    }
    
    if (isNaN(quantity) || quantity <= 0) {
        alert('Please enter a valid quantity');
        return;
    }
    
    try {
        const share = await this.getShare(shareId);
        if (!share) throw new Error('Share not found');
        
        if (quantity > share.amount) {
            alert(`Only ${share.amount} shares available for this listing`);
            return;
        }
        
        // Calculate total cost
        const totalCost = quantity * share.pricePerShare;
        
        // Check if user has enough savings
        const userSavings = await this.getUserSavings(this.currentUser.id, this.currentGroup.id);
        const totalSaved = userSavings.reduce((sum, saving) => sum + saving.amount, 0);
        
        if (totalCost > totalSaved) {
            alert(`You don't have enough savings (need ${this.currentGroup.currency} ${totalCost.toLocaleString()}, have ${this.currentGroup.currency} ${totalSaved.toLocaleString()})`);
            return;
        }
        
        // Create share transaction
        const transaction = {
            id: this.generateId(),
            buyerId: this.currentUser.id,
            sellerId: share.sellerId,
            shareId: share.id,
            groupId: this.currentGroup.id,
            shares: quantity,
            amount: totalCost,
            date: new Date().toISOString(),
            status: 'pending'
        };
        
        // Add to blockchain
        await this.addBlock({
            type: 'share_transaction',
            transaction: transaction
        });
        
        // Update UI
        this.updateShares();
        
        // Reset form
        document.getElementById('buySharesForm').reset();
        
        // Show success message
        alert('Share purchase request submitted! Waiting for admin approval.');
    } catch (error) {
        console.error('Error buying shares:', error);
        alert('Failed to buy shares');
    }
}

// Implement member approval/rejection
async approveMember(memberId) {
    if (!this.currentUser || !this.currentGroup || !this.isGroupAdmin) return;
    
    try {
        const user = await this.getUser(memberId);
        if (!user) throw new Error('User not found');
        
        // Add user to group
        if (!user.groups.includes(this.currentGroup.id)) {
            user.groups.push(this.currentGroup.id);
            
            // Update user in blockchain
            await this.addBlock({
                type: 'user_update',
                user: user
            });
        }
        
        // Add user to group members list if not already there
        if (!this.currentGroup.members.includes(memberId)) {
            this.currentGroup.members.push(memberId);
            
            // Update group in blockchain
            await this.addBlock({
                type: 'group_update',
                group: this.currentGroup
            });
        }
        
        // Send welcome message
        await this.sendMessage({
            senderId: this.currentUser.id,
            recipientId: memberId,
            content: `Welcome to ${this.currentGroup.name}! Your membership has been approved.`,
            timestamp: new Date().toISOString()
        });
        
        // Add timeline post
        await this.addBlock({
            type: 'timeline_post',
            post: {
                id: this.generateId(),
                groupId: this.currentGroup.id,
                userId: this.currentUser.id,
                content: `New member approved: ${user.name}`,
                timestamp: new Date().toISOString()
            }
        });
        
        // Update UI
        this.updateMembers();
        
        // Show success message
        alert('Member approved successfully!');
    } catch (error) {
        console.error('Error approving member:', error);
        alert('Failed to approve member');
    }
}

async rejectMember(memberId) {
    if (!this.currentUser || !this.currentGroup || !this.isGroupAdmin) return;
    
    try {
        const user = await this.getUser(memberId);
        if (!user) throw new Error('User not found');
        
        // Send rejection message
        await this.sendMessage({
            senderId: this.currentUser.id,
            recipientId: memberId,
            content: `Your application to join ${this.currentGroup.name} has been rejected.`,
            timestamp: new Date().toISOString()
        });
        
        // Add timeline post (anonymous)
        await this.addBlock({
            type: 'timeline_post',
            post: {
                id: this.generateId(),
                groupId: this.currentGroup.id,
                userId: this.currentUser.id,
                content: 'A membership application was rejected',
                timestamp: new Date().toISOString()
            }
        });
        
        // Update UI
        this.updateMembers();
        
        // Show success message
        alert('Member rejected successfully!');
    } catch (error) {
        console.error('Error rejecting member:', error);
        alert('Failed to reject member');
    }
}

// Implement messaging
async sendMessage() {
    const recipientId = document.getElementById('messageRecipient').value;
    const content = document.getElementById('messageContent').value.trim();
    
    if (!recipientId) {
        alert('Please select a recipient');
        return;
    }
    
    if (!content) {
        alert('Please enter message content');
        return;
    }
    
    try {
        // Create message
        const message = {
            id: this.generateId(),
            senderId: this.currentUser.id,
            recipientId: recipientId,
            content: content,
            timestamp: new Date().toISOString(),
            read: false
        };
        
        // Add to blockchain
        await this.addBlock({
            type: 'message',
            message: message
        });
        
        // Update UI
        this.updateMessages();
        
        // Close modal
        $('#newMessageModal').modal('hide');
        
        // Reset form
        document.getElementById('messageForm').reset();
        
        // Show success message
        alert('Message sent successfully!');
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message');
    }
}

// Implement profile updates
async saveProfile() {
    if (!this.currentUser) return;
    
    const name = document.getElementById('profileName').value.trim();
    const username = document.getElementById('profileUsername').value.trim();
    const phone = document.getElementById('profilePhone').value.trim();
    const location = document.getElementById('profileLocation').value.trim();
    const nextOfKin = document.getElementById('profileNextOfKin').value.trim();
    const nextOfKinPhone = document.getElementById('profileNextOfKinPhone').value.trim();
    
    if (!name) {
        alert('Please enter your name');
        return;
    }
    
    try {
        // Get current user data
        const userData = await this.getUser(this.currentUser.id);
        if (!userData) throw new Error('User not found');
        
        // Update fields
        userData.name = name;
        userData.username = username;
        userData.phone = phone;
        userData.location = location;
        userData.nextOfKin = nextOfKin;
        userData.nextOfKinPhone = nextOfKinPhone;
        
        // Update in blockchain
        await this.addBlock({
            type: 'user_update',
            user: userData
        });
        
        // Reload user data
        await this.loadUserData(this.currentUser.id);
        
        // Show success message
        alert('Profile updated successfully!');
    } catch (error) {
        console.error('Error saving profile:', error);
        alert('Failed to save profile');
    }
}

async uploadProfilePicture(file) {
    if (!file || !this.currentUser) return;
    
    try {
        // In a real app, you would upload to IPFS or similar decentralized storage
        // For this example, we'll use a mock upload process
        
        // Read file as data URL
        const reader = new FileReader();
        reader.onload = async (e) => {
            const imageData = e.target.result;
            
            // Get current user data
            const userData = await this.getUser(this.currentUser.id);
            if (!userData) throw new Error('User not found');
            
            // Update profile picture
            userData.profilePicture = imageData;
            
            // Update in blockchain
            await this.addBlock({
                type: 'user_update',
                user: userData
            });
            
            // Reload user data
            await this.loadUserData(this.currentUser.id);
            
            // Show success message
            alert('Profile picture updated successfully!');
        };
        reader.readAsDataURL(file);
    } catch (error) {
        console.error('Error uploading profile picture:', error);
        alert('Failed to upload profile picture');
    }
}

// Implement password change
async changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        alert('Please fill in all password fields');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert('New passwords do not match');
        return;
    }
    
    if (newPassword.length < 8) {
        alert('Password must be at least 8 characters long');
        return;
    }
    
    try {
        const user = auth.currentUser;
        if (!user) throw new Error('User not logged in');
        
        // Reauthenticate user
        const credential = firebase.auth.EmailAuthProvider.credential(
            user.email,
            currentPassword
        );
        
        await user.reauthenticateWithCredential(credential);
        
        // Change password
        await user.updatePassword(newPassword);
        
        // Close modal
        $('#changePasswordModal').modal('hide');
        
        // Reset form
        document.getElementById('passwordForm').reset();
        
        // Show success message
        alert('Password changed successfully!');
    } catch (error) {
        console.error('Error changing password:', error);
        alert(`Failed to change password: ${error.message}`);
    }
}

// Implement account deactivation
async deactivateAccount() {
    const confirmDeactivate = document.getElementById('confirmDeactivate').checked;
    const reason = document.getElementById('deactivateReason').value.trim();
    
    if (!confirmDeactivate) {
        alert('Please confirm you want to deactivate your account');
        return;
    }
    
    if (!reason) {
        alert('Please provide a reason for deactivating your account');
        return;
    }
    
    try {
        const user = auth.currentUser;
        if (!user) throw new Error('User not logged in');
        
        // Get current user data
        const userData = await this.getUser(this.currentUser.id);
        if (!userData) throw new Error('User not found');
        
        // Update user status
        userData.active = false;
        userData.deactivationReason = reason;
        userData.deactivationDate = new Date().toISOString();
        
        // Update in blockchain
        await this.addBlock({
            type: 'user_update',
            user: userData
        });
        
        // Sign out
        await auth.signOut();
        
        // Close modal
        $('#deactivateAccountModal').modal('hide');
        
        // Reset form
        document.getElementById('deactivateForm').reset();
        
        // Show success message
        alert('Account deactivated successfully. You can reactivate by logging in again.');
    } catch (error) {
        console.error('Error deactivating account:', error);
        alert('Failed to deactivate account');
    }
}

// Implement group settings
async saveGroupSettings() {
    if (!this.currentUser || !this.currentGroup || !this.isGroupAdmin) return;
    
    const savingFrequency = document.getElementById('savingFrequencySetting').value;
    const savingDay = document.getElementById('savingDaySetting').value;
    const savingDate = document.getElementById('savingDateSetting').value;
    const savingAmount = document.getElementById('savingAmountSetting').value;
    const savingCompulsory = document.getElementById('savingCompulsorySetting').checked;
    const savingPenalty = document.getElementById('savingPenaltySetting').value;
    const loansEnabled = document.getElementById('loansEnabledSetting').checked;
    const loanInterestRate = document.getElementById('loanInterestRateSetting').value;
    const sharesEnabled = document.getElementById('sharesEnabledSetting').checked;
    const shareValue = document.getElementById('shareValueSetting').value;
    const cycleLength = document.getElementById('cycleLengthSetting').value;
    const targetAmount = document.getElementById('targetAmountSetting').value;
    
    try {
        // Update group settings
        this.currentGroup.settings = {
            savingFrequency: savingFrequency,
            savingDay: savingFrequency === 'weekly' ? parseInt(savingDay) : null,
            savingDate: savingFrequency === 'monthly' ? parseInt(savingDate) : null,
            savingAmount: savingAmount ? parseFloat(savingAmount) : null,
            savingCompulsory: savingCompulsory,
            savingPenalty: savingCompulsory ? parseFloat(savingPenalty) : null,
            loansEnabled: loansEnabled,
            loanInterestRate: parseFloat(loanInterestRate),
            sharesEnabled: sharesEnabled,
            shareValue: parseFloat(shareValue),
            cycleLength: parseInt(cycleLength),
            targetAmount: targetAmount ? parseFloat(targetAmount) : null,
            autoApproveSavings: document.getElementById('autoApproveSavingsSetting').checked
        };
        
        // Update in blockchain
        await this.addBlock({
            type: 'group_settings_update',
            group: this.currentGroup
        });
        
        // Close modal
        $('#adminSettingsModal').modal('hide');
        
        // Update UI
        this.updateUI();
        
        // Show success message
        alert('Group settings updated successfully!');
    } catch (error) {
        console.error('Error saving group settings:', error);
        alert('Failed to save group settings');
    }
}

// Implement group broadcast
async sendGroupBroadcast() {
    if (!this.currentUser || !this.currentGroup || !this.isGroupAdmin) return;
    
    const title = document.getElementById('broadcastTitle').value.trim();
    const content = document.getElementById('broadcastContent').value.trim();
    const recipients = document.getElementById('broadcastRecipients').value;
    const selectedMembers = Array.from(document.getElementById('broadcastMembersSelect').selectedOptions)
        .map(option => option.value);
    
    if (!title || !content) {
        alert('Please enter both title and content');
        return;
    }
    
    if (recipients === 'selected' && selectedMembers.length === 0) {
        alert('Please select at least one member');
        return;
    }
    
    try {
        // Create broadcast
        const broadcast = {
            id: this.generateId(),
            groupId: this.currentGroup.id,
            senderId: this.currentUser.id,
            title: title,
            content: content,
            recipients: recipients === 'all' ? 'all' : selectedMembers,
            timestamp: new Date().toISOString()
        };
        
        // Add to blockchain
        await this.addBlock({
            type: 'broadcast',
            broadcast: broadcast
        });
        
        // Close modal
        $('#adminBroadcastModal').modal('hide');
        
        // Reset form
        document.getElementById('broadcastForm').reset();
        
        // Show success message
        alert('Broadcast sent successfully!');
    } catch (error) {
        console.error('Error sending broadcast:', error);
        alert('Failed to send broadcast');
    }
}

// Implement super admin functionality
async saveSuperAdminSettings() {
    if (!this.currentUser || !this.isSuperAdmin) return;
    
    const subscriptionPrice = document.getElementById('subscriptionPriceSetting').value;
    const subscriptionCurrency = document.getElementById('subscriptionCurrencySetting').value;
    const paymentMethods = Array.from(document.getElementById('paymentMethodsSetting').selectedOptions)
        .map(option => option.value);
    const mobileMoneyNumber = document.getElementById('mobileMoneyNumberSetting').value.trim();
    const broadcastDuration = document.getElementById('broadcastDurationSetting').value;
    const advertDuration = document.getElementById('advertDurationSetting').value;
    const maxGroupsPerUser = document.getElementById('maxGroupsPerUserSetting').value;
    const inactiveAdminThreshold = document.getElementById('inactiveAdminThresholdSetting').value;
    
    try {
        // Update system settings
        const settings = {
            subscriptionPrice: parseFloat(subscriptionPrice),
            subscriptionCurrency: subscriptionCurrency,
            paymentMethods: paymentMethods,
            mobileMoneyNumber: mobileMoneyNumber,
            broadcastDuration: parseInt(broadcastDuration),
            advertDuration: parseInt(advertDuration),
            maxGroupsPerUser: parseInt(maxGroupsPerUser),
            inactiveAdminThreshold: parseInt(inactiveAdminThreshold)
        };
        
        // Save to blockchain
        await this.addBlock({
            type: 'system_settings_update',
            settings: settings
        });
        
        // Update local settings
        this.systemSettings = settings;
        
        // Close modal
        $('#superAdminSettingsModal').modal('hide');
        
        // Show success message
        alert('System settings updated successfully!');
    } catch (error) {
        console.error('Error saving system settings:', error);
        alert('Failed to save system settings');
    }
}

async sendSuperAdminBroadcast() {
    if (!this.currentUser || !this.isSuperAdmin) return;
    
    const title = document.getElementById('superBroadcastTitle').value.trim();
    const content = document.getElementById('superBroadcastContent').value.trim();
    const recipients = document.getElementById('superBroadcastRecipients').value;
    const selectedGroups = Array.from(document.getElementById('superBroadcastGroupSelect').selectedOptions)
        .map(option => option.value);
    
    if (!title || !content) {
        alert('Please enter both title and content');
        return;
    }
    
    if (recipients === 'group' && selectedGroups.length === 0) {
        alert('Please select at least one group');
        return;
    }
    
    try {
        // Create broadcast
        const broadcast = {
            id: this.generateId(),
            senderId: this.currentUser.id,
            title: title,
            content: content,
            recipients: recipients === 'all' ? 'all' : 
                      recipients === 'admins' ? 'admins' : selectedGroups,
            timestamp: new Date().toISOString()
        };
        
        // Add to blockchain
        await this.addBlock({
            type: 'super_broadcast',
            broadcast: broadcast
        });
        
        // Close modal
        $('#superAdminBroadcastModal').modal('hide');
        
        // Reset form
        document.getElementById('superBroadcastForm').reset();
        
        // Show success message
        alert('Broadcast sent successfully!');
    } catch (error) {
        console.error('Error sending broadcast:', error);
        alert('Failed to send broadcast');
    }
}

async createSubscription() {
    if (!this.currentUser || !this.currentGroup || !this.isGroupAdmin) return;
    
    const period = document.getElementById('subscriptionPeriod').value;
    const customDays = document.getElementById('customSubscriptionDays').value;
    const paymentMethod = document.getElementById('subscriptionPaymentMethod').value;
    const reference = document.getElementById('subscriptionPaymentReference').value.trim();
    
    if (!period) {
        alert('Please select subscription period');
        return;
    }
    
    if (period === 'custom' && (!customDays || isNaN(customDays) || customDays <= 0) {
        alert('Please enter valid custom days');
        return;
    }
    
    if (!paymentMethod) {
        alert('Please select payment method');
        return;
    }
    
    if (!reference) {
        alert('Please enter payment reference');
        return;
    }
    
    try {
        // Calculate expiry date
        const expiryDate = new Date();
        if (period === '1year') {
            expiryDate.setFullYear(expiryDate.getFullYear() + 1);
        } else if (period === '2years') {
            expiryDate.setFullYear(expiryDate.getFullYear() + 2);
        } else if (period === '3years') {
            expiryDate.setFullYear(expiryDate.getFullYear() + 3);
        } else if (period === '5years') {
            expiryDate.setFullYear(expiryDate.getFullYear() + 5);
        } else if (period === 'custom') {
            expiryDate.setDate(expiryDate.getDate() + parseInt(customDays));
        }
        
        // Create subscription
        const subscription = {
            id: this.generateId(),
            groupId: this.currentGroup.id,
            adminId: this.currentUser.id,
            period: period,
            startDate: new Date().toISOString(),
            expiryDate: expiryDate.toISOString(),
            paymentMethod: paymentMethod,
            paymentReference: reference,
            amount: this.systemSettings.subscriptionPrice,
            currency: this.systemSettings.subscriptionCurrency,
            status: 'pending'
        };
        
        // Add to blockchain
        await this.addBlock({
            type: 'subscription',
            subscription: subscription
        });
        
        // Close modal
        $('#newSubscriptionModal').modal('hide');
        
        // Reset form
        document.getElementById('subscriptionForm').reset();
        
        // Show success message
        alert('Subscription request submitted! Waiting for super admin approval.');
    } catch (error) {
        console.error('Error creating subscription:', error);
        alert('Failed to create subscription');
    }
}

// Implement group approval/rejection (for super admin)
async approveGroup(groupId) {
    if (!this.currentUser || !this.isSuperAdmin) return;
    
    try {
        const group = await this.getGroup(groupId);
        if (!group) throw new Error('Group not found');
        
        // Approve subscription if pending
        if (group.subscription && group.subscription.status === 'pending') {
            group.subscription.status = 'active';
        }
        
        // Update in blockchain
        await this.addBlock({
            type: 'group_approval',
            group: group
        });
        
        // Send notification to group admin
        await this.sendMessage({
            senderId: this.currentUser.id,
            recipientId: group.adminId,
            content: `Your group "${group.name}" has been approved!`,
            timestamp: new Date().toISOString()
        });
        
        // Update UI
        this.updateSuperAdminPanel();
        
        // Show success message
        alert('Group approved successfully!');
    } catch (error) {
        console.error('Error approving group:', error);
        alert('Failed to approve group');
    }
}

async rejectGroup(groupId) {
    if (!this.currentUser || !this.isSuperAdmin) return;
    
    try {
        const group = await this.getGroup(groupId);
        if (!group) throw new Error('Group not found');
        
        // Reject subscription if pending
        if (group.subscription && group.subscription.status === 'pending') {
            group.subscription.status = 'rejected';
        }
        
        // Update in blockchain
        await this.addBlock({
            type: 'group_rejection',
            group: group
        });
        
        // Send notification to group admin
        await this.sendMessage({
            senderId: this.currentUser.id,
            recipientId: group.adminId,
            content: `Your group "${group.name}" has been rejected.`,
            timestamp: new Date().toISOString()
        });
        
        // Update UI
        this.updateSuperAdminPanel();
        
        // Show success message
        alert('Group rejected successfully!');
    } catch (error) {
        console.error('Error rejecting group:', error);
        alert('Failed to reject group');
    }
}

// Implement admin role transfer
async transferAdminRoles(newAdminId) {
    if (!this.currentUser || !this.currentGroup || !this.isGroupAdmin) return;
    
    const confirmTransfer = confirm('Are you sure you want to transfer your admin roles? This action cannot be undone.');
    if (!confirmTransfer) return;
    
    try {
        // Get new admin user
        const newAdmin = await this.getUser(newAdminId);
        if (!newAdmin) throw new Error('User not found');
        
        // Update group admin
        this.currentGroup.adminId = newAdminId;
        
        // Update user roles
        const currentAdmin = await this.getUser(this.currentUser.id);
        if (currentAdmin) {
            currentAdmin.roles = currentAdmin.roles.filter(role => role !== 'group_admin');
            await this.addBlock({
                type: 'user_update',
                user: currentAdmin
            });
        }
        
        newAdmin.roles.push('group_admin');
        await this.addBlock({
            type: 'user_update',
            user: newAdmin
        });
        
        // Update group in blockchain
        await this.addBlock({
            type: 'group_update',
            group: this.currentGroup
        });
        
        // Send notifications
        await this.sendMessage({
            senderId: this.currentUser.id,
            recipientId: newAdminId,
            content: `You have been made admin of ${this.currentGroup.name}`,
            timestamp: new Date().toISOString()
        });
        
        // Broadcast to group
        await this.addBlock({
            type: 'broadcast',
            broadcast: {
                id: this.generateId(),
                groupId: this.currentGroup.id,
                senderId: this.currentUser.id,
                title: 'Admin Role Transfer',
                content: `${newAdmin.name} is now the new admin of ${this.currentGroup.name}`,
                recipients: 'all',
                timestamp: new Date().toISOString()
            }
        });
        
        // Reload data
        await this.loadUserData(this.currentUser.id);
        await this.loadGroupData(this.currentGroup.id);
        
        // Show success message
        alert('Admin roles transferred successfully!');
    } catch (error) {
        console.error('Error transferring admin roles:', error);
        alert('Failed to transfer admin roles');
    }
}

// Implement group merging
async initiateGroupMerge(targetGroupId) {
    if (!this.currentUser || !this.currentGroup || !this.isGroupAdmin) return;
    
    try {
        const targetGroup = await this.getGroup(targetGroupId);
        if (!targetGroup) throw new Error('Target group not found');
        
        // Create merge proposal
        const proposal = {
            id: this.generateId(),
            sourceGroupId: this.currentGroup.id,
            targetGroupId: targetGroupId,
            initiatorId: this.currentUser.id,
            status: 'pending',
            votes: [],
            timestamp: new Date().toISOString()
        };
        
        // Add to blockchain
        await this.addBlock({
            type: 'merge_proposal',
            proposal: proposal
        });
        
        // Send notification to target group admin
        await this.sendMessage({
            senderId: this.currentUser.id,
            recipientId: targetGroup.adminId,
            content: `A merge proposal has been initiated between ${this.currentGroup.name} and ${targetGroup.name}`,
            timestamp: new Date().toISOString()
        });
        
        // Show success message
        alert('Merge proposal initiated! Waiting for approval from both groups.');
    } catch (error) {
        console.error('Error initiating group merge:', error);
        alert('Failed to initiate group merge');
    }
}

// Implement voting system
async voteOnProposal(proposalId, vote) {
    if (!this.currentUser || !this.currentGroup) return;
    
    try {
        const proposal = await this.getProposal(proposalId);
        if (!proposal) throw new Error('Proposal not found');
        
        // Check if user already voted
        if (proposal.votes.some(v => v.userId === this.currentUser.id)) {
            alert('You have already voted on this proposal');
            return;
        }
        
        // Add vote
        proposal.votes.push({
            userId: this.currentUser.id,
            vote: vote,
            timestamp: new Date().toISOString()
        });
        
        // Check if proposal passed
        const group = await this.getGroup(proposal.sourceGroupId);
        const requiredVotes = Math.ceil(group.members.length * 0.75); // 75% of members
        
        if (proposal.votes.length >= requiredVotes) {
            const yesVotes = proposal.votes.filter(v => v.vote === 'yes').length;
            
            if (yesVotes >= requiredVotes) {
                proposal.status = 'approved';
                await this.executeMerge(proposal);
            } else {
                proposal.status = 'rejected';
            }
        }
        
        // Update in blockchain
        await this.addBlock({
            type: 'proposal_update',
            proposal: proposal
        });
        
        // Show success message
        alert('Vote recorded successfully!');
    } catch (error) {
        console.error('Error voting on proposal:', error);
        alert('Failed to record vote');
    }
}

async executeMerge(proposal) {
    try {
        const sourceGroup = await this.getGroup(proposal.sourceGroupId);
        const targetGroup = await this.getGroup(proposal.targetGroupId);
        
        if (!sourceGroup || !targetGroup) throw new Error('Groups not found');
        
        // Merge members (unique only)
        const mergedMembers = [...new Set([...sourceGroup.members, ...targetGroup.members])];
        
        // Merge savings
        const sourceSavings = await this.getGroupSavings(sourceGroup.id);
        const targetSavings = await this.getGroupSavings(targetGroup.id);
        const mergedSavings = [...sourceSavings, ...targetSavings];
        
        // Update target group
        targetGroup.members = mergedMembers;
        targetGroup.lastActive = new Date().toISOString();
        
        // Update in blockchain
        await this.addBlock({
            type: 'group_update',
            group: targetGroup
        });
        
        // Mark source group as merged
        sourceGroup.merged = true;
        sourceGroup.mergedInto = targetGroup.id;
        sourceGroup.lastActive = new Date().toISOString();
        
        await this.addBlock({
            type: 'group_update',
            group: sourceGroup
        });
        
        // Transfer savings
        for (const saving of mergedSavings) {
            saving.groupId = targetGroup.id;
            await this.addBlock({
                type: 'saving_update',
                saving: saving
            });
        }
        
        // Notify members
        await this.addBlock({
            type: 'broadcast',
            broadcast: {
                id: this.generateId(),
                groupId: targetGroup.id,
                senderId: this.currentUser.id,
                title: 'Group Merge Complete',
                content: `${sourceGroup.name} has been merged into ${targetGroup.name}`,
                recipients: 'all',
                timestamp: new Date().toISOString()
            }
        });
        
        // Initiate admin election
        await this.initiateAdminElection(targetGroup.id);
    } catch (error) {
        console.error('Error executing merge:', error);
        throw error;
    }
}

async initiateAdminElection(groupId) {
    try {
        const group = await this.getGroup(groupId);
        if (!group) throw new Error('Group not found');
        
        // Create election
        const election = {
            id: this.generateId(),
            groupId: groupId,
            status: 'active',
            candidates: [],
            votes: [],
            startDate: new Date().toISOString(),
            endDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString() // 3 days
        };
        
        // Add to blockchain
        await this.addBlock({
            type: 'election',
            election: election
        });
        
        // Broadcast to group
        await this.addBlock({
            type: 'broadcast',
            broadcast: {
                id: this.generateId(),
                groupId: groupId,
                senderId: this.currentUser.id,
                title: 'Admin Election Started',
                content: 'Vote for the new group admin',
                recipients: 'all',
                timestamp: new Date().toISOString()
            }
        });
    } catch (error) {
        console.error('Error initiating admin election:', error);
        throw error;
    }
}

// Utility methods
generateId() {
    return crypto.randomUUID ? crypto.randomUUID() : 
        Date.now().toString(36) + Math.random().toString(36).substring(2);
}

printContent(contentId, title) {
    const content = document.getElementById(contentId).cloneNode(true);
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <html>
            <head>
                <title>${title}</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    .no-print { display: none; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    @page { size: auto; margin: 10mm; }
                </style>
            </head>
            <body>
                <h1>${title}</h1>
                <p>Date: ${new Date().toLocaleDateString()}</p>
                <hr>
                ${content.innerHTML}
            </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

// Initialize the application when the DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.kiiraSave = new KiiraSave();
                });
        }
    </script>
</body>
</html>
