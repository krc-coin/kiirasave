<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiira Save - Skysoft Technologies</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --gray-color: #95a5a6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .auth-buttons button {
            background-color: white;
            color: var(--primary-color);
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .auth-buttons button:hover {
            background-color: var(--light-color);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary {
            background-color: var(--gray-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d35400;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-3 {
            margin-top: 15px;
        }
        
        .mb-3 {
            margin-bottom: 15px;
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .dashboard {
            display: flex;
            min-height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 250px;
            background-color: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            background-color: white;
            margin-left: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            margin-bottom: 10px;
        }
        
        .nav-link {
            display: block;
            padding: 10px;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: var(--light-color);
            color: var(--primary-color);
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .card-body {
            margin-bottom: 15px;
        }
        
        .card-footer {
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .table th {
            background-color: var(--light-color);
            font-weight: 600;
        }
        
        .table tr:hover {
            background-color: #f9f9f9;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .progress {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-name {
            font-weight: 600;
        }
        
        .broadcast-container {
            position: fixed;
            top: 70px;
            left: 0;
            width: 100%;
            background-color: var(--warning-color);
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                margin-bottom: 20px;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .auth-buttons {
                margin-top: 10px;
                width: 100%;
                display: flex;
                justify-content: space-between;
            }
            
            .auth-buttons button {
                margin-left: 0;
                width: 48%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">Kiira Save</div>
            <div class="auth-buttons">
                <button id="signupBtn">Sign Up</button>
                <button id="loginBtn">Login</button>
            </div>
        </div>
    </header>

    <!-- Sign Up Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create Account</div>
                <button class="close-modal">&times;</button>
            </div>
            <form id="signupForm">
                <div class="form-group">
                    <label for="signupName">Full Name</label>
                    <input type="text" id="signupName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signupPhone">Phone Number</label>
                    <input type="tel" id="signupPhone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signupLocation">Location</label>
                    <input type="text" id="signupLocation" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signupNextOfKin">Next of Kin Name</label>
                    <input type="text" id="signupNextOfKin" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signupNextOfKinPhone">Next of Kin Phone</label>
                    <input type="tel" id="signupNextOfKinPhone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="signupGroup">Group Name (Leave blank if creating new group)</label>
                    <input type="text" id="signupGroup" class="form-control">
                </div>
                <div id="newGroupFields" class="hidden">
                    <div class="form-group">
                        <label for="newGroupTitle">New Group Title</label>
                        <input type="text" id="newGroupTitle" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="newGroupCurrency">Group Currency</label>
                        <select id="newGroupCurrency" class="form-control">
                            <option value="UGX">UGX - Ugandan Shilling</option>
                            <option value="KES">KES - Kenyan Shilling</option>
                            <option value="TZS">TZS - Tanzanian Shilling</option>
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">Sign Up</button>
                </div>
                <div class="text-center mt-3">
                    Already have an account? <a href="#" id="showLoginFromSignup">Login</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Login</div>
                <button class="close-modal">&times;</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email or Phone</label>
                    <input type="text" id="loginEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">Login</button>
                </div>
                <div class="text-center mt-3">
                    Don't have an account? <a href="#" id="showSignupFromLogin">Sign Up</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard (hidden by default) -->
    <div id="dashboard" class="hidden">
        <div class="broadcast-container hidden" id="broadcastMessage">
            <div id="broadcastContent"></div>
        </div>
        
        <div class="container dashboard">
            <div class="sidebar">
                <div class="user-info mb-3">
                    <img src="https://via.placeholder.com/40" alt="User" class="avatar" id="userAvatar">
                    <div>
                        <div class="user-name" id="sidebarUserName"></div>
                        <small id="sidebarUserRole"></small>
                    </div>
                </div>
                
                <ul class="nav-menu">
                    <li class="nav-item"><a href="#" class="nav-link active" data-section="overview">Overview</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-section="savings">Savings</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-section="loans">Loans</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-section="shares">Shares</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-section="members">Members</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-section="transactions">Transactions</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-section="timeline">Timeline</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-section="messages">Messages</a></li>
                    <li class="nav-item admin-only hidden"><a href="#" class="nav-link" data-section="admin">Admin</a></li>
                    <li class="nav-item superadmin-only hidden"><a href="#" class="nav-link" data-section="superadmin">Super Admin</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-section="profile">Profile</a></li>
                    <li class="nav-item"><a href="#" id="logoutBtn" class="nav-link">Logout</a></li>
                </ul>
                
                <div class="card mt-3 hidden" id="advertCard">
                    <div class="card-header">
                        <div class="card-title">Advertisement</div>
                    </div>
                    <div class="card-body" id="advertContent">
                        <!-- Ad content will be loaded here -->
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <!-- Overview Section -->
                <div class="dashboard-section" id="overviewSection">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Group Summary</div>
                        </div>
                        <div class="card-body">
                            <h3 id="groupTitleOverview"></h3>
                            <p>Current Cycle: <span id="currentCycle"></span></p>
                            <p>Next Saving Date: <span id="nextSavingDate"></span></p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Your Savings</div>
                        </div>
                        <div class="card-body">
                            <div class="progress">
                                <div class="progress-bar" id="savingsProgressBar">0%</div>
                            </div>
                            <p>Amount Saved: <span id="amountSaved"></span></p>
                            <p>Percentage of Group: <span id="percentageOfGroup"></span></p>
                            <p>Last Saved: <span id="lastSavedDate"></span></p>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary" id="addSavingBtn">Add Saving</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Group Statistics</div>
                        </div>
                        <div class="card-body">
                            <p>Total Members: <span id="totalMembers"></span></p>
                            <p>Total Group Savings: <span id="totalGroupSavings"></span></p>
                            <p>Active Loans: <span id="activeLoans"></span></p>
                            <p>Shares on Market: <span id="sharesOnMarket"></span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Savings Section -->
                <div class="dashboard-section hidden" id="savingsSection">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Add New Saving</div>
                        </div>
                        <div class="card-body">
                            <form id="addSavingForm">
                                <div class="form-group">
                                    <label for="savingAmount">Amount</label>
                                    <input type="number" id="savingAmount" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="savingDate">Date</label>
                                    <input type="date" id="savingDate" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="savingNote">Note (Optional)</label>
                                    <textarea id="savingNote" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Submit Saving</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Your Savings History</div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Note</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="savingsHistoryTable">
                                        <!-- Savings history will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-secondary" id="printSavingsBtn">Print Savings</button>
                        </div>
                    </div>
                </div>
                
                <!-- Loans Section -->
                <div class="dashboard-section hidden" id="loansSection">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Apply for Loan</div>
                        </div>
                        <div class="card-body">
                            <form id="loanApplicationForm">
                                <div class="form-group">
                                    <label for="loanAmount">Amount</label>
                                    <input type="number" id="loanAmount" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="loanPurpose">Purpose</label>
                                    <textarea id="loanPurpose" class="form-control" rows="3" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="loanRepaymentPeriod">Repayment Period</label>
                                    <select id="loanRepaymentPeriod" class="form-control" required>
                                        <option value="1week">1 Week</option>
                                        <option value="1month">1 Month</option>
                                        <option value="3months">3 Months</option>
                                        <option value="6months">6 Months</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <p>Interest Rate: <span id="loanInterestRate">5</span>%</p>
                                    <p>Total to Repay: <span id="loanTotalRepay">0</span></p>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary" id="applyLoanBtn">Apply for Loan</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Your Loans</div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Due Date</th>
                                            <th>Amount Due</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="loansHistoryTable">
                                        <!-- Loans history will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card admin-only hidden">
                        <div class="card-header">
                            <div class="card-title">Pending Loan Approvals</div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Member</th>
                                            <th>Amount</th>
                                            <th>Purpose</th>
                                            <th>Period</th>
                                            <th>Votes</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pendingLoansTable">
                                        <!-- Pending loans will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Shares Section -->
                <div class="dashboard-section hidden" id="sharesSection">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Shares Market</div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Member</th>
                                            <th>Amount</th>
                                            <th>Price</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sharesMarketTable">
                                        <!-- Shares market will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Your Shares</div>
                        </div>
                        <div class="card-body">
                            <form id="listSharesForm" class="mb-3">
                                <div class="form-group">
                                    <label for="shareAmount">Amount to List</label>
                                    <input type="number" id="shareAmount" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="sharePrice">Price per Share</label>
                                    <input type="number" id="sharePrice" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">List Shares</button>
                                </div>
                            </form>
                            
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date Listed</th>
                                            <th>Amount</th>
                                            <th>Price</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="yourSharesTable">
                                        <!-- Your shares will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Members Section -->
                <div class="dashboard-section hidden" id="membersSection">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Group Members</div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Savings</th>
                                            <th>Last Active</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="groupMembersTable">
                                        <!-- Group members will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card admin-only hidden">
                        <div class="card-header">
                            <div class="card-title">Pending Members</div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Date Applied</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pendingMembersTable">
                                        <!-- Pending members will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Transactions Section -->
                <div class="dashboard-section hidden" id="transactionsSection">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Recent Transactions</div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Amount</th>
                                            <th>Details</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsTable">
                                        <!-- Transactions will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline Section -->
                <div class="dashboard-section hidden" id="timelineSection">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Group Timeline</div>
                        </div>
                        <div class="card-body">
                            <form id="timelinePostForm" class="mb-3">
                                <div class="form-group">
                                    <textarea id="timelinePostContent" class="form-control" rows="3" placeholder="Share something with the group..."></textarea>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Post</button>
                                </div>
                            </form>
                            
                            <div id="timelinePosts">
                                <!-- Timeline posts will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Messages Section -->
                <div class="dashboard-section hidden" id="messagesSection">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Messages</div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="list-group" id="messageContacts">
                                        <!-- Message contacts will be loaded here -->
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div id="messageConversation" class="hidden">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="card-title" id="messageRecipientName"></div>
                                            </div>
                                            <div class="card-body" id="messageHistory" style="height: 300px; overflow-y: auto;">
                                                <!-- Message history will be loaded here -->
                                            </div>
                                            <div class="card-footer">
                                                <form id="sendMessageForm">
                                                    <div class="input-group">
                                                        <input type="text" id="messageContent" class="form-control" placeholder="Type your message...">
                                                        <div class="input-group-append">
                                                            <button class="btn btn-primary" type="submit">Send</button>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="noMessageSelected" class="text-center py-5">
                                        <p>Select a conversation to start chatting</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Admin Section -->
                <div class="dashboard-section hidden" id="adminSection">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Group Settings</div>
                        </div>
                        <div class="card-body">
                            <form id="groupSettingsForm">
                                <div class="form-group">
                                    <label for="groupName">Group Name</label>
                                    <input type="text" id="groupName" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="groupCurrency">Currency</label>
                                    <select id="groupCurrency" class="form-control" required>
                                        <option value="UGX">UGX - Ugandan Shilling</option>
                                        <option value="KES">KES - Kenyan Shilling</option>
                                        <option value="TZS">TZS - Tanzanian Shilling</option>
                                        <option value="USD">USD - US Dollar</option>
                                        <option value="EUR">EUR - Euro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="savingFrequency">Saving Frequency</label>
                                    <select id="savingFrequency" class="form-control" required>
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="annually">Annually</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="form-group" id="savingDayGroup">
                                    <label for="savingDay">Saving Day</label>
                                    <select id="savingDay" class="form-control">
                                        <option value="1">Monday</option>
                                        <option value="2">Tuesday</option>
                                        <option value="3">Wednesday</option>
                                        <option value="4">Thursday</option>
                                        <option value="5">Friday</option>
                                        <option value="6">Saturday</option>
                                        <option value="0">Sunday</option>
                                    </select>
                                </div>
                                <div class="form-group" id="savingDateGroup" style="display: none;">
                                    <label for="savingDateInput">Saving Date (1-28)</label>
                                    <input type="number" id="savingDateInput" class="form-control" min="1" max="28" value="1">
                                </div>
                                <div class="form-group">
                                    <label for="savingAmountType">Saving Amount Type</label>
                                    <select id="savingAmountType" class="form-control" required>
                                        <option value="fixed">Fixed Amount</option>
                                        <option value="variable">Variable Amount</option>
                                    </select>
                                </div>
                                <div class="form-group" id="fixedAmountGroup">
                                    <label for="fixedAmount">Fixed Amount</label>
                                    <input type="number" id="fixedAmount" class="form-control" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="savingCompulsory">Is Saving Compulsory?</label>
                                    <select id="savingCompulsory" class="form-control" required>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="loanEnabled">Enable Loans?</label>
                                    <select id="loanEnabled" class="form-control" required>
                                        <option value="yes">Yes</option>
                                        <option value="no">No</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="defaultInterestRate">Default Interest Rate (%)</label>
                                    <input type="number" id="defaultInterestRate" class="form-control" min="0" max="100" step="0.1" value="5">
                                </div>
                                <div class="form-group">
                                    <label for="penaltyInterestRate">Penalty Interest Rate (%)</label>
                                    <input type="number" id="penaltyInterestRate" class="form-control" min="0" max="100" step="0.1" value="20">
                                </div>
                                <div class="form-group">
                                    <label for="cycleDuration">Cycle Duration</label>
                                    <select id="cycleDuration" class="form-control" required>
                                        <option value="1month">1 Month</option>
                                        <option value="3months">3 Months</option>
                                        <option value="6months">6 Months</option>
                                        <option value="1year">1 Year</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Save Settings</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Admin Actions</div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <button class="btn btn-primary btn-block mb-2" id="addMemberSavingBtn">Add Member Saving</button>
                                    <button class="btn btn-primary btn-block mb-2" id="enableWithdrawalBtn">Enable Withdrawals</button>
                                    <button class="btn btn-danger btn-block mb-2" id="disableWithdrawalBtn">Disable Withdrawals</button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-warning btn-block mb-2" id="startVotingBtn">Start Admin Voting</button>
                                    <button class="btn btn-info btn-block mb-2" id="transferAdminBtn">Transfer Admin Role</button>
                                    <button class="btn btn-secondary btn-block mb-2" id="printAllSavingsBtn">Print All Savings</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Group Subscription</div>
                        </div>
                        <div class="card-body">
                            <div id="subscriptionInfo">
                                <!-- Subscription info will be loaded here -->
                            </div>
                            <div id="subscriptionForm" class="hidden">
                                <form id="paySubscriptionForm">
                                    <div class="form-group">
                                        <label for="subscriptionPeriod">Subscription Period</label>
                                        <select id="subscriptionPeriod" class="form-control" required>
                                            <option value="1year">1 Year</option>
                                            <option value="2years">2 Years</option>
                                            <option value="3years">3 Years</option>
                                            <option value="5years">5 Years</option>
                                            <option value="custom">Custom</option>
                                        </select>
                                    </div>
                                    <div class="form-group" id="customPeriodGroup" style="display: none;">
                                        <label for="customPeriod">Custom Period (Days)</label>
                                        <input type="number" id="customPeriod" class="form-control" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label for="paymentMethod">Payment Method</label>
                                        <select id="paymentMethod" class="form-control" required>
                                            <option value="mobile_money">Mobile Money</option>
                                            <option value="bank">Bank Transfer</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" class="btn btn-primary">Pay Subscription</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Super Admin Section -->
                <div class="dashboard-section hidden" id="superadminSection">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">All Groups</div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Group Name</th>
                                            <th>Admin</th>
                                            <th>Members</th>
                                            <th>Total Savings</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="allGroupsTable">
                                        <!-- All groups will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">System Settings</div>
                        </div>
                        <div class="card-body">
                            <form id="systemSettingsForm">
                                <div class="form-group">
                                    <label for="maxGroupsPerUser">Maximum Groups per User</label>
                                    <input type="number" id="maxGroupsPerUser" class="form-control" min="1" value="2" required>
                                </div>
                                <div class="form-group">
                                    <label for="subscriptionAmount">Subscription Amount</label>
                                    <input type="number" id="subscriptionAmount" class="form-control" min="0" value="0" required>
                                </div>
                                <div class="form-group">
                                    <label for="mobileMoneyNumber">Mobile Money Number</label>
                                    <input type="text" id="mobileMoneyNumber" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="broadcastDuration">Broadcast Duration (seconds)</label>
                                    <input type="number" id="broadcastDuration" class="form-control" min="5" value="10" required>
                                </div>
                                <div class="form-group">
                                    <label for="successor1">First Successor (User ID)</label>
                                    <input type="text" id="successor1" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="successor2">Second Successor (User ID)</label>
                                    <input type="text" id="successor2" class="form-control">
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Save Settings</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Send Broadcast</div>
                        </div>
                        <div class="card-body">
                            <form id="broadcastForm">
                                <div class="form-group">
                                    <label for="broadcastRecipient">Recipient</label>
                                    <select id="broadcastRecipient" class="form-control" required>
                                        <option value="all_admins">All Group Admins</option>
                                        <option value="all_members">All Members</option>
                                        <option value="specific_group">Specific Group</option>
                                    </select>
                                </div>
                                <div class="form-group" id="specificGroupGroup" style="display: none;">
                                    <label for="specificGroup">Select Group</label>
                                    <select id="specificGroup" class="form-control">
                                        <!-- Groups will be loaded here -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="broadcastMessage">Message</label>
                                    <textarea id="broadcastMessageInput" class="form-control" rows="3" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="broadcastAttachment">Attachment (Optional)</label>
                                    <input type="file" id="broadcastAttachment" class="form-control">
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Send Broadcast</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Section -->
                <div class="dashboard-section hidden" id="profileSection">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Your Profile</div>
                        </div>
                        <div class="card-body">
                            <form id="profileForm">
                                <div class="form-group">
                                    <label for="profileName">Full Name</label>
                                    <input type="text" id="profileName" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="profileEmail">Email</label>
                                    <input type="email" id="profileEmail" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="profilePhone">Phone Number</label>
                                    <input type="tel" id="profilePhone" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="profileLocation">Location</label>
                                    <input type="text" id="profileLocation" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="profileNextOfKin">Next of Kin Name</label>
                                    <input type="text" id="profileNextOfKin" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="profileNextOfKinPhone">Next of Kin Phone</label>
                                    <input type="tel" id="profileNextOfKinPhone" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="profileUsername">Username</label>
                                    <input type="text" id="profileUsername" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="profilePicture">Profile Picture</label>
                                    <input type="file" id="profilePicture" class="form-control">
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Update Profile</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Change Password</div>
                        </div>
                        <div class="card-body">
                            <form id="changePasswordForm">
                                <div class="form-group">
                                    <label for="currentPassword">Current Password</label>
                                    <input type="password" id="currentPassword" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="newPassword">New Password</label>
                                    <input type="password" id="newPassword" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="confirmNewPassword">Confirm New Password</label>
                                    <input type="password" id="confirmNewPassword" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">Change Password</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Your Groups</div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Group Name</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userGroupsTable">
                                        <!-- User groups will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Saving Modal -->
    <div id="addMemberSavingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Saving for Member</div>
                <button class="close-modal">&times;</button>
            </div>
            <form id="addMemberSavingForm">
                <div class="form-group">
                    <label for="memberSelect">Select Member</label>
                    <select id="memberSelect" class="form-control" required>
                        <!-- Members will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="memberSavingAmount">Amount</label>
                    <input type="number" id="memberSavingAmount" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="memberSavingDate">Date</label>
                    <input type="date" id="memberSavingDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="memberSavingNote">Note (Optional)</label>
                    <textarea id="memberSavingNote" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Add Saving</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transfer Admin Modal -->
    <div id="transferAdminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Transfer Admin Role</div>
                <button class="close-modal">&times;</button>
            </div>
            <form id="transferAdminForm">
                <div class="form-group">
                    <label for="newAdminSelect">Select New Admin</label>
                    <select id="newAdminSelect" class="form-control" required>
                        <!-- Members will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <div class="alert alert-warning">
                        <strong>Warning!</strong> This action is irreversible. You will lose all admin privileges.
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmTransfer">Type "CONFIRM" to proceed</label>
                    <input type="text" id="confirmTransfer" class="form-control" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-danger">Transfer Admin Role</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Voting Modal -->
    <div id="votingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Vote for New Admin</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="card-body">
                <div id="votingCandidates">
                    <!-- Voting candidates will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Gift Modal -->
    <div id="giftModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Gift to Member</div>
                <button class="close-modal">&times;</button>
            </div>
            <form id="giftForm">
                <div class="form-group">
                    <label for="giftRecipient">Recipient</label>
                    <select id="giftRecipient" class="form-control" required>
                        <!-- Members will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="giftAmount">Amount</label>
                    <input type="number" id="giftAmount" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="giftNote">Note (Optional)</label>
                    <textarea id="giftNote" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Send Gift</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Withdraw Savings</div>
                <button class="close-modal">&times;</button>
            </div>
            <form id="withdrawForm">
                <div class="form-group">
                    <label for="withdrawAmount">Amount (Available: <span id="availableBalance">0</span>)</label>
                    <input type="number" id="withdrawAmount" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="withdrawMethod">Withdrawal Method</label>
                    <select id="withdrawMethod" class="form-control" required>
                        <option value="mobile_money">Mobile Money</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="cash">Cash</option>
                    </select>
                </div>
                <div class="form-group" id="mobileMoneyDetails">
                    <label for="mobileMoneyNumberWithdraw">Mobile Money Number</label>
                    <input type="text" id="mobileMoneyNumberWithdraw" class="form-control">
                </div>
                <div class="form-group" id="bankDetails" style="display: none;">
                    <label for="bankAccountNumber">Bank Account Number</label>
                    <input type="text" id="bankAccountNumber" class="form-control">
                    <label for="bankName">Bank Name</label>
                    <input type="text" id="bankName" class="form-control">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Request Withdrawal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Share Purchase Modal -->
    <div id="sharePurchaseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Purchase Shares</div>
                <button class="close-modal">&times;</button>
            </div>
            <form id="sharePurchaseForm">
                <div class="form-group">
                    <label for="sharePurchaseAmount">Amount to Purchase</label>
                    <input type="number" id="sharePurchaseAmount" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="sharePurchasePaymentMethod">Payment Method</label>
                    <select id="sharePurchasePaymentMethod" class="form-control" required>
                        <option value="mobile_money">Mobile Money</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="cash">Cash</option>
                    </select>
                </div>
                <div class="form-group">
                    <p>Total Cost: <span id="sharePurchaseTotal">0</span></p>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Purchase Shares</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loan Payment Modal -->
    <div id="loanPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Pay Loan</div>
                <button class="close-modal">&times;</button>
            </div>
            <form id="loanPaymentForm">
                <div class="form-group">
                    <label for="loanPaymentAmount">Amount (Due: <span id="loanDueAmount">0</span>)</label>
                    <input type="number" id="loanPaymentAmount" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="loanPaymentMethod">Payment Method</label>
                    <select id="loanPaymentMethod" class="form-control" required>
                        <option value="mobile_money">Mobile Money</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="cash">Cash</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Make Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-content" style="text-align: center; background: transparent; box-shadow: none;">
            <div class="loading" style="width: 50px; height: 50px; border-width: 5px;"></div>
            <p id="loadingText" style="color: white; margin-top: 15px;">Initializing application...</p>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/ipfs/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dat-sdk@1.0.0/dist/bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // Firebase configuration for email verification
        const firebaseConfig = {
            apiKey: "AIzaSyDEXAMPLEEXAMPLEEXAMPLEEXAMPLE",
            authDomain: "kira-save-example.firebaseapp.com",
            projectId: "kira-save-example",
            storageBucket: "kira-save-example.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Application state
        const state = {
            initialized: false,
            currentUser: null,
            currentGroup: null,
            isAdmin: false,
            isSuperAdmin: false,
            db: null,
            ipfs: null,
            dat: null,
            peer: null,
            blockchain: [],
            networkPeers: [],
            verificationEmailSent: false
        };
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading('Initializing application...');
            
            try {
                // Initialize IndexedDB
                await initIndexedDB();
                
                // Initialize cryptographic functions
                await initCrypto();
                
                // Initialize network components
                await initNetwork();
                
                // Initialize UI
                initUI();
                
                // Check if user is already logged in
                await checkAuthState();
                
                state.initialized = true;
                hideLoading();
            } catch (error) {
                console.error('Initialization error:', error);
                showLoading('Initialization failed. Please refresh the page.');
                setTimeout(() => {
                    hideLoading();
                    alert('Application failed to initialize. Please check your internet connection and refresh the page.');
                }, 3000);
            }
        });
        
        // Initialize IndexedDB
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('KiiraSaveDB', 1);
                
                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    reject('Failed to open database');
                };
                
                request.onsuccess = (event) => {
                    state.db = event.target.result;
                    console.log('Database initialized');
                    resolve();
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create object stores
                    if (!db.objectStoreNames.contains('users')) {
                        const usersStore = db.createObjectStore('users', { keyPath: 'id' });
                        usersStore.createIndex('email', 'email', { unique: true });
                        usersStore.createIndex('phone', 'phone', { unique: true });
                    }
                    
                    if (!db.objectStoreNames.contains('groups')) {
                        const groupsStore = db.createObjectStore('groups', { keyPath: 'id' });
                        groupsStore.createIndex('name', 'name', { unique: true });
                    }
                    
                    if (!db.objectStoreNames.contains('memberships')) {
                        const membershipsStore = db.createObjectStore('memberships', { keyPath: 'id' });
                        membershipsStore.createIndex('userId', 'userId', { unique: false });
                        membershipsStore.createIndex('groupId', 'groupId', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('savings')) {
                        const savingsStore = db.createObjectStore('savings', { keyPath: 'id' });
                        savingsStore.createIndex('userId', 'userId', { unique: false });
                        savingsStore.createIndex('groupId', 'groupId', { unique: false });
                        savingsStore.createIndex('date', 'date', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('loans')) {
                        const loansStore = db.createObjectStore('loans', { keyPath: 'id' });
                        loansStore.createIndex('userId', 'userId', { unique: false });
                        loansStore.createIndex('groupId', 'groupId', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('shares')) {
                        const sharesStore = db.createObjectStore('shares', { keyPath: 'id' });
                        sharesStore.createIndex('userId', 'userId', { unique: false });
                        sharesStore.createIndex('groupId', 'groupId', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('transactions')) {
                        const transactionsStore = db.createObjectStore('transactions', { keyPath: 'id' });
                        transactionsStore.createIndex('userId', 'userId', { unique: false });
                        transactionsStore.createIndex('groupId', 'groupId', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('messages')) {
                        const messagesStore = db.createObjectStore('messages', { keyPath: 'id' });
                        messagesStore.createIndex('senderId', 'senderId', { unique: false });
                        messagesStore.createIndex('receiverId', 'receiverId', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('timeline')) {
                        const timelineStore = db.createObjectStore('timeline', { keyPath: 'id' });
                        timelineStore.createIndex('groupId', 'groupId', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('blockchain')) {
                        db.createObjectStore('blockchain', { keyPath: 'index' });
                    }
                    
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                    
                    console.log('Database schema created');
                };
            });
        }
        
        // Initialize cryptographic functions
        async function initCrypto() {
            // Check if Web Crypto API is available
            if (!window.crypto || !window.crypto.subtle) {
                throw new Error('Web Crypto API not available. Please use a modern browser.');
            }
            
            console.log('Crypto initialized');
        }
        
        // Initialize network components (IPFS, DAT, PeerJS)
        async function initNetwork() {
            try {
                // Initialize IPFS
                state.ipfs = await Ipfs.create({ repo: 'kira-save-ipfs' });
                console.log('IPFS initialized');
                
                // Initialize DAT
                state.dat = await DatSdk();
                console.log('DAT initialized');
                
                // Initialize PeerJS
                state.peer = new Peer();
                
                return new Promise((resolve) => {
                    state.peer.on('open', (id) => {
                        console.log('PeerJS initialized with ID:', id);
                        resolve();
                    });
                    
                    state.peer.on('error', (error) => {
                        console.error('PeerJS error:', error);
                        // We'll still resolve as the app can work without PeerJS
                        resolve();
                    });
                });
            } catch (error) {
                console.error('Network initialization error:', error);
                // We'll still resolve as the app can work in offline mode
                return Promise.resolve();
            }
        }
        
        // Initialize UI event listeners
        function initUI() {
            // Auth modals
            document.getElementById('signupBtn').addEventListener('click', () => showModal('signupModal'));
            document.getElementById('loginBtn').addEventListener('click', () => showModal('loginModal'));
            document.getElementById('showLoginFromSignup').addEventListener('click', (e) => {
                e.preventDefault();
                hideModal('signupModal');
                showModal('loginModal');
            });
            document.getElementById('showSignupFromLogin').addEventListener('click', (e) => {
                e.preventDefault();
                hideModal('loginModal');
                showModal('signupModal');
            });
            
            // Close modals
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    hideModal(modal.id);
                });
            });
            
            // Auth forms
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.dataset.section) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        switchSection(link.dataset.section);
                    });
                }
            });
            
            // Group creation toggle
            document.getElementById('signupGroup').addEventListener('input', function() {
                const newGroupFields = document.getElementById('newGroupFields');
                if (this.value.trim() === '') {
                    newGroupFields.classList.remove('hidden');
                } else {
                    newGroupFields.classList.add('hidden');
                }
            });
            
            // Savings form
            document.getElementById('addSavingForm').addEventListener('submit', handleAddSaving);
            document.getElementById('addSavingBtn').addEventListener('click', () => {
                switchSection('savings');
            });
            
            // Loan form
            document.getElementById('loanApplicationForm').addEventListener('submit', handleLoanApplication);
            document.getElementById('loanAmount').addEventListener('input', updateLoanCalculation);
            
            // Shares form
            document.getElementById('listSharesForm').addEventListener('submit', handleListShares);
            
            // Profile forms
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            
            // Admin forms
            document.getElementById('groupSettingsForm').addEventListener('submit', handleGroupSettingsUpdate);
            document.getElementById('addMemberSavingBtn').addEventListener('click', () => showModal('addMemberSavingModal'));
            document.getElementById('transferAdminBtn').addEventListener('click', () => showModal('transferAdminModal'));
            document.getElementById('startVotingBtn').addEventListener('click', () => showModal('votingModal'));
            document.getElementById('enableWithdrawalBtn').addEventListener('click', handleEnableWithdrawals);
            document.getElementById('disableWithdrawalBtn').addEventListener('click', handleDisableWithdrawals);
            document.getElementById('printAllSavingsBtn').addEventListener('click', handlePrintAllSavings);
            
            // Super admin forms
            document.getElementById('systemSettingsForm').addEventListener('submit', handleSystemSettingsUpdate);
            document.getElementById('broadcastForm').addEventListener('submit', handleBroadcast);
            document.getElementById('broadcastRecipient').addEventListener('change', function() {
                document.getElementById('specificGroupGroup').style.display = 
                    this.value === 'specific_group' ? 'block' : 'none';
            });
            
            // Modal forms
            document.getElementById('addMemberSavingForm').addEventListener('submit', handleAddMemberSaving);
            document.getElementById('transferAdminForm').addEventListener('submit', handleTransferAdmin);
            document.getElementById('giftForm').addEventListener('submit', handleGift);
            document.getElementById('withdrawForm').addEventListener('submit', handleWithdraw);
            document.getElementById('sharePurchaseForm').addEventListener('submit', handleSharePurchase);
            document.getElementById('loanPaymentForm').addEventListener('submit', handleLoanPayment);
            
            // Payment method toggle
            document.getElementById('withdrawMethod').addEventListener('change', function() {
                document.getElementById('mobileMoneyDetails').style.display = 
                    this.value === 'mobile_money' ? 'block' : 'none';
                document.getElementById('bankDetails').style.display = 
                    this.value === 'bank' ? 'block' : 'none';
            });
            
            // Saving frequency toggle
            document.getElementById('savingFrequency').addEventListener('change', function() {
                document.getElementById('savingDayGroup').style.display = 
                    this.value === 'weekly' ? 'block' : 'none';
                document.getElementById('savingDateGroup').style.display = 
                    this.value === 'monthly' ? 'block' : 'none';
            });
            
            // Saving amount type toggle
            document.getElementById('savingAmountType').addEventListener('change', function() {
                document.getElementById('fixedAmountGroup').style.display = 
                    this.value === 'fixed' ? 'block' : 'none';
            });
            
            // Subscription period toggle
            document.getElementById('subscriptionPeriod').addEventListener('change', function() {
                document.getElementById('customPeriodGroup').style.display = 
                    this.value === 'custom' ? 'block' : 'none';
            });
            
            console.log('UI initialized');
        }
        
        // Check authentication state
        async function checkAuthState() {
            const authToken = Cookies.get('authToken');
            if (authToken) {
                try {
                    // Verify token and get user data
                    const user = await verifyAuthToken(authToken);
                    if (user) {
                        state.currentUser = user;
                        
                        // Load user's default group
                        const memberships = await getDBData('memberships', 'userId', user.id);
                        if (memberships.length > 0) {
                            state.currentGroup = await getDBData('groups', 'id', memberships[0].groupId);
                            state.isAdmin = memberships[0].isAdmin;
                            state.isSuperAdmin = user.isSuperAdmin;
                            
                            // Load dashboard
                            showDashboard();
                            loadDashboardData();
                        } else {
                            // User has no groups
                            showDashboard();
                        }
                    }
                } catch (error) {
                    console.error('Auth check error:', error);
                    Cookies.remove('authToken');
                }
            }
        }
        
        // Handle signup
        async function handleSignup(e) {
            e.preventDefault();
            showLoading('Creating account...');
            
            try {
                const name = document.getElementById('signupName').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const phone = document.getElementById('signupPhone').value.trim();
                const location = document.getElementById('signupLocation').value.trim();
                const nextOfKin = document.getElementById('signupNextOfKin').value.trim();
                const nextOfKinPhone = document.getElementById('signupNextOfKinPhone').value.trim();
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                const groupName = document.getElementById('signupGroup').value.trim();
                
                // Validate inputs
                if (password !== confirmPassword) {
                    throw new Error('Passwords do not match');
                }
                
                if (!name || !email || !phone || !location || !nextOfKin || !nextOfKinPhone) {
                    throw new Error('All fields are required');
                }
                
                // Hash password
                const passwordHash = await hashPassword(password);
                
                // Check if user already exists
                const existingUser = await getDBData('users', 'email', email) || 
                                    await getDBData('users', 'phone', phone);
                
                if (existingUser) {
                    throw new Error('User with this email or phone already exists');
                }
                
                // Create user object
                const user = {
                    id: generateId(),
                    name,
                    email,
                    phone,
                    location,
                    nextOfKin,
                    nextOfKinPhone,
                    passwordHash,
                    username: generateUsername(name),
                    profilePicture: '',
                    isVerified: false,
                    isSuperAdmin: false, // First user becomes super admin
                    createdAt: new Date().toISOString(),
                    lastActive: new Date().toISOString()
                };
                
                // Handle group
                let group = null;
                let isAdmin = false;
                
                if (groupName) {
                    // Join existing group
                    group = await getDBData('groups', 'name', groupName);
                    
                    if (!group) {
                        throw new Error('Group not found');
                    }
                    
                    // Membership will be pending approval
                    isAdmin = false;
                } else {
                    // Create new group
                    const groupTitle = document.getElementById('newGroupTitle').value.trim();
                    const groupCurrency = document.getElementById('newGroupCurrency').value;
                    
                    if (!groupTitle) {
                        throw new Error('Group title is required');
                    }
                    
                    // Check if group exists
                    const existingGroup = await getDBData('groups', 'name', groupTitle);
                    if (existingGroup) {
                        throw new Error('Group with this name already exists');
                    }
                    
                    group = {
                        id: generateId(),
                        name: groupTitle,
                        currency: groupCurrency,
                        settings: getDefaultGroupSettings(),
                        createdAt: new Date().toISOString(),
                        lastActive: new Date().toISOString(),
                        isActive: true
                    };
                    
                    await addDBData('groups', group);
                    
                    // First user becomes admin
                    isAdmin = true;
                    
                    // Check if this is the first user (super admin)
                    const allUsers = await getAllDBData('users');
                    if (allUsers.length === 0) {
                        user.isSuperAdmin = true;
                    }
                }
                
                // Save user
                await addDBData('users', user);
                
                // Create membership
                const membership = {
                    id: generateId(),
                    userId: user.id,
                    groupId: group.id,
                    isAdmin,
                    isApproved: isAdmin, // Auto-approve if admin
                    joinedAt: new Date().toISOString(),
                    balance: 0,
                    shares: 0
                };
                
                await addDBData('memberships', membership);
                
                // Create auth token
                const authToken = await generateAuthToken(user);
                Cookies.set('authToken', authToken, { expires: 30 });
                
                // Set current user and group
                state.currentUser = user;
                state.currentGroup = group;
                state.isAdmin = isAdmin;
                state.isSuperAdmin = user.isSuperAdmin;
                
                // Send verification email
                await sendVerificationEmail(user.email);
                
                // Show dashboard
                showDashboard();
                loadDashboardData();
                
                hideLoading();
                hideModal('signupModal');
                
                // Show verification notice
                alert('A verification email has been sent to your address. Please verify your email to access all features.');
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Signup error:', error);
            }
        }
        
        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            showLoading('Logging in...');
            
            try {
                const emailOrPhone = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                // Find user by email or phone
                const user = await getDBData('users', 'email', emailOrPhone) || 
                             await getDBData('users', 'phone', emailOrPhone);
                
                if (!user) {
                    throw new Error('User not found');
                }
                
                // Verify password
                const passwordMatch = await verifyPassword(password, user.passwordHash);
                if (!passwordMatch) {
                    throw new Error('Invalid password');
                }
                
                // Check if user is verified
                if (!user.isVerified) {
                    throw new Error('Please verify your email before logging in');
                }
                
                // Create auth token
                const authToken = await generateAuthToken(user);
                Cookies.set('authToken', authToken, { expires: 30 });
                
                // Set current user
                state.currentUser = user;
                
                // Load user's default group
                const memberships = await getDBData('memberships', 'userId', user.id);
                if (memberships.length > 0) {
                    state.currentGroup = await getDBData('groups', 'id', memberships[0].groupId);
                    state.isAdmin = memberships[0].isAdmin;
                    state.isSuperAdmin = user.isSuperAdmin;
                }
                
                // Update last active
                user.lastActive = new Date().toISOString();
                await updateDBData('users', user);
                
                // Show dashboard
                showDashboard();
                loadDashboardData();
                
                hideLoading();
                hideModal('loginModal');
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Login error:', error);
            }
        }
        
        // Handle logout
        async function handleLogout() {
            Cookies.remove('authToken');
            state.currentUser = null;
            state.currentGroup = null;
            state.isAdmin = false;
            state.isSuperAdmin = false;
            
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('signupBtn').style.display = 'inline-block';
            document.getElementById('loginBtn').style.display = 'inline-block';
        }
        
        // Handle add saving
        async function handleAddSaving(e) {
            e.preventDefault();
            showLoading('Adding saving...');
            
            try {
                const amount = parseFloat(document.getElementById('savingAmount').value);
                const date = document.getElementById('savingDate').value;
                const note = document.getElementById('savingNote').value.trim();
                
                if (!amount || amount <= 0) {
                    throw new Error('Invalid amount');
                }
                
                if (!date) {
                    throw new Error('Date is required');
                }
                
                // Check if saving is fixed amount
                if (state.currentGroup.settings.savingAmountType === 'fixed' && 
                    amount !== state.currentGroup.settings.fixedAmount) {
                    throw new Error(`Saving amount must be exactly ${state.currentGroup.settings.fixedAmount} ${state.currentGroup.currency}`);
                }
                
                // Create saving record
                const saving = {
                    id: generateId(),
                    userId: state.currentUser.id,
                    groupId: state.currentGroup.id,
                    amount,
                    date,
                    note,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('savings', saving);
                
                // Create transaction
                const transaction = {
                    id: generateId(),
                    userId: state.currentUser.id,
                    groupId: state.currentGroup.id,
                    type: 'saving',
                    amount,
                    status: 'pending',
                    details: 'Saving submission',
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('transactions', transaction);
                
                // Add to blockchain
                await addBlock({
                    type: 'saving',
                    data: saving
                });
                
                // Show success message
                alert('Saving submitted for approval');
                
                // Reload savings data
                loadSavingsData();
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Add saving error:', error);
            }
        }
        
        // Handle loan application
        async function handleLoanApplication(e) {
            e.preventDefault();
            showLoading('Processing loan application...');
            
            try {
                const amount = parseFloat(document.getElementById('loanAmount').value);
                const purpose = document.getElementById('loanPurpose').value.trim();
                const repaymentPeriod = document.getElementById('loanRepaymentPeriod').value;
                
                if (!amount || amount <= 0) {
                    throw new Error('Invalid amount');
                }
                
                if (!purpose) {
                    throw new Error('Purpose is required');
                }
                
                // Check if loans are enabled
                if (!state.currentGroup.settings.loanEnabled) {
                    throw new Error('Loans are currently disabled in this group');
                }
                
                // Check if user has sufficient savings
                const membership = await getMembership(state.currentUser.id, state.currentGroup.id);
                if (amount > membership.balance) {
                    throw new Error('Loan amount cannot exceed your savings balance');
                }
                
                // Create loan record
                const interestRate = state.currentGroup.settings.defaultInterestRate;
                const interestAmount = amount * (interestRate / 100);
                const totalAmount = amount + interestAmount;
                
                let dueDate = new Date();
                switch (repaymentPeriod) {
                    case '1week':
                        dueDate.setDate(dueDate.getDate() + 7);
                        break;
                    case '1month':
                        dueDate.setMonth(dueDate.getMonth() + 1);
                        break;
                    case '3months':
                        dueDate.setMonth(dueDate.getMonth() + 3);
                        break;
                    case '6months':
                        dueDate.setMonth(dueDate.getMonth() + 6);
                        break;
                }
                
                const loan = {
                    id: generateId(),
                    userId: state.currentUser.id,
                    groupId: state.currentGroup.id,
                    amount,
                    purpose,
                    interestRate,
                    interestAmount,
                    totalAmount,
                    repaymentPeriod,
                    dueDate: dueDate.toISOString(),
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('loans', loan);
                
                // Create transaction
                const transaction = {
                    id: generateId(),
                    userId: state.currentUser.id,
                    groupId: state.currentGroup.id,
                    type: 'loan',
                    amount,
                    status: 'pending',
                    details: 'Loan application',
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('transactions', transaction);
                
                // Add to blockchain
                await addBlock({
                    type: 'loan',
                    data: loan
                });
                
                // Show success message
                alert('Loan application submitted for approval');
                
                // Reload loans data
                loadLoansData();
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Loan application error:', error);
            }
        }
        
        // Handle list shares
        async function handleListShares(e) {
            e.preventDefault();
            showLoading('Listing shares...');
            
            try {
                const amount = parseFloat(document.getElementById('shareAmount').value);
                const price = parseFloat(document.getElementById('sharePrice').value);
                
                if (!amount || amount <= 0) {
                    throw new Error('Invalid amount');
                }
                
                if (!price || price <= 0) {
                    throw new Error('Invalid price');
                }
                
                // Check if user has sufficient shares
                const membership = await getMembership(state.currentUser.id, state.currentGroup.id);
                if (amount > membership.shares) {
                    throw new Error('You don\'t have enough shares');
                }
                
                // Create share record
                const share = {
                    id: generateId(),
                    userId: state.currentUser.id,
                    groupId: state.currentGroup.id,
                    amount,
                    price,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('shares', share);
                
                // Create transaction
                const transaction = {
                    id: generateId(),
                    userId: state.currentUser.id,
                    groupId: state.currentGroup.id,
                    type: 'share',
                    amount,
                    status: 'pending',
                    details: 'Share listing',
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('transactions', transaction);
                
                // Add to blockchain
                await addBlock({
                    type: 'share',
                    data: share
                });
                
                // Show success message
                alert('Shares submitted for approval');
                
                // Reload shares data
                loadSharesData();
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('List shares error:', error);
            }
        }
        
        // Handle profile update
        async function handleProfileUpdate(e) {
            e.preventDefault();
            showLoading('Updating profile...');
            
            try {
                const name = document.getElementById('profileName').value.trim();
                const email = document.getElementById('profileEmail').value.trim();
                const phone = document.getElementById('profilePhone').value.trim();
                const location = document.getElementById('profileLocation').value.trim();
                const nextOfKin = document.getElementById('profileNextOfKin').value.trim();
                const nextOfKinPhone = document.getElementById('profileNextOfKinPhone').value.trim();
                const username = document.getElementById('profileUsername').value.trim();
                const profilePicture = document.getElementById('profilePicture').files[0];
                
                if (!name || !email || !phone || !location || !nextOfKin || !nextOfKinPhone || !username) {
                    throw new Error('All fields are required');
                }
                
                // Update user object
                const user = state.currentUser;
                user.name = name;
                user.email = email;
                user.phone = phone;
                user.location = location;
                user.nextOfKin = nextOfKin;
                user.nextOfKinPhone = nextOfKinPhone;
                user.username = username;
                
                // Handle profile picture upload
                if (profilePicture) {
                    // In a real app, you would upload this to IPFS or a server
                    // For this demo, we'll just store a placeholder
                    user.profilePicture = 'https://via.placeholder.com/150';
                }
                
                await updateDBData('users', user);
                
                // Update current user
                state.currentUser = user;
                
                // Update UI
                document.getElementById('sidebarUserName').textContent = user.name;
                document.getElementById('sidebarUserRole').textContent = 
                    state.isSuperAdmin ? 'Super Admin' : (state.isAdmin ? 'Admin' : 'Member');
                
                // Show success message
                alert('Profile updated successfully');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Profile update error:', error);
            }
        }
        
        // Handle change password
        async function handleChangePassword(e) {
            e.preventDefault();
            showLoading('Changing password...');
            
            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                
                if (newPassword !== confirmNewPassword) {
                    throw new Error('New passwords do not match');
                }
                
                // Verify current password
                const passwordMatch = await verifyPassword(currentPassword, state.currentUser.passwordHash);
                if (!passwordMatch) {
                    throw new Error('Current password is incorrect');
                }
                
                // Hash new password
                const newPasswordHash = await hashPassword(newPassword);
                
                // Update user
                const user = state.currentUser;
                user.passwordHash = newPasswordHash;
                await updateDBData('users', user);
                
                // Show success message
                alert('Password changed successfully');
                
                // Clear form
                document.getElementById('changePasswordForm').reset();
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Change password error:', error);
            }
        }
        
        // Handle group settings update
        async function handleGroupSettingsUpdate(e) {
            e.preventDefault();
            showLoading('Updating group settings...');
            
            try {
                const name = document.getElementById('groupName').value.trim();
                const currency = document.getElementById('groupCurrency').value;
                const savingFrequency = document.getElementById('savingFrequency').value;
                const savingDay = document.getElementById('savingDay').value;
                const savingDate = document.getElementById('savingDateInput').value;
                const savingAmountType = document.getElementById('savingAmountType').value;
                const fixedAmount = parseFloat(document.getElementById('fixedAmount').value) || 0;
                const savingCompulsory = document.getElementById('savingCompulsory').value;
                const loanEnabled = document.getElementById('loanEnabled').value;
                const defaultInterestRate = parseFloat(document.getElementById('defaultInterestRate').value) || 0;
                const penaltyInterestRate = parseFloat(document.getElementById('penaltyInterestRate').value) || 0;
                const cycleDuration = document.getElementById('cycleDuration').value;
                
                if (!name) {
                    throw new Error('Group name is required');
                }
                
                // Update group
                const group = state.currentGroup;
                group.name = name;
                group.currency = currency;
                
                // Update settings
                group.settings = {
                    savingFrequency,
                    savingDay,
                    savingDate,
                    savingAmountType,
                    fixedAmount,
                    savingCompulsory,
                    loanEnabled,
                    defaultInterestRate,
                    penaltyInterestRate,
                    cycleDuration,
                    withdrawalsEnabled: group.settings.withdrawalsEnabled || false
                };
                
                await updateDBData('groups', group);
                
                // Update current group
                state.currentGroup = group;
                
                // Update UI
                document.getElementById('groupTitleOverview').textContent = group.name;
                
                // Show success message
                alert('Group settings updated successfully');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Group settings update error:', error);
            }
        }
        
        // Handle system settings update
        async function handleSystemSettingsUpdate(e) {
            e.preventDefault();
            showLoading('Updating system settings...');
            
            try {
                const maxGroupsPerUser = parseInt(document.getElementById('maxGroupsPerUser').value) || 2;
                const subscriptionAmount = parseFloat(document.getElementById('subscriptionAmount').value) || 0;
                const mobileMoneyNumber = document.getElementById('mobileMoneyNumber').value.trim();
                const broadcastDuration = parseInt(document.getElementById('broadcastDuration').value) || 10;
                const successor1 = document.getElementById('successor1').value.trim();
                const successor2 = document.getElementById('successor2').value.trim();
                
                // Update settings
                const settings = {
                    maxGroupsPerUser,
                    subscriptionAmount,
                    mobileMoneyNumber,
                    broadcastDuration,
                    successor1,
                    successor2
                };
                
                await addDBData('settings', { key: 'system', value: settings });
                
                // Show success message
                alert('System settings updated successfully');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('System settings update error:', error);
            }
        }
        
        // Handle broadcast
        async function handleBroadcast(e) {
            e.preventDefault();
            showLoading('Sending broadcast...');
            
            try {
                const recipient = document.getElementById('broadcastRecipient').value;
                const message = document.getElementById('broadcastMessageInput').value.trim();
                const attachment = document.getElementById('broadcastAttachment').files[0];
                const specificGroup = document.getElementById('specificGroup').value;
                
                if (!message) {
                    throw new Error('Message is required');
                }
                
                // Create broadcast
                const broadcast = {
                    id: generateId(),
                    senderId: state.currentUser.id,
                    recipientType: recipient,
                    specificGroup: recipient === 'specific_group' ? specificGroup : null,
                    message,
                    attachment: attachment ? attachment.name : null,
                    createdAt: new Date().toISOString()
                };
                
                // In a real app, you would send this to all relevant users
                // For this demo, we'll just show it in the broadcast container
                showBroadcast(message);
                
                // Add to blockchain
                await addBlock({
                    type: 'broadcast',
                    data: broadcast
                });
                
                // Show success message
                alert('Broadcast sent successfully');
                
                // Clear form
                document.getElementById('broadcastForm').reset();
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Broadcast error:', error);
            }
        }
        
        // Handle add member saving
        async function handleAddMemberSaving(e) {
            e.preventDefault();
            showLoading('Adding member saving...');
            
            try {
                const memberId = document.getElementById('memberSelect').value;
                const amount = parseFloat(document.getElementById('memberSavingAmount').value);
                const date = document.getElementById('memberSavingDate').value;
                const note = document.getElementById('memberSavingNote').value.trim();
                
                if (!memberId) {
                    throw new Error('Member is required');
                }
                
                if (!amount || amount <= 0) {
                    throw new Error('Invalid amount');
                }
                
                if (!date) {
                    throw new Error('Date is required');
                }
                
                // Create saving record
                const saving = {
                    id: generateId(),
                    userId: memberId,
                    groupId: state.currentGroup.id,
                    amount,
                    date,
                    note,
                    status: 'approved',
                    approvedBy: state.currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('savings', saving);
                
                // Update member's balance
                const membership = await getMembership(memberId, state.currentGroup.id);
                membership.balance += amount;
                await updateDBData('memberships', membership);
                
                // Create transaction
                const transaction = {
                    id: generateId(),
                    userId: memberId,
                    groupId: state.currentGroup.id,
                    type: 'saving',
                    amount,
                    status: 'completed',
                    details: 'Saving added by admin',
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('transactions', transaction);
                
                // Add to blockchain
                await addBlock({
                    type: 'saving',
                    data: saving
                });
                
                // Show success message
                alert('Saving added successfully');
                
                // Reload savings data
                loadSavingsData();
                
                // Close modal
                hideModal('addMemberSavingModal');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Add member saving error:', error);
            }
        }
        
        // Handle transfer admin
        async function handleTransferAdmin(e) {
            e.preventDefault();
            showLoading('Transferring admin role...');
            
            try {
                const newAdminId = document.getElementById('newAdminSelect').value;
                const confirmText = document.getElementById('confirmTransfer').value.trim();
                
                if (!newAdminId) {
                    throw new Error('New admin is required');
                }
                
                if (confirmText !== 'CONFIRM') {
                    throw new Error('Please type "CONFIRM" to proceed');
                }
                
                // Get current membership
                const currentMembership = await getMembership(state.currentUser.id, state.currentGroup.id);
                
                // Get new admin membership
                const newAdminMembership = await getMembership(newAdminId, state.currentGroup.id);
                
                // Transfer admin role
                currentMembership.isAdmin = false;
                newAdminMembership.isAdmin = true;
                
                await updateDBData('memberships', currentMembership);
                await updateDBData('memberships', newAdminMembership);
                
                // Update state
                state.isAdmin = false;
                
                // Update UI
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                document.getElementById('sidebarUserRole').textContent = 'Member';
                
                // Add to blockchain
                await addBlock({
                    type: 'admin_transfer',
                    data: {
                        from: state.currentUser.id,
                        to: newAdminId,
                        groupId: state.currentGroup.id,
                        timestamp: new Date().toISOString()
                    }
                });
                
                // Show success message
                alert('Admin role transferred successfully');
                
                // Close modal
                hideModal('transferAdminModal');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Transfer admin error:', error);
            }
        }
        
        // Handle enable withdrawals
        async function handleEnableWithdrawals() {
            showLoading('Enabling withdrawals...');
            
            try {
                // Update group settings
                const group = state.currentGroup;
                group.settings.withdrawalsEnabled = true;
                await updateDBData('groups', group);
                
                // Update current group
                state.currentGroup = group;
                
                // Show success message
                alert('Withdrawals enabled successfully');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Enable withdrawals error:', error);
            }
        }
        
        // Handle disable withdrawals
        async function handleDisableWithdrawals() {
            showLoading('Disabling withdrawals...');
            
            try {
                // Update group settings
                const group = state.currentGroup;
                group.settings.withdrawalsEnabled = false;
                await updateDBData('groups', group);
                
                // Update current group
                state.currentGroup = group;
                
                // Show success message
                alert('Withdrawals disabled successfully');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Disable withdrawals error:', error);
            }
        }
        
        // Handle print all savings
        async function handlePrintAllSavings() {
            showLoading('Preparing savings report...');
            
            try {
                // Get all savings for the group
                const savings = await getDBData('savings', 'groupId', state.currentGroup.id);
                const memberships = await getDBData('memberships', 'groupId', state.currentGroup.id);
                
                // Group savings by member
                const savingsByMember = {};
                memberships.forEach(membership => {
                    savingsByMember[membership.userId] = {
                        user: null,
                        total: 0,
                        savings: []
                    };
                });
                
                // Get user details and calculate totals
                for (const saving of savings) {
                    if (!savingsByMember[saving.userId].user) {
                        savingsByMember[saving.userId].user = await getDBData('users', 'id', saving.userId);
                    }
                    
                    if (saving.status === 'approved') {
                        savingsByMember[saving.userId].total += saving.amount;
                    }
                    
                    savingsByMember[saving.userId].savings.push(saving);
                }
                
                // Generate printable content
                let printContent = `
                    <h1>${state.currentGroup.name} - Savings Report</h1>
                    <p>Generated on ${new Date().toLocaleDateString()} by ${state.currentUser.name}</p>
                    <hr>
                    <h2>Summary</h2>
                    <p>Total Members: ${memberships.length}</p>
                    <p>Total Savings: ${state.currentGroup.currency} ${Object.values(savingsByMember).reduce((sum, member) => sum + member.total, 0).toFixed(2)}</p>
                    <hr>
                    <h2>Member Details</h2>
                `;
                
                for (const memberId in savingsByMember) {
                    const memberData = savingsByMember[memberId];
                    
                    printContent += `
                        <h3>${memberData.user.name}</h3>
                        <p>Total Saved: ${state.currentGroup.currency} ${memberData.total.toFixed(2)}</p>
                        <table border="1" cellpadding="5" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    for (const saving of memberData.savings) {
                        printContent += `
                            <tr>
                                <td>${new Date(saving.date).toLocaleDateString()}</td>
                                <td>${state.currentGroup.currency} ${saving.amount.toFixed(2)}</td>
                                <td>${saving.status}</td>
                                <td>${saving.note || '-'}</td>
                            </tr>
                        `;
                    }
                    
                    printContent += `
                            </tbody>
                        </table>
                        <hr>
                    `;
                }
                
                // Open print window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>${state.currentGroup.name} - Savings Report</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                th { background-color: #f2f2f2; }
                                hr { margin: 20px 0; border: 0; border-top: 1px solid #eee; }
                            </style>
                        </head>
                        <body>
                            ${printContent}
                            <script>
                                window.onload = function() {
                                    window.print();
                                };
                            </script>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Print all savings error:', error);
            }
        }
        
        // Handle gift
        async function handleGift(e) {
            e.preventDefault();
            showLoading('Processing gift...');
            
            try {
                const recipientId = document.getElementById('giftRecipient').value;
                const amount = parseFloat(document.getElementById('giftAmount').value);
                const note = document.getElementById('giftNote').value.trim();
                
                if (!recipientId) {
                    throw new Error('Recipient is required');
                }
                
                if (!amount || amount <= 0) {
                    throw new Error('Invalid amount');
                }
                
                // Check if recipient is in the same group
                const recipientMembership = await getMembership(recipientId, state.currentGroup.id);
                if (!recipientMembership) {
                    throw new Error('Recipient is not a member of this group');
                }
                
                // Check if sender has sufficient balance
                const senderMembership = await getMembership(state.currentUser.id, state.currentGroup.id);
                if (amount > senderMembership.balance) {
                    throw new Error('Insufficient balance');
                }
                
                // Transfer amount
                senderMembership.balance -= amount;
                recipientMembership.balance += amount;
                
                await updateDBData('memberships', senderMembership);
                await updateDBData('memberships', recipientMembership);
                
                // Create transaction for sender
                const senderTransaction = {
                    id: generateId(),
                    userId: state.currentUser.id,
                    groupId: state.currentGroup.id,
                    type: 'gift_sent',
                    amount,
                    status: 'completed',
                    details: `Gift to ${recipientId}: ${note}`,
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('transactions', senderTransaction);
                
                // Create transaction for recipient
                const recipientTransaction = {
                    id: generateId(),
                    userId: recipientId,
                    groupId: state.currentGroup.id,
                    type: 'gift_received',
                    amount,
                    status: 'completed',
                    details: `Gift from ${state.currentUser.id}: ${note}`,
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('transactions', recipientTransaction);
                
                // Add to timeline
                const timelinePost = {
                    id: generateId(),
                    groupId: state.currentGroup.id,
                    userId: state.currentUser.id,
                    type: 'gift',
                    content: `Gifted ${state.currentGroup.currency} ${amount.toFixed(2)} to a member`,
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('timeline', timelinePost);
                
                // Add to blockchain
                await addBlock({
                    type: 'gift',
                    data: {
                        from: state.currentUser.id,
                        to: recipientId,
                        amount,
                        note,
                        timestamp: new Date().toISOString()
                    }
                });
                
                // Show success message
                alert('Gift sent successfully');
                
                // Reload dashboard data
                loadDashboardData();
                
                // Close modal
                hideModal('giftModal');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Gift error:', error);
            }
        }
        
        // Handle withdraw
        async function handleWithdraw(e) {
            e.preventDefault();
            showLoading('Processing withdrawal...');
            
            try {
                const amount = parseFloat(document.getElementById('withdrawAmount').value);
                const method = document.getElementById('withdrawMethod').value;
                const mobileMoneyNumber = document.getElementById('mobileMoneyNumberWithdraw').value.trim();
                const bankAccountNumber = document.getElementById('bankAccountNumber').value.trim();
                const bankName = document.getElementById('bankName').value.trim();
                
                if (!amount || amount <= 0) {
                    throw new Error('Invalid amount');
                }
                
                // Check if withdrawals are enabled
                if (!state.currentGroup.settings.withdrawalsEnabled) {
                    throw new Error('Withdrawals are currently disabled');
                }
                
                // Check if user has sufficient balance
                const membership = await getMembership(state.currentUser.id, state.currentGroup.id);
                if (amount > membership.balance) {
                    throw new Error('Insufficient balance');
                }
                
                // Create withdrawal record
                const withdrawal = {
                    id: generateId(),
                    userId: state.currentUser.id,
                    groupId: state.currentGroup.id,
                    amount,
                    method,
                    mobileMoneyNumber: method === 'mobile_money' ? mobileMoneyNumber : null,
                    bankAccountNumber: method === 'bank' ? bankAccountNumber : null,
                    bankName: method === 'bank' ? bankName : null,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('withdrawals', withdrawal);
                
                // Create transaction
                const transaction = {
                    id: generateId(),
                    userId: state.currentUser.id,
                    groupId: state.currentGroup.id,
                    type: 'withdrawal',
                    amount,
                    status: 'pending',
                    details: 'Withdrawal request',
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('transactions', transaction);
                
                // Add to blockchain
                await addBlock({
                    type: 'withdrawal',
                    data: withdrawal
                });
                
                // Show success message
                alert('Withdrawal request submitted for approval');
                
                // Reload dashboard data
                loadDashboardData();
                
                // Close modal
                hideModal('withdrawModal');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Withdraw error:', error);
            }
        }
        
        // Handle share purchase
        async function handleSharePurchase(e) {
            e.preventDefault();
            showLoading('Processing share purchase...');
            
            try {
                const amount = parseFloat(document.getElementById('sharePurchaseAmount').value);
                const method = document.getElementById('sharePurchasePaymentMethod').value;
                
                if (!amount || amount <= 0) {
                    throw new Error('Invalid amount');
                }
                
                // Get the share being purchased
                const shareId = document.getElementById('sharePurchaseModal').dataset.shareId;
                const share = await getDBData('shares', 'id', shareId);
                
                if (!share || share.status !== 'approved') {
                    throw new Error('Share not available for purchase');
                }
                
                // Calculate total cost
                const totalCost = amount * share.price;
                
                // Check if buyer has sufficient funds
                const buyerMembership = await getMembership(state.currentUser.id, state.currentGroup.id);
                if (totalCost > buyerMembership.balance) {
                    throw new Error('Insufficient balance');
                }
                
                // Check if seller has sufficient shares
                const sellerMembership = await getMembership(share.userId, state.currentGroup.id);
                if (amount > sellerMembership.shares) {
                    throw new Error('Seller doesn\'t have enough shares');
                }
                
                // Transfer funds and shares
                buyerMembership.balance -= totalCost;
                buyerMembership.shares += amount;
                
                sellerMembership.balance += totalCost;
                sellerMembership.shares -= amount;
                
                await updateDBData('memberships', buyerMembership);
                await updateDBData('memberships', sellerMembership);
                
                // Update share amount or delete if fully purchased
                if (amount === share.amount) {
                    await deleteDBData('shares', share.id);
                } else {
                    share.amount -= amount;
                    await updateDBData('shares', share);
                }
                
                // Create transaction for buyer
                const buyerTransaction = {
                    id: generateId(),
                    userId: state.currentUser.id,
                    groupId: state.currentGroup.id,
                    type: 'share_purchase',
                    amount: totalCost,
                    status: 'completed',
                    details: `Purchased ${amount} shares from ${share.userId}`,
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('transactions', buyerTransaction);
                
                // Create transaction for seller
                const sellerTransaction = {
                    id: generateId(),
                    userId: share.userId,
                    groupId: state.currentGroup.id,
                    type: 'share_sale',
                    amount: totalCost,
                    status: 'completed',
                    details: `Sold ${amount} shares to ${state.currentUser.id}`,
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('transactions', sellerTransaction);
                
                // Add to timeline
                const timelinePost = {
                    id: generateId(),
                    groupId: state.currentGroup.id,
                    userId: state.currentUser.id,
                    type: 'share_purchase',
                    content: `Purchased ${amount} shares`,
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('timeline', timelinePost);
                
                // Add to blockchain
                await addBlock({
                    type: 'share_purchase',
                    data: {
                        buyer: state.currentUser.id,
                        seller: share.userId,
                        amount,
                        price: share.price,
                        total: totalCost,
                        timestamp: new Date().toISOString()
                    }
                });
                
                // Show success message
                alert('Shares purchased successfully');
                
                // Reload shares data
                loadSharesData();
                
                // Close modal
                hideModal('sharePurchaseModal');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Share purchase error:', error);
            }
        }
        
        // Handle loan payment
        async function handleLoanPayment(e) {
            e.preventDefault();
            showLoading('Processing loan payment...');
            
            try {
                const amount = parseFloat(document.getElementById('loanPaymentAmount').value);
                const method = document.getElementById('loanPaymentMethod').value;
                
                if (!amount || amount <= 0) {
                    throw new Error('Invalid amount');
                }
                
                // Get the loan being paid
                const loanId = document.getElementById('loanPaymentModal').dataset.loanId;
                const loan = await getDBData('loans', 'id', loanId);
                
                if (!loan || loan.status !== 'active') {
                    throw new Error('Loan not available for payment');
                }
                
                // Check if payment is sufficient
                if (amount > loan.totalAmount) {
                    throw new Error('Payment amount exceeds loan total');
                }
                
                // Check if user has sufficient funds
                const membership = await getMembership(state.currentUser.id, state.currentGroup.id);
                if (amount > membership.balance) {
                    throw new Error('Insufficient balance');
                }
                
                // Update loan
                loan.totalAmount -= amount;
                
                if (loan.totalAmount <= 0) {
                    loan.status = 'paid';
                }
                
                await updateDBData('loans', loan);
                
                // Deduct from user's balance
                membership.balance -= amount;
                await updateDBData('memberships', membership);
                
                // Create transaction
                const transaction = {
                    id: generateId(),
                    userId: state.currentUser.id,
                    groupId: state.currentGroup.id,
                    type: 'loan_payment',
                    amount,
                    status: 'completed',
                    details: 'Loan payment',
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('transactions', transaction);
                
                // Add to timeline
                const timelinePost = {
                    id: generateId(),
                    groupId: state.currentGroup.id,
                    userId: state.currentUser.id,
                    type: 'loan_payment',
                    content: `Paid ${state.currentGroup.currency} ${amount.toFixed(2)} towards loan`,
                    createdAt: new Date().toISOString()
                };
                
                await addDBData('timeline', timelinePost);
                
                // Add to blockchain
                await addBlock({
                    type: 'loan_payment',
                    data: {
                        loanId,
                        amount,
                        remaining: loan.totalAmount,
                        timestamp: new Date().toISOString()
                    }
                });
                
                // Show success message
                alert('Loan payment processed successfully');
                
                // Reload loans data
                loadLoansData();
                
                // Close modal
                hideModal('loanPaymentModal');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                alert(error.message);
                console.error('Loan payment error:', error);
            }
        }
        
        // Show modal
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        // Hide modal
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Show loading
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text || 'Loading...';
            document.getElementById('loadingModal').style.display = 'flex';
        }
        
        // Hide loading
        function hideLoading() {
            document.getElementById('loadingModal').style.display = 'none';
        }
        
        // Show dashboard
        function showDashboard() {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('signupBtn').style.display = 'none';
            document.getElementById('loginBtn').style.display = 'none';
            
            // Update user info in sidebar
            if (state.currentUser) {
                document.getElementById('sidebarUserName').textContent = state.currentUser.name;
                document.getElementById('sidebarUserRole').textContent = 
                    state.isSuperAdmin ? 'Super Admin' : (state.isAdmin ? 'Admin' : 'Member');
                
                // Show/hide admin sections
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.classList.toggle('hidden', !state.isAdmin && !state.isSuperAdmin);
                });
                
                document.querySelectorAll('.superadmin-only').forEach(el => {
                    el.classList.toggle('hidden', !state.isSuperAdmin);
                });
            }
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            if (!state.currentUser || !state.currentGroup) return;
            
            showLoading('Loading dashboard...');
            
            try {
                // Load group info
                document.getElementById('groupTitleOverview').textContent = state.currentGroup.name;
                document.title = `${state.currentGroup.name} - Kiira Save`;
                
                // Load user's savings info
                const membership = await getMembership(state.currentUser.id, state.currentGroup.id);
                if (membership) {
                    document.getElementById('amountSaved').textContent = 
                        `${state.currentGroup.currency} ${membership.balance.toFixed(2)}`;
                    
                    // Calculate percentage of group savings
                    const allMemberships = await getDBData('memberships', 'groupId', state.currentGroup.id);
                    const totalGroupSavings = allMemberships.reduce((sum, m) => sum + m.balance, 0);
                    const percentage = totalGroupSavings > 0 ? 
                        (membership.balance / totalGroupSavings * 100).toFixed(2) : 0;
                    
                    document.getElementById('percentageOfGroup').textContent = `${percentage}%`;
                    document.getElementById('savingsProgressBar').textContent = `${percentage}%`;
                    document.getElementById('savingsProgressBar').style.width = `${percentage}%`;
                    
                    document.getElementById('totalGroupSavings').textContent = 
                        `${state.currentGroup.currency} ${totalGroupSavings.toFixed(2)}`;
                }
                
                // Load group stats
                const members = await getDBData('memberships', 'groupId', state.currentGroup.id);
                document.getElementById('totalMembers').textContent = members.length;
                
                const loans = await getDBData('loans', 'groupId', state.currentGroup.id);
                const activeLoans = loans.filter(l => l.status === 'active').length;
                document.getElementById('activeLoans').textContent = activeLoans;
                
                const shares = await getDBData('shares', 'groupId', state.currentGroup.id);
                const activeShares = shares.filter(s => s.status === 'approved').length;
                document.getElementById('sharesOnMarket').textContent = activeShares;
                
                // Load last saved date
                const savings = await getDBData('savings', 'groupId', state.currentGroup.id);
                const userSavings = savings.filter(s => s.userId === state.currentUser.id && s.status === 'approved');
                if (userSavings.length > 0) {
                    const lastSaved = userSavings.reduce((latest, saving) => {
                        return new Date(saving.date) > new Date(latest.date) ? saving : latest;
                    }, userSavings[0]);
                    
                    document.getElementById('lastSavedDate').textContent = 
                        new Date(lastSaved.date).toLocaleDateString();
                } else {
                    document.getElementById('lastSavedDate').textContent = 'Never';
                }
                
                // Load next saving date
                const nextSavingDate = calculateNextSavingDate();
                document.getElementById('nextSavingDate').textContent = nextSavingDate.toLocaleDateString();
                
                // Load current cycle
                document.getElementById('currentCycle').textContent = 
                    getCycleDescription(state.currentGroup.settings.cycleDuration);
                
                // Load section-specific data
                switchSection('overview');
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Dashboard load error:', error);
            }
        }
        
        // Switch section
        async function switchSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Deactivate all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Activate current nav link
            document.querySelector(`.nav-link[data-section="${sectionId}"]`).classList.add('active');
            
            // Show current section
            document.getElementById(`${sectionId}Section`).classList.remove('hidden');
            
            // Load section data
            switch (sectionId) {
                case 'savings':
                    await loadSavingsData();
                    break;
                case 'loans':
                    await loadLoansData();
                    break;
                case 'shares':
                    await loadSharesData();
                    break;
                case 'members':
                    await loadMembersData();
                    break;
                case 'transactions':
                    await loadTransactionsData();
                    break;
                case 'timeline':
                    await loadTimelineData();
                    break;
                case 'messages':
                    await loadMessagesData();
                    break;
                case 'admin':
                    await loadAdminData();
                    break;
                case 'superadmin':
                    await loadSuperAdminData();
                    break;
                case 'profile':
                    await loadProfileData();
                    break;
            }
        }
        
        // Load savings data
        async function loadSavingsData() {
            showLoading('Loading savings...');
            
            try {
                // Load user's savings
                const savings = await getDBData('savings', 'groupId', state.currentGroup.id);
                const userSavings = savings.filter(s => s.userId === state.currentUser.id);
                
                // Populate savings history table
                const savingsTable = document.getElementById('savingsHistoryTable');
                savingsTable.innerHTML = '';
                
                userSavings.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                for (const saving of userSavings) {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${new Date(saving.date).toLocaleDateString()}</td>
                        <td>${state.currentGroup.currency} ${saving.amount.toFixed(2)}</td>
                        <td><span class="badge ${getStatusBadgeClass(saving.status)}">${saving.status}</span></td>
                        <td>${saving.note || '-'}</td>
                        <td>
                            ${saving.status === 'pending' ? `
                                <button class="btn btn-sm btn-danger" data-saving-id="${saving.id}">Cancel</button>
                            ` : ''}
                        </td>
                    `;
                    
                    savingsTable.appendChild(row);
                }
                
                // Add event listeners to cancel buttons
                document.querySelectorAll('[data-saving-id]').forEach(button => {
                    button.addEventListener('click', async function() {
                        const savingId = this.dataset.savingId;
                        if (confirm('Are you sure you want to cancel this saving?')) {
                            await deleteDBData('savings', savingId);
                            loadSavingsData();
                        }
                    });
                });
                
                // If admin, load pending savings approvals
                if (state.isAdmin) {
                    const pendingSavings = savings.filter(s => s.status === 'pending');
                    const pendingTable = document.getElementById('pendingSavingsTable');
                    
                    if (pendingTable) {
                        pendingTable.innerHTML = '';
                        
                        for (const saving of pendingSavings) {
                            const user = await getDBData('users', 'id', saving.userId);
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${user.name}</td>
                                <td>${state.currentGroup.currency} ${saving.amount.toFixed(2)}</td>
                                <td>${new Date(saving.date).toLocaleDateString()}</td>
                                <td>${saving.note || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-success" data-saving-id="${saving.id}" data-action="approve">Approve</button>
                                    <button class="btn btn-sm btn-danger" data-saving-id="${saving.id}" data-action="reject">Reject</button>
                                </td>
                            `;
                            
                            pendingTable.appendChild(row);
                        }
                        
                        // Add event listeners to approve/reject buttons
                        document.querySelectorAll('[data-saving-id]').forEach(button => {
                            button.addEventListener('click', async function() {
                                const savingId = this.dataset.savingId;
                                const action = this.dataset.action;
                                
                                if (action === 'approve') {
                                    await approveSaving(savingId);
                                } else {
                                    await rejectSaving(savingId);
                                }
                                
                                loadSavingsData();
                            });
                        });
                    }
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Load savings error:', error);
            }
        }
        
        // Load loans data
        async function loadLoansData() {
            showLoading('Loading loans...');
            
            try {
                // Load user's loans
                const loans = await getDBData('loans', 'groupId', state.currentGroup.id);
                const userLoans = loans.filter(l => l.userId === state.currentUser.id);
                
                // Populate loans history table
                const loansTable = document.getElementById('loansHistoryTable');
                loansTable.innerHTML = '';
                
                userLoans.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                for (const loan of userLoans) {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${new Date(loan.createdAt).toLocaleDateString()}</td>
                        <td>${state.currentGroup.currency} ${loan.amount.toFixed(2)}</td>
                        <td><span class="badge ${getStatusBadgeClass(loan.status)}">${loan.status}</span></td>
                        <td>${new Date(loan.dueDate).toLocaleDateString()}</td>
                        <td>${state.currentGroup.currency} ${loan.totalAmount.toFixed(2)}</td>
                        <td>
                            ${loan.status === 'active' ? `
                                <button class="btn btn-sm btn-primary" data-loan-id="${loan.id}">Pay</button>
                            ` : ''}
                        </td>
                    `;
                    
                    loansTable.appendChild(row);
                }
                
                // Add event listeners to pay buttons
                document.querySelectorAll('[data-loan-id]').forEach(button => {
                    button.addEventListener('click', function() {
                        const loanId = this.dataset.loanId;
                        showLoanPaymentModal(loanId);
                    });
                });
                
                // If admin, load pending loan approvals
                if (state.isAdmin) {
                    const pendingLoans = loans.filter(l => l.status === 'pending');
                    const pendingTable = document.getElementById('pendingLoansTable');
                    
                    if (pendingTable) {
                        pendingTable.innerHTML = '';
                        
                        for (const loan of pendingLoans) {
                            const user = await getDBData('users', 'id', loan.userId);
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${user.name}</td>
                                <td>${state.currentGroup.currency} ${loan.amount.toFixed(2)}</td>
                                <td>${loan.purpose}</td>
                                <td>${loan.repaymentPeriod}</td>
                                <td>
                                    <button class="btn btn-sm btn-success" data-loan-id="${loan.id}" data-action="approve">Approve</button>
                                    <button class="btn btn-sm btn-danger" data-loan-id="${loan.id}" data-action="reject">Reject</button>
                                </td>
                            `;
                            
                            pendingTable.appendChild(row);
                        }
                        
                        // Add event listeners to approve/reject buttons
                        document.querySelectorAll('[data-loan-id]').forEach(button => {
                            button.addEventListener('click', async function() {
                                const loanId = this.dataset.loanId;
                                const action = this.dataset.action;
                                
                                if (action === 'approve') {
                                    await approveLoan(loanId);
                                } else {
                                    await rejectLoan(loanId);
                                }
                                
                                loadLoansData();
                            });
                        });
                    }
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Load loans error:', error);
            }
        }
        
        // Load shares data
        async function loadSharesData() {
            showLoading('Loading shares...');
            
            try {
                // Load shares market
                const shares = await getDBData('shares', 'groupId', state.currentGroup.id);
                const marketShares = shares.filter(s => s.status === 'approved' && s.userId !== state.currentUser.id);
                
                // Populate shares market table
                const marketTable = document.getElementById('sharesMarketTable');
                marketTable.innerHTML = '';
                
                for (const share of marketShares) {
                    const user = await getDBData('users', 'id', share.userId);
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${share.amount}</td>
                        <td>${state.currentGroup.currency} ${share.price.toFixed(2)}</td>
                        <td><span class="badge ${getStatusBadgeClass(share.status)}">${share.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" data-share-id="${share.id}">Buy</button>
                        </td>
                    `;
                    
                    marketTable.appendChild(row);
                }
                
                // Add event listeners to buy buttons
                document.querySelectorAll('[data-share-id]').forEach(button => {
                    button.addEventListener('click', function() {
                        const shareId = this.dataset.shareId;
                        showSharePurchaseModal(shareId);
                    });
                });
                
                // Load user's shares
                const userShares = shares.filter(s => s.userId === state.currentUser.id);
                const yourSharesTable = document.getElementById('yourSharesTable');
                yourSharesTable.innerHTML = '';
                
                for (const share of userShares) {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${new Date(share.createdAt).toLocaleDateString()}</td>
                        <td>${share.amount}</td>
                        <td>${state.currentGroup.currency} ${share.price.toFixed(2)}</td>
                        <td><span class="badge ${getStatusBadgeClass(share.status)}">${share.status}</span></td>
                        <td>
                            ${share.status === 'pending' ? `
                                <button class="btn btn-sm btn-danger" data-share-id="${share.id}">Cancel</button>
                            ` : ''}
                        </td>
                    `;
                    
                    yourSharesTable.appendChild(row);
                }
                
                // Add event listeners to cancel buttons
                document.querySelectorAll('[data-share-id]').forEach(button => {
                    button.addEventListener('click', async function() {
                        const shareId = this.dataset.shareId;
                        if (confirm('Are you sure you want to cancel this share listing?')) {
                            await deleteDBData('shares', shareId);
                            loadSharesData();
                        }
                    });
                });
                
                // If admin, load pending share approvals
                if (state.isAdmin) {
                    const pendingShares = shares.filter(s => s.status === 'pending');
                    const pendingTable = document.getElementById('pendingSharesTable');
                    
                    if (pendingTable) {
                        pendingTable.innerHTML = '';
                        
                        for (const share of pendingShares) {
                            const user = await getDBData('users', 'id', share.userId);
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${user.name}</td>
                                <td>${share.amount}</td>
                                <td>${state.currentGroup.currency} ${share.price.toFixed(2)}</td>
                                <td>
                                    <button class="btn btn-sm btn-success" data-share-id="${share.id}" data-action="approve">Approve</button>
                                    <button class="btn btn-sm btn-danger" data-share-id="${share.id}" data-action="reject">Reject</button>
                                </td>
                            `;
                            
                            pendingTable.appendChild(row);
                        }
                        
                        // Add event listeners to approve/reject buttons
                        document.querySelectorAll('[data-share-id]').forEach(button => {
                            button.addEventListener('click', async function() {
                                const shareId = this.dataset.shareId;
                                const action = this.dataset.action;
                                
                                if (action === 'approve') {
                                    await approveShare(shareId);
                                } else {
                                    await rejectShare(shareId);
                                }
                                
                                loadSharesData();
                            });
                        });
                    }
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Load shares error:', error);
            }
        }
        
        // Load members data
        async function loadMembersData() {
            showLoading('Loading members...');
            
            try {
                // Load group members
                const memberships = await getDBData('memberships', 'groupId', state.currentGroup.id);
                const approvedMemberships = memberships.filter(m => m.isApproved);
                
                // Populate members table
                const membersTable = document.getElementById('groupMembersTable');
                membersTable.innerHTML = '';
                
                for (const membership of approvedMemberships) {
                    const user = await getDBData('users', 'id', membership.userId);
                    const savings = await getDBData('savings', 'groupId', state.currentGroup.id);
                    const userSavings = savings.filter(s => s.userId === user.id && s.status === 'approved');
                    const totalSaved = userSavings.reduce((sum, s) => sum + s.amount, 0);
                    
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>
                            <div class="user-info">
                                <img src="${user.profilePicture || 'https://via.placeholder.com/40'}" alt="${user.name}" class="avatar">
                                <div>
                                    <div class="user-name">${user.name}</div>
                                    <small>${membership.isAdmin ? 'Admin' : 'Member'}</small>
                                </div>
                            </div>
                        </td>
                        <td>${user.phone}</td>
                        <td>${state.currentGroup.currency} ${totalSaved.toFixed(2)}</td>
                        <td>${new Date(user.lastActive).toLocaleDateString()}</td>
                        <td>
                            ${!membership.isAdmin && state.isAdmin ? `
                                <button class="btn btn-sm btn-primary" data-user-id="${user.id}" data-action="message">Message</button>
                                <button class="btn btn-sm btn-success" data-user-id="${user.id}" data-action="gift">Gift</button>
                            ` : ''}
                            ${membership.isAdmin && state.isSuperAdmin ? `
                                <button class="btn btn-sm btn-danger" data-user-id="${user.id}" data-action="remove">Remove</button>
                            ` : ''}
                        </td>
                    `;
                    
                    membersTable.appendChild(row);
                }
                
                // Add event listeners to action buttons
                document.querySelectorAll('[data-user-id]').forEach(button => {
                    button.addEventListener('click', function() {
                        const userId = this.dataset.userId;
                        const action = this.dataset.action;
                        
                        if (action === 'message') {
                            // Open message conversation
                            openMessageConversation(userId);
                        } else if (action === 'gift') {
                            // Show gift modal
                            showGiftModal(userId);
                        } else if (action === 'remove') {
                            // Remove member
                            if (confirm('Are you sure you want to remove this member?')) {
                                removeMember(userId);
                            }
                        }
                    });
                });
                
                // If admin, load pending members
                if (state.isAdmin) {
                    const pendingMemberships = memberships.filter(m => !m.isApproved);
                    const pendingTable = document.getElementById('pendingMembersTable');
                    
                    if (pendingTable) {
                        pendingTable.innerHTML = '';
                        
                        for (const membership of pendingMemberships) {
                            const user = await getDBData('users', 'id', membership.userId);
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${user.name}</td>
                                <td>${user.phone}</td>
                                <td>${new Date(membership.joinedAt).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-sm btn-success" data-user-id="${user.id}" data-action="approve">Approve</button>
                                    <button class="btn btn-sm btn-danger" data-user-id="${user.id}" data-action="reject">Reject</button>
                                </td>
                            `;
                            
                            pendingTable.appendChild(row);
                        }
                        
                        // Add event listeners to approve/reject buttons
                        document.querySelectorAll('[data-user-id]').forEach(button => {
                            button.addEventListener('click', async function() {
                                const userId = this.dataset.userId;
                                const action = this.dataset.action;
                                
                                if (action === 'approve') {
                                    await approveMember(userId);
                                } else {
                                    await rejectMember(userId);
                                }
                                
                                loadMembersData();
                            });
                        });
                    }
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Load members error:', error);
            }
        }
        
        // Load transactions data
        async function loadTransactionsData() {
            showLoading('Loading transactions...');
            
            try {
                // Load user's transactions
                const transactions = await getDBData('transactions', 'groupId', state.currentGroup.id);
                const userTransactions = transactions.filter(t => t.userId === state.currentUser.id);
                
                // Populate transactions table
                const transactionsTable = document.getElementById('transactionsTable');
                transactionsTable.innerHTML = '';
                
                userTransactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                for (const transaction of userTransactions) {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${new Date(transaction.createdAt).toLocaleDateString()}</td>
                        <td>${transaction.type.replace('_', ' ')}</td>
                        <td>${state.currentGroup.currency} ${transaction.amount.toFixed(2)}</td>
                        <td>${transaction.details}</td>
                        <td><span class="badge ${getStatusBadgeClass(transaction.status)}">${transaction.status}</span></td>
                    `;
                    
                    transactionsTable.appendChild(row);
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Load transactions error:', error);
            }
        }
        
        // Load timeline data
        async function loadTimelineData() {
            showLoading('Loading timeline...');
            
            try {
                // Load timeline posts
                const timeline = await getDBData('timeline', 'groupId', state.currentGroup.id);
                
                // Populate timeline
                const timelineContainer = document.getElementById('timelinePosts');
                timelineContainer.innerHTML = '';
                
                timeline.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                for (const post of timeline) {
                    const user = await getDBData('users', 'id', post.userId);
                    const postElement = document.createElement('div');
                    postElement.className = 'card mb-3';
                    
                    postElement.innerHTML = `
                        <div class="card-body">
                            <div class="user-info mb-2">
                                <img src="${user.profilePicture || 'https://via.placeholder.com/40'}" alt="${user.name}" class="avatar">
                                <div>
                                    <div class="user-name">${user.name}</div>
                                    <small>${new Date(post.createdAt).toLocaleString()}</small>
                                </div>
                            </div>
                            <p>${post.content}</p>
                        </div>
                    `;
                    
                    timelineContainer.appendChild(postElement);
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Load timeline error:', error);
            }
        }
        
        // Load messages data
        async function loadMessagesData() {
            showLoading('Loading messages...');
            
            try {
                // Load user's contacts
                const memberships = await getDBData('memberships', 'groupId', state.currentGroup.id);
                const approvedMemberships = memberships.filter(m => m.isApproved && m.userId !== state.currentUser.id);
                
                // Populate contacts list
                const contactsList = document.getElementById('messageContacts');
                contactsList.innerHTML = '';
                
                for (const membership of approvedMemberships) {
                    const user = await getDBData('users', 'id', membership.userId);
                    const messages = await getDBData('messages', 'groupId', state.currentGroup.id);
                    const userMessages = messages.filter(m => 
                        (m.senderId === user.id && m.receiverId === state.currentUser.id) ||
                        (m.senderId === state.currentUser.id && m.receiverId === user.id)
                    );
                    
                    const lastMessage = userMessages.length > 0 ? 
                        userMessages[userMessages.length - 1] : null;
                    
                    const contactElement = document.createElement('a');
                    contactElement.href = '#';
                    contactElement.className = 'list-group-item list-group-item-action';
                    contactElement.dataset.userId = user.id;
                    
                    contactElement.innerHTML = `
                        <div class="user-info">
                            <img src="${user.profilePicture || 'https://via.placeholder.com/40'}" alt="${user.name}" class="avatar">
                            <div>
                                <div class="user-name">${user.name}</div>
                                <small>${lastMessage ? lastMessage.content.substring(0, 20) + (lastMessage.content.length > 20 ? '...' : '') : 'No messages yet'}</small>
                            </div>
                        </div>
                    `;
                    
                    contactElement.addEventListener('click', function(e) {
                        e.preventDefault();
                        openMessageConversation(user.id);
                    });
                    
                    contactsList.appendChild(contactElement);
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Load messages error:', error);
            }
        }
        
        // Load admin data
        async function loadAdminData() {
            showLoading('Loading admin data...');
            
            try {
                // Load group settings
                document.getElementById('groupName').value = state.currentGroup.name;
                document.getElementById('groupCurrency').value = state.currentGroup.currency;
                document.getElementById('savingFrequency').value = state.currentGroup.settings.savingFrequency;
                document.getElementById('savingDay').value = state.currentGroup.settings.savingDay;
                document.getElementById('savingDateInput').value = state.currentGroup.settings.savingDate;
                document.getElementById('savingAmountType').value = state.currentGroup.settings.savingAmountType;
                document.getElementById('fixedAmount').value = state.currentGroup.settings.fixedAmount;
                document.getElementById('savingCompulsory').value = state.currentGroup.settings.savingCompulsory;
                document.getElementById('loanEnabled').value = state.currentGroup.settings.loanEnabled;
                document.getElementById('defaultInterestRate').value = state.currentGroup.settings.defaultInterestRate;
                document.getElementById('penaltyInterestRate').value = state.currentGroup.settings.penaltyInterestRate;
                document.getElementById('cycleDuration').value = state.currentGroup.settings.cycleDuration;
                
                // Toggle fields based on settings
                document.getElementById('savingDayGroup').style.display = 
                    state.currentGroup.settings.savingFrequency === 'weekly' ? 'block' : 'none';
                document.getElementById('savingDateGroup').style.display = 
                    state.currentGroup.settings.savingFrequency === 'monthly' ? 'block' : 'none';
                document.getElementById('fixedAmountGroup').style.display = 
                    state.currentGroup.settings.savingAmountType === 'fixed' ? 'block' : 'none';
                
                // Load members for admin transfer
                const memberships = await getDBData('memberships', 'groupId', state.currentGroup.id);
                const approvedMembers = memberships.filter(m => m.isApproved && !m.isAdmin);
                
                const memberSelect = document.getElementById('memberSelect');
                const newAdminSelect = document.getElementById('newAdminSelect');
                
                memberSelect.innerHTML = '';
                newAdminSelect.innerHTML = '';
                
                for (const membership of approvedMembers) {
                    const user = await getDBData('users', 'id', membership.userId);
                    
                    const option1 = document.createElement('option');
                    option1.value = user.id;
                    option1.textContent = user.name;
                    memberSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = user.id;
                    option2.textContent = user.name;
                    newAdminSelect.appendChild(option2);
                }
                
                // Load subscription info
                const subscriptionInfo = document.getElementById('subscriptionInfo');
                const subscriptionForm = document.getElementById('subscriptionForm');
                const systemSettings = await getDBData('settings', 'key', 'system');
                
                if (systemSettings && systemSettings.value.subscriptionAmount > 0) {
                    subscriptionInfo.innerHTML = `
                        <p>Subscription Fee: ${state.currentGroup.currency} ${systemSettings.value.subscriptionAmount.toFixed(2)}</p>
                        <p>Payment Method: Mobile Money (${systemSettings.value.mobileMoneyNumber})</p>
                        <button class="btn btn-primary" id="showSubscriptionForm">Pay Subscription</button>
                    `;
                    
                    document.getElementById('showSubscriptionForm').addEventListener('click', function() {
                        subscriptionInfo.classList.add('hidden');
                        subscriptionForm.classList.remove('hidden');
                    });
                } else {
                    subscriptionInfo.innerHTML = '<p>No subscription fee required</p>';
                    subscriptionForm.classList.add('hidden');
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Load admin data error:', error);
            }
        }
        
        // Load super admin data
        async function loadSuperAdminData() {
            showLoading('Loading super admin data...');
            
            try {
                // Load all groups
                const groups = await getAllDBData('groups');
                const allGroupsTable = document.getElementById('allGroupsTable');
                allGroupsTable.innerHTML = '';
                
                for (const group of groups) {
                    const memberships = await getDBData('memberships', 'groupId', group.id);
                    const adminMembership = memberships.find(m => m.isAdmin);
                    const admin = adminMembership ? await getDBData('users', 'id', adminMembership.userId) : null;
                    
                    // Calculate total savings
                    const totalSavings = memberships.reduce((sum, m) => sum + m.balance, 0);
                    
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${group.name}</td>
                        <td>${admin ? admin.name : 'No admin'}</td>
                        <td>${memberships.length}</td>
                        <td>${group.currency} ${totalSavings.toFixed(2)}</td>
                        <td><span class="badge ${group.isActive ? 'badge-success' : 'badge-danger'}">${group.isActive ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" data-group-id="${group.id}">View</button>
                            <button class="btn btn-sm btn-danger" data-group-id="${group.id}">${group.isActive ? 'Deactivate' : 'Activate'}</button>
                        </td>
                    `;
                    
                    allGroupsTable.appendChild(row);
                }
                
                // Add event listeners to group actions
                document.querySelectorAll('[data-group-id]').forEach(button => {
                    button.addEventListener('click', async function() {
                        const groupId = this.dataset.groupId;
                        
                        if (this.textContent === 'View') {
                            // View group details
                            // Implement as needed
                        } else {
                            // Toggle group active status
                            const group = await getDBData('groups', 'id', groupId);
                            group.isActive = !group.isActive;
                            await updateDBData('groups', group);
                            loadSuperAdminData();
                        }
                    });
                });
                
                // Load system settings
                const systemSettings = await getDBData('settings', 'key', 'system');
                if (systemSettings) {
                    document.getElementById('maxGroupsPerUser').value = systemSettings.value.maxGroupsPerUser;
                    document.getElementById('subscriptionAmount').value = systemSettings.value.subscriptionAmount;
                    document.getElementById('mobileMoneyNumber').value = systemSettings.value.mobileMoneyNumber || '';
                    document.getElementById('broadcastDuration').value = systemSettings.value.broadcastDuration;
                    document.getElementById('successor1').value = systemSettings.value.successor1 || '';
                    document.getElementById('successor2').value = systemSettings.value.successor2 || '';
                }
                
                // Load groups for specific broadcast
                const specificGroupSelect = document.getElementById('specificGroup');
                specificGroupSelect.innerHTML = '';
                
                for (const group of groups) {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    specificGroupSelect.appendChild(option);
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Load super admin data error:', error);
            }
        }
        
        // Load profile data
        async function loadProfileData() {
            showLoading('Loading profile...');
            
            try {
                // Load user data
                document.getElementById('profileName').value = state.currentUser.name;
                document.getElementById('profileEmail').value = state.currentUser.email;
                document.getElementById('profilePhone').value = state.currentUser.phone;
                document.getElementById('profileLocation').value = state.currentUser.location;
                document.getElementById('profileNextOfKin').value = state.currentUser.nextOfKin;
                document.getElementById('profileNextOfKinPhone').value = state.currentUser.nextOfKinPhone;
                document.getElementById('profileUsername').value = state.currentUser.username;
                
                // Load user's groups
                const memberships = await getDBData('memberships', 'userId', state.currentUser.id);
                const userGroupsTable = document.getElementById('userGroupsTable');
                userGroupsTable.innerHTML = '';
                
                for (const membership of memberships) {
                    const group = await getDBData('groups', 'id', membership.groupId);
                    
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${group.name}</td>
                        <td>${membership.isAdmin ? 'Admin' : 'Member'}</td>
                        <td><span class="badge ${group.isActive ? 'badge-success' : 'badge-danger'}">${group.isActive ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" data-group-id="${group.id}">Switch</button>
                            ${!membership.isAdmin ? `
                                <button class="btn btn-sm btn-danger" data-group-id="${group.id}">Leave</button>
                            ` : ''}
                        </td>
                    `;
                    
                    userGroupsTable.appendChild(row);
                }
                
                // Add event listeners to group actions
                document.querySelectorAll('[data-group-id]').forEach(button => {
                    button.addEventListener('click', async function() {
                        const groupId = this.dataset.groupId;
                        
                        if (this.textContent === 'Switch') {
                            // Switch to this group
                            const group = await getDBData('groups', 'id', groupId);
                            const membership = await getMembership(state.currentUser.id, groupId);
                            
                            state.currentGroup = group;
                            state.isAdmin = membership.isAdmin;
                            
                            // Update UI
                            document.getElementById('sidebarUserRole').textContent = 
                                state.isSuperAdmin ? 'Super Admin' : (state.isAdmin ? 'Admin' : 'Member');
                            
                            document.querySelectorAll('.admin-only').forEach(el => {
                                el.classList.toggle('hidden', !state.isAdmin && !state.isSuperAdmin);
                            });
                            
                            // Reload dashboard
                            loadDashboardData();
                        } else {
                            // Leave group
                            if (confirm('Are you sure you want to leave this group?')) {
                                await deleteDBData('memberships', (await getMembership(state.currentUser.id, groupId)).id);
                                loadProfileData();
                                
                                // If this was the current group, switch to another
                                if (state.currentGroup.id === groupId) {
                                    const remainingMemberships = await getDBData('memberships', 'userId', state.currentUser.id);
                                    if (remainingMemberships.length > 0) {
                                        const newGroup = await getDBData('groups', 'id', remainingMemberships[0].groupId);
                                        const newMembership = await getMembership(state.currentUser.id, newGroup.id);
                                        
                                        state.currentGroup = newGroup;
                                        state.isAdmin = newMembership.isAdmin;
                                        
                                        // Update UI
                                        document.getElementById('sidebarUserRole').textContent = 
                                            state.isSuperAdmin ? 'Super Admin' : (state.isAdmin ? 'Admin' : 'Member');
                                        
                                        document.querySelectorAll('.admin-only').forEach(el => {
                                            el.classList.toggle('hidden', !state.isAdmin && !state.isSuperAdmin);
                                        });
                                        
                                        // Reload dashboard
                                        loadDashboardData();
                                    } else {
                                        // No groups left
                                        state.currentGroup = null;
                                        state.isAdmin = false;
                                        
                                        // Update UI
                                        document.getElementById('sidebarUserRole').textContent = 'Member';
                                        document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                                        
                                        // Show empty dashboard
                                        switchSection('overview');
                                    }
                                }
                            }
                        }
                    });
                });
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Load profile error:', error);
            }
        }
        
        // Show loan payment modal
        async function showLoanPaymentModal(loanId) {
            const loan = await getDBData('loans', 'id', loanId);
            document.getElementById('loanPaymentModal').dataset.loanId = loanId;
            document.getElementById('loanDueAmount').textContent = loan.totalAmount.toFixed(2);
            document.getElementById('loanPaymentAmount').value = loan.totalAmount.toFixed(2);
            showModal('loanPaymentModal');
        }
        
        // Show share purchase modal
        async function showSharePurchaseModal(shareId) {
            const share = await getDBData('shares', 'id', shareId);
            document.getElementById('sharePurchaseModal').dataset.shareId = shareId;
            document.getElementById('sharePurchaseAmount').value = share.amount;
            document.getElementById('sharePurchaseTotal').textContent = (share.amount * share.price).toFixed(2);
            showModal('sharePurchaseModal');
        }
        
        // Show gift modal
        async function showGiftModal(userId) {
            const user = await getDBData('users', 'id', userId);
            document.getElementById('giftRecipient').value = userId;
            
            // Load available balance
            const membership = await getMembership(state.currentUser.id, state.currentGroup.id);
            document.getElementById('giftAmount').setAttribute('max', membership.balance);
            
            showModal('giftModal');
        }
        
        // Open message conversation
        async function openMessageConversation(userId) {
            const user = await getDBData('users', 'id', userId);
            
            // Set recipient name
            document.getElementById('messageRecipientName').textContent = user.name;
            
            // Load message history
            const messages = await getDBData('messages', 'groupId', state.currentGroup.id);
            const conversationMessages = messages.filter(m => 
                (m.senderId === user.id && m.receiverId === state.currentUser.id) ||
                (m.senderId === state.currentUser.id && m.receiverId === user.id)
            );
            
            // Sort by date
            conversationMessages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            
            // Display messages
            const messageHistory = document.getElementById('messageHistory');
            messageHistory.innerHTML = '';
            
            for (const message of conversationMessages) {
                const isSender = message.senderId === state.currentUser.id;
                const messageElement = document.createElement('div');
                messageElement.className = `mb-2 ${isSender ? 'text-right' : 'text-left'}`;
                
                messageElement.innerHTML = `
                    <div class="d-inline-block p-2 rounded ${isSender ? 'bg-primary text-white' : 'bg-light'}">
                        ${message.content}
                        <div class="small text-muted">${new Date(message.createdAt).toLocaleTimeString()}</div>
                    </div>
                `;
                
                messageHistory.appendChild(messageElement);
            }
            
            // Scroll to bottom
            messageHistory.scrollTop = messageHistory.scrollHeight;
            
            // Set up message form
            document.getElementById('sendMessageForm').onsubmit = async function(e) {
                e.preventDefault();
                const content = document.getElementById('messageContent').value.trim();
                
                if (content) {
                    // Create message
                    const message = {
                        id: generateId(),
                        senderId: state.currentUser.id,
                        receiverId: user.id,
                        groupId: state.currentGroup.id,
                        content,
                        createdAt: new Date().toISOString()
                    };
                    
                    await addDBData('messages', message);
                    
                    // Add to blockchain
                    await addBlock({
                        type: 'message',
                        data: message
                    });
                    
                    // Clear input
                    document.getElementById('messageContent').value = '';
                    
                    // Reload conversation
                    openMessageConversation(userId);
                }
            };
            
            // Show conversation
            document.getElementById('messageConversation').classList.remove('hidden');
            document.getElementById('noMessageSelected').classList.add('hidden');
        }
        
        // Show broadcast
        function showBroadcast(message) {
            const broadcastContainer = document.getElementById('broadcastMessage');
            const broadcastContent = document.getElementById('broadcastContent');
            
            broadcastContent.textContent = message;
            broadcastContainer.classList.remove('hidden');
            
            // Hide after duration
            const systemSettings = getDBData('settings', 'key', 'system');
            const duration = (systemSettings && systemSettings.value.broadcastDuration) || 10;
            
            setTimeout(() => {
                broadcastContainer.classList.add('hidden');
            }, duration * 1000);
        }
        
        // Update loan calculation
        function updateLoanCalculation() {
            const amount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const interestRate = state.currentGroup.settings.defaultInterestRate;
            const interestAmount = amount * (interestRate / 100);
            const totalAmount = amount + interestAmount;
            
            document.getElementById('loanTotalRepay').textContent = totalAmount.toFixed(2);
        }
        
        // Calculate next saving date
        function calculateNextSavingDate() {
            const settings = state.currentGroup.settings;
            const now = new Date();
            let nextDate = new Date();
            
            switch (settings.savingFrequency) {
                case 'daily':
                    nextDate.setDate(now.getDate() + 1);
                    break;
                case 'weekly':
                    // Find next saving day
                    const currentDay = now.getDay();
                    const savingDay = parseInt(settings.savingDay);
                    
                    if (currentDay < savingDay) {
                        nextDate.setDate(now.getDate() + (savingDay - currentDay));
                    } else {
                        nextDate.setDate(now.getDate() + (7 - currentDay + savingDay));
                    }
                    break;
                case 'monthly':
                    // Find next saving date
                    const currentDate = now.getDate();
                    const savingDate = parseInt(settings.savingDate);
                    
                    if (currentDate < savingDate) {
                        nextDate.setDate(savingDate);
                    } else {
                        nextDate.setMonth(now.getMonth() + 1);
                        nextDate.setDate(savingDate);
                    }
                    break;
                case 'annually':
                    nextDate.setFullYear(now.getFullYear() + 1);
                    break;
                default:
                    // Custom frequency - not implemented
                    nextDate.setDate(now.getDate() + 7);
            }
            
            return nextDate;
        }
        
        // Get cycle description
        function getCycleDescription(cycleDuration) {
            switch (cycleDuration) {
                case '1month': return '1 Month';
                case '3months': return '3 Months';
                case '6months': return '6 Months';
                case '1year': return '1 Year';
                default: return 'Custom';
            }
        }
        
        // Get status badge class
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'pending': return 'badge-warning';
                case 'approved': 
                case 'active': 
                case 'completed': 
                case 'paid': return 'badge-success';
                case 'rejected': 
                case 'cancelled': 
                case 'failed': return 'badge-danger';
                default: return 'badge-secondary';
            }
        }
        
        // Approve saving
        async function approveSaving(savingId) {
            const saving = await getDBData('savings', 'id', savingId);
            saving.status = 'approved';
            saving.approvedBy = state.currentUser.id;
            await updateDBData('savings', saving);
            
            // Update member's balance
            const membership = await getMembership(saving.userId, saving.groupId);
            membership.balance += saving.amount;
            await updateDBData('memberships', membership);
            
            // Update transaction
            const transactions = await getDBData('transactions', 'groupId', saving.groupId);
            const savingTransaction = transactions.find(t => 
                t.type === 'saving' && 
                t.amount === saving.amount && 
                new Date(t.createdAt).getTime() === new Date(saving.createdAt).getTime()
            );
            
            if (savingTransaction) {
                savingTransaction.status = 'completed';
                await updateDBData('transactions', savingTransaction);
            }
            
            // Add to timeline
            const user = await getDBData('users', 'id', saving.userId);
            const timelinePost = {
                id: generateId(),
                groupId: saving.groupId,
                userId: state.currentUser.id,
                type: 'saving_approved',
                content: `Approved saving of ${state.currentGroup.currency} ${saving.amount.toFixed(2)} from ${user.name}`,
                createdAt: new Date().toISOString()
            };
            
            await addDBData('timeline', timelinePost);
            
            // Add to blockchain
            await addBlock({
                type: 'saving_approval',
                data: {
                    savingId,
                    approvedBy: state.currentUser.id,
                    timestamp: new Date().toISOString()
                }
            });
        }
        
        // Reject saving
        async function rejectSaving(savingId) {
            const saving = await getDBData('savings', 'id', savingId);
            saving.status = 'rejected';
            saving.approvedBy = state.currentUser.id;
            await updateDBData('savings', saving);
            
            // Update transaction
            const transactions = await getDBData('transactions', 'groupId', saving.groupId);
            const savingTransaction = transactions.find(t => 
                t.type === 'saving' && 
                t.amount === saving.amount && 
                new Date(t.createdAt).getTime() === new Date(saving.createdAt).getTime()
            );
            
            if (savingTransaction) {
                savingTransaction.status = 'rejected';
                await updateDBData('transactions', savingTransaction);
            }
            
            // Add to timeline
            const user = await getDBData('users', 'id', saving.userId);
            const timelinePost = {
                id: generateId(),
                groupId: saving.groupId,
                userId: state.currentUser.id,
                type: 'saving_rejected',
                content: `Rejected saving of ${state.currentGroup.currency} ${saving.amount.toFixed(2)} from ${user.name}`,
                createdAt: new Date().toISOString()
            };
            
            await addDBData('timeline', timelinePost);
            
            // Add to blockchain
            await addBlock({
                type: 'saving_rejection',
                data: {
                    savingId,
                    rejectedBy: state.currentUser.id,
                    timestamp: new Date().toISOString()
                }
            });
        }
        
        // Approve loan
        async function approveLoan(loanId) {
            const loan = await getDBData('loans', 'id', loanId);
            loan.status = 'active';
            loan.approvedBy = state.currentUser.id;
            await updateDBData('loans', loan);
            
            // Update transaction
            const transactions = await getDBData('transactions', 'groupId', loan.groupId);
            const loanTransaction = transactions.find(t => 
                t.type === 'loan' && 
                t.amount === loan.amount && 
                new Date(t.createdAt).getTime() === new Date(loan.createdAt).getTime()
            );
            
            if (loanTransaction) {
                loanTransaction.status = 'completed';
                await updateDBData('transactions', loanTransaction);
            }
            
            // Add to timeline
            const user = await getDBData('users', 'id', loan.userId);
            const timelinePost = {
                id: generateId(),
                groupId: loan.groupId,
                userId: state.currentUser.id,
                type: 'loan_approved',
                content: `Approved loan of ${state.currentGroup.currency} ${loan.amount.toFixed(2)} to ${user.name}`,
                createdAt: new Date().toISOString()
            };
            
            await addDBData('timeline', timelinePost);
            
            // Add to blockchain
            await addBlock({
                type: 'loan_approval',
                data: {
                    loanId,
                    approvedBy: state.currentUser.id,
                    timestamp: new Date().toISOString()
                }
            });
        }
        
        // Reject loan
        async function rejectLoan(loanId) {
            const loan = await getDBData('loans', 'id', loanId);
            loan.status = 'rejected';
            loan.approvedBy = state.currentUser.id;
            await updateDBData('loans', loan);
            
            // Update transaction
            const transactions = await getDBData('transactions', 'groupId', loan.groupId);
            const loanTransaction = transactions.find(t => 
                t.type === 'loan' && 
                t.amount === loan.amount && 
                new Date(t.createdAt).getTime() === new Date(loan.createdAt).getTime()
            );
            
            if (loanTransaction) {
                loanTransaction.status = 'rejected';
                await updateDBData('transactions', loanTransaction);
            }
            
            // Add to timeline
            const user = await getDBData('users', 'id', loan.userId);
            const timelinePost = {
                id: generateId(),
                groupId: loan.groupId,
                userId: state.currentUser.id,
                type: 'loan_rejected',
                content: `Rejected loan application of ${state.currentGroup.currency} ${loan.amount.toFixed(2)} from ${user.name}`,
                createdAt: new Date().toISOString()
            };
            
            await addDBData('timeline', timelinePost);
            
            // Add to blockchain
            await addBlock({
                type: 'loan_rejection',
                data: {
                    loanId,
                    rejectedBy: state.currentUser.id,
                    timestamp: new Date().toISOString()
                }
            });
        }
        
        // Approve share
        async function approveShare(shareId) {
            const share = await getDBData('shares', 'id', shareId);
            share.status = 'approved';
            share.approvedBy = state.currentUser.id;
            await updateDBData('shares', share);
            
            // Update transaction
            const transactions = await getDBData('transactions', 'groupId', share.groupId);
            const shareTransaction = transactions.find(t => 
                t.type === 'share' && 
                t.amount === share.amount && 
                new Date(t.createdAt).getTime() === new Date(share.createdAt).getTime()
            );
            
            if (shareTransaction) {
                shareTransaction.status = 'completed';
                await updateDBData('transactions', shareTransaction);
            }
            
            // Add to timeline
            const user = await getDBData('users', 'id', share.userId);
            const timelinePost = {
                id: generateId(),
                groupId: share.groupId,
                userId: state.currentUser.id,
                type: 'share_approved',
                content: `Approved share listing of ${share.amount} shares from ${user.name}`,
                createdAt: new Date().toISOString()
            };
            
            await addDBData('timeline', timelinePost);
            
            // Add to blockchain
            await addBlock({
                type: 'share_approval',
                data: {
                    shareId,
                    approvedBy: state.currentUser.id,
                    timestamp: new Date().toISOString()
                }
            });
        }
        
        // Reject share
        async function rejectShare(shareId) {
            const share = await getDBData('shares', 'id', shareId);
            share.status = 'rejected';
            share.approvedBy = state.currentUser.id;
            await updateDBData('shares', share);
            
            // Update transaction
            const transactions = await getDBData('transactions', 'groupId', share.groupId);
            const shareTransaction = transactions.find(t => 
                t.type === 'share' && 
                t.amount === share.amount && 
                new Date(t.createdAt).getTime() === new Date(share.createdAt).getTime()
            );
            
            if (shareTransaction) {
                shareTransaction.status = 'rejected';
                await updateDBData('transactions', shareTransaction);
            }
            
            // Add to timeline
            const user = await getDBData('users', 'id', share.userId);
            const timelinePost = {
                id: generateId(),
                groupId: share.groupId,
                userId: state.currentUser.id,
                type: 'share_rejected',
                content: `Rejected share listing of ${share.amount} shares from ${user.name}`,
                createdAt: new Date().toISOString()
            };
            
            await addDBData('timeline', timelinePost);
            
            // Add to blockchain
            await addBlock({
                type: 'share_rejection',
                data: {
                    shareId,
                    rejectedBy: state.currentUser.id,
                    timestamp: new Date().toISOString()
                }
            });
        }
        
        // Approve member
        async function approveMember(userId) {
            const membership = await getMembership(userId, state.currentGroup.id);
            membership.isApproved = true;
            await updateDBData('memberships', membership);
            
            // Add to timeline
            const user = await getDBData('users', 'id', userId);
            const timelinePost = {
                id: generateId(),
                groupId: state.currentGroup.id,
                userId: state.currentUser.id,
                type: 'member_approved',
                content: `Approved membership for ${user.name}`,
                createdAt: new Date().toISOString()
            };
            
            await addDBData('timeline', timelinePost);
            
            // Add to blockchain
            await addBlock({
                type: 'member_approval',
                data: {
                    userId,
                    approvedBy: state.currentUser.id,
                    timestamp: new Date().toISOString()
                }
            });
        }
        
        // Reject member
        async function rejectMember(userId) {
            await deleteDBData('memberships', (await getMembership(userId, state.currentGroup.id)).id);
            
            // Add to timeline
            const user = await getDBData('users', 'id', userId);
            const timelinePost = {
                id: generateId(),
                groupId: state.currentGroup.id,
                userId: state.currentUser.id,
                type: 'member_rejected',
                content: `Rejected membership for ${user.name}`,
                createdAt: new Date().toISOString()
            };
            
            await addDBData('timeline', timelinePost);
            
            // Add to blockchain
            await addBlock({
                type: 'member_rejection',
                data: {
                    userId,
                    rejectedBy: state.currentUser.id,
                    timestamp: new Date().toISOString()
                }
            });
        }
        
        // Remove member
        async function removeMember(userId) {
            await deleteDBData('memberships', (await getMembership(userId, state.currentGroup.id)).id);
            
            // Add to timeline
            const user = await getDBData('users', 'id', userId);
            const timelinePost = {
                id: generateId(),
                groupId: state.currentGroup.id,
                userId: state.currentUser.id,
                type: 'member_removed',
                content: `Removed ${user.name} from the group`,
                createdAt: new Date().toISOString()
            };
            
            await addDBData('timeline', timelinePost);
            
            // Add to blockchain
            await addBlock({
                type: 'member_removal',
                data: {
                    userId,
                    removedBy: state.currentUser.id,
                    timestamp: new Date().toISOString()
                }
            });
            
            // Reload members data
            loadMembersData();
        }
        
        // Get membership
        async function getMembership(userId, groupId) {
            const memberships = await getDBData('memberships', 'groupId', groupId);
            return memberships.find(m => m.userId === userId);
        }
        
        // Get default group settings
        function getDefaultGroupSettings() {
            return {
                savingFrequency: 'monthly',
                savingDay: '1', // Monday
                savingDate: '1', // 1st of the month
                savingAmountType: 'fixed',
                fixedAmount: 10000,
                savingCompulsory: 'yes',
                loanEnabled: 'yes',
                defaultInterestRate: 5,
                penaltyInterestRate: 20,
                cycleDuration: '1year',
                withdrawalsEnabled: false
            };
        }
        
        // Generate ID
        function generateId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // Generate username from name
        function generateUsername(name) {
            return name.toLowerCase().replace(/\s+/g, '_') + Math.floor(Math.random() * 1000);
        }
        
        // Hash password
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
        
        // Verify password
        async function verifyPassword(password, hash) {
            const passwordHash = await hashPassword(password);
            return passwordHash === hash;
        }
        
        // Generate auth token
        async function generateAuthToken(user) {
            const tokenData = {
                userId: user.id,
                email: user.email,
                timestamp: new Date().toISOString()
            };
            
            const encoder = new TextEncoder();
            const data = encoder.encode(JSON.stringify(tokenData));
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const token = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            return token;
        }
        
        // Verify auth token
        async function verifyAuthToken(token) {
            // In a real app, you would verify the token against stored tokens
            // For this demo, we'll just check if the user exists
            const users = await getAllDBData('users');
            return users.find(u => u.email === Cookies.get('authEmail'));
        }
        
        // Send verification email
        async function sendVerificationEmail(email) {
            // In a real app, you would send an actual email
            // For this demo, we'll just store the email in a cookie
            Cookies.set('authEmail', email, { expires: 1 });
            state.verificationEmailSent = true;
            
            // Simulate email verification
            setTimeout(async () => {
                const user = await getDBData('users', 'email', email);
                if (user) {
                    user.isVerified = true;
                    await updateDBData('users', user);
                    
                    if (state.currentUser && state.currentUser.email === email) {
                        state.currentUser.isVerified = true;
                    }
                }
            }, 3000);
        }
        
        // Add block to blockchain
        async function addBlock(data) {
            // Get current blockchain
            const blockchain = await getAllDBData('blockchain');
            
            // Create new block
            const previousBlock = blockchain.length > 0 ? blockchain[blockchain.length - 1] : null;
            const newBlock = {
                index: blockchain.length,
                timestamp: new Date().toISOString(),
                data,
                previousHash: previousBlock ? previousBlock.hash : '0',
                hash: '',
                nonce: 0
            };
            
            // Mine block (simple proof-of-work)
            newBlock.hash = await calculateBlockHash(newBlock);
            while (!(await isValidBlockHash(newBlock.hash))) {
                newBlock.nonce++;
                newBlock.hash = await calculateBlockHash(newBlock);
            }
            
            // Add to blockchain
            await addDBData('blockchain', newBlock);
            
            // Sync with peers
            syncBlockchain();
        }
        
        // Calculate block hash
        async function calculateBlockHash(block) {
            const blockString = JSON.stringify({
                index: block.index,
                timestamp: block.timestamp,
                data: block.data,
                previousHash: block.previousHash,
                nonce: block.nonce
            });
            
            const encoder = new TextEncoder();
            const data = encoder.encode(blockString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            return hashHex;
        }
        
        // Validate block hash
        async function isValidBlockHash(hash) {
            // Simple proof-of-work: hash must start with '00'
            return hash.startsWith('00');
        }
        
        // Sync blockchain with peers
        async function syncBlockchain() {
            if (!state.peer || !state.ipfs) return;
            
            try {
                // Get current blockchain
                const localBlockchain = await getAllDBData('blockchain');
                
                // Connect to peers and get their blockchains
                const peers = await state.ipfs.swarm.peers();
                for (const peer of peers) {
                    try {
                        const remoteBlockchain = await state.ipfs.dag.get(peer.peer);
                        
                        // If remote blockchain is longer, validate and replace
                        if (remoteBlockchain.length > localBlockchain.length) {
                            if (await validateBlockchain(remoteBlockchain)) {
                                // Replace local blockchain
                                await clearDBData('blockchain');
                                for (const block of remoteBlockchain) {
                                    await addDBData('blockchain', block);
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error syncing with peer:', peer.peer, error);
                    }
                }
            } catch (error) {
                console.error('Blockchain sync error:', error);
            }
        }
        
        // Validate blockchain
        async function validateBlockchain(blockchain) {
            for (let i = 1; i < blockchain.length; i++) {
                const currentBlock = blockchain[i];
                const previousBlock = blockchain[i - 1];
                
                // Check previous hash
                if (currentBlock.previousHash !== previousBlock.hash) {
                    return false;
                }
                
                // Check hash validity
                const calculatedHash = await calculateBlockHash(currentBlock);
                if (currentBlock.hash !== calculatedHash) {
                    return false;
                }
                
                // Check proof-of-work
                if (!(await isValidBlockHash(currentBlock.hash))) {
                    return false;
                }
            }
            
            return true;
        }
        
        // IndexedDB helper functions
        function getDBData(storeName, indexName, value) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.get(value);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function getAllDBData(storeName, indexName, value) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                let request;
                
                if (indexName && value !== undefined) {
                    const index = store.index(indexName);
                    request = index.getAll(value);
                } else {
                    request = store.getAll();
                }
                
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }
        
        function addDBData(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        function updateDBData(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        function deleteDBData(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        function clearDBData(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = state.db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
    </script>
</body>
</html>
